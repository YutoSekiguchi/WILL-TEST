!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("js-ext"),require("js-md5"),require("long"),require("gl-matrix"),require("poly2tri"),require("clipper-lib"),require("rbush"),require("jszip"),require("protobufjs")):"function"==typeof define&&define.amd?define(["exports","js-ext","js-md5","long","gl-matrix","poly2tri","clipper-lib","rbush","jszip","protobufjs"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).DigitalInk={},e.jsExt,e.md5,e.Long,e.glMatrix,e.poly2tri,e.ClipperLib,e.RBush,e.JSZip,e.protobuf)}(this,(function(e,t,r,n,i,o,a,s,u,c){"use strict";void 0===a&&console.warn("digital-ink dependency clipper-lib not found, expected in global scope"),void 0===o&&console.warn("digital-ink dependency poly2tri not found, expected in global scope"),void 0===r&&console.warn("digital-ink dependency js-md5 not found, expected in global scope"),void 0===u&&console.warn("digital-ink dependency jszip not found, expected in global scope"),void 0===n&&console.warn("digital-ink dependency long not found, expected in global scope"),void 0===c&&console.warn("digital-ink dependency protobufjs not found, expected in global scope"),void 0===t&&console.warn("digital-ink dependency js-ext not found, expected in global scope"),void 0===i&&console.warn("digital-ink dependency gl-matrix not found, expected in global scope"),void 0===s&&console.warn("digital-ink dependency rbush not found, expected in global scope");const l="undefined"==typeof document?void 0:document.currentScript.src;function h(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}function f(e){if(e&&e.__esModule)return e;var t=Object.create(null);return e&&Object.keys(e).forEach((function(r){if("default"!==r){var n=Object.getOwnPropertyDescriptor(e,r);Object.defineProperty(t,r,n.get?n:{enumerable:!0,get:function(){return e[r]}})}})),t.default=e,Object.freeze(t)}var d=f(r),p=f(n),y=f(o),v=f(a),m=h(s),g=f(u),b=f(c);function E(e){return(E="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function P(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function k(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function w(e,t,r){return t&&k(e.prototype,t),r&&k(e,r),e}var x=function(){function e(){P(this,e)}return w(e,[{key:"getInkBuilder",value:function(e){throw new Error("InkController.getInkBuilder(pointerID) is abstract and should be implemented")}},{key:"registerInputProvider",value:function(e,t){throw new Error("InkController.registerInputProvider(pointerID, isPrimary) is abstract and should be implemented")}},{key:"reset",value:function(e){throw new Error("InkController.reset(sensorPoint) is abstract and should be implemented")}},{key:"begin",value:function(e){throw new Error("InkController.begin(sensorPoint) is abstract and should be implemented")}},{key:"move",value:function(e,t){throw new Error("InkController.move(sensorPoint, [prediction]) is abstract and should be implemented")}},{key:"end",value:function(e){throw new Error("InkController.end(sensorPoint) is abstract and should be implemented")}},{key:"abort",value:function(e){throw new Error("InkController.abort(pointerID) is abstract and should be implemented")}},{key:"resize",value:function(e){throw new Error("InkController.resize() is abstract and should be implemented")}}]),e}();function S(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function I(e,t){return(I=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function R(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&I(e,t)}function T(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function A(e,t){if(t&&("object"===E(t)||"function"==typeof t))return t;if(void 0!==t)throw new TypeError("Derived constructors may only return object or undefined");return T(e)}function O(e){return(O=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function C(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}function D(e,t,r){return(D=C()?Reflect.construct:function(e,t,r){var n=[null];n.push.apply(n,t);var i=new(Function.bind.apply(e,n));return r&&I(i,r.prototype),i}).apply(null,arguments)}function N(e){var t="function"==typeof Map?new Map:void 0;return(N=function(e){if(null===e||(r=e,-1===Function.toString.call(r).indexOf("[native code]")))return e;var r;if("function"!=typeof e)throw new TypeError("Super expression must either be null or a function");if(void 0!==t){if(t.has(e))return t.get(e);t.set(e,n)}function n(){return D(e,arguments,O(this).constructor)}return n.prototype=Object.create(e.prototype,{constructor:{value:n,enumerable:!1,writable:!0,configurable:!0}}),I(n,e)})(e)}var M=d?d.default||globalThis.md5:{},L=p?p.default||globalThis.Long:{},B={mask:"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx",generate:function(){var e=Date.now();return this.mask.replace(/[xy]/g,(function(t){var r=(e+16*Math.random())%16|0;return e=Math.floor(e/16),("x"==t?r:3&r|8).toString(16)}))},validate:function(e){return"string"==typeof e&&!!e.match(/^[a-fA-F0-9]{8}-[a-fA-F0-9]{4}-[a-fA-F0-9]{4}-[a-fA-F0-9]{4}-[a-fA-F0-9]{12}$/)},format:function(e){var t=[],r=0;return this.mask.split("-").forEach((function(n){t.push(e.substring(r,r+n.length)),r+=n.length})),t.join("-")},fromString:function(e){return this.fromBytes(new Uint8Array(M.arrayBuffer(e)))},toBytes:function(e){var t=[];return e.split("-").map((function(e,r){(r<3?e.match(/.{1,2}/g).reverse():e.match(/.{1,2}/g)).map((function(e){return t.push(parseInt(e,16))}))})),new Uint8Array(t)},fromBytes:function(e){var t=Array.from(e).map((function(e){return e.toString(16)})).map((function(e){return(1==e.length?"0":"")+e}));return t.slice(0,4).reverse().join("")+"-"+t.slice(4,6).reverse().join("")+"-"+t.slice(6,8).reverse().join("")+"-"+t.slice(8,10).join("")+"-"+t.slice(10).join("")},toUint32Array:function(e){var t=new Uint32Array(4),r=this.toBytes(e);return t[0]=new Uint32Array(r.slice(0,4).buffer)[0],t[1]=new Uint32Array(r.slice(4,8).buffer)[0],t[2]=new Uint32Array(r.slice(8,12).buffer)[0],t[3]=new Uint32Array(r.slice(12).buffer)[0],t},fromUint32Array:function(e){return this.fromBytes(new Uint8Array(e.buffer))},toUint64Array:function(e){var t=new BigUint64Array(2),r=this.toBytes(e);return t[0]=new BigUint64Array(r.slice(0,8).buffer)[0],t[1]=new BigUint64Array(r.slice(8).buffer)[0],t},fromUint64Array:function(e){return this.fromBytes(new Uint8Array(e.buffer))},toLongArray:function(e){var t=new Array(2),r=this.toBytes(e);return t[0]=L.fromBytes(r.slice(0,8)),t[1]=L.fromBytes(r.slice(8)),t},fromLongArray:function(e){var t=e[0].toBytes().concat(e[1].toBytes());return this.fromBytes(t)}};function _(e,t){var r="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!r){if(Array.isArray(e)||(r=function(e,t){if(!e)return;if("string"==typeof e)return F(e,t);var r=Object.prototype.toString.call(e).slice(8,-1);"Object"===r&&e.constructor&&(r=e.constructor.name);if("Map"===r||"Set"===r)return Array.from(e);if("Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r))return F(e,t)}(e))||t&&e&&"number"==typeof e.length){r&&(e=r);var n=0,i=function(){};return{s:i,n:function(){return n>=e.length?{done:!0}:{done:!1,value:e[n++]}},e:function(e){throw e},f:i}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var o,a=!0,s=!1;return{s:function(){r=r.call(e)},n:function(){var e=r.next();return a=e.done,e},e:function(e){s=!0,o=e},f:function(){try{a||null==r.return||r.return()}finally{if(s)throw o}}}}function F(e,t){(null==t||t>e.length)&&(t=e.length);for(var r=0,n=new Array(t);r<t;r++)n[r]=e[r];return n}var U=function(){function e(t){var r;if(P(this,e),(r="function"==typeof this.getMD5Message?e.Algorithm.MD5:"function"==typeof this.buildURI?e.Algorithm.URI:e.Algorithm.GUID)==e.Algorithm.MD5&&(this.invalidateID=function(){return t=void 0}),Object.defineProperty(this,"id",{get:function(){return t||(t=this.resolveID()),t},set:function(e){if(t)throw new Error("id is immutable");t=e},enumerable:!0}),t&&r==e.Algorithm.GUID&&!B.validate(t))throw new Error("Identifiable ".concat(t," is not a well formed UUID"));Object.defineProperty(this,"algorithm",{value:r})}return w(e,[{key:"resolveID",value:function(){if(this.algorithm==e.Algorithm.MD5){var t,r="",n=_(this.getMD5Message());try{for(n.s();!(t=n.n()).done;){var i=t.value;if(Array.isArray(i)){var o,a=_(i);try{for(a.s();!(o=a.n()).done;){r+=o.value,r+="\n"}}catch(e){a.e(e)}finally{a.f()}}else r+=i;r+="\n"}}catch(e){n.e(e)}finally{n.f()}if(!r)throw new Error("Empty MD5 message container found");return M(r)}return this.algorithm==e.Algorithm.URI?this.buildURI():B.generate()}}],[{key:"SEPARATOR",get:function(){return"\n"}},{key:"buildMD5Tokens",value:function(e){var t=[];return Object.keys(e).sort().forEach((function(r){return t.push(r,e[r])})),t}}]),e}();function j(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var r,n=O(e);if(t){var i=O(this).constructor;r=Reflect.construct(n,arguments,i)}else r=n.apply(this,arguments);return A(this,r)}}Object.defineEnum(U,"Algorithm",["GUID","MD5","URI"]);var G=function(e){R(r,e);var t=j(r);function r(e){var n,i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return P(this,r),(n=t.call(this)).type=e,n.props=Object.assign({},i),n}return w(r,[{key:"getMD5Message",value:function(){if(!Object.isFrozen(this))throw new Error("ID generation failed. InkInputProvider do not belongs to any SensorChannelsContext yet");return["InkInputProvider",this.type.name,U.buildMD5Tokens(this.props)]}}]),r}(U);Object.defineEnum(G,"Type",["PEN","TOUCH","MOUSE","CONTROLLER"]);var Y=function(){function e(){P(this,e),this.phase=e.Phase.END}return w(e,[{key:"add",value:function(e,t,r){if(!this.move(e))throw new Error("Cannot move from phase ".concat(this.phase.name," to phase ").concat(e.name));return this.debug&&(console.log("-------------------------------------"),console.log(this.constructor.name,e.name)),this.addImpl(t,r)}},{key:"addImpl",value:function(e,t){throw new Error("Abstract method addImpl of DataProcessor should be implemented")}},{key:"move",value:function(t){return(this.phase!=e.Phase.END||t==e.Phase.BEGIN)&&((this.phase!=e.Phase.BEGIN||t==e.Phase.UPDATE||t==e.Phase.END)&&((this.phase!=e.Phase.UPDATE||t==e.Phase.UPDATE||t==e.Phase.END)&&(t==e.Phase.BEGIN&&this.reset(),this.phase=t,!0)))}},{key:"reset",value:function(){this.phase=e.Phase.END}}]),e}();Object.defineEnum(Y,"Phase",["BEGIN","UPDATE","END"]);var X=function(){function e(t,r,n,o){var a=this;if(P(this,e),isNaN(t))throw new Error("Invalid x found: ".concat(t));if(isNaN(r))throw new Error("Invalid y found: ".concat(r));var s=[t,r];isFinite(n)&&(s.push(n),isFinite(o)&&s.push(o)),this.value=s.toFloat32Array(),Object.defineProperty(this,"x",{get:function(){return a.value[0]},set:function(e){a.value[0]=e},enumerable:!0}),Object.defineProperty(this,"y",{get:function(){return a.value[1]},set:function(e){a.value[1]=e},enumerable:!0}),2==s.length?this.vec=i.vec2:3==s.length?(this.vec=i.vec3,Object.defineProperty(this,"z",{get:function(){return a.value[2]},set:function(e){a.value[2]=e},enumerable:!0})):(this.vec=i.vec4,Object.defineProperty(this,"w",{get:function(){return a.value[3]},set:function(e){a.value[3]=e},enumerable:!0}))}return w(e,[{key:"add",value:function(t){t instanceof e||(t=e.fromPoint(t));var r=this.vec.create();return this.vec.add(r,this.value,t.value),e.fromPoint(r)}},{key:"addSelf",value:function(t){return t instanceof e||(t=e.fromPoint(t)),this.vec.add(this.value,this.value,t.value),this}},{key:"subtract",value:function(t){t instanceof e||(t=e.fromPoint(t));var r=this.vec.create();return this.vec.subtract(r,this.value,t.value),e.fromPoint(r)}},{key:"subtractSelf",value:function(t){return t instanceof e||(t=e.fromPoint(t)),this.vec.subtract(this.value,this.value,t.value),this}},{key:"multiply",value:function(t){t instanceof e||(t=e.fromPoint(t));var r=this.vec.create();return this.vec.multiply(r,this.value,t.value),e.fromPoint(r)}},{key:"multiplySelf",value:function(t){return t instanceof e||(t=e.fromPoint(t)),this.vec.multiply(this.value,this.value,t.value),this}},{key:"divide",value:function(t){t instanceof e||(t=e.fromPoint(t));var r=this.vec.create();return this.vec.divide(r,this.value,t.value),e.fromPoint(r)}},{key:"divideSelf",value:function(t){return t instanceof e||(t=e.fromPoint(t)),this.vec.divide(this.value,this.value,t.value),this}},{key:"scale",value:function(t){var r=this.vec.create();return this.vec.scale(r,this.value,t),e.fromPoint(r)}},{key:"scaleSelf",value:function(e){return this.vec.scale(this.value,this.value,e),this}},{key:"abs",value:function(){return new e(Math.abs(this.x),Math.abs(this.y),isFinite(this.z)?Math.abs(this.z):void 0,isFinite(this.w)?Math.abs(this.w):void 0)}},{key:"absSelf",value:function(){return this.x=Math.abs(this.x),this.y=Math.abs(this.y),isFinite(this.z)&&(this.z=Math.abs(this.z)),isFinite(this.w)&&(this.w=Math.abs(this.w)),this}},{key:"transform",value:function(t){if(!t)return this;var r=this.vec.create();return this.vec.transformMat4(r,this.value,t.toFloat32Array()),e.fromPoint(r)}},{key:"transformSelf",value:function(e){return this.vec.transformMat4(this.value,this.value,e.toFloat32Array()),this}},{key:"toFloat32Array",value:function(){return this.value}},{key:"toJSON",value:function(){var e={x:this.x,y:this.y};return isFinite(this.z)&&(e.z=this.z,isFinite(this.w)&&(e.w=this.w)),e}},{key:"toString",value:function(){return"point(".concat(this.value.join(", "),")")}},{key:"clone",value:function(){return e.fromPoint(this)}}],[{key:"fromPoint",value:function(t){return Array.isArray(t)||ArrayBuffer.isTypedArray(t)?new e(t[0],t[1],t[2],t[3]):new e(t.x,t.y,t.z,t.w)}}]),e}(),z=function(){function e(t,r,n,i){P(this,e);var o=t,a=r,s=t+n,u=r+i;Object.defineProperties(this,{left:{value:o,enumerable:!0},x:{value:t,enumerable:!0},bottom:{value:a,enumerable:!0},y:{value:r,enumerable:!0},right:{value:s,enumerable:!0},top:{value:u,enumerable:!0},width:{value:n,enumerable:!0},height:{value:i,enumerable:!0}})}return w(e,[{key:"union",value:function(t){if(t&&!(t instanceof e))throw new TypeError("rect must be instance of RectGL");return t?e.ofEdges(Math.min(this.left,t.left),Math.min(this.bottom,t.bottom),Math.max(this.right,t.right),Math.max(this.top,t.top)):this}},{key:"intersect",value:function(t){if(t&&!(t instanceof e))throw new TypeError("rect must be instance of RectGL");if(!t)return null;var r=e.ofEdges(Math.max(this.left,t.left),Math.max(this.bottom,t.bottom),Math.min(this.right,t.right),Math.min(this.top,t.top));return r.width>0&&r.height>0?r:null}},{key:"ceil",value:function(){return e.ofEdges(Math.floor(this.left),Math.floor(this.bottom),Math.ceil(this.right),Math.ceil(this.top))}},{key:"floor",value:function(){return e.ofEdges(Math.ceil(this.left),Math.ceil(this.bottom),Math.floor(this.right),Math.floor(this.top))}},{key:"transform",value:function(t){if(!t)return this;var r=X.fromPoint({x:this.left,y:this.bottom}).transform(t),n=X.fromPoint({x:this.right,y:this.bottom}).transform(t),i=X.fromPoint({x:this.left,y:this.top}).transform(t),o=X.fromPoint({x:this.right,y:this.top}).transform(t),a=Math.min(i.x,o.x,r.x,n.x),s=Math.min(i.y,o.y,r.y,n.y),u=Math.max(i.x,o.x,r.x,n.x),c=Math.max(i.y,o.y,r.y,n.y);return e.ofEdges(a,s,u,c)}},{key:"toQuad",value:function(e){var t;if(e){var r=X.fromPoint({x:this.left,y:this.bottom}).transform(e),n=X.fromPoint({x:this.right,y:this.bottom}).transform(e),o=X.fromPoint({x:this.left,y:this.top}).transform(e),a=X.fromPoint({x:this.right,y:this.top}).transform(e);t=i.quat2.fromValues(r.x,r.y,n.x,n.y,o.x,o.y,a.x,a.y)}else t=i.quat2.fromValues(this.left,this.bottom,this.right,this.bottom,this.left,this.top,this.right,this.top);return t}},{key:"toString",value:function(){return"gl-rect(".concat(this.x,", ").concat(this.y,", ").concat(this.width,", ").concat(this.height,")")}}],[{key:"ofEdges",value:function(t,r,n,i){return new e(t,r,n-t,i-r)}},{key:"calculateBrushGLSegmentBounds",value:function(t){var r,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,i=arguments.length>2?arguments[2]:void 0,o=[{x:-1,y:-1},{x:1,y:-1},{x:-1,y:1},{x:1,y:1}],a=.5*t.size,s=Math.abs(n*a);if(i){var u=new X(t.x,t.y,t.x,t.z);r=u.transform(i)}else r=t;var c=r.x,l=r.y,h=t.scaleX*a,f=t.scaleY*a,d=t.offsetX,p=-t.offsetY,y=Math.cos(t.rotation),v=Math.sin(t.rotation),m=Number.MAX_SAFE_INTEGER,g=Number.MIN_SAFE_INTEGER,b=Number.MAX_SAFE_INTEGER,E=Number.MIN_SAFE_INTEGER;return o.forEach((function(e){e.x=e.x*h+d,e.y=e.y*f+p;var t=y*e.x+v*e.y+c,r=-v*e.x+y*e.y+l,n=t-s;m=Math.min(m,n),g=Math.max(g,n),n=t+s,m=Math.min(m,n),g=Math.max(g,n);var i=r-s;b=Math.min(b,i),E=Math.max(E,i),i=r+s,b=Math.min(b,i),E=Math.max(E,i)})),e.ofEdges(m,b,g,E)}}]),e}();Object.defineProperty(z,"SQURE",{value:Object.freeze([Object.freeze({x:-1,y:-1}),Object.freeze({x:1,y:-1}),Object.freeze({x:-1,y:1}),Object.freeze({x:1,y:1})]),enumerable:!0});var V=function(){function e(t,r,n,i){P(this,e);var o,a,s=t,u=r,c=t+n,l=r+i;Object.defineProperties(this,{left:{value:s,enumerable:!0},top:{value:u,enumerable:!0},right:{value:c,enumerable:!0},bottom:{value:l,enumerable:!0},x:{value:t,enumerable:!0},y:{value:r,enumerable:!0},width:{value:n,enumerable:!0},height:{value:i,enumerable:!0},size:{get:function(){return o||(o={width:n,height:i}),o},enumerable:!0},center:{get:function(){return a||(a={x:(s+c)/2,y:(u+l)/2}),a},enumerable:!0}})}return w(e,[{key:"union",value:function(t){return t?e.ofEdges(Math.min(this.left,t.left),Math.min(this.top,t.top),Math.max(this.right,t.right),Math.max(this.bottom,t.bottom)):this}},{key:"intersect",value:function(t){if(!t)return null;var r=e.ofEdges(Math.max(this.left,t.left),Math.max(this.top,t.top),Math.min(this.right,t.right),Math.min(this.bottom,t.bottom));return r.width>0&&r.height>0?r:null}},{key:"intersects",value:function(e){return this.left<=e.right&&this.right>=e.left&&this.top<=e.bottom&&this.bottom>=e.top}},{key:"ceil",value:function(t){var r=Math.floor(this.left),n=Math.floor(this.top),i=Math.ceil(this.right),o=Math.ceil(this.bottom);if(t){var a=i-r,s=o-n;i=r+(a+=a%2),o=n+(s+=s%2)}return e.ofEdges(r,n,i,o)}},{key:"floor",value:function(t){var r=Math.ceil(this.left),n=Math.ceil(this.top),i=Math.floor(this.right),o=Math.floor(this.bottom);if(t){var a=i-r,s=o-n;i=r+(a-=a%2),o=n+(s-=s%2)}return e.ofEdges(r,n,i,o)}},{key:"contains",value:function(e){return this.left<=e.x&&this.right>=e.x&&this.top<=e.y&&this.bottom>=e.y}},{key:"includes",value:function(e){return this.left<=e.left&&this.right>=e.right&&this.top<=e.top&&this.bottom>=e.bottom}},{key:"transform",value:function(t){if(!t)return this;var r=X.fromPoint({x:this.left,y:this.top}).transform(t),n=X.fromPoint({x:this.right,y:this.top}).transform(t),i=X.fromPoint({x:this.left,y:this.bottom}).transform(t),o=X.fromPoint({x:this.right,y:this.bottom}).transform(t),a=Math.min(r.x,n.x,i.x,o.x),s=Math.min(r.y,n.y,i.y,o.y),u=Math.max(r.x,n.x,i.x,o.x),c=Math.max(r.y,n.y,i.y,o.y);return e.ofEdges(a,s,u,c)}},{key:"toPath",value:function(e){throw new Error("Rect.toPath is deprecated. Try oneof (ArrayPath, SharedPath, Spline).fromRect(rect, pointProps)")}},{key:"toGLRect",value:function(){return new z(this.x,this.y,this.width,this.height)}},{key:"toString",value:function(){return"rect(".concat(this.x,", ").concat(this.y,", ").concat(this.width,", ").concat(this.height,")")}},{key:"toJSON",value:function(){return{x:this.left,y:this.top,width:this.width,height:this.height}}}],[{key:"fromGLRect",value:function(t){if(!t)return null;if(!(t instanceof z))throw new TypeError("rect must be instance of RectGL");return new e(t.left,t.bottom,t.width,t.height)}},{key:"isRect",value:function(e){return e&&isFinite(e.left)&&isFinite(e.top)&&isFinite(e.width)&&isFinite(e.height)}},{key:"fromString",value:function(t){return t=t.substring(t.indexOf("(")+1,t.indexOf(")")).split(/,\s*/g),new e(parseFloat(t[0]),parseFloat(t[1]),parseFloat(t[2]),parseFloat(t[3]))}},{key:"fromRect",value:function(t){return"string"==typeof t?e.fromString(t):new e(t.x,t.y,t.width,t.height)}},{key:"ofPolygon",value:function(t){if(t.shape&&(t=t.shape),0==t.length)return null;for(var r=Number.MAX_SAFE_INTEGER,n=Number.MAX_SAFE_INTEGER,i=Number.MIN_SAFE_INTEGER,o=Number.MIN_SAFE_INTEGER,a=0;a<t.length;a++){var s=t.getPointX(a),u=t.getPointY(a);r=Math.min(r,s),n=Math.min(n,u),i=Math.max(i,s),o=Math.max(o,u)}return e.ofEdges(r,n,i,o)}},{key:"ofSpline",value:function(t){for(var r,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,i=0;i<t.length;i++)r=z.calculateBrushGLSegmentBounds(t.getPoint(i),n).union(r);return e.fromGLRect(r)}},{key:"ofEdges",value:function(t,r,n,i){return new e(t,r,n-t,i-r)}},{key:"union",value:function(e,t){return e?t?e.union(t):e:t}},{key:"intersect",value:function(e,t){return e&&t?e.intersect(t):null}}]),e}(),H={m11:0,m12:1,m13:2,m14:3,m21:4,m22:5,m23:6,m24:7,m31:8,m32:9,m33:10,m34:11,m41:12,m42:13,m43:14,m44:15},Z=H.m11,q=H.m12,W=H.m21,K=H.m22,J=H.m41,$=H.m42,Q=function(){function e(){var t=this,r=arguments.length>0&&void 0!==arguments[0]?arguments[0]:i.mat4.create(),n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:e.MultiplicationType.PRE;P(this,e),Object.defineProperty(this,"value",{value:r,enumerable:!0}),Object.defineProperty(this,"multiplicationType",{value:n,enumerable:!0});var o=function(e,t){var r=H[e];this.value[r]=t};Object.defineProperty(this,"a",{get:function(){return t.value[Z]},set:o.bind(this,"m11"),enumerable:!0}),Object.defineProperty(this,"b",{get:function(){return t.value[q]},set:o.bind(this,"m12"),enumerable:!0}),Object.defineProperty(this,"c",{get:function(){return t.value[W]},set:o.bind(this,"m21"),enumerable:!0}),Object.defineProperty(this,"d",{get:function(){return t.value[K]},set:o.bind(this,"m22"),enumerable:!0}),Object.defineProperty(this,"e",{get:function(){return t.value[J]},set:o.bind(this,"m41"),enumerable:!0}),Object.defineProperty(this,"f",{get:function(){return t.value[$]},set:o.bind(this,"m42"),enumerable:!0}),Object.defineProperty(this,"tx",{get:function(){return t.value[J]},set:o.bind(this,"m41"),enumerable:!0}),Object.defineProperty(this,"ty",{get:function(){return t.value[$]},set:o.bind(this,"m42"),enumerable:!0}),Object.defineProperty(this,"m11",{get:function(){return t.value[0]},set:o.bind(this,"m11"),enumerable:!0}),Object.defineProperty(this,"m12",{get:function(){return t.value[1]},set:o.bind(this,"m12"),enumerable:!0}),Object.defineProperty(this,"m13",{get:function(){return t.value[2]},set:o.bind(this,"m13"),enumerable:!0}),Object.defineProperty(this,"m14",{get:function(){return t.value[3]},set:o.bind(this,"m14"),enumerable:!0}),Object.defineProperty(this,"m21",{get:function(){return t.value[4]},set:o.bind(this,"m21"),enumerable:!0}),Object.defineProperty(this,"m22",{get:function(){return t.value[5]},set:o.bind(this,"m22"),enumerable:!0}),Object.defineProperty(this,"m23",{get:function(){return t.value[6]},set:o.bind(this,"m23"),enumerable:!0}),Object.defineProperty(this,"m24",{get:function(){return t.value[7]},set:o.bind(this,"m24"),enumerable:!0}),Object.defineProperty(this,"m31",{get:function(){return t.value[8]},set:o.bind(this,"m31"),enumerable:!0}),Object.defineProperty(this,"m32",{get:function(){return t.value[9]},set:o.bind(this,"m32"),enumerable:!0}),Object.defineProperty(this,"m33",{get:function(){return t.value[10]},set:o.bind(this,"m33"),enumerable:!0}),Object.defineProperty(this,"m34",{get:function(){return t.value[11]},set:o.bind(this,"m34"),enumerable:!0}),Object.defineProperty(this,"m41",{get:function(){return t.value[12]},set:o.bind(this,"m41"),enumerable:!0}),Object.defineProperty(this,"m42",{get:function(){return t.value[13]},set:o.bind(this,"m42"),enumerable:!0}),Object.defineProperty(this,"m43",{get:function(){return t.value[14]},set:o.bind(this,"m43"),enumerable:!0}),Object.defineProperty(this,"m44",{get:function(){return t.value[15]},set:o.bind(this,"m44"),enumerable:!0}),Object.defineProperty(this,"isIdentity",{get:function(){return 1==t.a&&0==t.b&&0==t.c&&1==t.d&&0==t.tx&&0==t.ty},enumerable:!0}),Object.defineProperty(this,"is2D",{get:function(){return!(0!=t.m31||0!=t.m32||0!=t.m13||0!=t.m23||1!=t.m33||0!=t.m43||0!=t.m14||0!=t.m24||0!=t.m34||1!=t.m44)},enumerable:!0}),Object.defineProperty(this,"translateX",{get:function(){return t.tx}}),Object.defineProperty(this,"translateY",{get:function(){return t.ty}}),Object.defineProperty(this,"skewX",{get:function(){return Math.tan(t.c)}}),Object.defineProperty(this,"skewY",{get:function(){return Math.tan(t.b)}}),Object.defineProperty(this,"scaleX",{get:function(){return Math.sqrt(t.a*t.a+t.c*t.c)}}),Object.defineProperty(this,"scaleY",{get:function(){return Math.sqrt(t.d*t.d+t.b*t.b)}}),Object.defineProperty(this,"rotation",{get:function(){return Math.atan2(t.b,t.a)}})}return w(e,[{key:"clone",value:function(){return new e(this.value.clone(),this.multiplicationType)}},{key:"translate",value:function(t){return this.multiply(e.fromTranslate(t))}},{key:"translateSelf",value:function(t){this.multiplySelf(e.fromTranslate(t))}},{key:"rotate",value:function(t,r){return this.multiply(e.fromRotate(t,r))}},{key:"rotateSelf",value:function(t,r){this.multiplySelf(e.fromRotate(t,r))}},{key:"scale",value:function(t,r){return this.multiply(e.fromScale(t,r))}},{key:"scaleSelf",value:function(t,r){this.multiplySelf(e.fromScale(t,r))}},{key:"multiply",value:function(t){return this.multiplicationType==e.MultiplicationType.PRE?this.preMultiply(t):this.postMultiply(t)}},{key:"preMultiply",value:function(t){var r=i.mat4.create();return i.mat4.multiply(r,t.toFloat32Array(),this.value),new e(r,this.multiplicationType)}},{key:"postMultiply",value:function(t){var r=i.mat4.create();return i.mat4.multiply(r,this.value,t.toFloat32Array()),new e(r,this.multiplicationType)}},{key:"multiplySelf",value:function(t){this.multiplicationType==e.MultiplicationType.PRE?this.preMultiplySelf(t):this.postMultiplySelf(t)}},{key:"preMultiplySelf",value:function(e){i.mat4.multiply(this.value,e.toFloat32Array(),this.value)}},{key:"postMultiplySelf",value:function(e){i.mat4.multiply(this.value,this.value,e.toFloat32Array())}},{key:"invert",value:function(){var t=i.mat4.create();return i.mat4.invert(t,this.value),new e(t,this.multiplicationType)}},{key:"invertSelf",value:function(){i.mat4.invert(this.value,this.value)}},{key:"decompose",value:function(){return{translate:{x:this.tx,y:this.ty},rotate:{angle:Math.atan2(this.b,this.a)},skew:{angleX:Math.tan(this.c),angleY:Math.tan(this.b)},scale:{x:Math.sqrt(this.a*this.a+this.c*this.c),y:Math.sqrt(this.d*this.d+this.b*this.b)},matrix:this.toJSON()}}},{key:"transformPoint",value:function(e){return X.fromPoint(e).transform(this)}},{key:"toFloat32Array",value:function(){return this.value}},{key:"toJSON",value:function(){return{a:this.a,b:this.b,c:this.c,d:this.d,tx:this.tx,ty:this.ty}}},{key:"toString",value:function(e){if(e){var t=function(e){return((e<0?"":" ")+e.toPrecision(6)).substring(0,8)};return" Matrix 4x4\n"+"-".repeat(39)+"\n".concat(t(this.m11),", ").concat(t(this.m21),", ").concat(t(this.m31),", ").concat(t(this.m41))+"\n".concat(t(this.m12),", ").concat(t(this.m22),", ").concat(t(this.m32),", ").concat(t(this.m42))+"\n".concat(t(this.m13),", ").concat(t(this.m23),", ").concat(t(this.m33),", ").concat(t(this.m43))+"\n".concat(t(this.m14),", ").concat(t(this.m24),", ").concat(t(this.m34),", ").concat(t(this.m44))}return this.is2D?"matrix(".concat(this.a,", ").concat(this.b,", ").concat(this.c,", ").concat(this.d,", ").concat(this.tx,", ").concat(this.ty,")"):"matrix3d(".concat(this.m11,", ").concat(this.m12,", ").concat(this.m13,", ").concat(this.m14,", ").concat(this.m21,", ").concat(this.m22,", ").concat(this.m23,", ").concat(this.m24,", ").concat(this.m31,", ").concat(this.m32,", ").concat(this.m33,", ").concat(this.m34,", ").concat(this.m41,", ").concat(this.m42,", ").concat(this.m43,", ").concat(this.m44,")")}}],[{key:"fromString",value:function(t,r){var n=i.mat4.create();if("none"!=t){var o=t.substring(0,t.indexOf("("));t=t.substring(t.indexOf("(")+1,t.indexOf(")")).split(/,\s*/g),"matrix3d"==o?(n[0]=parseFloat(t[0]),n[1]=parseFloat(t[1]),n[2]=parseFloat(t[2]),n[3]=parseFloat(t[3]),n[4]=parseFloat(t[4]),n[5]=parseFloat(t[5]),n[6]=parseFloat(t[6]),n[7]=parseFloat(t[7]),n[8]=parseFloat(t[8]),n[9]=parseFloat(t[9]),n[10]=parseFloat(t[10]),n[11]=parseFloat(t[11]),n[12]=parseFloat(t[12]),n[13]=parseFloat(t[13]),n[14]=parseFloat(t[14]),n[15]=parseFloat(t[15])):(n[Z]=parseFloat(t[0]),n[q]=parseFloat(t[1]),n[W]=parseFloat(t[2]),n[K]=parseFloat(t[3]),n[J]=parseFloat(t[4]),n[$]=parseFloat(t[5]))}return new e(n,r)}},{key:"fromMatrix",value:function(t,r){if(!t)throw new Error("data not found, Matrix instance creation failed");if("function"==typeof t)throw new Error("data type function is not allowed");if(t instanceof e)return t;if(Array.isArray(t)&&(t=new Float32Array(t)),t instanceof Float32Array)return new e(t,r);if("string"==typeof t)return e.fromString(t,r);var n=i.mat4.create(),o=Object.assign({},t);return isFinite(t.a)&&(o.m11=t.a),isFinite(t.b)&&(o.m12=t.b),isFinite(t.c)&&(o.m21=t.c),isFinite(t.d)&&(o.m22=t.d),isFinite(t.tx)?o.m41=t.tx:isFinite(t.e)?o.m41=t.e:isFinite(t.dx)&&(o.m41=t.dx),isFinite(t.ty)?o.m42=t.ty:isFinite(t.f)?o.m42=t.f:isFinite(t.dy)&&(o.m42=t.dy),isFinite(o.m11)&&(n[0]=o.m11),isFinite(o.m12)&&(n[1]=o.m12),isFinite(o.m13)&&(n[2]=o.m13),isFinite(o.m14)&&(n[3]=o.m14),isFinite(o.m21)&&(n[4]=o.m21),isFinite(o.m22)&&(n[5]=o.m22),isFinite(o.m23)&&(n[6]=o.m23),isFinite(o.m24)&&(n[7]=o.m24),isFinite(o.m31)&&(n[8]=o.m31),isFinite(o.m32)&&(n[9]=o.m32),isFinite(o.m33)&&(n[10]=o.m33),isFinite(o.m34)&&(n[11]=o.m34),isFinite(o.m41)&&(n[12]=o.m41),isFinite(o.m42)&&(n[13]=o.m42),isFinite(o.m43)&&(n[14]=o.m43),isFinite(o.m44)&&(n[15]=o.m44),new e(n,r||t.multiplicationType)}},{key:"fromTranslate",value:function(t){var r=isFinite(t)?{tx:t,ty:t}:{tx:t.x,ty:t.y};return e.fromMatrix(r)}},{key:"fromRotate",value:function(t,r){var n=Math.sin(t),i=Math.cos(t),o={a:i,b:n,c:-n,d:i};return r&&(o.tx=r.x-r.x*i+r.y*n,o.ty=r.y-r.x*n-r.y*i),e.fromMatrix(o)}},{key:"fromScale",value:function(t,r){isFinite(t)&&(t={x:t,y:t});var n={a:t.x,d:t.y};return r&&(n.tx=r.x-r.x*t.x,n.ty=r.y-r.y*t.y),e.fromMatrix(n)}},{key:"fromPoints",value:function(t,r){if(!Array.isArray(t)||!Array.isArray(r))throw new Error("Expected input type Array requirement not satisfied");if(3!=t.length||3!=r.length)throw new Error("Expected input size 3 requirement not satisfied");var n=e.fromMatrix({m11:t[0].x,m21:t[1].x,m31:t[2].x,m12:t[0].y,m22:t[1].y,m32:t[2].y,m13:1,m23:1,m33:1}),i=e.fromMatrix({m11:r[0].x,m21:r[1].x,m31:r[2].x,m12:r[0].y,m22:r[1].y,m32:r[2].y,m13:1,m23:1,m33:1}),o=n.invert().preMultiply(i);return e.fromMatrix({a:o.m11,b:o.m12,c:o.m21,d:o.m22,tx:o.m31,ty:o.m32})}},{key:"multiply",value:function(t,r){var n=i.mat4.create();return i.mat4.multiply(n,t.value,r.value),new e(n)}}]),e}();function ee(e,t){(null==t||t>e.length)&&(t=e.length);for(var r=0,n=new Array(t);r<t;r++)n[r]=e[r];return n}function te(e){return function(e){if(Array.isArray(e))return ee(e)}(e)||function(e){if("undefined"!=typeof Symbol&&null!=e[Symbol.iterator]||null!=e["@@iterator"])return Array.from(e)}(e)||function(e,t){if(e){if("string"==typeof e)return ee(e,t);var r=Object.prototype.toString.call(e).slice(8,-1);return"Object"===r&&e.constructor&&(r=e.constructor.name),"Map"===r||"Set"===r?Array.from(e):"Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r)?ee(e,t):void 0}}(e)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}Q.MultiplicationType=Object.freeze({PRE:"PRE",POST:"POST"});var re={longToByteArray:function(e){for(var t=[0,0,0,0,0,0,0,0],r=0;r<t.length;r++){var n=255&e;t[r]=n,e=(e-n)/256}return t},byteArrayToLong:function(e){for(var t=0,r=e.length-1;r>=0;r--)t=256*t+e[r];return t},crc32:function(){for(var e=new Uint32Array(256),t=256;t--;){for(var r=t,n=8;n--;)r=1&r?3988292384^r>>>1:r>>>1;e[t]=r}return function(t){for(var r=-1,n=0,i=t.length;n<i;n++)r=r>>>8^e[255&r^t[n]];return(-1^r)>>>0}}(),encodeBitMask:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[];if(0==e.length)return 0;for(var t="",r=Math.max.apply(Math,te(e)),n=1;n<=r;n++)t+=e.includes(n)?"1":"0";return parseInt(t.split("").reverse().join(""),2)},decodeBitMask:function(e){for(var t=[],r=e.toString(2).split("").reverse(),n=0;n<r.length;n++)1==r[n]&&t.push(n+1);return t},mapTo:function(e,t,r){return r.min+(re.clamp(e,t)-t.min)/(t.max-t.min)*(r.max-r.min)},clamp:function(e,t){return Math.min(Math.max(e,t.min),t.max)},debounce:function(e,t){var r=null;return function(){var n=this,i=arguments;clearTimeout(r),r=setTimeout((function(){e.apply(n,i)}),t)}},comparator:function(){var e=Array.prototype.slice.call(arguments),t=function(e,t,r){var n="asc"===r?1:-1;return e>t?1*n:e<t?-1*n:0},r=function(e,t,r){return t.replace("[",".").replace("]","").split(".").forEach((function(t){return e=e[t]})),r?e.toLowerCase():e};return function(n,i){return e.map((function(e){return t(r(n,e.sortBy,e.ignoreCase),r(i,e.sortBy,e.ignoreCase),e.sortOrder)})).reduceRight((function(e,t){return t||e}))}},isValidURL:function(e){if("string"!=typeof e)return!1;try{return new URL(e),!0}catch(e){return!1}},getPropName:function(e,t){var r=e.split("_"),n=r.first.toLowerCase();t&&(n=n.substring(0,1).toUpperCase()+n.substring(1));for(var i=1;i<r.length;i++)n+=r[i].substring(0,1),n+=r[i].substring(1).toLowerCase();return n},getEnumValueName:function(e){for(var t="",r=0;r<e.length;r++)r>0&&e[r]!=e[r].toLowerCase()&&(t+="_"),t+=e[r];return t.toUpperCase()}},ne=function(){function e(t){var r=this;P(this,e),this.header=[],this.table=[],t.forEach((function(e){"string"==typeof e&&(e={name:e,title:e}),e.size=e.title.length,r.header.push(e)})),Object.defineProperty(this,"length",{get:function(){return r.table.length},enumerable:!0})}return w(e,[{key:"insert",value:function(e){this.table.push(e),this.header.forEach((function(t){var r=e[t.name];null!=r&&(t.size=Math.max(t.size,r.toString().length))}))}},{key:"build",value:function(){var e=this,t=[],r=this.header.length+1,n=[];return this.header.forEach((function(t){r+=t.size+2;var i=t.size-t.title.length,o=Math.floor(i/2),a=Math.ceil(i/2);n.push(e.getRepetedValue(o)+t.title+e.getRepetedValue(a))})),this.table.forEach((function(r){var n=[];e.header.forEach((function(t){var i=null==r[t.name]?"":r[t.name],o=t.size-i.toString().length;n.push(i+e.getRepetedValue(o))})),t.push(n)})),{delimiterLength:r,headerRow:n,content:t}}},{key:"getFormattedRow",value:function(e){var t="| ";return e.forEach((function(e){t+=e,t+=" | "})),t.trim()}},{key:"getRepetedValue",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:" ";return new Array(e+1).join(t)}},{key:"clear",value:function(){this.table.clear()}},{key:"toString",value:function(){var e=this,t="",r=this.build(),n=r.delimiterLength,i=r.headerRow,o=r.content;return t+=this.getRepetedValue(n,"="),t+="\n",t+=this.getFormattedRow(i),t+="\n",t+=this.getRepetedValue(n,"="),t+="\n",o.forEach((function(r){t+=e.getFormattedRow(r),t+="\n"})),t}}]),e}();function ie(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var r,n=O(e);if(t){var i=O(this).constructor;r=Reflect.construct(n,arguments,i)}else r=n.apply(this,arguments);return A(this,r)}}if("object"===("undefined"==typeof window?"undefined":E(window))&&"undefined"==typeof TouchEvent){var oe=function(e){R(r,e);var t=ie(r);function r(){return P(this,r),t.apply(this,arguments)}return r}(N(Event));window.TouchEvent=oe}var ae={pointers:{mouse:["down","move","up"],touch:["start","move","end"]},inactive:[],open:function(e){if(!(e instanceof x))throw new Error("Argument doesn't implement InkController interface");this.inkController=e,this.canvas=e.canvas.surface,this.mounted||(this.mounted=!0,this.begin=this.begin.bind(this),this.move=this.move.bind(this),this.end=this.end.bind(this),this.abort=this.abort.bind(this)),addEventListener("touchcancel",this.abort,{passive:!0}),this.attachResize(),this.start()},reset:function(e){for(var t in this.pointers){var r=t==ae.PointerType.TOUCH?{passive:!0}:void 0,n=t+this.pointers[t][0];this.canvas.removeEventListener(n,this.begin),e.canvas.surface.addEventListener(n,this.begin,r)}this.dettachResize(),this.inkController=e,this.canvas=e.canvas.surface,this.attachResize()},close:function(){this.stop(),this.dettachResize(),removeEventListener("touchcancel",this.abort),delete this.canvas,delete this.inkController},start:function(e){var t=e?S({},e,this.pointers[e]):this.pointers;for(e in e&&this.inactive.remove(e),this.inactive.forEach((function(e){return delete t[e]})),t)for(var r=e==ae.PointerType.TOUCH?{passive:!0}:void 0,n=0;n<t[e].length;n++){var i=e+t[e][n];0==n?this.canvas.addEventListener(i,this.begin,r):addEventListener(i,2==n?this.end:this.move,r)}},stop:function(e){var t=e?S({},e,this.pointers[e]):this.pointers;for(e in e&&!this.inactive.includes(e)&&this.inactive.push(e),this.inactive.forEach((function(e){return delete t[e]})),e&&e!=ae.PointerType.MOUSE||clearTimeout(this.timeoutID),t)for(var r=0;r<t[e].length;r++){var n=e+t[e][r];0==r?this.canvas.removeEventListener(n,this.begin):removeEventListener(n,2==r?this.end:this.move)}},isInputAllowed:function(e){var t=this.provider;if(e.type.endsWith("down")||e.type.endsWith("start")){if(t||(t=this.getInputProvider(e)),this.inactive.includes(t))return!1;if(t==ae.PointerType.MOUSE&&0!=e.button)return!1;for(var r in this.suppressKeys)if(e[r])return!1}return t==this.getInputProvider(e)},isInputExpected:function(e){var t=!1,r=e.changedTouches?Array.from(e.changedTouches).map((function(e){return e.identifier})):[],n=this.inkController.getInkBuilder(r);return n&&(t=e.type.endsWith("down")||e.type.endsWith("start")?!n.phase:n.phase&&n.phase!=Y.Phase.END),t},getSensorPoint:function(e){var t=void 0,r=e.changedTouches?Array.from(e.changedTouches).map((function(e){return e.identifier})):[],n=this.inkController.getInkBuilder(r);return n&&(t=this.createSensorPoint(e,n.pointerID)),t},createSensorPoint:function(e,t){var r=this.getOffset(e),n={x:r.x,y:r.y,z:void 0,timestamp:Math.floor(e.timeStamp),pressure:void 0,radiusX:void 0,radiusY:void 0,rotation:void 0},i={id:void 0,type:void 0,button:void 0,buttons:void 0};if(Object.defineProperty(n,"phase",{value:Y.Phase[e.type.replace(/pointer|mouse|touch/g,"").replace(/down|start/,"BEGIN").replace(/move/,"UPDATE").replace(/up|end/,"END")],enumerable:!0}),Object.defineProperty(n,"pointer",{value:i,enumerable:!0}),Object.defineProperty(n.pointer,"provider",{get:function(){return G.Type[this.type.toUpperCase()]},enumerable:!0}),e instanceof MouseEvent)i.type=ae.PointerType.MOUSE,i.button=e.button,i.buttons=e.buttons;else{if(!(e instanceof TouchEvent))throw new Error("Unexpected event detected: ".concat(e.constructor.name,". Expected event should be instance of MouseEvent or TouchEvent."));if(isNaN(t))throw new Error("pointerID is required for touch event");if(!(e=Array.from(e.changedTouches).filter((function(e){return e.identifier==t})).first))return null;isNaN(n.x)&&(n.x=e.offsetX||e.clientX),isNaN(n.y)&&(n.y=e.offsetY||e.clientY),i.id=e.identifier,i.type=ae.PointerType.TOUCH,n.pressure=e.force,n.radiusX=e.radiusX,n.radiusY=e.radiusY,n.rotation=Math.toRadians(e.rotationAngle)}return n},getOffset:function(e){if(e.changedTouches){var t=Array.from(e.changedTouches).map((function(e){return e.identifier})),r=this.inkController.getInkBuilder(t);e=r.pointerID!=e.changedTouches.item(0).identifier?Array.from(e.changedTouches).filter((function(e){return e.identifier==r.pointerID})).first:e.changedTouches.item(0)}var n=this.canvas.offsetParent;if(!n)return{x:0,y:0};"flex"==n.getStyle("display")&&(n=this.canvas);var i=this.inkController.transform,o=this.canvas.getStyle("transform");"none"==o?o=n.getStyle("transform"):n=this.canvas,o="none"==o?null:Q.fromMatrix(o);var a=X.fromPoint({x:e.clientX,y:e.clientY}),s=n.getBoundingClientRect();if(o){var u=o.invert();a=a.transform(u),s=V.fromRect(s).transform(u)}var c={x:a.x-s.x,y:a.y-s.y};return i&&(c=X.fromPoint(c).transform(i.invert())),c},getInputProvider:function(e){return e.type.replace(/down|start|move|up|end/g,"")},begin:function(e){if(this.logSampleInput(e),!(e instanceof MouseEvent&&0!=e.button)&&this.isInputAllowed(e)){if(e instanceof TouchEvent){var t=Array.from(e.changedTouches).map((function(e){return e.identifier}));this.inkController.registerInputProvider(t)}if(this.isInputExpected(e)){this.provider||(this.provider=this.getInputProvider(e));var r=this.getSensorPoint(e);r&&this.inkController.begin(r,e)}}},move:function(e){if(this.isInputAllowed(e)&&this.isInputExpected(e)){this.logSampleInput(e);var t=this.getSensorPoint(e);t&&this.inkController.move(t,void 0,e)}},end:function(e){var t=this;if(this.isInputAllowed(e)&&this.isInputExpected(e)){this.logSampleInput(e);var r=this.getSensorPoint(e);r&&(this.inkController.end(r,e),e instanceof MouseEvent||this.inactive.includes(ae.PointerType.MOUSE)||(this.stop(ae.PointerType.MOUSE),this.timeoutID=setTimeout((function(){return t.start(ae.PointerType.MOUSE)}),500))),e.touches&&0!=e.touches.length||delete this.provider}},abort:function(e){if(delete this.provider,this.inkController.abort)if(e instanceof TouchEvent){var t=Array.from(e.changedTouches).map((function(e){return e.identifier}));this.inkController.abort(t)}else this.inkController.abort()},logSampleInput:function(e){if(this.debug){var t=e.type.endsWith("move"),r="mouseup"==e.type||"touchend"==e.type;t&&!this.debug.move||r&&!this.debug.end||(r&&this.table.length>0&&(console.log(this.table.toString()),this.table.clear()),this.table||(this.table=new ne(["type","id","pointerType","x","y","pressure","radius","rotation","timestamp"])),this.table.insert({type:e.type,id:e.changedTouches?e.changedTouches[0].identifier:void 0,pointerType:this.getInputProvider(e),x:e.changedTouches?e.changedTouches[0].clientX.toFixed(2):e.clientX,y:e.changedTouches?e.changedTouches[0].clientY.toFixed(2):e.clientY,pressure:e.changedTouches?e.changedTouches[0].force.toFixed(2):void 0,radius:e.changedTouches?e.changedTouches[0].radiusX.toFixed(2)+" / "+e.changedTouches[0].radiusY.toFixed(2):void 0,rotation:e.changedTouches?e.changedTouches[0].rotationAngle:e.twist,timestamp:e.timeStamp.toFixed(8)}),t||(console.log(this.table.toString()),this.table.clear()))}},PointerType:{MOUSE:"mouse",TOUCH:"touch"}},se={inactive:[],suppressKeys:{ctrlKey:!0,altKey:!0,shiftKey:!0,metaKey:!0},open:function(e){if(!(e instanceof x))throw new Error("Argument doesn't implement InkController interface");this.inkController=e,this.canvas=e.canvas.surface,this.mounted||(this.mounted=!0,this.begin=this.begin.bind(this),this.move=this.move.bind(this),this.end=this.end.bind(this),this.abort=this.abort.bind(this)),addEventListener("pointercancel",this.abort),this.attachResize(),this.start()},reset:function(e){this.canvas.removeEventListener("pointerdown",this.begin),e.canvas.surface.addEventListener("pointerdown",this.begin),this.dettachResize(),this.inkController=e,this.canvas=e.canvas.surface,this.attachResize()},close:function(){this.stop(),this.dettachResize(),removeEventListener("pointercancel",this.abort),delete this.canvas,delete this.inkController},start:function(e){e?this.inactive.remove(e):(this.canvas.addEventListener("pointerdown",this.begin),addEventListener("pointermove",this.move),addEventListener("pointerup",this.end))},stop:function(e){e?this.inactive.includes(e)||this.inactive.push(e):(this.canvas.removeEventListener("pointerdown",this.begin),removeEventListener("pointermove",this.move),removeEventListener("pointerup",this.end))},attachResize:function(){var e=this;if(this.inkController.resize!=x.prototype.resize){var t,r=se.ResizeReason.WINDOW,n=devicePixelRatio,i=screen.width;matchMedia("screen and (orientation: portrait)").addListener((function(e){r=se.ResizeReason.ORIENTATION,i=screen.width})),function e(){t&&(t.removeListener(e),r=n<devicePixelRatio?se.ResizeReason.ZOOM_IN:se.ResizeReason.ZOOM_OUT,n=devicePixelRatio),(t=matchMedia("(resolution: ".concat(devicePixelRatio,"dppx)"))).addListener(e)}(),this.resize=re.debounce((function(){r==se.ResizeReason.WINDOW&&i!=screen.width&&(r=i<screen.width?se.ResizeReason.SCREEN_SIZE_INCREASED:se.ResizeReason.SCREEN_SIZE_DECREASED,i=screen.width),e.inkController.resize(r),r=se.ResizeReason.WINDOW}),200),addEventListener("resize",this.resize)}},dettachResize:function(){this.inkController.resize!=x.prototype.resize&&removeEventListener("resize",this.resize)},isInputAllowed:function(e){if("pointerdown"!=e.type)return!0;var t=this.provider;if(t||(t=this.getInputProvider(e)),this.inactive.includes(t))return!1;if(t==se.PointerType.MOUSE){if(0!=e.button)return!1}else if(t==se.PointerType.PEN&&0==e.pressure)return!1;for(var r in this.suppressKeys)if(e[r])return!1;return!0},isInputExpected:function(e){var t=!1,r=this.inkController.getInkBuilder(e.pointerId);return r&&(t="pointerdown"==e.type?!r.phase:r.phase&&r.phase!=Y.Phase.END),t},getSensorPoint:function(e){var t=void 0,r=this.inkController.getInkBuilder(e.pointerId);if(r){if(e.pointerId!=r.pointerID)throw new Error("Create sensor point failed, expected pointer with id: ".concat(r.pointerID,", found: ").concat(e.pointerId));if("pointerdown"==e.type){var n=this.getInputProvider(e);e.pointerType!=n?r.pointerType=n:delete r.pointerType}t=this.createSensorPoint(e,r.pointerType)}return t},createSensorPoint:function(e,t,r){var n=this;if(!(e instanceof PointerEvent))throw new Error("Unexpected event detected: ".concat(e.constructor.name,". Expected event should be instance of PointerEvent."));var i,o=this.getOffset(e),a={x:o.x,y:o.y,z:void 0,timestamp:Math.floor(e.timeStamp),pressure:void 0,radiusX:void 0,radiusY:void 0,tiltX:void 0,tiltY:void 0,rotation:void 0};if(r?(Object.defineProperty(a,"phase",{value:r.phase,enumerable:!0}),i=r.pointer):(Object.defineProperty(a,"phase",{value:Y.Phase[e.type.replace(/pointer|mouse|touch/g,"").replace(/down|start/,"BEGIN").replace(/move/,"UPDATE").replace(/up|end/,"END")],enumerable:!0}),i={id:e.pointerId,type:t||e.pointerType,button:void 0,buttons:void 0},Object.defineProperty(i,"provider",{get:function(){return G.Type[this.type.toUpperCase()]},enumerable:!0}),"pen"!=i.type&&"mouse"!=i.type||(i.button=e.button,i.buttons=e.buttons)),Object.defineProperty(a,"pointer",{value:i,enumerable:!0}),"pen"!=i.type&&"touch"!=i.type||(a.pressure=e.pressure,a.rotation=Math.toRadians(e.twist)),"pen"==i.type?(a.tiltX=e.tiltX,a.tiltY=e.tiltY):"touch"==i.type&&(a.radiusX=e.width/2,a.radiusY=e.height/2),!r){if(e.getPredictedEvents){var s,u=e.getPredictedEvents();if(u.length>0)Object.defineProperty(a,"predicted",{get:function(){return s||(s=u.map((function(e){return n.createSensorPoint(e,t,a)}))),s},enumerable:!0})}if("pen"==i.type&&e.getCoalescedEvents){var c,l=e.getCoalescedEvents();if(l.length>1)Object.defineProperty(a,"coalesced",{get:function(){return c||(c=l.map((function(e){return n.createSensorPoint(e,t,a)}))),c},enumerable:!0})}}return a},getOffset:function(e){var t=this.canvas.offsetParent;if(!t)return{x:0,y:0};"flex"==t.getStyle("display")&&(t=this.canvas);var r=this.inkController.transform,n=this.canvas.getStyle("transform");"none"==n?n=t.getStyle("transform"):t=this.canvas,n="none"==n?null:Q.fromMatrix(n);var i=X.fromPoint({x:e.clientX,y:e.clientY}),o=t.getBoundingClientRect();if(n){var a=n.invert();i=i.transform(a),o=V.fromRect(o).transform(a)}var s={x:i.x-o.x,y:i.y-o.y};return r&&(s=X.fromPoint(s).transform(r.invert())),s},getInputProvider:function(e){return e.pointerType==se.PointerType.MOUSE&&e.pressure>0&&.5!==e.pressure?se.PointerType.PEN:e.pointerType},begin:function(e){if(this.logSampleInput(e),this.isInputAllowed(e)&&(this.inkController.registerInputProvider(e.pointerId,e.isPrimary),this.isInputExpected(e))){this.provider||(this.provider=this.getInputProvider(e));var t=this.getSensorPoint(e);t&&this.inkController.begin(t,e)}},move:function(e){if(this.isInputAllowed(e)&&this.isInputExpected(e)){this.logSampleInput(e);var t=this.getSensorPoint(e);if(t){var r;if(this.inkController.getInkBuilder(e.pointerId).prediction&&e.getPredictedEvents){var n=e.getPredictedEvents();n.length>0&&(r=this.createSensorPoint(n.last,t.pointer.type,t))}this.inkController.move(t,r,e)}}},end:function(e){if(this.isInputAllowed(e)&&this.isInputExpected(e)){this.logSampleInput(e);var t=this.getSensorPoint(e);t&&this.inkController.end(t,e),delete this.provider}},abort:function(e){delete this.provider,this.inkController.abort&&this.inkController.abort(e.pointerId)},logSampleInput:function(e){this.debug&&(this.debug.move||this.debug.end)&&("pointermove"!=e.type||this.debug.move)&&("pointerup"!=e.type||this.debug.end)&&(e.pointerType!=this.getInputProvider(e)&&(e.pen=!0),"pointerup"==e.type&&this.table.length>0&&(console.log(this.table.toString()),this.table.clear()),this.table||(this.table=new ne(["type","id","pointerType","x","y","pressure","radius","tilt","rotation","timestamp"])),this.table.insert({type:e.type,id:e.pointerId,pointerType:e.pen?"".concat(e.pointerType," / pen"):e.pointerType,x:e.clientX.toFixed(2),y:e.clientY.toFixed(2),pressure:e.pressure.toFixed(2),radius:(e.width/2).toFixed(2)+" / "+(e.height/2).toFixed(2),rotation:e.twist,tilt:isFinite(e.tiltX)?e.tiltX+" / "+e.tiltY:"",timestamp:e.timeStamp.toFixed(8)}),"pointermove"!=e.type&&(console.log(this.table.toString()),this.table.clear()))},PointerType:{PEN:"pen",MOUSE:"mouse",TOUCH:"touch"}};Object.defineEnum(se,"ResizeReason",["WINDOW","ZOOM_IN","ZOOM_OUT","SCREEN_SIZE_INCREASED","SCREEN_SIZE_DECREASED","ORIENTATION"]),"object"===("undefined"==typeof window?"undefined":E(window))&&"undefined"==typeof PointerEvent&&(ae.suppressKeys=se.suppressKeys,ae.ResizeReason=se.ResizeReason,ae.attachResize=se.attachResize,ae.dettachResize=se.dettachResize,se=ae);var ue=se;function ce(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var r,n=O(e);if(t){var i=O(this).constructor;r=Reflect.construct(n,arguments,i)}else r=n.apply(this,arguments);return A(this,r)}}var le=function(e){R(r,e);var t=ce(r);function r(e,n,i){var o,a=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{};return P(this,r),(o=t.call(this,e,n,i)).red=a.red,o.green=a.green,o.blue=a.blue,o.alpha=a.alpha,o.size=a.size||r.defaults.size,o.rotation=a.rotation||r.defaults.rotation,o.scaleX=a.scaleX||r.defaults.scaleX,o.scaleY=a.scaleY||r.defaults.scaleY,o.scaleZ=isFinite(i)?a.scaleZ||r.defaults.scaleZ:void 0,o.offsetX=a.offsetX||r.defaults.offsetX,o.offsetY=a.offsetY||r.defaults.offsetY,o.offsetZ=isFinite(i)?a.offsetZ||r.defaults.offsetZ:void 0,o.dX,o.dY,o}return w(r,[{key:"fill",value:function(e,t,n){var i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{},o={},a=e*n.length;n.forEach((function(e,n){return r.setProperty(o,e,t[a+n])})),this.x=o.x,this.y=o.y,this.z=o.z,this.red=isFinite(o.red)?o.red:i.red,this.green=isFinite(o.green)?o.green:i.green,this.blue=isFinite(o.blue)?o.blue:i.blue,this.alpha=isFinite(o.alpha)?o.alpha:i.alpha,this.size=o.size||i.size||r.defaults.size,this.rotation=o.rotation||i.rotation||r.defaults.rotation,this.scaleX=o.scaleX||i.scaleX||r.defaults.scaleX,this.scaleY=o.scaleY||i.scaleY||r.defaults.scaleY,this.scaleZ=isFinite(o.z)?o.scaleZ||i.scaleZ||r.defaults.scaleZ:void 0,this.offsetX=o.offsetX||i.offsetX||r.defaults.offsetX,this.offsetY=o.offsetY||i.offsetY||r.defaults.offsetY,this.offsetZ=isFinite(o.z)?o.offsetZ||i.offsetZ||r.defaults.offsetZ:void 0,this.dX=o.dX,this.dY=o.dY}},{key:"getProperty",value:function(e){switch(e){case r.Property.X:return this.x;case r.Property.Y:return this.y;case r.Property.Z:return this.z;case r.Property.RED:return this.red;case r.Property.GREEN:return this.green;case r.Property.BLUE:return this.blue;case r.Property.ALPHA:return this.alpha;case r.Property.SIZE:return this.size;case r.Property.ROTATION:return this.rotation;case r.Property.SCALE_X:return this.scaleX;case r.Property.SCALE_Y:return this.scaleY;case r.Property.SCALE_Z:return this.scaleZ;case r.Property.OFFSET_X:return this.offsetX;case r.Property.OFFSET_Y:return this.offsetY;case r.Property.OFFSET_Z:return this.offsetZ;case r.Property.D_X:return this.dX;case r.Property.D_Y:return this.dY;default:throw console.warn(e),new Error("Invalid property found")}}},{key:"setProperty",value:function(e,t){r.setProperty(this,e,t)}},{key:"transform",value:function(e){if(!(e instanceof Q))throw new Error("matrix is instance of ".concat(e.constructor.name," - it should be instance of Matrix. Use Matrix.fromMatrix method to convert."));var t=e.scaleX,r=e.rotation;this.transformSelf(e),this.size*=t,this.rotation+=r,this.scaleX*=t,this.scaleY*=t,isFinite(this.z)&&(this.scaleZ*=t),this.offsetX*=t,this.offsetY*=t,isFinite(this.z)&&(this.offsetZ*=t)}},{key:"toArray",value:function(e){var t=this;return e.map((function(e){var r=t.getProperty(e);if(null==r||isNaN(r))throw new Error("Property ".concat(e.name," has invalid value ").concat(r));return r}))}},{key:"toJSON",value:function(){var e=this,t={};return r.Property.values.forEach((function(r){var n=e.getProperty(r);null!=n&&isFinite(n)&&(t[r.name]=e.getProperty(r))})),t}}],[{key:"createInstance",value:function(e,t,n){var i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0,o=new r(0,0,e.includes(r.Property.Z)?0:void 0);return n&&o.fill(i,n,e,t),o}},{key:"setProperty",value:function(e,t,n){switch(t){case r.Property.X:e.x=n;break;case r.Property.Y:e.y=n;break;case r.Property.Z:e.z=n;break;case r.Property.RED:e.red=n;break;case r.Property.GREEN:e.green=n;break;case r.Property.BLUE:e.blue=n;break;case r.Property.ALPHA:e.alpha=n;break;case r.Property.SIZE:e.size=n;break;case r.Property.ROTATION:e.rotation=n;break;case r.Property.SCALE_X:e.scaleX=n;break;case r.Property.SCALE_Y:e.scaleY=n;break;case r.Property.SCALE_Z:e.scaleZ=n;break;case r.Property.OFFSET_X:e.offsetX=n;break;case r.Property.OFFSET_Y:e.offsetY=n;break;case r.Property.OFFSET_Z:e.offsetZ=n;break;case r.Property.D_X:e.dX=n;break;case r.Property.D_Y:e.dY=n;break;default:throw console.warn(t),new Error("Invalid property found")}}}]),r}(X);function he(e,t,r,n,i,o,a){try{var s=e[o](a),u=s.value}catch(e){return void r(e)}s.done?t(u):Promise.resolve(u).then(n,i)}function fe(e){return function(){var t=this,r=arguments;return new Promise((function(n,i){var o=e.apply(t,r);function a(e){he(o,n,i,a,s,"next",e)}function s(e){he(o,n,i,a,s,"throw",e)}a(void 0)}))}}S(le,"defaults",{size:1,rotation:0,scaleX:1,scaleY:1,scaleZ:1,offsetX:0,offsetY:0,offsetZ:0}),Object.defineEnum(le,"Property",["X","Y","Z","RED","GREEN","BLUE","ALPHA","SIZE","ROTATION","SCALE_X","SCALE_Y","SCALE_Z","OFFSET_X","OFFSET_Y","OFFSET_Z","D_X","D_Y"]);var de={exports:{}};!function(e){var t=function(e){var t,r=Object.prototype,n=r.hasOwnProperty,i="function"==typeof Symbol?Symbol:{},o=i.iterator||"@@iterator",a=i.asyncIterator||"@@asyncIterator",s=i.toStringTag||"@@toStringTag";function u(e,t,r){return Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}),e[t]}try{u({},"")}catch(e){u=function(e,t,r){return e[t]=r}}function c(e,t,r,n){var i=t&&t.prototype instanceof v?t:v,o=Object.create(i.prototype),a=new T(n||[]);return o._invoke=function(e,t,r){var n=h;return function(i,o){if(n===d)throw new Error("Generator is already running");if(n===p){if("throw"===i)throw o;return O()}for(r.method=i,r.arg=o;;){var a=r.delegate;if(a){var s=S(a,r);if(s){if(s===y)continue;return s}}if("next"===r.method)r.sent=r._sent=r.arg;else if("throw"===r.method){if(n===h)throw n=p,r.arg;r.dispatchException(r.arg)}else"return"===r.method&&r.abrupt("return",r.arg);n=d;var u=l(e,t,r);if("normal"===u.type){if(n=r.done?p:f,u.arg===y)continue;return{value:u.arg,done:r.done}}"throw"===u.type&&(n=p,r.method="throw",r.arg=u.arg)}}}(e,r,a),o}function l(e,t,r){try{return{type:"normal",arg:e.call(t,r)}}catch(e){return{type:"throw",arg:e}}}e.wrap=c;var h="suspendedStart",f="suspendedYield",d="executing",p="completed",y={};function v(){}function m(){}function g(){}var b={};u(b,o,(function(){return this}));var E=Object.getPrototypeOf,P=E&&E(E(A([])));P&&P!==r&&n.call(P,o)&&(b=P);var k=g.prototype=v.prototype=Object.create(b);function w(e){["next","throw","return"].forEach((function(t){u(e,t,(function(e){return this._invoke(t,e)}))}))}function x(e,t){function r(i,o,a,s){var u=l(e[i],e,o);if("throw"!==u.type){var c=u.arg,h=c.value;return h&&"object"==typeof h&&n.call(h,"__await")?t.resolve(h.__await).then((function(e){r("next",e,a,s)}),(function(e){r("throw",e,a,s)})):t.resolve(h).then((function(e){c.value=e,a(c)}),(function(e){return r("throw",e,a,s)}))}s(u.arg)}var i;this._invoke=function(e,n){function o(){return new t((function(t,i){r(e,n,t,i)}))}return i=i?i.then(o,o):o()}}function S(e,r){var n=e.iterator[r.method];if(n===t){if(r.delegate=null,"throw"===r.method){if(e.iterator.return&&(r.method="return",r.arg=t,S(e,r),"throw"===r.method))return y;r.method="throw",r.arg=new TypeError("The iterator does not provide a 'throw' method")}return y}var i=l(n,e.iterator,r.arg);if("throw"===i.type)return r.method="throw",r.arg=i.arg,r.delegate=null,y;var o=i.arg;return o?o.done?(r[e.resultName]=o.value,r.next=e.nextLoc,"return"!==r.method&&(r.method="next",r.arg=t),r.delegate=null,y):o:(r.method="throw",r.arg=new TypeError("iterator result is not an object"),r.delegate=null,y)}function I(e){var t={tryLoc:e[0]};1 in e&&(t.catchLoc=e[1]),2 in e&&(t.finallyLoc=e[2],t.afterLoc=e[3]),this.tryEntries.push(t)}function R(e){var t=e.completion||{};t.type="normal",delete t.arg,e.completion=t}function T(e){this.tryEntries=[{tryLoc:"root"}],e.forEach(I,this),this.reset(!0)}function A(e){if(e){var r=e[o];if(r)return r.call(e);if("function"==typeof e.next)return e;if(!isNaN(e.length)){var i=-1,a=function r(){for(;++i<e.length;)if(n.call(e,i))return r.value=e[i],r.done=!1,r;return r.value=t,r.done=!0,r};return a.next=a}}return{next:O}}function O(){return{value:t,done:!0}}return m.prototype=g,u(k,"constructor",g),u(g,"constructor",m),m.displayName=u(g,s,"GeneratorFunction"),e.isGeneratorFunction=function(e){var t="function"==typeof e&&e.constructor;return!!t&&(t===m||"GeneratorFunction"===(t.displayName||t.name))},e.mark=function(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,g):(e.__proto__=g,u(e,s,"GeneratorFunction")),e.prototype=Object.create(k),e},e.awrap=function(e){return{__await:e}},w(x.prototype),u(x.prototype,a,(function(){return this})),e.AsyncIterator=x,e.async=function(t,r,n,i,o){void 0===o&&(o=Promise);var a=new x(c(t,r,n,i),o);return e.isGeneratorFunction(r)?a:a.next().then((function(e){return e.done?e.value:a.next()}))},w(k),u(k,s,"Generator"),u(k,o,(function(){return this})),u(k,"toString",(function(){return"[object Generator]"})),e.keys=function(e){var t=[];for(var r in e)t.push(r);return t.reverse(),function r(){for(;t.length;){var n=t.pop();if(n in e)return r.value=n,r.done=!1,r}return r.done=!0,r}},e.values=A,T.prototype={constructor:T,reset:function(e){if(this.prev=0,this.next=0,this.sent=this._sent=t,this.done=!1,this.delegate=null,this.method="next",this.arg=t,this.tryEntries.forEach(R),!e)for(var r in this)"t"===r.charAt(0)&&n.call(this,r)&&!isNaN(+r.slice(1))&&(this[r]=t)},stop:function(){this.done=!0;var e=this.tryEntries[0].completion;if("throw"===e.type)throw e.arg;return this.rval},dispatchException:function(e){if(this.done)throw e;var r=this;function i(n,i){return s.type="throw",s.arg=e,r.next=n,i&&(r.method="next",r.arg=t),!!i}for(var o=this.tryEntries.length-1;o>=0;--o){var a=this.tryEntries[o],s=a.completion;if("root"===a.tryLoc)return i("end");if(a.tryLoc<=this.prev){var u=n.call(a,"catchLoc"),c=n.call(a,"finallyLoc");if(u&&c){if(this.prev<a.catchLoc)return i(a.catchLoc,!0);if(this.prev<a.finallyLoc)return i(a.finallyLoc)}else if(u){if(this.prev<a.catchLoc)return i(a.catchLoc,!0)}else{if(!c)throw new Error("try statement without catch or finally");if(this.prev<a.finallyLoc)return i(a.finallyLoc)}}}},abrupt:function(e,t){for(var r=this.tryEntries.length-1;r>=0;--r){var i=this.tryEntries[r];if(i.tryLoc<=this.prev&&n.call(i,"finallyLoc")&&this.prev<i.finallyLoc){var o=i;break}}o&&("break"===e||"continue"===e)&&o.tryLoc<=t&&t<=o.finallyLoc&&(o=null);var a=o?o.completion:{};return a.type=e,a.arg=t,o?(this.method="next",this.next=o.finallyLoc,y):this.complete(a)},complete:function(e,t){if("throw"===e.type)throw e.arg;return"break"===e.type||"continue"===e.type?this.next=e.arg:"return"===e.type?(this.rval=this.arg=e.arg,this.method="return",this.next="end"):"normal"===e.type&&t&&(this.next=t),y},finish:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var r=this.tryEntries[t];if(r.finallyLoc===e)return this.complete(r.completion,r.afterLoc),R(r),y}},catch:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var r=this.tryEntries[t];if(r.tryLoc===e){var n=r.completion;if("throw"===n.type){var i=n.arg;R(r)}return i}}throw new Error("illegal catch attempt")},delegateYield:function(e,r,n){return this.delegate={iterator:A(e),resultName:r,nextLoc:n},"next"===this.method&&(this.arg=t),y}},e}(e.exports);try{regeneratorRuntime=t}catch(e){"object"==typeof globalThis?globalThis.regeneratorRuntime=t:Function("r","regeneratorRuntime = r")(t)}}(de);var pe=de.exports,ye="1.4.2";Object.defineProperty(globalThis,"DIGITAL_INK_ENV",{value:"AUTO",enumerable:!0,configurable:!0});var ve={version:ye};Object.defineEnum(ve,"Type",["WEB","WORKER","NODE","SHELL"]),Object.defineEnum(ve,"Type2D",["SCREEN","OFFSCREEN"]),Object.defineEnum(ve,"TypeGL",["WEB","STACK"]),function(e){var t,r="BROWSER"!=DIGITAL_INK_ENV&&"object"===("undefined"==typeof process?"undefined":E(process))&&"function"==typeof require;t="object"===("undefined"==typeof window?"undefined":E(window))?"WEB":"function"==typeof importScripts?"WORKER":r?"NODE":"SHELL";var n="undefined"==typeof OffscreenCanvas?"OFFSCREEN":"SCREEN",i="undefined"==typeof WebGLRenderingContext?"STACK":"WEB";Object.defineProperty(ve,"commonJS",{value:r,enumerable:!0}),Object.defineProperty(ve,"type",{value:ve.Type[t],enumerable:!0}),Object.defineProperty(ve,"type2D",{value:ve.Type2D[n],enumerable:!0}),Object.defineProperty(ve,"typeGL",{value:ve.TypeGL[i],enumerable:!0})}();var me=void 0;ve.commonJS&&(me=require("systeminformation"));var ge=me;function be(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var r,n=O(e);if(t){var i=O(this).constructor;r=Reflect.construct(n,arguments,i)}else r=n.apply(this,arguments);return A(this,r)}}var Ee=function(e){R(n,e);var t,r=be(n);function n(){var e;return P(this,n),(e=r.call(this)).props={},e}return w(n,[{key:"getMD5Message",value:function(){if(!Object.isFrozen(this))throw new Error("ID generation failed. Environment do not belongs to any InputContext yet");return["Environment",U.buildMD5Tokens(this.props)]}}],[{key:"createInstance",value:(t=fe(pe.mark((function e(){var t,r,i,o=arguments;return pe.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t=o.length>0&&void 0!==o[0]?o[0]:{},(r=new n).props["env.name"]=ve.type.name,void 0!==ge){e.next=7;break}r.props["user.agent"]=navigator.userAgent,e.next=15;break;case 7:return e.next=9,ge.osInfo();case 9:i=e.sent,r.props["os.id"]=i.serial.toLowerCase(),r.props["os.name"]=i.codename,r.props["os.version"]=i.release,r.props["os.build"]=i.build,r.props["os.platform"]="".concat(i.distro," (").concat(i.platform," ").concat(i.arch,")");case 15:return Object.keys(t).forEach((function(e){return r.props[e]=t[e]})),e.abrupt("return",r);case 17:case"end":return e.stop()}}),e)}))),function(){return t.apply(this,arguments)})}]),n}(U);function Pe(e,t){var r="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!r){if(Array.isArray(e)||(r=function(e,t){if(!e)return;if("string"==typeof e)return ke(e,t);var r=Object.prototype.toString.call(e).slice(8,-1);"Object"===r&&e.constructor&&(r=e.constructor.name);if("Map"===r||"Set"===r)return Array.from(e);if("Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r))return ke(e,t)}(e))||t&&e&&"number"==typeof e.length){r&&(e=r);var n=0,i=function(){};return{s:i,n:function(){return n>=e.length?{done:!0}:{done:!1,value:e[n++]}},e:function(e){throw e},f:i}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var o,a=!0,s=!1;return{s:function(){r=r.call(e)},n:function(){var e=r.next();return a=e.done,e},e:function(e){s=!0,o=e},f:function(){try{a||null==r.return||r.return()}finally{if(s)throw o}}}}function ke(e,t){(null==t||t>e.length)&&(t=e.length);for(var r=0,n=new Array(t);r<t;r++)n[r]=e[r];return n}var we={DP:160,PICA:6,POINT:72,DIP:96,DPI:96*("undefined"==typeof window?1:window.devicePixelRatio)},xe=function(){function e(){P(this,e)}return w(e,null,[{key:"getChannelResolution",value:function(t){var r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1,n=1,i=e.getUnitMetric(t);return i!=e.Metric.NORMALIZED&&i!=e.Metric.LOGICAL&&(n=e[Se[i.name].name][t.name]/r),n}},{key:"convert",value:function(t,r,n,i){return r?n*e[Se[t.name].name][i.name]/r:n}},{key:"convertAny",value:function(t,r,n,i){return t*e[r.name][n.name]/i}},{key:"getUnitMetric",value:function(t){switch(t){case e.Unit.METER:case e.Unit.CENTIMETER:case e.Unit.MILLIMETER:case e.Unit.MICROMETER:case e.Unit.INCH:case e.Unit.DP:case e.Unit.PICA:case e.Unit.POINT:case e.Unit.DIP:case e.Unit.DPI:return e.Metric.LENGTH;case e.Unit.SECOND:case e.Unit.MILLISECOND:case e.Unit.MICROSECOND:case e.Unit.NANOSECOND:return e.Metric.TIME;case e.Unit.RADIAN:case e.Unit.DEGREE:return e.Metric.ANGLE;case e.Unit.NEWTON:return e.Metric.FORCE;case e.Unit.NORMALIZED:return e.Metric.NORMALIZED;case e.Unit.LOGICAL:return e.Metric.LOGICAL;default:throw console.warn(t),new Error("Invalid unit found")}}},{key:"getMetricUnits",value:function(t){switch(t){case e.Metric.LENGTH:return[e.Unit.METER,e.Unit.CENTIMETER,e.Unit.MILLIMETER,e.Unit.MICROMETER,e.Unit.INCH,e.Unit.DP,e.Unit.PICA,e.Unit.POINT,e.Unit.DIP,e.Unit.DPI];case e.Metric.TIME:return[e.Unit.SECOND,e.Unit.MILLISECOND,e.Unit.MICROSECOND,e.Unit.NANOSECOND];case e.Metric.ANGLE:return[e.Unit.RADIAN,e.Unit.DEGREE];case e.Metric.FORCE:return[e.Unit.NEWTON];case e.Metric.NORMALIZED:return[e.Unit.NORMALIZED];case e.Metric.LOGICAL:return[e.Unit.LOGICAL];case e.Metric.DIMENSIONLESS:return[];default:throw console.warn(t),new Error("Invalid metric found")}}},{key:"getUnit",value:function(e){return Se[e.name]}},{key:"convertValue",value:function(t,r,n){return t*e[r.name][n.name]}}]),e}();S(xe,"Units",{METER:{METER:1,CENTIMETER:100,MILLIMETER:1e3,MICROMETER:1e6,INCH:39.3700787402},CENTIMETER:{METER:.01,CENTIMETER:1,MILLIMETER:10,MICROMETER:1e4,INCH:.3937007874},MILLIMETER:{METER:.001,CENTIMETER:.1,MILLIMETER:1,MICROMETER:1e3,INCH:.0393700787},MICROMETER:{METER:1e-6,CENTIMETER:1e-4,MILLIMETER:.001,MICROMETER:1,INCH:393701e-10},INCH:{METER:.0254,CENTIMETER:2.54,MILLIMETER:25.4,MICROMETER:25400,INCH:1},SECOND:{SECOND:1,MILLISECOND:1e3,MICROSECOND:1e6,NANOSECOND:1e9},MILLISECOND:{SECOND:.001,MILLISECOND:1,MICROSECOND:1e3,NANOSECOND:1e6},MICROSECOND:{SECOND:1e-6,MILLISECOND:.001,MICROSECOND:1,NANOSECOND:1e3},NANOSECOND:{SECOND:1e-9,MILLISECOND:1e-6,MICROSECOND:.001,NANOSECOND:1},RADIAN:{RADIAN:1,DEGREE:57.2957795},DEGREE:{RADIAN:.0174532925,DEGREE:1},NEWTON:{NEWTON:1}}),Object.defineEnum(xe,"Unit",["METER","CENTIMETER","MILLIMETER","MICROMETER","INCH","DP","PICA","POINT","DIP","DPI","SECOND","MILLISECOND","MICROSECOND","NANOSECOND","RADIAN","DEGREE","NEWTON","NORMALIZED","LOGICAL"]),Object.defineEnum(xe,"Metric",["LENGTH","TIME","FORCE","ANGLE","NORMALIZED","LOGICAL","DIMENSIONLESS"]);var Se=Object.freeze({LENGTH:xe.Unit.METER,TIME:xe.Unit.SECOND,FORCE:xe.Unit.NEWTON,ANGLE:xe.Unit.RADIAN,NORMALIZED:xe.Unit.NORMALIZED,LOGICAL:xe.Unit.LOGICAL});function Ie(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var r,n=O(e);if(t){var i=O(this).constructor;r=Reflect.construct(n,arguments,i)}else r=n.apply(this,arguments);return A(this,r)}}!function(){var e,t=xe.getMetricUnits(xe.Metric.LENGTH).filter((function(e){return!(e.name in we)})),r=Pe(t);try{for(r.s();!(e=r.n()).done;){var n=e.value,i=xe.Units[n.name];for(var o in we)i[o]=i.INCH*we[o]}}catch(e){r.e(e)}finally{r.f()}for(var a in we){var s,u={},c=Pe(t);try{for(c.s();!(s=c.n()).done;){var l=s.value;u[l.name]=xe.Units.INCH[l.name]/we[a]}}catch(e){c.e(e)}finally{c.f()}for(var h in we)u[h]=we[h]/we[a];xe.Units[a]=u}for(var f in xe.Units)xe[f]=xe.Units[f]}(),Object.freeze(xe);var Re=function(e){R(r,e);var t=Ie(r);function r(e,n,i,o,a){var s;if(P(this,r),s=t.call(this),n==r.Metric.DIMENSIONLESS)i=1;else if(isNaN(i)||!n){var u=r.getDefaultUnitDescriptorPerType(e);if(!n){if(!u)throw new Error("metric is required");n=u.metric}if(!i){if(!u)throw new Error("resolution is required");i=xe.getChannelResolution(u.unit)}isNaN(o)&&(o=u.min),isNaN(a)&&(a=u.max)}return s.type=e,s.metric=n,s.resolution=i,s.min=o,s.max=a,e==r.Type.TIMESTAMP?s.precision=0:s.precision=2,Object.defineProperty(T(s),"name",{get:function(){return re.getEnumValueName(this.type.substring(this.type.lastIndexOf("/")+1))}}),s}return w(r,[{key:"getMD5Message",value:function(){if(!this.context)throw new Error("ID generation failed. This channel do not belongs to SensorChannelsContext yet");if(!Object.isFrozen(this.context)&&!Object.isFrozen(this))throw new Error("ID generation failed. Underlying SensorChannelsContext do not belongs to any SensorContext yet");var e=[];return e.push("SensorChannel"),e.push(this.context.inkProvider?this.context.inkProvider.id:""),e.push(this.context.device.id),e.push(this.type),e.push(this.metric.name),e.push(this.resolution.toFixed(4)),e.push((this.min||0).toFixed(4)),e.push((this.max||0).toFixed(4)),e.push(this.precision.toString()),e}}],[{key:"getTypeName",value:function(e){return Object.keys(r.Type).find((function(t){return r.Type[t]==e}))}},{key:"getDefaultUnitDescriptorPerType",value:function(e){var t={};switch(e){case r.Type.X:case r.Type.Y:case r.Type.Z:case r.Type.RADIUS_X:case r.Type.RADIUS_Y:t.unit=xe.Unit.DIP;break;case r.Type.TIMESTAMP:t.unit=xe.Unit.MILLISECOND;break;case r.Type.PRESSURE:t.unit=xe.Unit.NORMALIZED,t.min=0,t.max=1;break;case r.Type.ALTITUDE:case r.Type.AZIMUTH:case r.Type.ROTATION:t.unit=xe.Unit.RADIAN,t.min=0,t.max=2*Math.PI;break;default:t=null}return t.metric=xe.getUnitMetric(t.unit),t}},{key:"createCustomChannel",value:function(e,t,n,i,o,a){var s=new r(e,n,i,o,a);return s.precision=t,s}},{key:"createDefaultInstance",value:function(e,t){var n=r.getDefaultUnitDescriptorPerType(e);n||console.error("SensorChannel: createDefaultInstance failed with ".concat(e," type"));var i=xe.getChannelResolution(n.unit),o=new r(e,n.metric,i,n.min,n.max);return o.unit=n.unit,e!=r.Type.X&&e!=r.Type.Y||t.type!=G.Type.MOUSE||(o.precision=0),o}}]),r}(U);function Te(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var r,n=O(e);if(t){var i=O(this).constructor;r=Reflect.construct(n,arguments,i)}else r=n.apply(this,arguments);return A(this,r)}}Re.defaults=Object.freeze({PEN:["X","Y","TIMESTAMP","PRESSURE","ALTITUDE","AZIMUTH","ROTATION"],TOUCH:["X","Y","TIMESTAMP","PRESSURE","RADIUS_X","RADIUS_Y","ROTATION"],MOUSE:["X","Y","TIMESTAMP"]}),Re.Type={X:"will://input/3.0/channel/X",Y:"will://input/3.0/channel/Y",Z:"will://input/3.0/channel/Z",TIMESTAMP:"will://input/3.0/channel/Timestamp",PRESSURE:"will://input/3.0/channel/Pressure",RADIUS_X:"will://input/3.0/channel/RadiusX",RADIUS_Y:"will://input/3.0/channel/RadiusY",ALTITUDE:"will://input/3.0/channel/Altitude",AZIMUTH:"will://input/3.0/channel/Azimuth",ROTATION:"will://input/3.0/channel/Rotation"},Re.Metric=xe.Metric;var Ae=function(e){R(r,e);var t=Te(r);function r(e,n){var i;P(this,r),(i=t.call(this)).device=e.freeze(),i.inkProvider=Object.freeze(n);var o,a,s=[];return Object.defineProperty(T(i),"channels",{get:function(){return s},set:function(e){var t=this;this.invalidateID(),s=[],e.forEach((function(e){return t.add(e)}))},enumerable:!0}),Object.defineProperty(T(i),"layout",{get:function(){return s.map((function(e){return e.name}))},set:function(e){this.invalidateID(),s=s.filter((function(t){return e.includes(t.name)}))},enumerable:!0}),Object.defineProperty(T(i),"samplingRate",{get:function(){return o},set:function(e){this.invalidateID(),o=e},enumerable:!0}),Object.defineProperty(T(i),"latency",{get:function(){return a},set:function(e){this.invalidateID(),a=e},enumerable:!0}),i}return w(r,[{key:"getMD5Message",value:function(){if(!Object.isFrozen(this))throw new Error("ID generation failed. SensorChannelsContext do not belongs to any SensorContext yet");var e=["SensorChannelsContext"].concat(te(this.channels.map((function(e){return e.id}))));return e.push(this.samplingRate||""),e.push(this.latency||""),e.push(this.inkProvider?this.inkProvider.id:""),e.push(this.device.id),e}},{key:"add",value:function(e){if((e.type==Re.Type.X||e.type==Re.Type.Y)&&!this.inkProvider)throw new Error("inkProvider is not found. Required for ink group.");e.context=this,Object.freeze(e),this.channels.push(e)}},{key:"get",value:function(e){return this.channels.filter((function(t){return t.id==e})).first}}],[{key:"createDefaultInstance",value:function(e,t){var n=new r(e,t);return n.channels=Re.defaults[t.type.name].map((function(e){return Re.createDefaultInstance(Re.Type[e],t)})),n}}]),r}(U);function Oe(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var r,n=O(e);if(t){var i=O(this).constructor;r=Reflect.construct(n,arguments,i)}else r=n.apply(this,arguments);return A(this,r)}}var Ce=function(e){R(r,e);var t=Oe(r);function r(){var e;P(this,r),e=t.call(this);var n=[];return Object.defineProperty(T(e),"channelsContexts",{get:function(){return n},set:function(e){this.invalidateID(),n=e},enumerable:!0}),e}return w(r,[{key:"getMD5Message",value:function(){if(!Object.isFrozen(this))throw new Error("ID generation failed. SensorContext do not belongs to any InputContext yet");return["SensorContext"].concat(te(this.channelsContexts.map((function(e){return e.id}))))}},{key:"addContext",value:function(e){if(!this.channelsContexts.includes(e)){if(this.channelsContexts.some((function(t){return t.device==e.device})))throw new Error("Already exists channelsContext with device ".concat(e.device.id,". Device should be unique in the scope of SensorContext."));e.inkProvider&&(this.inkChannelsContext=e),Object.freeze(e),this.channelsContexts.push(e)}}},{key:"getContext",value:function(e){return this.channelsContexts.find((function(t){return t.id==e}))}},{key:"getContextByChannelID",value:function(e){return this.channelsContexts.find((function(t){return t.get(e)}))}}],[{key:"createDefaultInstance",value:function(e,t){var n=new r;return n.addContext(Ae.createDefaultInstance(e,t)),n}}]),r}(U);function De(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var r,n=O(e);if(t){var i=O(this).constructor;r=Reflect.construct(n,arguments,i)}else r=n.apply(this,arguments);return A(this,r)}}var Ne=function(e){R(r,e);var t=De(r);function r(e,n){var i;return P(this,r),(i=t.call(this)).environment=Object.freeze(e),i.sensorContext=Object.freeze(n),i}return w(r,[{key:"getMD5Message",value:function(){return["InputContext",this.environment.id,this.sensorContext.id]}},{key:"addChannelsContext",value:function(e){this.sensorContext.addContext(e)}}],[{key:"createDefaultInstance",value:function(e,t,n){return new r(e,Ce.createDefaultInstance(t,n))}}]),r}(U),Me=function(){function e(){P(this,e)}return w(e,null,[{key:"createTreeURI",value:function(e,t){return"uim:tree/".concat(t?"".concat(t,"/"):"").concat(e)}},{key:"createStrokeURI",value:function(e,t){return"uim:stroke/".concat(t?"".concat(t,"/"):"").concat(e)}},{key:"createSensorDataURI",value:function(e,t){return"uim:sensor/".concat(t?"".concat(t,"/"):"").concat(e)}},{key:"createNodeURI",value:function(t,r,n){if(!t)throw new Error("inkTree is required");var i="";return n&&(i="#frag=".concat(n.fromPointIndex,",").concat(n.toPointIndex),0==n.fromTValue&&1==n.toTValue||(i+=",".concat(n.fromTValue.toFixed(5),",").concat(n.toTValue.toFixed(5)))),"".concat(e.createNodeURISchema(t),"/").concat(r).concat(i)}},{key:"createNodeURISchema",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:e.name;return"uim:node".concat(e.id?"/".concat(e.id):"","/").concat(t)}},{key:"createNamedEntityURI",value:function(e,t){return"uim:ne/".concat(t?"".concat(t,"/"):"").concat(e)}}]),e}();function Le(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var r,n=O(e);if(t){var i=O(this).constructor;r=Reflect.construct(n,arguments,i)}else r=n.apply(this,arguments);return A(this,r)}}var Be=function(e){R(r,e);var t=Le(r);function r(e,n){var i,o;return P(this,r),i=t.call(this,n),Object.defineProperty(T(i),"uri",{get:function(){return o||(o=Me.createSensorDataURI(i.id)),o},enumerable:!0}),i.created=Date.now(),i.inkState=r.InkState.PLANE,i.context=e,i.streams=[],i}return w(r,[{key:"add",value:function(e){if(!this.context.sensorContext.getContextByChannelID(e.channels.first.id))throw new Error("SensorContext do not contains information about SensorChannelsContext corresponding with this stream");e.ink&&(this.inkStream=e),this.streams.push(e)}}]),r}(U);Object.defineEnum(Be,"InkState",["PLANE","HOVERING","IN_VOLUME","VOLUME_HOVERING"]);var _e=function(){function e(t){P(this,e),this.channels=t,this.data=[],this.ignoredIndex=[],Object.defineProperty(this,"layout",{value:t.map((function(e){return e.name})),enumerable:!0}),Object.defineProperty(this,"stride",{value:this.layout.length,enumerable:!0}),Object.defineProperty(this,"length",{get:function(){return this.data.length/this.stride},enumerable:!0}),this.ink=this.layout.includes("X")&&this.layout.includes("Y")}return w(e,[{key:"add",value:function(e,t){var r=this;t&&this.ignoredIndex.push(this.length),this.channels.forEach((function(t){var n=re.getPropName(t.name),i=e[n];if(t.type==Re.Type.ALTITUDE&&!("altitude"in e))throw new Error("SensorStream input data do not provides altitude");if(t.type==Re.Type.AZIMUTH&&!("azimuth"in e))throw new Error("SensorStream input data do not provides azimuth");r.data.push(i)}))}},{key:"get",value:function(e){if(e>=this.length||e<0)throw new Error("Index ".concat(e," out of range - (0, ").concat(this.length-1,")"));for(var t={},r=0;r<this.stride;r++){var n=this.channels[r],i=re.getPropName(n.name),o=e*this.stride;t[i]=this.data[o+r]}return t}},{key:"getChannelData",value:function(e){var t=new Float32Array(this.length),r=this.channels.findIndex((function(t){return t.type==e}));this.channels[r].name;for(var n=0;n<this.length;n++)t[n]=this.data[n*this.stride+r];return t}},{key:"getPipelineMapping",value:function(){var e=[];if(this.ignoredIndex.length>0)for(var t=0;t<this.length;t++)this.ignoredIndex.includes(t)||e.push(t);return e}}]),e}();function Fe(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var r,n=O(e);if(t){var i=O(this).constructor;r=Reflect.construct(n,arguments,i)}else r=n.apply(this,arguments);return A(this,r)}}var Ue,je=function(e){R(n,e);var t,r=Fe(n);function n(){var e;return P(this,n),(e=r.call(this)).props={},e.devices=[],e}return w(n,[{key:"freeze",value:function(){return Object.freeze(this.props),this}},{key:"getMD5Message",value:function(){if(!Object.isFrozen(this.props)&&!Object.isFrozen(this))throw new Error("ID generation failed. InputDevice do not belongs to any SensorChannelsContext yet");return["InputDevice",U.buildMD5Tokens(this.props)]}},{key:"link",value:function(e){if(!(e instanceof n))throw new Error("Implementation of InputDevice is required");this.devices.push(e)}},{key:"getInkInputProvider",value:function(e){return new G(e)}},{key:"getInkSensorContext",value:function(e){var t=this.getInkInputProvider(e);return Ce.createDefaultInstance(this,t)}},{key:"openStream",value:function(e){var t=this;if(!this.environment)throw new Error("Environment is not configured for current InputDevice instance");var r=G.Type[e.pointer.type.toUpperCase()],i=this.getInkSensorContext(r),o=new Ne(this.environment,i);i.inkChannelsContext.layout=n.getLayout(e),this.sensorData=new Be(o),this.sensorData.add(new _e(i.inkChannelsContext.channels)),this.sampleTimestamp=e.timestamp,this.devices.forEach((function(e){return e.openStream(t.sensorData)}))}},{key:"add",value:function(e,t){if(!this.sensorData)throw new Error("Open ink stream not found");e.timestamp-=this.sampleTimestamp,this.sensorData.inkStream.add(e,t)}},{key:"closeStream",value:function(e){var t=this.sensorData;return this.devices.forEach((function(t){return t.closeStream(e)})),this.sensorData=null,this.sampleTimestamp=0,e?null:t}}],[{key:"getLayout",value:function(e){var t=[];return Object.keys(Re.Type).forEach((function(r){var i,o=Re.Type[r];i=o==Re.Type.ALTITUDE?"tiltX":o==Re.Type.AZIMUTH?"tiltY":re.getPropName(r),n.isValidInput(i,e)&&t.push(r)})),t}},{key:"isValidInput",value:function(e,t){var r=!1;return isFinite(t[e])&&(r=!0,"pressure"==e?(r=t.pressure>0)&&t.pointer&&("mouse"==t.pointer.type?r=!1:"touch"==t.pointer.type&&(r=.5!==t.pressure&&1!==t.pressure)):"tiltX"==e||"tiltY"==e?r=0!=t.tiltX||0!=t.tiltY:"radiusX"==e||"radiusY"==e?r=t.radiusX!=t.radiusY||parseInt(t.radiusX)!=t.radiusX:"rotation"==e&&(r=0!=t.rotation)),r}},{key:"createInstance",value:(t=fe(pe.mark((function e(t){var r,n,i,o,a,s,u=arguments;return pe.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r=D(this,te(Array.from(u).slice(1))),void 0!==ge){e.next=5;break}r.props["dev.graphics.resolution"]="".concat(screen.width,"x").concat(screen.height),e.next=22;break;case 5:return e.next=7,ge.system();case 7:return n=e.sent,e.next=10,ge.cpu();case 10:return i=e.sent,e.next=13,ge.graphics();case 13:o=e.sent,a=o.displays.filter((function(e){return e.main}))[0],s=o.controllers[0],r.props["dev.id"]=n.uuid.toLowerCase(),r.props["dev.manufacturer"]=n.manufacturer,r.props["dev.model"]=n.model,r.props["dev.cpu"]="".concat(i.manufacturer," ").concat(i.brand," ").concat(i.speed," - ").concat(i.cores," core(s)"),r.props["dev.graphics.display"]="".concat(a.model," ").concat(a.currentResX,"x").concat(a.currentResY," (").concat(a.pixeldepth," bit)"),r.props["dev.graphics.adapter"]="".concat(s.model," ").concat(s.vram," GB");case 22:return e.next=24,Ee.createInstance(t);case 24:return r.environment=e.sent,e.abrupt("return",r);case 26:case"end":return e.stop()}}),e,this)}))),function(e){return t.apply(this,arguments)})}]),n}(U),Ge=function(){function e(){if(P(this,e),Ue)throw new Error("URIResolver instance already available");Ue=this,this.init()}return w(e,[{key:"init",value:function(){throw new Error("URIResolver: init should be implemented")}},{key:"get",value:function(e){return this[e]}},{key:"register",value:function(e,t){this[e]=t}},{key:"resolve",value:function(e){var t;if(e.includes("?")){var r=this[e.split("?")[0]];if(r){var n=e.split("?")[1],i=[];n.split("&").forEach((function(e){var t=e.split("=")[1],r=parseFloat(t);isFinite(r)?t=r:"true"==t?t=!0:"false"==t&&(t=!1),i.push(t)})),t=function(){return r.apply(void 0,te(Array.from(arguments).concat(i)))}}}else t=this[e];if(!t)throw new Error("Failed to resolve ".concat(e));return t}}]),e}();Object.defineProperty(Ge,"instance",{get:function(){return Ue}});var Ye=function(){function e(){P(this,e)}return w(e,null,[{key:"encode",value:function(t){var r,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:e.Encoding.AUTO;if(n==e.Encoding.AUTO&&(n="undefined"==typeof Buffer?"undefined"!=typeof SharedArrayBuffer&&t.buffer instanceof SharedArrayBuffer?e.Encoding.NONE:e.Encoding.ARRAY:e.Encoding.BUFFER),n==e.Encoding.NONE)r=t;else if(n==e.Encoding.ARRAY)r=t.toArray();else{if("undefined"==typeof Buffer)throw new Error("Buffer not found, unable to serialize. Please provide Buffer in global scope.");var i=Buffer.from(t.buffer);switch(n){case e.Encoding.BUFFER:r=i.toJSON();break;case e.Encoding.BASE64:r=i.toString("base64");break;default:throw new Error("Invalid encoding provided: ".concat(n.name))}}return{encoding:n.name,type:t.constructor.name,content:r}}},{key:"decode",value:function(t){var r,n=e.Encoding[t.encoding];if(n==e.Encoding.NONE)r=t.content;else if(n==e.Encoding.ARRAY)r=t.content.toFloat32Array();else{if("undefined"==typeof Buffer)throw new Error("Buffer not found, unable to deserialize. Please provide Buffer in global scope.");var i;switch(n){case e.Encoding.BUFFER:i=Buffer.from(t.content);break;case e.Encoding.BASE64:i=Buffer.from(t.content,"base64");break;default:throw new Error("Invalid encoding provided: ".concat(n.name))}var o=new Uint8Array(i);r=new globalThis[t.type](o.buffer)}return r}},{key:"isTypedArrayData",value:function(e){return e&&e.encoding&&e.type&&e.type.endsWith("Array")}}]),e}();Object.defineEnum(Ye,"Encoding",["AUTO","NONE","ARRAY","BUFFER","BASE64"]);var Xe=function(){function e(t,r){P(this,e),this.name=t,!t||re.isValidURL(t)||e.repetitionsCache.has(t)||(e.repetitionsCache.add(t),console.warn("The string ".concat(t," is not a well formed URI"))),Object.defineProperty(this,"value",{get:function(){if(!r){if(!this.name)throw new Error("Resource descriptor identifier not found. Cannot resolve resource content.");if("function"==typeof this.resolve&&(r=this.resolve(this.name)),!r){if(!Ge.instance)throw new Error("Resource URI ".concat(this.name," cannot be resolved. URIResolver not implemented yet. Please implement and instantiate."));r=Ge.instance.resolve(this.name)}if(!r)throw new Error("Resource URI ".concat(this.name," cannot be resolved. Please provide resource definition in URIResolver init implementation."))}return r},set:function(e){r=e},enumerable:!0})}return w(e,[{key:"toJSON",value:function(){var e=this.value;return ArrayBuffer.isTypedArray(e)?e=Ye.encode(e,this.encoding):"function"==typeof e&&(e=e()),{name:this.name,value:e}}}],[{key:"fromJSON",value:function(t){var r=t.value;return Ye.isTypedArrayData(r)&&(r=Ye.decode(r)),new e(t.name,r)}},{key:"getInstance",value:function(t,r){return new e(r,t)}}]),e}();S(Xe,"repetitionsCache",new Set);var ze=function(){function e(t){P(this,e),re.isValidURL(t)||(Xe.repetitionsCache.has(t)||(Xe.repetitionsCache.add(t),console.warn("Brush URI ".concat(t," is not a well formed URI"))),t=this.constructor.onInvalidName(t)),Object.defineProperty(this,"id",{value:t}),Object.defineProperty(this,"uri",{value:t}),Object.defineProperty(this,"name",{value:t,enumerable:!0})}return w(e,[{key:"toJSON",value:function(){throw new Error("Brush.toJSON() should be implemented")}}],[{key:"fromJSON",value:function(e){throw new Error("static Brush.fromJSON() should be implemented")}},{key:"onInvalidName",value:function(e){return e}}]),e}(),Ve=function(){function e(){P(this,e)}return w(e,null,[{key:"createCircle",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:e.defaults.CIRCLE_PRECISION,r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:e.defaults.CIRCLE_RADIUS,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{x:0,y:0};return e.createEllipse(t,r,r,n)}},{key:"createEllipse",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:e.defaults.ELLIPSE_PRECISION,r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:e.defaults.ELLIPSE_RADIUS_X,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:e.defaults.ELLIPSE_RADIUS_Y,i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{x:0,y:0},o=[],a=2*Math.PI/t;if(r<=0)throw new Error("Invalid radius x found ".concat(r," > 0"));if(n<=0)throw new Error("Invalid radius y found ".concat(n," > 0"));for(var s=0;s<t;s++){var u=s*a,c=r*Math.cos(u),l=n*Math.sin(u);o.push(i.x+c,i.y+l)}return Float32Array.createSharedInstance(o)}},{key:"createStar",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:e.defaults.STAR_POINTS,r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:e.defaults.STAR_INTERNAL_RADIUS,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:e.defaults.STAR_RADIUS,i=[];if(n<=0)throw new Error("Invalid radius found ".concat(n," > 0"));if(r<=0)throw new Error("Invalid internal radius found ".concat(r," > 0"));if(r>n)throw new Error("Invalid internal radius found 0 < ".concat(r," < ").concat(n));for(var o=2*Math.PI/t,a=0;a<t;a++){var s=a*o,u=n*Math.cos(s),c=n*Math.sin(s),l=r*Math.cos(s+o/2),h=r*Math.sin(s+o/2);i.push(u,c,l,h)}return Float32Array.createSharedInstance(i)}}]),e}();S(Ve,"defaults",{CIRCLE_PRECISION:20,CIRCLE_RADIUS:.5,ELLIPSE_PRECISION:20,ELLIPSE_RADIUS_X:.5,ELLIPSE_RADIUS_Y:.25,STAR_POINTS:5,STAR_RADIUS:.5,STAR_INTERNAL_RADIUS:.25});var He=y?y.default||globalThis.poly2tri:{},Ze=He.SweepContext,qe=He.Point,We=function(){function e(t,r,n){var i=this,o=arguments.length>3&&void 0!==arguments[3]?arguments[3]:1;if(P(this,e),this.red=t,this.green=r,this.blue=n,this.alpha=o,o<0||o>1)throw new Error("Invalid alpha ".concat(o," found. The value must be in the interval [0, 1]."));Object.defineProperty(this,"hex",{get:function(){return"#".concat(i.red.toString(16).pad(2,"0")).concat(i.green.toString(16).pad(2,"0")).concat(i.blue.toString(16).pad(2,"0")).concat(Math.round(255*i.alpha).toString(16).pad(2,"0"))},enumerable:!0})}return w(e,[{key:"premultiply",value:function(){return{red:this.red/255*this.alpha,green:this.green/255*this.alpha,blue:this.blue/255*this.alpha,alpha:this.alpha}}},{key:"equals",value:function(e){return e&&this.red==e.red&&this.green==e.green&&this.blue==e.blue&&this.alpha==e.alpha}},{key:"toRGB",value:function(){return 1==this.alpha?this:new e(this.red,this.green,this.blue)}},{key:"toRGBA",value:function(t){return new e(this.red,this.green,this.blue,t)}},{key:"toHSLA",value:function(){var e=this.red/255,t=this.green/255,r=this.blue/255,n=Math.min(e,t,r),i=Math.max(e,t,r),o=0,a=0,s=(i+n)/2;if(i!=n){var u=i-n;switch(a=u/(1-Math.abs(2*s-1)),i){case e:o=(t-r)/u%6;break;case t:o=(r-e)/u+2;break;case r:o=(e-t)/u+4}}return(o*=60)<0&&(o+=360),{hue:parseFloat(o.toFixed(0)),saturation:parseFloat((100*a).toFixed(2)),lightness:parseFloat((100*s).toFixed(2)),alpha:this.alpha}}},{key:"toArray",value:function(){return[this.red,this.green,this.blue,this.alpha]}},{key:"toJSON",value:function(){return{red:this.red,green:this.green,blue:this.blue,alpha:this.alpha}}},{key:"toString",value:function(){return 1==this.alpha?"rgb(".concat(this.red,", ").concat(this.green,", ").concat(this.blue,")"):"rgba(".concat(this.red,", ").concat(this.green,", ").concat(this.blue,", ").concat(this.alpha,")")}}],[{key:"postdivide",value:function(t,r,n,i){return new e(parseInt(255*t/i),parseInt(255*r/i),parseInt(255*n/i),i)}},{key:"isColor",value:function(e){return e&&isFinite(e.red)&&isFinite(e.green)&&isFinite(e.blue)}},{key:"fromColor",value:function(t){var r,n,i,o;if("string"==typeof t)if(t.startsWith("rgb"))t=t.substring(t.indexOf("(")+1,t.indexOf(")")).split(/,\s*/g),r=parseInt(t[0]),n=parseInt(t[1]),i=parseInt(t[2]),o=t[3]?parseInt(t[3]):1;else{if(!t.startsWith("#"))throw new Error("Unknown input found: ".concat(t,". Expected data starts with rgba, rgb or #."));t=t.substring(1),r=parseInt(t.substring(0,2),16),n=parseInt(t.substring(2,4),16),i=parseInt(t.substring(4,6),16),o=8==t.length?parseInt(t.substring(6,8),16)/255:1}else Array.isArray(t)?(r=t[0],n=t[1],i=t[2],o=t[3]):(r=t.red,n=t.green,i=t.blue,o=t.alpha);return new e(r,n,i,o)}},{key:"fromHSLA",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,i=arguments.length>3?arguments[3]:void 0;t/=60,r/=100,n/=100;var o=(1-Math.abs(2*n-1))*r,a=o*(1-Math.abs(t%2-1)),s=0,u=0,c=0;t>=0&&t<1?(s=o,u=a):t>=1&&t<2?(s=a,u=o):t>=2&&t<3?(u=o,c=a):t>=3&&t<4?(u=a,c=o):t>=4&&t<5?(s=a,c=o):(s=o,c=a);var l=n-o/2;return s+=l,u+=l,c+=l,new e(Math.round(255*s),Math.round(255*u),Math.round(255*c),i)}},{key:"random",value:function(t){return new e(Math.randomInt(0,255),Math.randomInt(0,255),Math.randomInt(0,255),t?Math.random():1)}}]),e}();We.TRANSPERENT=new We(0,0,0,0),We.BLACK=new We(0,0,0,1),We.WHITE=new We(255,255,255,1),We.RED=new We(255,0,0,1),We.GREEN=new We(0,255,0,1),We.BLUE=new We(0,0,255,1);var Ke=function(){function e(t,r){var n=this,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};P(this,e),this.layout=t,this.pointProps=r,this.sheet={};var o={};Object.defineProperties(o,{size:{get:this.getComputed.bind(this,"size"),set:this.setStyle.bind(this,"size"),enumerable:!0},red:{get:this.getComputed.bind(this,"red"),set:this.setStyle.bind(this,"red"),enumerable:!0},green:{get:this.getComputed.bind(this,"green"),set:this.setStyle.bind(this,"green"),enumerable:!0},blue:{get:this.getComputed.bind(this,"blue"),set:this.setStyle.bind(this,"blue"),enumerable:!0},alpha:{get:this.getComputed.bind(this,"alpha"),set:this.setStyle.bind(this,"alpha"),enumerable:!0},rotation:{get:this.getComputed.bind(this,"rotation"),set:this.setStyle.bind(this,"rotation"),enumerable:!0},scaleX:{get:this.getComputed.bind(this,"scaleX"),set:this.setStyle.bind(this,"scaleX"),enumerable:!0},scaleY:{get:this.getComputed.bind(this,"scaleY"),set:this.setStyle.bind(this,"scaleY"),enumerable:!0},scaleZ:{get:this.getComputed.bind(this,"scaleZ"),set:this.setStyle.bind(this,"scaleZ"),enumerable:!0},offsetX:{get:this.getComputed.bind(this,"offsetX"),set:this.setStyle.bind(this,"offsetX"),enumerable:!0},offsetY:{get:this.getComputed.bind(this,"offsetY"),set:this.setStyle.bind(this,"offsetY"),enumerable:!0},offsetZ:{get:this.getComputed.bind(this,"offsetZ"),set:this.setStyle.bind(this,"offsetZ"),enumerable:!0},color:{get:this.getComputed.bind(this,"color"),set:this.setStyle.bind(this,"color"),enumerable:!0},blendMode:{get:this.getComputed.bind(this,"blendMode"),set:this.setStyle.bind(this,"blendMode"),enumerable:!0},visibility:{get:this.getComputed.bind(this,"visibility"),set:this.setStyle.bind(this,"visibility"),enumerable:!0},reset:{value:function(e){e&&(i=e),n.clear(),Object.keys(i).forEach((function(e){return n.setStyle(e,i[e])}))}},clear:{value:this.clear.bind(this)}}),this.style=Object.freeze(o),this.style.reset(i)}return w(e,[{key:"setStyle",value:function(t,r){if(null==r&&(r=void 0),e.validate(this.layout,t,r),"color"==t&&r)return this.sheet.red=r.red,this.sheet.green=r.green,this.sheet.blue=r.blue,void(this.sheet.alpha=r.alpha);null==r?delete this.sheet[t]:this.sheet[t]=r}},{key:"getStyle",value:function(e){var t=this.sheet[e];return"visibility"==e?"boolean"!=typeof t&&(t=!0):"color"==e&&We.isColor(this.sheet)&&(t=We.fromColor(this.sheet)),t}},{key:"getComputed",value:function(e){var t=this.getStyle(e);if(null==t)if("color"==e){var r={red:isFinite(this.sheet.red)?this.sheet.red:this.pointProps.red,green:isFinite(this.sheet.green)?this.sheet.green:this.pointProps.green,blue:isFinite(this.sheet.blue)?this.sheet.blue:this.pointProps.blue,alpha:isFinite(this.sheet.alpha)?this.sheet.alpha:this.pointProps.alpha};We.isColor(r)&&(t=We.fromColor(r))}else t=this.pointProps[e];return t}},{key:"clear",value:function(){this.sheet={}}}],[{key:"validate",value:function(e,t,r,n){var i;if(r&&e.includes(le.Property[re.getEnumValueName(t)])){if(!n)throw new Error("Property ".concat(t," value ").concat(r," is not applicable. This is a dynamic property and is part of the layout."));console.warn("Property ".concat(t," value ").concat(r," is not applicable. This is a dynamic property and is part of the layout.")),r=void 0}if("color"==t)!r||r instanceof We||(i="Property ".concat(t," is not an instance of Color"));else if("blendMode"==t)""==r&&(r=void 0);else if("number"==typeof r)if("size"==t)r<0?i="Property ".concat(t," with value ").concat(r," is not allowed. Value should be a positive number."):0==r&&(r=void 0);else if("red"==t||"green"==t||"blue"==t||"alpha"==t){var o="alpha"==t?{min:0,max:1}:{min:0,max:255};r>=o.min&&r<=o.max||(i="Property ".concat(t," with value ").concat(r," is out of range. Allowd range: [").concat(o.min,", ").concat(o.max,"]."))}else"rotation"==t?0==r&&(r=void 0):"scattering"==t&&r<0&&(r=void 0);if(i)throw new Error(i);return r}}]),e}(),Je=[le.Property.X,le.Property.Y],$e=function(){function e(t){var r=this,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:Je;if(P(this,e),e.name==this.constructor.name)throw new Error("Path class is abstract. Constructor is not accessible.");if(t%i.length!=0)throw new Error("Points length do not matches with given layout");if(Object.defineProperties(this,{layout:{value:Object.freeze(i)},stride:{value:i.length},length:{value:t/i.length}}),!Object.isSealed(n))for(var o in n)void 0!==n[o]&&(n[o]=Ke.validate(this.layout,o,n[o],!0));i.includes(le.Property.ROTATION)||"rotation"in n||(n.rotation=void 0),i.includes(le.Property.SIZE)||n.size||(n.size=1),Object.defineProperty(this,"pointProps",{value:Object.seal(n)}),i.forEach((function(e,t){var n=re.getPropName(e.name,!0);Object.defineProperty(r,"setPoint".concat(n),{value:r.setPointPropertyValue.bind(r,t)}),Object.defineProperty(r,"getPoint".concat(n),{value:r.getPointPropertyValue.bind(r,t)})}))}return w(e,[{key:"setPointPropertyValue",value:function(e,t,r){if(isNaN(t))throw new Error("Point index is required");if(t>=this.length||t<0)throw new Error("Index ".concat(e," out of range - (0, ").concat(this.length-1,")"));if(isNaN(r))throw new Error("value is required");this.points[t*this.layout.length+e]=r}},{key:"getPointPropertyValue",value:function(e,t){if(isNaN(t))throw new Error("Point index is required");if(t>=this.length||t<0)throw new Error("Index ".concat(e," out of range - (0, ").concat(this.length-1,")"));return this.points[t*this.layout.length+e]}},{key:"setPoint",value:function(e,t){var r=this,n=e*this.stride;this.layout.forEach((function(e,i){return r.points[n+i]=t.getProperty(e)}))}},{key:"getPoint",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:this.pointProps;if(e>=this.length||e<0)throw new Error("Index ".concat(e," out of range - (0, ").concat(this.length-1,")"));return le.createInstance(this.layout,t,this.points,e)}},{key:"getChannelData",value:function(e){var t=new([le.Property.RED,le.Property.GREEN,le.Property.BLUE].includes(e)?Uint8Array:Float32Array)(this.length),r=this.layout.indexOf(e);if(-1==r)throw new Error("Property ".concat(e.name," is not part from the spline layout ").concat(this.layout.map((function(e){return e.name})).join(", ")));for(var n=0;n<this.length;n++)t[n]=this.points[n*this.stride+r];return t}},{key:"transform",value:function(e){for(var t=e.scaleX,r=e.rotation,n=0;n<this.length;n++){var o=n*this.stride,a=i.vec4.fromValues(this.getPointX(n),this.getPointY(n),0,1);i.vec4.transformMat4(a,a,e.value);for(var s=0;s<this.stride;s++){var u=o+s;switch(this.layout[s]){case le.Property.X:this.points[u]=a[0]/a[3];break;case le.Property.Y:this.points[u]=a[1]/a[3];break;case le.Property.Z:this.points[u]=a[2]/a[3];break;case le.Property.ROTATION:this.points[u]+=r;break;case le.Property.SIZE:case le.Property.SCALE_X:case le.Property.SCALE_Y:case le.Property.SCALE_Z:case le.Property.OFFSET_X:case le.Property.OFFSET_Y:case le.Property.OFFSET_Z:this.points[u]*=t}}}this.layout.includes(le.Property.ROTATION)||(this.pointProps.rotation=0==r?void 0:r)}},{key:"clone",value:function(){throw new Error("Path.clone()) is abstract and should be implemented")}},{key:"slice",value:function(e){throw new Error("Path.slice(fragment)) is abstract and should be implemented")}},{key:"slicePoints",value:function(e,t){throw new Error("Path.slicePoints(fromPointIndex, toPointIndex, fromTValue, toTValue)) is abstract and should be implemented")}},{key:"toSVGPath",value:function(){for(var e=[],t=0;t<this.length;t++)e.push("".concat(this.getPointX(t),",").concat(this.getPointY(t)));return"M ".concat(e.join(" L ")," Z")}},{key:"toJSON",value:function(){throw new Error("Path.toJSON() is abstract and should be implemented")}}],[{key:"fromJSON",value:function(e){throw new Error("static Path.fromJSON(data) is abstract and should be implemented")}},{key:"fromRect",value:function(e,t){return new this([e.left,e.top,e.right,e.top,e.right,e.bottom,e.left,e.bottom,e.left,e.top],t)}}]),e}(),Qe=function(){function e(t,r,n){var i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0,o=arguments.length>4&&void 0!==arguments[4]?arguments[4]:1;P(this,e),Object.defineProperties(this,{path:{value:t,enumerable:!0},fromPointIndex:{value:r,enumerable:!0},toPointIndex:{value:n,enumerable:!0},fromTValue:{value:i,enumerable:!0},toTValue:{value:o,enumerable:!0}}),this.validate()}return w(e,[{key:"validate",value:function(){e.validate(this.path,this.fromPointIndex,this.toPointIndex,this.fromTValue,this.toTValue)}},{key:"overlaps",value:function(e){if(e.path!=this.path)return!1;var t=e.fromPointIndex<this.toPointIndex-3||e.fromPointIndex==this.toPointIndex-3&&e.fromTValue<=this.toTValue,r=e.toPointIndex-3>this.fromPointIndex||e.toPointIndex-3==this.fromPointIndex&&e.toTValue>=this.fromTValue;return t&&r}},{key:"toPath",value:function(){return this.path.slice(this)}},{key:"toString",value:function(){return"fragment".concat(this.path.id?"{".concat(this.path.id,"}"):"","(").concat(this.fromPointIndex,", ").concat(this.toPointIndex,", ").concat(this.fromTValue,", ").concat(this.toTValue,")")}}],[{key:"validate",value:function(e,t,r){var n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0,i=arguments.length>4&&void 0!==arguments[4]?arguments[4]:1;if(t<0)throw new Error("Invalid fragment fromPointIndex ".concat(t," found. The value must be non-negative."));if(r>e.length-1)throw new Error("Invalid fragment toPointIndex ".concat(r," found. Last point in path index is ").concat(e.length-1,"."));if(isFinite(e.ts)&&isFinite(e.tf)){if(n<0||n>=1)throw new Error("Invalid fragment fromTValue ".concat(n," found. The value must be in the interval [0, 1)."));if(i<=0||i>1)throw new Error("Invalid fragment toTValue ".concat(i," found. The value must be in the interval (0, 1]."));if(r+1-t<4)throw new Error("Invalid fragment points range {".concat(t,", ").concat(r,"} found. At least 4 points are needed to define spline."));if(t==r-3&&i<=n)throw new Error("Invalid fragment T values range {".concat(n,", ").concat(i,"} found. The value must be in the interval (fromTValue, 1]."))}}}]),e}();function et(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var r,n=O(e);if(t){var i=O(this).constructor;r=Reflect.construct(n,arguments,i)}else r=n.apply(this,arguments);return A(this,r)}}le.Property.X,le.Property.Y;var tt=function(e){R(r,e);var t=et(r);function r(e,n,i){var o;return P(this,r),o=t.call(this,e.length,n,i),Array.isArray(e)&&(e=Object.seal(e)),Object.defineProperty(T(o),"points",{get:function(){return e},enumerable:!0}),o}return w(r,[{key:"clone",value:function(){return new r(this.points.clone(),Object.clone(this.pointProps),this.layout.slice())}},{key:"slice",value:function(e){return new r(this.slicePoints(e.fromPointIndex,e.toPointIndex),Object.clone(this.pointProps),this.layout.slice())}},{key:"slicePoints",value:function(e,t){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:1;return Qe.validate(this,e,t,r,n),this.points.slice(e*this.stride,(t+1)*this.stride)}},{key:"toJSON",value:function(){return{type:"ArrayPath",points:this.points,pointProps:this.pointProps,layout:this.layout.map((function(e){return e.name}))}}}],[{key:"fromJSON",value:function(e){if("ArrayPath"!=e.type)throw new Error("ArrayPath deserialization failed. JSON type is ".concat(e.type,", expected ArrayPath."));return new r(e.points,e.pointProps,e.layout.map((function(e){return le.Property[e]})))}}]),r}($e);function rt(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var r,n=O(e);if(t){var i=O(this).constructor;r=Reflect.construct(n,arguments,i)}else r=n.apply(this,arguments);return A(this,r)}}var nt=function(e){R(r,e);var t=rt(r);function r(e,n,i){var o;return P(this,r),o=t.call(this,e.length,n,i),e=Float32Array.createSharedInstance(e),Object.defineProperty(T(o),"points",{get:function(){return e},enumerable:!0}),Object.defineProperty(T(o),"buffer",{get:function(){return e.buffer},set:function(t){if("undefined"!=typeof SharedArrayBuffer&&o.points.buffer instanceof SharedArrayBuffer)throw new Error("Underlying buffer is SharedArrayBuffer and cannot be restored");if(o.points.buffer.byteLength>0)throw new Error("Cannot restore buffer when underlying buffer is not empty");e=new Float32Array(t)}}),o}return w(r,[{key:"clone",value:function(){var e=arguments.length>0&&void 0!==arguments[0]&&arguments[0];if(0==this.buffer.byteLength)throw new Error("Path buffer is empty. Data could be processing under some thread. Clone failed.");return e?new tt(this.points.toArray(),Object.clone(this.pointProps),this.layout.slice()):new r(this.points.clone(),Object.clone(this.pointProps),this.layout.slice())}},{key:"slice",value:function(e){return new r(this.slicePoints(e.fromPointIndex,e.toPointIndex),Object.clone(this.pointProps),this.layout.slice())}},{key:"slicePoints",value:function(e,t){var r,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:1;if(Qe.validate(this,e,t,n,i),"undefined"!=typeof SharedArrayBuffer&&this.buffer instanceof SharedArrayBuffer){var o=this.points.subarray(e*this.stride,(t+1)*this.stride),a=new SharedArrayBuffer(o.length*Float32Array.BYTES_PER_ELEMENT);(r=new Float32Array(a)).set(o)}else r=this.points.slice(e*this.stride,(t+1)*this.stride);return r}},{key:"toJSON",value:function(){return{type:"SharedPath",points:Ye.encode(this.points,this.encoding),pointProps:this.pointProps,layout:this.layout.map((function(e){return e.name}))}}}],[{key:"fromJSON",value:function(e){if("SharedPath"!=e.type)throw new Error("SharedPath deserialization failed. JSON type is ".concat(e.type,", expected SharedPath."));return new r(Ye.decode(e.points),e.pointProps,e.layout.map((function(e){return le.Property[e]})))}}]),r}($e),it=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:2;P(this,e),this.stride=t}return w(e,[{key:"sort",value:function(e,t){return this.sortArrayPart(e,0,e.length-this.stride,t),e}},{key:"partition",value:function(e,t,r,n){for(var i=e[r],o=e[r+1],a=t-this.stride,s=t;s<r;s+=2)n?n(i,o,e[s],e[s+1])&&(a+=this.stride,this.swap(e,a,s)):(i>e[s]||i==e[s]&&o>e[s+1])&&(a+=this.stride,this.swap(e,a,s));return this.swap(e,a+this.stride,r),a+this.stride}},{key:"swap",value:function(e,t,r){var n=e[t],i=e[t+1];return e[t]=e[r],e[t+1]=e[r+1],e[r]=n,e[r+1]=i,e}},{key:"sortArrayPart",value:function(e,t,r,n){if(t<r){var i=this.partition(e,t,r,n);this.sortArrayPart(e,t,i-this.stride,n),this.sortArrayPart(e,i+this.stride,r,n)}}}]),e}();function ot(e,t,r,n,i,o){return(r-e)*(o-t)-(n-t)*(i-e)}function at(e,t,r,n,i,o){var a=e-r,s=i-r,u=a*(o-n)-s*(t-n);u*=u;var c=(a=i-r)*a+(s=o-n)*s;return c>0?Math.sqrt(u/c):Math.sqrt((r-e)*(r-e)+(n-t)*(n-t))}var st=Object.freeze({__proto__:null,vector:function(e,t){var r,n={};return Object.defineProperty(n,"x",{value:t.x-e.x,enumerable:!0}),Object.defineProperty(n,"y",{value:t.y-e.y,enumerable:!0}),Object.defineProperty(n,"length",{get:function(){return isNaN(r)&&(r=Math.sqrt(n.x*n.x+n.y*n.y)),r},enumerable:!0}),n},angle:function(e,t){var r=e.x*t.x+e.y*t.y,n=e.x*t.y-e.y*t.x;return Math.atan2(n,r)},cross:ot,perpendicularDistance:at}),ut=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:Float32Array;P(this,e),this.ArrayType=t,this.quickSort=new it}return w(e,[{key:"monotoneChain",value:function(e){if(e.length<=0)return new this.ArrayType;this.quickSort.sort(e);for(var t=new this.ArrayType(e.length),r=0,n=0;n<e.length;n+=2){for(;r>=4&&ot(t[r-4],t[r-3],t[r-2],t[r-1],e[n],e[n+1])<=0;)r-=2;t[r]=e[n],t[r+1]=e[n+1],r+=2}t=t.slice(0,r);var i,o=new this.ArrayType(e.length);r=0;for(var a=e.length-2;a>=0;a-=2){for(;r>=4&&ot(o[r-4],o[r-3],o[r-2],o[r-1],e[a],e[a+1])<=0;)r-=2;o[r]=e[a],o[r+1]=e[a+1],r+=2}if(o=o.slice(0,r-2),this.ArrayType==Float32Array){var s=o.length+t.length;(i=Float32Array.createSharedInstance(s)).set(o),i.set(t,o.length)}else i=o.concat(t);return i}}]),e}();function ct(e,t){var r="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!r){if(Array.isArray(e)||(r=function(e,t){if(!e)return;if("string"==typeof e)return lt(e,t);var r=Object.prototype.toString.call(e).slice(8,-1);"Object"===r&&e.constructor&&(r=e.constructor.name);if("Map"===r||"Set"===r)return Array.from(e);if("Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r))return lt(e,t)}(e))||t&&e&&"number"==typeof e.length){r&&(e=r);var n=0,i=function(){};return{s:i,n:function(){return n>=e.length?{done:!0}:{done:!1,value:e[n++]}},e:function(e){throw e},f:i}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var o,a=!0,s=!1;return{s:function(){r=r.call(e)},n:function(){var e=r.next();return a=e.done,e},e:function(e){s=!0,o=e},f:function(){try{a||null==r.return||r.return()}finally{if(s)throw o}}}}function lt(e,t){(null==t||t>e.length)&&(t=e.length);for(var r=0,n=new Array(t);r<t;r++)n[r]=e[r];return n}var ht=function(){function e(t){var r,n=this,i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[];if(P(this,e),!(t instanceof $e))throw new Error("Expected shape type is Path. Use createInstance or createSharedInstance Polygon methods to allocate instance.");if(i.some((function(e){return!(e instanceof $e)})))throw new Error("Expected hole type is Path. Use createInstance or createSharedInstance Polygon methods to allocate instance.");this.holesDirection=e.PointsDirection.CLOCKWISE,Object.defineProperty(this,"shape",{value:t,enumerable:!0}),Object.defineProperty(this,"holes",{value:i,enumerable:!0}),Object.defineProperty(this,"contours",{value:[t].concat(te(i)),enumerable:!0}),Object.defineProperty(this,"ArrayType",{value:t instanceof nt?Float32Array:Array}),Object.defineProperty(this,"bounds",{get:function(){return V.ofPolygon(n)},enumerable:!0}),Object.defineProperty(this,"vertices",{get:function(){return r||(r=n.triangulate()),r},set:function(e){return r=e},enumerable:!0}),Object.defineProperty(this,"verticesValue",{get:function(){return r}})}return w(e,[{key:"clone",value:function(){var t=arguments.length>0&&void 0!==arguments[0]&&arguments[0],r=this.shape.clone(t),n=this.holes.map((function(e){return e.clone(t)})),i=new e(r,n);return this.verticesValue&&(i.vertices=this.vertices.slice()),i}},{key:"fit",value:function(e){var t,r=this.bounds,n=e.width/r.width,i=e.height/r.height,o=n>0&&i>0?Math.min(n,i):Math.max(n,i),a=ct(this.contours);try{for(a.s();!(t=a.n()).done;)for(var s=t.value,u=0;u<s.length;u++)s.setPointX(u,s.getPointX(u)*o),s.setPointY(u,s.getPointY(u)*o)}catch(e){a.e(e)}finally{a.f()}}},{key:"center",value:function(){var e,t=this.bounds,r=ct(this.contours);try{for(r.s();!(e=r.n()).done;)for(var n=e.value,i=0;i<n.length;i++)n.setPointX(i,n.getPointX(i)-t.center.x),n.setPointY(i,n.getPointY(i)-t.center.y)}catch(e){r.e(e)}finally{r.f()}}},{key:"transform",value:function(e){this.contours.forEach((function(t){return t.transform(e)}))}},{key:"intersects",value:function(t){if(!(t instanceof e))throw new Error("Expected 'poly' type is Polygon");for(var r=this.shape,n=t.shape,i=0;i<2;i++)for(var o=0==i?r:n,a=0;a<o.length;a++){for(var s=a+1==o.length?0:a+1,u=o.getPointX(a),c=o.getPointY(a),l=o.getPointX(s),h=o.getPointY(s)-c,f=u-l,d=Number.POSITIVE_INFINITY,p=Number.NEGATIVE_INFINITY,y=0;y<r.length;y++){var v=h*r.getPointX(y)+f*r.getPointY(y);v<d&&(d=v),v>p&&(p=v)}for(var m=Number.POSITIVE_INFINITY,g=Number.NEGATIVE_INFINITY,b=0;b<n.length;b++){var E=h*n.getPointX(b)+f*n.getPointY(b);E<m&&(m=E),E>g&&(g=E)}if(p<m||g<d)return!1}return!0}},{key:"triangulate",value:function(){var e,t,r=[],n=ct(this.contours);try{for(n.s();!(e=n.n()).done;){for(var i=e.value,o=[],a=0;a<i.length;a++){var s=new qe(i.getPointX(a),i.getPointY(a));if(a>0){if(o.last.x==s.x&&o.last.y==s.y)continue;if(a==i.length-1&&o.first.x==s.x&&o.first.y==s.y)continue}o.push(s)}r.push(o)}}catch(e){n.e(e)}finally{n.f()}try{t=new Ze(r.shift())}catch(e){return console.error(e),new Float32Array}for(var u=0,c=r;u<c.length;u++){var l=c[u];try{t.addHole(l)}catch(e){return console.error(e),new Float32Array}}try{t.triangulate()}catch(e){return console.warn(e),new Float32Array}var h,f=t.getTriangles(),d=Float32Array.createSharedInstance(6*f.length),p=0,y=ct(f);try{for(y.s();!(h=y.n()).done;){var v,m=ct(h.value.getPoints());try{for(m.s();!(v=m.n()).done;){var g=v.value;d[p++]=g.x,d[p++]=g.y}}catch(e){m.e(e)}finally{m.f()}}}catch(e){y.e(e)}finally{y.f()}return d}},{key:"convex",value:function(){return this.buildConvex.convex(this.shape.points)}},{key:"union",value:function(e){var t=Array.of.apply(Array,te(this.shape.points).concat(te(e.shape.points)));return this.buildConvex(t)}},{key:"buildConvex",value:function(t){this.convexHullProducer||(this.convexHullProducer=new ut(this.ArrayType));var r=this.convexHullProducer.monotoneChain(t);return this.ArrayType==Float32Array?e.createSharedInstance(r):e.createInstance(r)}},{key:"simplify",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:.1;if(t<=0)throw new Error("epsilon expected value > 0");this.epsilon=t;var r,n=this.simplifyPath(this.shape),i=[],o=ct(this.holes);try{for(o.s();!(r=o.n()).done;){var a=r.value,s=this.simplifyPath(a);s.length>0&&i.push(s)}}catch(e){o.e(e)}finally{o.f()}return this.shape instanceof nt?e.createSharedInstance(n,i):e.createInstance(n,i)}},{key:"simplifyPath",value:function(e){if(e.length<3)return e.points;var t=Array.of.apply(Array,te(e.points).concat([e.getPointX(0),e.getPointY(0)])),r=this.simplifyPolyline(t);return r.length<8?t.slice(0,t.length-2):r.slice(0,r.length-2)}},{key:"simplifyPolyline",value:function(e){if(e.length<4)return e;for(var t=0,r=0,n=2;n<e.length-2;n+=2){var i=at(e[n],e[n+1],e[0],e[1],e[e.length-2],e[e.length-1]);i>t&&(r=n,t=i)}if(t>this.epsilon){var o=this.simplifyPolyline(e.slice(0,r+2)),a=this.simplifyPolyline(e.slice(r,e.length));return o.concat(a.slice(2,a.length))}return[e[0],e[1],e[e.length-2],e[e.length-1]]}},{key:"toSVGPath",value:function(){return this.contours.map((function(e){return e.toSVGPath()})).join(" ")}},{key:"toJSON",value:function(){return{type:"Polygon",shape:this.shape.toJSON(),holes:this.holes.map((function(e){return e.toJSON()})),holesDirection:this.holesDirection.name,vertices:this.verticesValue}}}],[{key:"fromJSON",value:function(t){if("Polygon"!=t.type)throw new Error("Polygon deserialization failed. JSON type is ".concat(t.type,", expected Polygon."));var r=new e("SharedPath"==t.shape.type?nt.fromJSON(t.shape):tt.fromJSON(t.shape),t.holes.map((function(e){return"SharedPath"==e.type?nt.fromJSON(e):tt.fromJSON(e)})));return r.holesDirection=e.PointsDirection[t.holesDirection],r.vertices=t.vertices,r}},{key:"fromRect",value:function(t){return e.createInstance([t.left,t.top,t.right,t.top,t.right,t.bottom,t.left,t.bottom,t.left,t.top])}},{key:"createInstance",value:function(t){var r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[];return new e(new tt(t),r.map((function(e){return new tt(e)})))}},{key:"createSharedInstance",value:function(t){var r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[],n=new e(new nt(t),r.map((function(e){return new nt(e)})));return Object.defineProperty(n,"encoding",{get:function(){return n.shape.encoding},set:function(e){n.contours.forEach((function(t){return t.encoding=e}))},enumerable:!0}),n}}]),e}();Object.defineEnum(ht,"PointsDirection",["CLOCKWISE","COUNTERCLOCKWISE"]);var ft=function(){function e(t){var r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1;P(this,e),this.size=r,Object.defineProperty(this,"descriptor",{value:{shape:void 0},enumerable:!0}),Object.defineProperty(this,"shape",{get:function(){if(!t){if("function"==typeof(t=this.descriptor.shape.value)&&(t=t()),(Array.isArray(t)||t instanceof Float32Array)&&(t=ht.createSharedInstance(t)),!(t instanceof ht))throw new Error("Expected shape type is Polygon");e.fitShape(t)}return t},set:function(r){if(!r)throw new Error("BrushPrototype: shape not found");"string"==typeof r?r=new Xe(r):r instanceof ht||r instanceof Float32Array||Array.isArray(r)?r=Xe.getInstance(r):r instanceof Xe||(r=new Xe(r.name,r.value)),t=null,this.descriptor.shape=r,this.descriptor.shape.resolve=e.resolve},enumerable:!0}),this.shape=t}return w(e,[{key:"toJSON",value:function(){return this.shape.encoding=this.encoding,{shape:{name:this.descriptor.shape.name,value:this.shape.toJSON()},size:this.size}}}],[{key:"fromJSON",value:function(t){return new e({name:t.shape.name,value:ht.fromJSON(t.shape.value)},t.size)}},{key:"create",value:function(t){for(var r,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,i=t,o=arguments.length,a=new Array(o>2?o-2:0),s=2;s<o;s++)a[s-2]=arguments[s];switch(t){case e.Type.CIRCLE:r=Ve.createCircle.apply(Ve,a),i+="?precision=".concat(a[0]||Ve.defaults.CIRCLE_PRECISION,"&radius=").concat(a[1]||Ve.defaults.CIRCLE_RADIUS);break;case e.Type.ELLIPSE:r=Ve.createEllipse.apply(Ve,a),i+="?precision=".concat(a[0]||Ve.defaults.ELLIPSE_PRECISION,"&radiusX=").concat(a[1]||Ve.defaults.ELLIPSE_RADIUS_X,"&radiusY=").concat(a[2]||Ve.defaults.ELLIPSE_RADIUS_Y);break;case e.Type.STAR:r=Ve.createStar.apply(Ve,a),i+="?points=".concat(a[0]||Ve.defaults.STAR_POINTS,"&internalRadius=").concat(a[1]||Ve.defaults.STAR_INTERNAL_RADIUS,"&radius=").concat(a[2]||Ve.defaults.STAR_RADIUS);break;default:console.error("Brush2D: createShape fails with ".concat(t," type"))}return new e({name:i,shape:r},n)}},{key:"resolve",value:function(t){var r,n=t.split("?"),i=n.first;if(Object.values(e.Type).includes(i)){var o=n.last.split("&"),a={};switch(o.forEach((function(e){a[e.substring(0,e.indexOf("="))]=e.substring(e.indexOf("=")+1)})),i){case e.Type.CIRCLE:var s=a.precision?parseInt(a.precision):void 0,u=a.radius?parseFloat(a.radius):1;r=Ve.createCircle(s,u);break;case e.Type.ELLIPSE:var c=a.precision?parseInt(a.precision):void 0,l=a.radiusX?parseFloat(a.radiusX):void 0,h=a.radiusY?parseFloat(a.radiusY):void 0;r=Ve.createEllipse(c,l,h);break;case e.Type.STAR:var f=a.points?parseInt(a.points):void 0,d=a.radius?parseFloat(a.radius):void 0,p=a.internalRadius?parseFloat(a.internalRadius):void 0;r=Ve.createStar(f,p,d);break;default:console.error("Brush2D: createShape fails with ".concat(i," type"))}}return r}},{key:"fitShape",value:function(t){if(!(t instanceof ht))throw new Error("Expected shape type is Polygon");t.center(),t.fit(e.SHAPE_FRAME)}}]),e}();function dt(e){return pt.apply(this,arguments)}function pt(){return(pt=fe(pe.mark((function e(t){var r,n,i,o,a,s,u=arguments;return pe.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r=u.length>1&&void 0!==u[1]?u[1]:"binary",n=u.length>2&&void 0!==u[2]?u[2]:{},!(t instanceof Uint8Array)){e.next=4;break}return e.abrupt("return",t);case 4:return e.next=6,fetch(t,Object.assign({mode:"no-cors"},n));case 6:if(o=e.sent,"json"!=r){e.next=13;break}return e.next=10,o.json();case 10:i=e.sent,e.next=36;break;case 13:if("text"!=r){e.next=19;break}return e.next=16,o.text();case 16:i=e.sent,e.next=36;break;case 19:if("binary"!=r){e.next=26;break}return e.next=22,o.arrayBuffer();case 22:a=e.sent,i=new Uint8Array(a),e.next=36;break;case 26:return e.next=28,o.blob();case 28:if(s=e.sent,"base64"!=r){e.next=35;break}return e.next=32,gt(s);case 32:i=e.sent,e.next=36;break;case 35:i=s;case 36:return e.abrupt("return",i);case 37:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function yt(e){return vt.apply(this,arguments)}function vt(){return(vt=fe(pe.mark((function e(t){var r,n,i=arguments;return pe.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=i.length>1&&void 0!==i[1]?i[1]:"binary",n=i.length>2&&void 0!==i[2]?i[2]:{},e.abrupt("return",dt(t,r,n));case 3:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function mt(){return(mt=fe(pe.mark((function e(t){var r,n,i=arguments;return pe.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=i.length>1&&void 0!==i[1]?i[1]:{},e.next=3,fetch(t,Object.assign({method:"HEAD",cache:"no-store"},r));case 3:return n=e.sent,e.abrupt("return",200==n.status);case 5:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function gt(e){return new Promise((function(t,r){var n=new FileReader;n.readAsDataURL(e),n.onloadend=function(){return t(n.result)},n.onerror=r}))}function bt(e){return new Promise((function(t,r){var n,i=new Image;i.crossOrigin="anonymous",i.onload=function(){if(ve.type2D==ve.Type2D.OFFSCREEN){var e=new OffscreenCanvas(i.width,i.height);e.getContext("2d").drawImage(i,0,0),t(e)}else n&&URL.revokeObjectURL(n),t(i)},i.onerror=r,"string"==typeof e?i.src=e:ve.type2D==ve.Type2D.OFFSCREEN?e instanceof Uint8Array?i.src=Buffer.from(e):e instanceof OffscreenCanvas?t(e):i.src=e:(e instanceof Uint8Array&&(e.byteLength!=e.buffer.byteLength&&(e=e.slice()),e=e.buffer),e instanceof ArrayBuffer&&(e=new Blob([e],{type:"image/png"})),n=URL.createObjectURL(e),i.src=n)}))}function Et(e){return Pt.apply(this,arguments)}function Pt(){return(Pt=fe(pe.mark((function e(t){var r;return pe.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if("string"!=typeof t&&"undefined"!=typeof createImageBitmap){e.next=6;break}return e.next=3,bt(t);case 3:r=e.sent,e.next=15;break;case 6:if(!(t instanceof ArrayBuffer||t instanceof Uint8Array)){e.next=12;break}return e.next=9,createImageBitmap(new Blob([t],{type:"image/png"}));case 9:r=e.sent,e.next=15;break;case 12:return e.next=14,createImageBitmap(t);case 14:r=e.sent;case 15:return e.abrupt("return",r);case 16:case"end":return e.stop()}}),e)})))).apply(this,arguments)}S(ft,"SHAPE_FRAME",new V(-.5,-.5,1,1)),ft.Type={ELLIPSE:"will://brush/3.0/shape/Ellipse",CIRCLE:"will://brush/3.0/shape/Circle",STAR:"will://brush/3.0/shape/Star"};var kt=Object.freeze({__proto__:null,readFile:dt,loadFile:yt,exists:function(e){return mt.apply(this,arguments)},loadImage:Et,saveAs:function(e,t){var r,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"application/octet-stream";if(e instanceof Blob)r=URL.createObjectURL(e);else{var i;e instanceof ArrayBuffer?i=[e]:e.buffer?(e.byteLength<e.buffer.byteLength&&(e=new Uint8Array(e)),i=[e.buffer]):e instanceof Array&&(i=e);var o=new Blob(i,{type:n});r=URL.createObjectURL(o)}var a=document.createElement("a");a.href=r,a.download=t,a.appendChild(document.createTextNode(t)),a.style.display="none",document.body.appendChild(a),a.click(),setTimeout((function(){URL.revokeObjectURL(r),a.remove()}),911)}});function wt(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var r,n=O(e);if(t){var i=O(this).constructor;r=Reflect.construct(n,arguments,i)}else r=n.apply(this,arguments);return A(this,r)}}var xt=function(e){R(n,e);var t,r=wt(n);function n(e,t,i){var o,a=arguments.length>3&&void 0!==arguments[3]?arguments[3]:1;return P(this,n),o=r.call(this,e),isFinite(i)&&(a=i,i=void 0),a<=0&&(console.warn("Invalid spacing found ".concat(a,". It should be positive number.")),a=1),Object.defineProperty(T(o),"shape",{get:function(){return t},set:function(e){if(e instanceof Float32Array&&(e=new ft(e)),e instanceof ft&&(e=[e]),e.some((function(e){return!(e instanceof ft)})))throw console.warn(e),new Error("Brush2D: Invalid shape found");e.sort(re.comparator({sortBy:"size",sortOrder:"asc"})),t=e},enumerable:!0}),o.shape=t,o.fill=i,o.spacing=a,o}return w(n,[{key:"configure",value:(t=fe(pe.mark((function e(t){var r;return pe.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!this.pattern&&this.fill){e.next=2;break}return e.abrupt("return");case 2:if(t instanceof CanvasRenderingContext2D||t instanceof OffscreenCanvasRenderingContext2D){e.next=4;break}throw new Error("ctx is not instance of CanvasRenderingContext2D or OffscreenCanvasRenderingContext2D");case 4:return e.next=6,Et(this.fill);case 6:r=e.sent,this.pattern=t.createPattern(r,"repeat");case 8:case"end":return e.stop()}}),e,this)}))),function(e){return t.apply(this,arguments)})},{key:"selectShape",value:function(e){for(var t,r=1;r<this.shape.length;r++)if(this.shape[r].size>e){t=this.shape[r-1];break}return t||(t=this.shape.last),t.shape}},{key:"toJSON",value:function(){var e=this;return{type:"Brush2D",name:this.name,spacing:this.spacing,shape:this.shape.map((function(t){return t.encoding=e.encoding,t.toJSON()}))}}}],[{key:"fromJSON",value:function(e){var t=1==e.shape.length?ft.fromJSON(e.shape[0]):e.shape.map((function(e){return ft.fromJSON(e)}));return new n(e.name,t,e.spacing)}}]),n}(ze),St=function(){function e(){P(this,e),this.state={}}return w(e,[{key:"isLayoutPart",value:function(t){if(e.posProps.includes(t))return this.inputLayout.includes(t.name);if(this.brush instanceof xt&&e.colorProps.includes(t))return!1;if(e.excludedProps.includes(t))return!1;var r=!1,n=re.getPropName(t.name),i=this.dynamics[n];if(i&&!i.disabled)if(i.dependencies&&i.dependencies.length>0){var o=this.inputLayout.map((function(e){return Re.Type[e]}));r=i.dependencies.filter((function(e){return o.includes(e)})).length>0}else r=!0;return r}},{key:"calculate",value:function(t,r,n){var i=this;return this.point=r.createPathPoint(this.statics),this.calculateProperty(le.Property.SIZE,t,r,n),e.colorProps.forEach((function(e){return i.calculateProperty(e,t,r,n)})),e.transformProps.forEach((function(e){return i.calculateTransform(e,t,r,n)})),this.point}},{key:"calculateProperty",value:function(t,r,n,i){if(this.layout.includes(t)){var o,a=re.getPropName(t.name),s=this.dynamics[a],u=this.state[a];if("function"==typeof u.resolve)o=u.resolve(r,n,i);else if(this.inputLayout.includes("PRESSURE")){var c=n.pressure||r.pressure/2;o=e.mapTo(c,u.pressure,s.value)}else{var l=n.speed(r,i);0==l&&r&&(l=r.velocity),n.velocity=l,o=e.mapTo(l,u.velocity,s.value)}this.point[re.getPropName(t.name)]=o}}},{key:"calculateTransform",value:function(t,r,n,i){if(this.layout.includes(t)){var o,a=re.getPropName(t.name),s=this.dynamics[a],u=this.state[a];if("function"==typeof u.resolve)o=u.resolve(r,n,i);else{var c=s.dependencies||[];if(t==le.Property.ROTATION)if(c.includes(Re.Type.ROTATION)&&this.inputLayout.includes("ROTATION"))o=n.rotation;else{if(!c.includes(Re.Type.AZIMUTH)||!this.inputLayout.includes("AZIMUTH"))throw new Error("Property ".concat(t.name," is not configured properly. Dependencies are expected or resolve handler."));o=n.computeNearestAzimuthAngle(r)}else if(c.includes(Re.Type.ALTITUDE)&&this.inputLayout.includes("ALTITUDE")){n.cosAltitude||(n.cosAltitude=Math.cos(n.altitude));var l=n.cosAltitude;o=e.mapTo(l,u.altitude,s.value)}else{if(t!=le.Property.SCALE_X&&t!=le.Property.SCALE_Y||!c.includes(Re.Type.RADIUS_X)&&!c.includes(Re.Type.RADIUS_Y)||!this.inputLayout.includes("RADIUS_X")||!this.inputLayout.includes("RADIUS_Y"))throw new Error("Property ".concat(t.name," is not configured properly. Dependencies are expected or resolve handler."));var h=t==le.Property.SCALE_X?"radiusX":"radiusY",f=n[h];o=e.mapTo(f,u[h],s.value)}}if(isNaN(o))throw new Error("Property ".concat(t.name," has no value"));this.point[re.getPropName(t.name)]=o}}},{key:"reset",value:function(t,r,n){var i=this,o=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{},a=arguments.length>4&&void 0!==arguments[4]?arguments[4]:{};if(this.brush=r,this.dynamics=o,this.statics={},this.color=new We(0,0,0),this.inputLayout=je.getLayout(t),this.layout=le.Property.values.filter((function(e){return i.isLayoutPart(e)})),this.debug&&console.log(t.pointer.type,this.inputLayout,this.layout.map((function(e){return e.name})),t),"size"in a){if(this.isLayoutPart(le.Property.SIZE))throw new Error("Size should exist only in dynamics or statics");this.statics.size=a.size}else{if(!this.isLayoutPart(le.Property.SIZE))throw new Error("Size not found. Should be set through dynamics or statics.");if(0==t.pressure&&"pen"==t.pointer.type)throw new Error("Hover point detected. Should be handeled manually.")}e.colorProps.forEach((function(e){var t=re.getPropName(e.name);i.isLayoutPart(e)?i.color[t]=n[t]:(i.statics[t]=isFinite(a[t])?a[t]:n[t],i.color[t]=i.statics[t])})),e.transformProps.forEach((function(e){if(!i.isLayoutPart(e)){var t=re.getPropName(e.name);isFinite(a[t])&&(i.statics[t]=a[t])}})),this.resetState(t)}},{key:"resetState",value:function(t){var r=this;this.state={},[le.Property.SIZE].concat(e.colorProps).forEach((function(t){if(r.layout.includes(t)){var n=re.getPropName(t.name),i=r.dynamics[n],o={};if(i.resolve)o.resolve=e.resolveAction(i.resolve);else{if(!i.value)throw new Error("PathPointContext: dynamics ".concat(n," value property not found"));if(i.value.min>i.value.max)throw new Error("PathPointContext: dynamics ".concat(n," invalid value range found: ").concat(i.value.min," - ").concat(i.value.max));var a=r.clonePropertySettings(i.velocity,0,4e3);a.remap=e.resolveAction(a.remap||i.value.remap);var s=r.clonePropertySettings(i.pressure,0,1);s.remap=e.resolveAction(s.remap||i.value.remap),o.velocity=e.validateRange(n,a,{min:0,max:3e4}),o.pressure=e.validateRange(n,s,{min:0,max:1})}r.state[n]=o}})),e.transformProps.forEach((function(n){if(r.layout.includes(n)){var i=re.getPropName(n.name),o=r.dynamics[i],a={};if(o.resolve)a.resolve=e.resolveAction(o.resolve);else if(o.dependencies){if(o.dependencies.includes(Re.Type.ALTITUDE)){if(!o.value)throw new Error("PathPointContext: dynamics ".concat(i," value property not found"));if(o.value.min>o.value.max)throw new Error("PathPointContext: dynamics ".concat(i," invalid value range found: ").concat(o.value.min," - ").concat(o.value.max));var s=r.clonePropertySettings(o.altitude,0,Math.PI/2);s.remap=e.resolveAction(s.remap||o.value.remap),a.altitude=e.validateRange(i,s,{min:0,max:Math.PI/2})}if(n==le.Property.SCALE_X&&o.dependencies.includes(Re.Type.RADIUS_X)||n==le.Property.SCALE_Y&&o.dependencies.includes(Re.Type.RADIUS_Y)){if(!o.value)throw new Error("PathPointContext: dynamics ".concat(i," value property not found"));var u=n==le.Property.SCALE_X?"radiusX":"radiusY",c=o[u]||{},l=t[u]<=1?0:1,h=t[u]<=1?1:50,f=t[u]<=1?{min:0,max:1,remap:c.remap}:c,d=r.clonePropertySettings(f,l,h);d.remap=e.resolveAction(d.remap||o.value.remap),a[u]=e.validateRange(i,d,{min:l,max:h})}}r.state[i]=a}}))}},{key:"clonePropertySettings",value:function(e,t,r){var n;return e?("min"in(n=Object.clone(e))||(n.min=t),"max"in n||(n.max=r)):n={min:t,max:r},n}}],[{key:"excludedProps",get:function(){return[le.Property.D_X,le.Property.D_Y]}},{key:"posProps",get:function(){return[le.Property.X,le.Property.Y,le.Property.Z]}},{key:"colorProps",get:function(){return[le.Property.RED,le.Property.GREEN,le.Property.BLUE,le.Property.ALPHA]}},{key:"transformProps",get:function(){return[le.Property.ROTATION,le.Property.SCALE_X,le.Property.SCALE_Y,le.Property.SCALE_Z,le.Property.OFFSET_X,le.Property.OFFSET_Y,le.Property.OFFSET_Z]}},{key:"resolveAction",value:function(e){if(e)return"string"==typeof e?e=new Xe(e):"function"==typeof e?e=Xe.getInstance(e):e instanceof Xe||(e=new Xe(e.name,e.value)),e.value}},{key:"validateRange",value:function(e,t,r){if(t.min<r.min||t.max>r.max)throw new Error("".concat(e," config is out of range - (").concat(t.min,", ").concat(t.max,"), expected values interval - (").concat(r.min,", ").concat(r.max,")"));if(t.min>t.max)throw new Error("".concat(e," min ").concat(t.min," exceeds max ").concat(t.max));return t}},{key:"mapTo",value:function(e,t,r){var n=(re.clamp(e,t)-t.min)/(t.max-t.min);return t.remap&&(n=t.remap(n)),r.min+n*(r.max-r.min)}}]),e}(),It=function(){function e(){var t=this;P(this,e),this.keepAllData=!1,Object.defineProperty(this,"allData",{get:function(){if(!t.keepAllData)throw new Error("All data is not accumulated. By default keepAllData property is false.");return t.path||(t.path=new t.constructor.ARRAY_TYPE),t.getOutput(t.path,e.OutputType.ALL_DATA)},enumerable:!0})}return w(e,[{key:"build",value:function(t){var r,n,i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:e.OutputType.PROCESSOR,o=!(arguments.length>2&&void 0!==arguments[2])||arguments[2];switch(i){case e.OutputType.ADDITION:r=this.add(t,o);break;case e.OutputType.PREDICTION:r=this.predict(t);break;case e.OutputType.PROCESSOR:this.reset(),r=this.buildImpl(t,i);break;default:throw new Error("Unexpected OutputType found. Allowed type is oneof(ADDITION, PREDICTION, PROCESSOR)")}i!=e.OutputType.PREDICTION&&(this.keepAllData&&(this.path||(this.path=new this.constructor.ARRAY_TYPE),r instanceof ht?this.path.push(r):(n=this.path).push.apply(n,te(r))));return this.debug&&console.log(this.constructor.name,i.name,o,r),this.getOutput(r,i)}},{key:"add",value:function(t){return this.buildImpl(t,e.OutputType.ADDITION)}},{key:"predict",value:function(t){return this.buildImpl(t,e.OutputType.PREDICTION)}},{key:"buildImpl",value:function(e){throw new Error("Abstract method buildImpl(input) of DataSequenceProcessor should be implemented")}},{key:"getOutput",value:function(e,t){return e}},{key:"reset",value:function(){this.path&&(this.path=new this.constructor.ARRAY_TYPE)}}]),e}();function Rt(){}S(It,"ARRAY_TYPE",Array),Object.defineEnum(It,"OutputType",["ADDITION","PREDICTION","ALL_DATA","PROCESSOR"]),Rt.BlendMode={SOURCE_OVER:"source-over",DESTINATION_OVER:"destination-over",DESTINATION_IN:"destination-in",DESTINATION_OUT:"destination-out",LIGHTER:"lighter",COPY:"copy",MIN:"MIN",MAX:"MAX",DIRECT_SOURCE_OUT:"DIRECT_SOURCE_OUT",DIRECT_DESTINATION_OUT:"DIRECT_DESTINATION_OUT"};var Tt=Rt.BlendMode,At=function(){function e(t){var r,n,i=this;if(P(this,e),!t)throw new Error("GL context is not available in current environment");this.gl=t,this.program=null,this.programs=[],Object.defineProperty(this,"blendMode",{get:function(){return r},set:function(e){if(!e)throw new Error("blendMode is required");r!=e&&(i.activeBlendMode(e),r=e)},enumerable:!0}),Object.defineProperty(this,"transform",{get:function(){return n&&!n.isIdentity?n:null},set:function(e){e!=n&&(n=e,i.program&&i.program.onContextChange())}}),Object.defineProperty(e,"VERTEX_SHADER_PRECISION",{value:this.getSupportedFloatPrecision(this.gl.VERTEX_SHADER),enumerable:!0,configurable:!0}),Object.defineProperty(e,"FRAGMENT_SHADER_PRECISION",{value:this.getSupportedFloatPrecision(this.gl.FRAGMENT_SHADER),enumerable:!0,configurable:!0}),Object.defineProperty(e,"VERTEX_BATCH_SIZE",{value:1e3,enumerable:!0})}return w(e,[{key:"init",value:function(e,t){this.gl.disable(this.gl.DITHER),this.gl.disable(this.gl.BLEND),this.gl.disable(this.gl.STENCIL_TEST),this.gl.disable(this.gl.DEPTH_TEST),this.gl.disable(this.gl.SCISSOR_TEST),this.gl.activeTexture(this.gl.TEXTURE0),this.blendMinMaxExt=this.gl.getExtension("EXT_blend_minmax"),this.blendMaxFallback=!this.gl.MAX&&!this.blendMinMaxExt,this.blendMode=Tt.COPY,this.resize(e,t),this.scatterMethodRandomSeed=parseInt(Date.now()/1e3),this.onChange();for(var r=0;r<this.programs.length;r++)this.programs[r].init()}},{key:"getSupportedFloatPrecision",value:function(e){return this.gl.getShaderPrecisionFormat(e,this.gl.HIGH_FLOAT).precision>0?"highp":this.gl.getShaderPrecisionFormat(e,this.gl.MEDIUM_FLOAT).precision>0?"mediump":"lowp"}},{key:"random",value:function(){return this.scatterMethodRandomSeed=1103515245*this.scatterMethodRandomSeed+12345&Number.MAX_INT32,this.scatterMethodRandomSeed/Number.MAX_INT32}},{key:"setUniforms",value:function(e){var t=i.mat4.create();e?i.mat4.ortho(t,this.graphicsBox.left,this.graphicsBox.right,this.graphicsBox.top,this.graphicsBox.bottom,1,-1):i.mat4.ortho(t,this.graphicsBox.left,this.graphicsBox.right,this.graphicsBox.bottom,this.graphicsBox.top,1,-1),this.graphicsSpaceToFramebufferSpaceT=t,this.onChange()}},{key:"resize",value:function(e,t){this.gl.viewport(e.x,e.y,e.width,e.height),this.bounds=e,this.graphicsBox=t,this.clipRect=t}},{key:"activeBlendMode",value:function(e){switch(e){case Tt.COPY:this.gl.disable(this.gl.BLEND);break;case Tt.SOURCE_OVER:this.gl.enable(this.gl.BLEND),this.gl.blendEquation(this.gl.FUNC_ADD),this.gl.blendFunc(this.gl.ONE,this.gl.ONE_MINUS_SRC_ALPHA);break;case Tt.DESTINATION_OVER:this.gl.enable(this.gl.BLEND),this.gl.blendEquation(this.gl.FUNC_ADD),this.gl.blendFunc(this.gl.ONE_MINUS_DST_ALPHA,this.gl.ONE);break;case Tt.DESTINATION_IN:this.gl.enable(this.gl.BLEND),this.gl.blendEquation(this.gl.FUNC_ADD),this.gl.blendFunc(this.gl.ZERO,this.gl.SRC_ALPHA);break;case Tt.DESTINATION_OUT:this.gl.enable(this.gl.BLEND),this.gl.blendEquation(this.gl.FUNC_ADD),this.gl.blendFunc(this.gl.ZERO,this.gl.ONE_MINUS_SRC_ALPHA);break;case Tt.DESTINATION_IN_MULTIPLY:this.gl.enable(this.gl.BLEND),this.gl.blendEquation(this.gl.FUNC_ADD),this.gl.blendFunc(this.gl.ZERO,this.gl.SRC_COLOR);break;case Tt.DESTINATION_OUT_NO_ALPHA:this.gl.enable(this.gl.BLEND),this.gl.blendEquation(this.gl.FUNC_ADD),this.gl.blendFunc(this.gl.ZERO,this.gl.ONE_MINUS_SRC_COLOR);break;case Tt.LIGHTER:this.gl.enable(this.gl.BLEND),this.gl.blendEquation(this.gl.FUNC_ADD),this.gl.blendFunc(this.gl.ONE,this.gl.ONE);break;case Tt.MIN:this.gl.enable(this.gl.BLEND),this.gl.MIN?this.gl.blendEquation(this.gl.MIN):this.blendMinMaxExt?this.gl.blendEquation(this.blendMinMaxExt.MIN_EXT):(this.gl.blendEquation(this.gl.FUNC_ADD),this.gl.blendFunc(this.gl.ONE,this.gl.ONE_MINUS_SRC_ALPHA));break;case Tt.MAX:this.gl.enable(this.gl.BLEND),this.gl.MAX?this.gl.blendEquation(this.gl.MAX):this.blendMinMaxExt?this.gl.blendEquation(this.blendMinMaxExt.MAX_EXT):(this.gl.blendEquation(this.gl.FUNC_ADD),this.gl.blendFunc(this.gl.ONE,this.gl.ONE_MINUS_SRC_ALPHA));break;case Tt.DIRECT_SOURCE_OUT:this.gl.enable(this.gl.BLEND),this.gl.blendEquation(this.gl.FUNC_SUBTRACT),this.gl.blendFunc(this.gl.ONE,this.gl.ONE);break;case Tt.DIRECT_DESTINATION_OUT:this.gl.enable(this.gl.BLEND),this.gl.blendEquation(this.gl.FUNC_REVERSE_SUBTRACT),this.gl.blendFunc(this.gl.ONE,this.gl.ONE);break;default:throw new Error("Unsupported blend mode: ".concat(e))}}},{key:"clearColorBuffer",value:function(e){this.gl.clearColor(e.red*e.alpha/255,e.green*e.alpha/255,e.blue*e.alpha/255,e.alpha),this.gl.clear(this.gl.COLOR_BUFFER_BIT)}},{key:"scissors",value:function(e){if(e&&!(e instanceof z))throw new TypeError("rect must be undefined or instanceof RectGL");var t=this.gl.isEnabled(this.gl.SCISSOR_TEST);e?(t||this.gl.enable(this.gl.SCISSOR_TEST),this.gl.scissor(e.x,e.y,e.width,e.height)):t&&this.gl.disable(this.gl.SCISSOR_TEST)}},{key:"isProgramActive",value:function(e){return this.program==e}},{key:"activateProgram",value:function(e){this.isProgramActive(e)?e.contextChanged&&(e.onContextChange(),e.contextChanged=!1):(this.program&&this.program.onDeactivate(),this.gl.useProgram(e.program),this.program=e,e.onActivate(),e.onContextChange(),e.contextChanged=!1)}},{key:"generateBuffersExt",value:function(e,t,r,n){var i=this.gl,o=i.createFramebuffer();i.bindFramebuffer(i.FRAMEBUFFER,o);var a=i.createTexture();return i.activeTexture(i.TEXTURE0),i.bindTexture(i.TEXTURE_2D,a),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_WRAP_S,i.CLAMP_TO_EDGE),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_WRAP_T,i.CLAMP_TO_EDGE),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_MAG_FILTER,r),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_MIN_FILTER,r),i.texImage2D(i.TEXTURE_2D,0,i.RGBA,e,t,0,i.RGBA,n,null),i.framebufferTexture2D(i.FRAMEBUFFER,i.COLOR_ATTACHMENT0,i.TEXTURE_2D,a,0),i.clearColor(0,0,0,0),i.clear(i.COLOR_BUFFER_BIT),{framebuffer:o,texture:a}}},{key:"genFrameAndRenders",value:function(e,t,r){var n=this.gl.createFramebuffer(),i=this.gl.createRenderbuffer();return this.gl.bindFramebuffer(this.gl.FRAMEBUFFER,n),this.gl.bindRenderbuffer(this.gl.RENDERBUFFER,i),this.gl.renderbufferStorage(this.gl.RENDERBUFFER,e,t,r),this.gl.framebufferRenderbuffer(this.gl.FRAMEBUFFER,this.gl.COLOR_ATTACHMENT0,this.gl.RENDERBUFFER,i),{framebuffer:n,renderbuffer:i}}},{key:"deleteBuffers",value:function(e,t){t&&this.gl.deleteTexture(t),e&&this.gl.deleteFramebuffer(e)}},{key:"deleteFrameAndRender",value:function(e,t){t&&this.gl.deleteRenderbuffer(t),e&&this.gl.deleteFramebuffer(e)}},{key:"onChange",value:function(){for(var e=0;e<this.programs.length;e++)this.programs[e].contextChanged=!0}},{key:"enableStencilBufferForBlending",value:function(e){this.gl.enable(this.gl.STENCIL_TEST),this.gl.stencilMask(4294967295),this.gl.clearStencil(0),this.gl.clear(this.gl.STENCIL_BUFFER_BIT),this.isStencilBufferAvailable()||this.attachStencilBufferForBlending(e)}},{key:"isStencilBufferAvailable",value:function(){return this.gl.getFramebufferAttachmentParameter(this.gl.FRAMEBUFFER,this.gl.STENCIL_ATTACHMENT,this.gl.FRAMEBUFFER_ATTACHMENT_OBJECT_TYPE)==this.gl.RENDERBUFFER}},{key:"attachStencilBufferForBlending",value:function(e){var t=this.gl.getParameter(this.gl.FRAMEBUFFER_BINDING);if(e.framebuffer==t){var r=this.gl.createRenderbuffer();this.gl.bindRenderbuffer(this.gl.RENDERBUFFER,r),this.gl.renderbufferStorage(this.gl.RENDERBUFFER,this.gl.STENCIL_INDEX8,e.width,e.height),this.gl.framebufferRenderbuffer(this.gl.FRAMEBUFFER,this.gl.STENCIL_ATTACHMENT,this.gl.RENDERBUFFER,r),e.renderbuffer=r,e.releaseRenderbuffer=!0}}},{key:"drawArrays",value:function(e,t,r){this.blendMode==Tt.MAX&&this.blendMaxFallback?this.drawBlendMaxFallback(this.gl.drawArrays.bind(this.gl,e,t,r)):this.gl.drawArrays(e,t,r)}},{key:"drawElements",value:function(e,t,r,n){this.blendMode==Tt.MAX&&this.blendMaxFallback?this.drawBlendMaxFallback(this.gl.drawElements.bind(this.gl,e,t,r,n)):this.gl.drawElements(e,t,r,n)}},{key:"drawBlendMaxFallback",value:function(e){this.gl.enable(this.gl.STENCIL_TEST),this.gl.stencilFunc(this.gl.NOTEQUAL,1,1),this.gl.stencilOp(this.gl.REPLACE,this.gl.REPLACE,this.gl.REPLACE),this.blendMode=Tt.DIRECT_DESTINATION_OUT,e(),this.gl.stencilFunc(this.gl.NOTEQUAL,2,1),this.gl.stencilOp(this.gl.REPLACE,this.gl.REPLACE,this.gl.REPLACE),this.inkGLContext.blendMode=Tt.LIGHTER,e(),this.gl.disable(this.gl.STENCIL_TEST)}}],[{key:"random",value:function(e){return(1103515245*e+12345&Number.MAX_INT32)/Number.MAX_INT32}},{key:"logGLError",value:function(e){var t,r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"",n=e.getError();n>0&&(e.constructor.prototype&&(t=Object.keys(e.constructor.prototype).filter((function(t){return e[t]===n})).join(" | ")),console.error("WebGL".concat(r?" ":"").concat(r,": ").concat(n).concat(t?" - ".concat(t):"")))}}]),e}();S(At,"ANTIALIASING",{passesSqrt:4,passes:16,spread:1.25,step:.3125,weight:1.01/16}),S(At,"IDENTITY_MATRIX",i.mat4.create());var Ot=function(){function e(){P(this,e)}var t,r;return w(e,[{key:"setTransform",value:function(e){this.matrix=e}},{key:"getExportCanvas",value:function(e){throw new Error("Abstract method getExportCanvas of Layer inheritor should be implemented")}},{key:"toBlob",value:(r=fe(pe.mark((function e(t){var r,n,i,o=arguments;return pe.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r=o.length>1&&void 0!==o[1]?o[1]:"image/png",n=o.length>2&&void 0!==o[2]?o[2]:.92,"undefined"!=typeof Blob){e.next=8;break}if("undefined"!=typeof Buffer){e.next=7;break}throw new Error("Current environment do not have neither Blob nor Buffer support.");case 7:throw new Error("This method is not compliant in underlying environment. Use `toBuffer` instead.");case 8:if(!(i=this.getExportCanvas(t)).toBlob){e.next=13;break}return e.abrupt("return",new Promise((function(e,t){return i.toBlob(e,r,n)})));case 13:return e.abrupt("return",i.convertToBlob({type:r,quality:n}));case 14:case"end":return e.stop()}}),e,this)}))),function(e){return r.apply(this,arguments)})},{key:"toBuffer",value:(t=fe(pe.mark((function e(t){var r,n,i,o,a,s=arguments;return pe.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r=s.length>1&&void 0!==s[1]?s[1]:"image/png",n=s.length>2&&void 0!==s[2]?s[2]:{},"undefined"!=typeof Buffer){e.next=8;break}if("undefined"!=typeof Blob){e.next=7;break}throw new Error("Current environment do not have neither Blob nor Buffer support.");case 7:throw new Error("This method is not compliant in underlying environment. Use `toBlob` instead.");case 8:return i=this.getExportCanvas(t),n.filters&&(o=Array.isArray(n.filters)?n.filters.slice():[n.filters],a=0,o.forEach((function(e){a|=i["PNG_FILTER_".concat(e.name)]})),Object.assign({},n,{filters:a})),e.abrupt("return",new Promise((function(e,t){return i.toBuffer((function(r,n){return r?t(r):e(n)}),r,n)})));case 11:case"end":return e.stop()}}),e,this)}))),function(e){return t.apply(this,arguments)})}],[{key:"getDefaultSize",value:function(e,t){var r={};return"undefined"==typeof screen?(r.width=e,r.height=t):navigator.maxTouchPoints?(r.width=Math.max(screen.width,screen.height),r.height=r.width):(r.width=screen.width,r.height=screen.height),r}}]),e}();function Ct(e,t){var r="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!r){if(Array.isArray(e)||(r=function(e,t){if(!e)return;if("string"==typeof e)return Dt(e,t);var r=Object.prototype.toString.call(e).slice(8,-1);"Object"===r&&e.constructor&&(r=e.constructor.name);if("Map"===r||"Set"===r)return Array.from(e);if("Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r))return Dt(e,t)}(e))||t&&e&&"number"==typeof e.length){r&&(e=r);var n=0,i=function(){};return{s:i,n:function(){return n>=e.length?{done:!0}:{done:!1,value:e[n++]}},e:function(e){throw e},f:i}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var o,a=!0,s=!1;return{s:function(){r=r.call(e)},n:function(){var e=r.next();return a=e.done,e},e:function(e){s=!0,o=e},f:function(){try{a||null==r.return||r.return()}finally{if(s)throw o}}}}function Dt(e,t){(null==t||t>e.length)&&(t=e.length);for(var r=0,n=new Array(t);r<t;r++)n[r]=e[r];return n}Object.defineEnum(Ot,"PNGFilterType",["NO","ALL","NONE","SUB","UP","AVG","PAETH"]);var Nt=function(){function e(t,r){P(this,e),Object.defineProperty(this,"ctx",{value:t,enumerable:!0}),Object.defineProperty(this,"value",{value:r,enumerable:!0}),Object.defineProperty(this,"texture",{value:r,enumerable:!0})}var t;return w(e,[{key:"update",value:(t=fe(pe.mark((function e(t,r){var n,i,o,a,s,u,c;return pe.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!Array.isArray(t)){e.next=26;break}n=[],i=Ct(t),e.prev=4,i.s();case 6:if((o=i.n()).done){e.next=14;break}return a=o.value,e.next=10,Et(a);case 10:s=e.sent,n.push(s);case 12:e.next=6;break;case 14:e.next=19;break;case 16:e.prev=16,e.t0=e.catch(4),i.e(e.t0);case 19:return e.prev=19,i.f(),e.finish(19);case 22:this.completeMipMap(n),this.fill(n,r),e.next=31;break;case 26:return u=t,e.next=29,Et(u);case 29:c=e.sent,this.fill(c);case 31:case"end":return e.stop()}}),e,this,[[4,16,19,22]])}))),function(e,r){return t.apply(this,arguments)})},{key:"completeMipMap",value:function(e){if(e.sort((function(e,t){return t.width-e.width})),1!=e.last.width)for(var t=e.last.width;t>1;){t/=2;var r=new OffscreenCanvas(e.last.width/2,e.last.height/2);r.getContext("2d").drawImage(e.last,0,0,r.width,r.height),e.push(r)}}},{key:"fill",value:function(e,t){var r=this,n=this.ctx,i=this.value;if(n.bindTexture(n.TEXTURE_2D,i),n.pixelStorei(n.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!0),Array.isArray(e)){var o=e;this.size=[],o.forEach((function(e,t){n.texImage2D(n.TEXTURE_2D,t,n.RGBA,n.RGBA,n.UNSIGNED_BYTE,e),r.size.push({width:e.width,height:e.height}),e.close&&e.close()})),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_MIN_FILTER,t?n.LINEAR_MIPMAP_LINEAR:n.LINEAR_MIPMAP_NEAREST),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_MAG_FILTER,n.LINEAR)}else n.texImage2D(n.TEXTURE_2D,0,n.RGBA,n.RGBA,n.UNSIGNED_BYTE,e),this.size={width:e.width,height:e.height},e.close&&e.close();n.pixelStorei(n.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!1),n.bindTexture(n.TEXTURE_2D,null),this.logError(this.ctx,i.name)}},{key:"readPixels",value:function(){var e=this.ctx,t=this.value,r=function(r,n){var i=new Uint8Array(r.width*r.height*4);return e.framebufferTexture2D(e.FRAMEBUFFER,e.COLOR_ATTACHMENT0,e.TEXTURE_2D,t,n),e.readPixels(0,0,r.width,r.height,e.RGBA,e.UNSIGNED_BYTE,i),i},n=e.createFramebuffer();e.bindFramebuffer(e.FRAMEBUFFER,n);var i=Array.isArray(this.size)?this.size.map(r):r(this.size,0);return e.deleteFramebuffer(n),i}},{key:"logError",value:function(){var e=this,t=this.ctx.getError();if(t>0){var r=Object.keys(this.ctx.constructor.prototype).filter((function(r){return e.ctx[r]===t})).join(" | ");console.error("WebGL error - ".concat(this.texture.name,": ").concat(t," - ").concat(r))}}}],[{key:"createInstance",value:function(t){var r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:t.CLAMP_TO_EDGE,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:t.NEAREST,i=t.createTexture();return t.bindTexture(t.TEXTURE_2D,i),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,r),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,r),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,n),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,n),t.bindTexture(t.TEXTURE_2D,null),new e(t,i)}}]),e}();function Mt(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var r,n=O(e);if(t){var i=O(this).constructor;r=Reflect.construct(n,arguments,i)}else r=n.apply(this,arguments);return A(this,r)}}var Lt=function(e){R(r,e);var t=Mt(r);function r(e){var n,i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};if(P(this,r),(n=t.call(this)).inkGLContext=e,n.gl=e.gl,n.scaleFactor=i.scaleFactor||1,n.flipY=!!i.flipY,n.useTextureStorage=!1,i.renderbuffer){if(!i.framebuffer)throw new Error("`framebuffer` is required when `renderbuffer` available");var o=n.initWithGLBuffers(i.framebuffer,i.renderbuffer);n.flipY=!0,n.ownGLResources=!!i.ownGLResources,n.setDimensions(o.width,o.height)}else if(i.framebuffer){var a=n.initWithGLFramebuffer(i.framebuffer);n.flipY=!0,n.ownGLResources=!!i.ownGLResources,n.setDimensions(a.width,a.height)}else if(i.texture){if(!(i.texture instanceof WebGLTexture))throw new Error("`texture` is not instance of WebGLTexture");var s;if(n.texture=i.texture,n.useTextureStorage=!0,i.width>0&&i.height>0)s={width:i.width,height:i.height};else if(n.texture.image)s={width:n.texture.image.width,height:n.texture.image.height};else{if(!n.texture.size)throw new Error("`width` and `height` are required when `texture` is available");s=n.texture.size}n.ownGLResources=!!i.ownGLResources,n.setDimensions(s.width,s.height)}else if(n.setDimensions(i.width,i.height),i.display)n.framebuffer=null,n.renderbuffer=null,n.texture=null;else if(n.useTextureStorage=!i.useBuffersStorage,n.ownGLResources=!0,n.useTextureStorage){var u=n.inkGLContext.generateBuffersExt(n.storageWidth,n.storageHeight,n.gl.LINEAR,n.gl.UNSIGNED_BYTE);n.framebuffer=u.framebuffer,n.texture=u.texture}else{var c=n.inkGLContext.genFrameAndRenders(n.gl.RGBA8||n.gl.RGBA4,n.storageWidth,n.storageHeight);n.framebuffer=c.framebuffer,n.renderbuffer=c.renderbuffer}return n.releaseRenderbuffer=!1,n.deleted=!1,n}return w(r,[{key:"initWithGLFramebuffer",value:function(e){if(!(e instanceof WebGLFramebuffer))throw new Error("`framebuffer` is not instance of WebGLFramebuffer");var t,r=this.gl.getParameter(this.gl.RENDERBUFFER_BINDING);if(this.gl.bindFramebuffer(this.gl.FRAMEBUFFER,e),this.gl.getError()==this.gl.INVALID_OPERATION)throw new Error("Invalid framebuffer");if(this.gl.checkFramebufferStatus(this.gl.FRAMEBUFFER)!=this.gl.FRAMEBUFFER_COMPLETE)throw new Error("Incomplete framebuffer");if(this.gl.getFramebufferAttachmentParameter(this.gl.FRAMEBUFFER,this.gl.COLOR_ATTACHMENT0,this.gl.FRAMEBUFFER_ATTACHMENT_OBJECT_TYPE)!=this.gl.RENDERBUFFER)throw new Error("Renderbuffer attachment not found");return t=this.gl.getFramebufferAttachmentParameter(this.gl.FRAMEBUFFER,this.gl.COLOR_ATTACHMENT0,this.gl.FRAMEBUFFER_ATTACHMENT_OBJECT_NAME),this.gl.bindFramebuffer(this.gl.FRAMEBUFFER,r),this.initWithGLBuffers(e,t)}},{key:"initWithGLBuffers",value:function(e,t){if(!(e instanceof WebGLFramebuffer))throw new Error("`framebuffer` is not instance of WebGLFramebuffer");if(!(t instanceof WebGLRenderbuffer))throw new Error("`renderbuffer` is not instance of WebGLRenderbuffer");var r=this.gl.getParameter(this.gl.RENDERBUFFER_BINDING);this.gl.bindRenderbuffer(this.gl.RENDERBUFFER,t);var n=this.gl.getRenderbufferParameter(this.gl.RENDERBUFFER,this.gl.RENDERBUFFER_WIDTH),i=this.gl.getRenderbufferParameter(this.gl.RENDERBUFFER,this.gl.RENDERBUFFER_HEIGHT);return this.gl.bindRenderbuffer(this.gl.RENDERBUFFER,r),this.framebuffer=e,this.renderbuffer=t,{width:n,height:i}}},{key:"setDimensions",value:function(e,t){var r=Math.ceil(e*this.scaleFactor),n=Math.ceil(t*this.scaleFactor),i=new z(0,0,e,t),o=new z(0,0,r,n);Object.defineProperties(this,{width:{value:e,enumerable:!0,configurable:!0},height:{value:t,enumerable:!0,configurable:!0},graphicsBounds:{value:i,enumerable:!0,configurable:!0},storageWidth:{value:r,enumerable:!0,configurable:!0},storageHeight:{value:n,enumerable:!0,configurable:!0},storageBounds:{value:o,enumerable:!0,configurable:!0}})}},{key:"resize",value:function(e,t){e>0&&t>0&&(this.width!=e||this.height!=t)&&(this.setDimensions(e,t),this.useTextureStorage?(this.gl.bindTexture(this.gl.TEXTURE_2D,this.texture),this.gl.texImage2D(this.gl.TEXTURE_2D,0,this.gl.RGBA,this.storageWidth,this.storageHeight,0,this.gl.RGBA,this.gl.UNSIGNED_BYTE,null)):this.renderbuffer&&(this.gl.bindRenderbuffer(this.gl.RENDERBUFFER,this.renderbuffer),this.gl.renderbufferStorage(this.gl.RENDERBUFFER,this.gl.RGBA8||this.gl.RGBA4,this.storageWidth,this.storageHeight)))}},{key:"fillTexture",value:function(e){if(!this.texture)throw new Error("Underlying layer is not texture based");new Nt(this.gl,this.texture).fill(e)}},{key:"delete",value:function(){this.ownGLResources&&(this.useTextureStorage?this.inkGLContext.deleteBuffers(this.framebuffer,this.texture):this.inkGLContext.deleteFrameAndRender(this.framebuffer,this.renderbuffer)),this.releaseRenderbuffer&&this.renderbuffer&&(this.gl.deleteRenderbuffer(this.renderbuffer),this.renderbuffer=null,this.releaseRenderbuffer=!1),this.deleted=!0}},{key:"deleteLater",value:function(){var e=this;setTimeout((function(){return e.delete()}),0)}},{key:"isDeleted",value:function(){return this.deleted}}]),r}(Ot),Bt=function(){function e(t){P(this,e),this.gl=t.gl,this.inkGLContext=t,this.program=this.createProgram(this.compileShader(this.constructor.getVertexShader(),this.gl.VERTEX_SHADER),this.compileShader(this.constructor.getFragmentShader(this.gl.getContextAttributes().premultipliedAlpha),this.gl.FRAGMENT_SHADER)),this.contextChanged=!0}return w(e,[{key:"init",value:function(){}},{key:"compileShader",value:function(e,t){var r=this.gl.createShader(t);if(this.gl.shaderSource(r,e),this.gl.compileShader(r),!this.gl.getShaderParameter(r,this.gl.COMPILE_STATUS))throw new Error("".concat(this.constructor.name," could not compile ").concat(t==this.gl.VERTEX_SHADER?"VERTEX":"FRAGMENT"," shader: ").concat(this.gl.getShaderInfoLog(r)));return r}},{key:"createProgram",value:function(e,t){var r=this.gl.createProgram();if(this.gl.attachShader(r,e),this.gl.attachShader(r,t),this.gl.linkProgram(r),!this.gl.getProgramParameter(r,this.gl.LINK_STATUS))throw new Error("".concat(this.constructor.name," failed to link: ").concat(this.gl.getProgramInfoLog(r)));return r}},{key:"onActivate",value:function(){}},{key:"onDeactivate",value:function(){}},{key:"onContextChange",value:function(){}},{key:"activate",value:function(){this.inkGLContext.activateProgram(this)}}]),e}();function _t(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var r,n=O(e);if(t){var i=O(this).constructor;r=Reflect.construct(n,arguments,i)}else r=n.apply(this,arguments);return A(this,r)}}var Ft=function(e){R(r,e);var t=_t(r);function r(e){var n;return P(this,r),(n=t.call(this,e)).buffer=n.gl.createBuffer(),n}return w(r,[{key:"init",value:function(){this.a_position=this.gl.getAttribLocation(this.program,"a_position"),this.u_color=this.gl.getUniformLocation(this.program,"u_color"),this.u_projectionMatrix=this.gl.getUniformLocation(this.program,"u_projectionMatrix"),this.u_viewMatrix=this.gl.getUniformLocation(this.program,"u_viewMatrix")}},{key:"onContextChange",value:function(){this.gl.uniform4f(this.u_color,this.color.red,this.color.green,this.color.blue,this.color.alpha),this.gl.uniformMatrix4fv(this.u_projectionMatrix,!1,this.inkGLContext.graphicsSpaceToFramebufferSpaceT),this.gl.uniformMatrix4fv(this.u_viewMatrix,!1,this.inkGLContext.transform?this.inkGLContext.transform.value:At.IDENTITY_MATRIX)}},{key:"onDeactivate",value:function(){this.gl.disableVertexAttribArray(this.a_position),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,null)}},{key:"drawVertices",value:function(e,t,r){var n,i=!(arguments.length>3&&void 0!==arguments[3])||arguments[3],o=arguments.length>4&&void 0!==arguments[4]&&arguments[4],a=arguments.length>5&&void 0!==arguments[5]&&arguments[5];this.color=r.premultiply(),i&&!a?(t=this.antialias(t),n=Tt.LIGHTER):(Array.isArray(t)&&(t=new Float32Array(t)),n=a?Tt.MAX:Tt.SOURCE_OVER);var s=t.length/2;this.activate(),this.gl.bindFramebuffer(this.gl.FRAMEBUFFER,e),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.buffer),this.gl.bufferData(this.gl.ARRAY_BUFFER,t,this.gl.STATIC_DRAW),this.gl.enableVertexAttribArray(this.a_position),this.gl.vertexAttribPointer(this.a_position,2,this.gl.FLOAT,!1,0,0),o&&(this.inkGLContext.blendMode=Tt.DIRECT_DESTINATION_OUT,this.gl.drawArrays(this.gl.TRIANGLES,0,s)),this.inkGLContext.blendMode=n,this.gl.drawArrays(this.gl.TRIANGLES,0,s)}},{key:"antialias",value:function(e){for(var t=At.ANTIALIASING,r=t.passesSqrt,n=t.passes,i=t.spread,o=t.step,a=t.weight,s=new Float32Array(e.length*n),u=0,c=0;c<r;c++)for(var l=0;l<r;l++)for(var h=c*o-(i-o)/2,f=l*o-(i-o)/2,d=0;d<e.length;d+=2)s[u++]=e[d]+h,s[u++]=e[d+1]+f;return this.color={red:this.color.red*a,green:this.color.green*a,blue:this.color.blue*a,alpha:this.color.alpha*a},s}}],[{key:"getVertexShader",value:function(){return"\n\t\t\tprecision ".concat(At.VERTEX_SHADER_PRECISION," float;\n\n\t\t\tuniform mat4 u_projectionMatrix;\n\t\t\tuniform mat4 u_viewMatrix;\n\t\t\tuniform lowp vec4 u_color;\n\n\t\t\tattribute highp vec4 a_position;\n\n\t\t\tvarying lowp vec4 v_color;\n\n\t\t\tvoid main() {\n\t\t\t\tvec4 viewPosition = u_viewMatrix * a_position;\n\n\t\t\t\tgl_Position = u_projectionMatrix * viewPosition;\n\t\t\t\tv_color = u_color;\n\t\t\t}\n\t\t")}},{key:"getFragmentShader",value:function(){return"\n\t\t\tvarying lowp vec4 v_color;\n\n\t\t\tvoid main() {\n\t\t\t\tgl_FragColor = v_color;\n\t\t\t}\n\t\t"}}]),r}(Bt);function Ut(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var r,n=O(e);if(t){var i=O(this).constructor;r=Reflect.construct(n,arguments,i)}else r=n.apply(this,arguments);return A(this,r)}}var jt=16,Gt=jt*Float32Array.BYTES_PER_ELEMENT,Yt=function(e){R(r,e);var t=Ut(r);function r(e){var n;return P(this,r),(n=t.call(this,e)).vao=n.gl.createVertexArray(),n.positionBuffer=n.gl.createBuffer(),n.colorBuffer=n.gl.createBuffer(),n.matrixBuffer=n.gl.createBuffer(),n}return w(r,[{key:"init",value:function(){this.a_position=this.gl.getAttribLocation(this.program,"a_position"),this.a_color=this.gl.getAttribLocation(this.program,"a_color"),this.a_matrix=this.gl.getAttribLocation(this.program,"a_matrix"),this.u_viewMatrix=this.gl.getUniformLocation(this.program,"u_viewMatrix")}},{key:"onContextChange",value:function(){this.gl.uniformMatrix4fv(this.u_viewMatrix,!1,this.inkGLContext.transform?this.inkGLContext.transform.value:At.IDENTITY_MATRIX)}},{key:"onDeactivate",value:function(){this.gl.disableVertexAttribArray(this.a_position),this.gl.disableVertexAttribArray(this.a_color),this.gl.disableVertexAttribArray(this.a_matrix),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,null),this.gl.bindVertexArray(null)}},{key:"drawVertices",value:function(e,t,r){var n=!(arguments.length>3&&void 0!==arguments[3])||arguments[3],o=arguments.length>4&&void 0!==arguments[4]&&arguments[4],a=arguments.length>5&&void 0!==arguments[5]&&arguments[5];r=r.premultiply(),Array.isArray(t)&&(t=new Float32Array(t));var s,u,c,l=1,h=t.length/2,f=this.inkGLContext.graphicsSpaceToFramebufferSpaceT;if(n&&!a){var d=At.ANTIALIASING,p=d.passesSqrt,y=d.passes,v=d.spread,m=d.step,g=d.weight,b=[r.red*g,r.green*g,r.blue*g,r.alpha*g];l=y,s=new Float32Array(4*l),u=new Float32Array(l*jt);for(var E=0;E<l;++E)for(var P=0;P<4;P++)s[4*E+P]=b[P];for(var k=0;k<p;k++)for(var w=0;w<p;w++){for(var x=p*k+w,S=x*jt,I=S*Float32Array.BYTES_PER_ELEMENT,R=0;R<jt;R++)u[S+R]=f[R];var T=new Float32Array(u.buffer,I,jt),A=k*m-(v-m)/2,O=w*m-(v-m)/2;i.mat4.translate(T,T,i.vec4.fromValues(A,O,0,1))}c=Tt.LIGHTER}else s=new Float32Array([r.red,r.green,r.blue,r.alpha]),u=f,c=a?Tt.MAX:Tt.SOURCE_OVER;this.activate(),this.gl.bindFramebuffer(this.gl.FRAMEBUFFER,e),this.gl.bindVertexArray(this.vao),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.positionBuffer),this.gl.bufferData(this.gl.ARRAY_BUFFER,t,this.gl.STATIC_DRAW),this.gl.enableVertexAttribArray(this.a_position),this.gl.vertexAttribPointer(this.a_position,2,this.gl.FLOAT,!1,0,0),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.colorBuffer),this.gl.bufferData(this.gl.ARRAY_BUFFER,s,this.gl.STATIC_DRAW),this.gl.enableVertexAttribArray(this.a_color),this.gl.vertexAttribPointer(this.a_color,4,this.gl.FLOAT,!1,0,0),this.gl.vertexAttribDivisor(this.a_color,1),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.matrixBuffer),this.gl.bufferData(this.gl.ARRAY_BUFFER,u,this.gl.STATIC_DRAW);for(var C=0;C<4;C++){var D=this.a_matrix+C,N=16*C;this.gl.enableVertexAttribArray(D),this.gl.vertexAttribPointer(D,4,this.gl.FLOAT,!1,Gt,N),this.gl.vertexAttribDivisor(D,1)}o&&(this.inkGLContext.blendMode=Tt.DIRECT_DESTINATION_OUT,this.gl.drawArraysInstanced(this.gl.TRIANGLES,0,h,l)),this.inkGLContext.blendMode=c,this.gl.drawArraysInstanced(this.gl.TRIANGLES,0,h,l)}}],[{key:"getVertexShader",value:function(){return"#version 300 es\n\t\t\tin vec4 a_position;\n\t\t\tin vec4 a_color;\n\t\t\tin mat4 a_matrix;\n\n\t\t\tuniform mat4 u_viewMatrix;\n\n\t\t\tout vec4 v_color;\n\n\t\t\tvoid main() {\n\t\t\t\tvec4 viewPosition = u_viewMatrix * a_position;\n\n\t\t\t\tgl_Position = a_matrix * viewPosition;\n\t\t\t\tv_color = a_color;\n\t\t\t}\n\t\t"}},{key:"getFragmentShader",value:function(){return"#version 300 es\n\t\t\tprecision highp float;\n\n\t\t\tin vec4 v_color;\n\n\t\t\tout vec4 outColor;\n\n\t\t\tvoid main() {\n\t\t\t\toutColor = v_color;\n\t\t\t}\n\t\t"}}]),r}(Bt);function Xt(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var r,n=O(e);if(t){var i=O(this).constructor;r=Reflect.construct(n,arguments,i)}else r=n.apply(this,arguments);return A(this,r)}}var zt=function(e){R(r,e);var t=Xt(r);function r(e){var n;return P(this,r),(n=t.call(this,e)).destBuffer=n.gl.createBuffer(),n.srcBuffer=n.gl.createBuffer(),n}return w(r,[{key:"init",value:function(){this.a_position=this.gl.getAttribLocation(this.program,"a_position"),this.a_srcPosition=this.gl.getAttribLocation(this.program,"a_srcPosition"),this.u_texture=this.gl.getUniformLocation(this.program,"u_texture"),this.u_projectionMatrix=this.gl.getUniformLocation(this.program,"u_projectionMatrix"),this.u_textureMatrix=this.gl.getUniformLocation(this.program,"u_textureMatrix")}},{key:"onDeactivate",value:function(){this.gl.bindBuffer(this.gl.ARRAY_BUFFER,null)}},{key:"drawTexture",value:function(e,t,r,n,i){this.activate(),this.gl.disable(this.gl.DEPTH_TEST),this.gl.disable(this.gl.STENCIL_TEST),this.gl.activeTexture(this.gl.TEXTURE0),this.gl.bindTexture(this.gl.TEXTURE_2D,e),this.gl.uniform1i(this.u_texture,0),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.destBuffer),this.gl.bufferData(this.gl.ARRAY_BUFFER,t,this.gl.DYNAMIC_DRAW),this.gl.enableVertexAttribArray(this.a_position),this.gl.vertexAttribPointer(this.a_position,2,this.gl.FLOAT,!1,0,0),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.srcBuffer),this.gl.bufferData(this.gl.ARRAY_BUFFER,r,this.gl.DYNAMIC_DRAW),this.gl.enableVertexAttribArray(this.a_srcPosition),this.gl.vertexAttribPointer(this.a_srcPosition,2,this.gl.FLOAT,!1,0,0),this.gl.uniformMatrix4fv(this.u_projectionMatrix,!1,n),this.gl.uniformMatrix4fv(this.u_textureMatrix,!1,i),this.inkGLContext.drawArrays(this.gl.TRIANGLE_STRIP,0,4)}}],[{key:"getVertexShader",value:function(){return"\n\t\t\tprecision ".concat(At.VERTEX_SHADER_PRECISION," float;\n\n\t\t\tuniform mat4 u_projectionMatrix;\n\t\t\tuniform mat4 u_textureMatrix;\n\t\t\tattribute highp vec4 a_position;\n\t\t\tattribute highp vec4 a_srcPosition;\n\t\t\tvarying highp vec2 v_textureCoordinate;\n\n\t\t\tvoid main() {\n\t\t\t\tgl_Position = u_projectionMatrix * a_position;\n\t\t\t\tv_textureCoordinate = (u_textureMatrix * a_srcPosition).xy;\n\t\t\t}\n\t\t")}},{key:"getFragmentShader",value:function(){return"\n\t\t\tprecision ".concat(At.FRAGMENT_SHADER_PRECISION," float;\n\n\t\t\tvarying vec2 v_textureCoordinate;\n\t\t\tuniform lowp sampler2D u_texture;\n\n\t\t\tvoid main() {\n\t\t\t\tgl_FragColor = texture2D(u_texture, v_textureCoordinate);\n\t\t\t}\n\t\t")}}]),r}(Bt);function Vt(e,t){var r="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!r){if(Array.isArray(e)||(r=function(e,t){if(!e)return;if("string"==typeof e)return Ht(e,t);var r=Object.prototype.toString.call(e).slice(8,-1);"Object"===r&&e.constructor&&(r=e.constructor.name);if("Map"===r||"Set"===r)return Array.from(e);if("Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r))return Ht(e,t)}(e))||t&&e&&"number"==typeof e.length){r&&(e=r);var n=0,i=function(){};return{s:i,n:function(){return n>=e.length?{done:!0}:{done:!1,value:e[n++]}},e:function(e){throw e},f:i}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var o,a=!0,s=!1;return{s:function(){r=r.call(e)},n:function(){var e=r.next();return a=e.done,e},e:function(e){s=!0,o=e},f:function(){try{a||null==r.return||r.return()}finally{if(s)throw o}}}}function Ht(e,t){(null==t||t>e.length)&&(t=e.length);for(var r=0,n=new Array(t);r<t;r++)n[r]=e[r];return n}function Zt(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var r,n=O(e);if(t){var i=O(this).constructor;r=Reflect.construct(n,arguments,i)}else r=n.apply(this,arguments);return A(this,r)}}var qt=function(e){R(c,e);var t,r,n,i,o,a,s,u=Zt(c);function c(e,t,r){var n,i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{},o=arguments.length>4&&void 0!==arguments[4]?arguments[4]:{};P(this,c),(n=u.call(this,e)).spacing=i.spacing||.15,n.scattering=i.scattering||0,n.rotationMode=i.rotationMode||c.RotationMode.RANDOM;var a=i.blendMode||Tt.SOURCE_OVER;return Object.defineProperty(T(n),"blendMode",{get:function(){return a},set:function(e){if(!e)throw new Error("BrushGL blendMode is required");a=e}}),Object.defineProperty(T(n),"particleSettings",{get:function(){return{spacing:n.spacing,scattering:n.scattering,blendMode:n.blendMode,rotationMode:n.rotationMode}},enumerable:!0}),Object.defineProperty(T(n),"fillTextureSettings",{get:function(){return{randomize:n.randomizeFill,size:n.fillTextureSize,offset:n.fillTextureOffset}},enumerable:!0}),Object.defineProperty(T(n),"descriptor",{value:{shape:void 0,fill:void 0},enumerable:!0}),Object.defineProperty(T(n),"shape",{get:function(){return Array.isArray(n.descriptor.shape)?n.descriptor.shape.map((function(e){return e.value})):n.descriptor.shape.value},enumerable:!0}),Object.defineProperty(T(n),"fill",{get:function(){return n.descriptor.fill.value},enumerable:!0}),n.updateShape(t),n.updateFill(r,o),n}return w(c,[{key:"updateShape",value:(s=fe(pe.mark((function e(t){return pe.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(Array.isArray(t)?t=t.map((function(e){return"string"==typeof e?Xe.getInstance(e):e instanceof Xe?e:new Xe(e.name,e.value)})):"string"==typeof t?t=Xe.getInstance(t):t instanceof Xe||(t=new Xe(t.name,t.value)),this.descriptor.shape=t,!this.ctx){e.next=5;break}return e.next=5,this.configureShape();case 5:case"end":return e.stop()}}),e,this)}))),function(e){return s.apply(this,arguments)})},{key:"updateFill",value:(a=fe(pe.mark((function e(t){var r,n=arguments;return pe.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r=n.length>1&&void 0!==n[1]?n[1]:{},this.randomizeFill=!("randomize"in r)||r.randomize,this.fillTextureSize=r.size,this.fillTextureOffset=r.offset||{x:0,y:0},!Array.isArray(t)){e.next=6;break}throw new Error("Mipmap is not compatible whith fill texture");case 6:if("string"==typeof t?t=Xe.getInstance(t):t instanceof Xe||(t=new Xe(t.name,t.value)),this.descriptor.fill=t,!this.ctx){e.next=11;break}return e.next=11,this.configureFill();case 11:case"end":return e.stop()}}),e,this)}))),function(e){return a.apply(this,arguments)})},{key:"configure",value:(o=fe(pe.mark((function e(t){return pe.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return this.ctx=t,e.next=3,this.configureShape();case 3:return e.next=5,this.configureFill();case 5:case"end":return e.stop()}}),e,this)}))),function(e){return o.apply(this,arguments)})},{key:"configureShape",value:(i=fe(pe.mark((function e(){return pe.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return this.shapeTexture||(this.shapeTexture=Nt.createInstance(this.ctx,this.ctx.CLAMP_TO_EDGE,this.ctx.LINEAR)),e.next=3,this.shapeTexture.update(this.shape,this.spacing<=1);case 3:case"end":return e.stop()}}),e,this)}))),function(){return i.apply(this,arguments)})},{key:"configureFill",value:(n=fe(pe.mark((function e(){return pe.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return this.fillTexture||(this.fillTexture=Nt.createInstance(this.ctx,this.ctx.REPEAT,this.ctx.NEAREST)),e.next=3,this.fillTexture.update(this.fill);case 3:this.fillTextureSize||(this.fillTextureSize=this.fillTexture.size);case 4:case"end":return e.stop()}}),e,this)}))),function(){return n.apply(this,arguments)})},{key:"getShapeBinary",value:(r=fe(pe.mark((function e(){var t,r,n,i,o,a;return pe.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!Array.isArray(this.shape)){e.next=24;break}r=[],n=Vt(this.shape),e.prev=3,n.s();case 5:if((i=n.n()).done){e.next=13;break}return o=i.value,e.next=9,yt(o);case 9:a=e.sent,r.push(a);case 11:e.next=5;break;case 13:e.next=18;break;case 15:e.prev=15,e.t0=e.catch(3),n.e(e.t0);case 18:return e.prev=18,n.f(),e.finish(18);case 21:t=r,e.next=27;break;case 24:return e.next=26,yt(this.shape);case 26:t=e.sent;case 27:return e.abrupt("return",t);case 28:case"end":return e.stop()}}),e,this,[[3,15,18,21]])}))),function(){return r.apply(this,arguments)})},{key:"getFillBinary",value:(t=fe(pe.mark((function e(){return pe.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,yt(this.fill);case 2:return e.abrupt("return",e.sent);case 3:case"end":return e.stop()}}),e,this)}))),function(){return t.apply(this,arguments)})},{key:"toJSON",value:function(){return{type:"BrushGL",name:this.name,shape:Array.isArray(this.descriptor.shape)?this.descriptor.shape.map((function(e){return e.toJSON()})):this.descriptor.shape.toJSON(),fill:this.descriptor.fill.toJSON(),particleSettings:{spacing:this.spacing,scattering:this.scattering,blendMode:this.blendMode.name,rotationMode:this.rotationMode.name},fillTextureSettings:{randomize:this.randomizeFill,size:this.fillTextureSize,offset:this.fillTextureOffset}}}},{key:"equals",value:function(e){return e==this&&e.shapeTexture==this.shapeTexture&&e.fillTexture==this.fillTexture}},{key:"delete",value:function(){this.deleteShape(),this.deleteFill()}},{key:"deleteShape",value:function(){this.shapeTexture&&(this.ctx.deleteTexture(this.shapeTexture),delete this.shapeTexture)}},{key:"deleteFill",value:function(){this.fillTexture&&(this.ctx.deleteTexture(this.fillTexture),delete this.fillTexture)}}],[{key:"fromJSON",value:function(e){e.particleSettings.blendMode=Tt[e.particleSettings.blendMode],e.particleSettings.rotationMode=c.RotationMode[e.particleSettings.rotationMode];var t=Array.isArray(e.shape)?e.shape.map((function(e){return Xe.fromJSON(e)})):Xe.fromJSON(e.shape),r=Xe.fromJSON(e.fill);return new c(e.name,t,r,e.particleSettings,e.fillTextureSettings)}}]),c}(ze);function Wt(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var r,n=O(e);if(t){var i=O(this).constructor;r=Reflect.construct(n,arguments,i)}else r=n.apply(this,arguments);return A(this,r)}}Object.defineEnum(qt,"RotationMode",["NONE","RANDOM","TRAJECTORY"]);var Kt=function(e){R(r,e);var t=Wt(r);function r(e){var n;return P(this,r),(n=t.call(this,e)).buffer=n.gl.createBuffer(),n.indexBuffer=n.gl.createBuffer(),n}return w(r,[{key:"init",value:function(){this.a_coordinates=this.gl.getAttribLocation(this.program,"a_coordinates"),this.a_xys=this.gl.getAttribLocation(this.program,"a_xys"),this.a_spriteRotation=this.gl.getAttribLocation(this.program,"a_spriteRotation"),this.a_spriteScaleAndOffset=this.gl.getAttribLocation(this.program,"a_spriteScaleAndOffset"),this.a_color=this.gl.getAttribLocation(this.program,"a_color"),this.a_velocity=this.gl.getAttribLocation(this.program,"a_velocity"),this.a_transformParams=this.gl.getAttribLocation(this.program,"a_transformParams"),this.u_projectionMatrix=this.gl.getUniformLocation(this.program,"u_projectionMatrix"),this.u_viewMatrix=this.gl.getUniformLocation(this.program,"u_viewMatrix"),this.u_fillTextureSize=this.gl.getUniformLocation(this.program,"u_fillTextureSize"),this.u_fillTextureOffset=this.gl.getUniformLocation(this.program,"u_fillTextureOffset"),this.u_shapeTexture=this.gl.getUniformLocation(this.program,"u_shapeTexture"),this.u_fillTexture=this.gl.getUniformLocation(this.program,"u_fillTexture")}},{key:"setBrush",value:function(e){this.brush=e,this.brushChanged=!0}},{key:"onActivate",value:function(){this.brushChanged=!0,this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.buffer),this.gl.bindBuffer(this.gl.ELEMENT_ARRAY_BUFFER,this.indexBuffer);var e=19*Float32Array.BYTES_PER_ELEMENT;this.gl.vertexAttribPointer(this.a_coordinates,2,this.gl.FLOAT,!1,e,0*Float32Array.BYTES_PER_ELEMENT),this.gl.vertexAttribPointer(this.a_xys,3,this.gl.FLOAT,!1,e,2*Float32Array.BYTES_PER_ELEMENT),this.gl.vertexAttribPointer(this.a_spriteRotation,1,this.gl.FLOAT,!1,e,5*Float32Array.BYTES_PER_ELEMENT),this.gl.vertexAttribPointer(this.a_spriteScaleAndOffset,4,this.gl.FLOAT,!1,e,6*Float32Array.BYTES_PER_ELEMENT),this.gl.vertexAttribPointer(this.a_color,4,this.gl.FLOAT,!1,e,10*Float32Array.BYTES_PER_ELEMENT),this.gl.vertexAttribPointer(this.a_velocity,2,this.gl.FLOAT,!1,e,14*Float32Array.BYTES_PER_ELEMENT),this.gl.vertexAttribPointer(this.a_transformParams,3,this.gl.FLOAT,!1,e,16*Float32Array.BYTES_PER_ELEMENT),this.gl.enableVertexAttribArray(this.a_coordinates),this.gl.enableVertexAttribArray(this.a_xys),this.gl.enableVertexAttribArray(this.a_spriteRotation),this.gl.enableVertexAttribArray(this.a_spriteScaleAndOffset),this.gl.enableVertexAttribArray(this.a_color),this.gl.enableVertexAttribArray(this.a_velocity),this.gl.enableVertexAttribArray(this.a_transformParams)}},{key:"onContextChange",value:function(){this.gl.uniformMatrix4fv(this.u_projectionMatrix,!1,this.inkGLContext.graphicsSpaceToFramebufferSpaceT),this.gl.uniformMatrix4fv(this.u_viewMatrix,!1,this.inkGLContext.transform?this.inkGLContext.transform.value:At.IDENTITY_MATRIX)}},{key:"onDeactivate",value:function(){this.gl.disableVertexAttribArray(this.a_coordinates),this.gl.disableVertexAttribArray(this.a_xys),this.gl.disableVertexAttribArray(this.a_spriteRotation),this.gl.disableVertexAttribArray(this.a_spriteScaleAndOffset),this.gl.disableVertexAttribArray(this.a_color),this.gl.disableVertexAttribArray(this.a_velocity),this.gl.disableVertexAttribArray(this.a_transformParams),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,null)}},{key:"updateTextures",value:function(){this.brushChanged&&(this.brushChanged=!1,this.gl.uniform2f(this.u_fillTextureOffset,this.brush.fillTextureOffset.x,this.brush.fillTextureOffset.y),this.gl.uniform2f(this.u_fillTextureSize,this.brush.fillTextureSize.width,this.brush.fillTextureSize.height),this.gl.activeTexture(this.gl.TEXTURE0),this.gl.bindTexture(this.gl.TEXTURE_2D,this.brush.shapeTexture.value),this.gl.uniform1i(this.u_shapeTexture,0),this.gl.activeTexture(this.gl.TEXTURE1),this.gl.bindTexture(this.gl.TEXTURE_2D,this.brush.fillTexture.value),this.gl.uniform1i(this.u_fillTexture,1))}},{key:"drawSprites",value:function(e){var t;this.activate(),this.updateTextures();for(var r=Math.ceil(e.length/At.VERTEX_BATCH_SIZE),n=0;n<r;n++){t=this.drawSpritesBatch(e,n).union(t)}return t}},{key:"drawSpritesBatch",value:function(e,t){var r,n=this,i=t*At.VERTEX_BATCH_SIZE,o=i+At.VERTEX_BATCH_SIZE;o>e.length&&(o=i+e.length%At.VERTEX_BATCH_SIZE);for(var a=o-i,s=new Float32Array(76*a),u=new Uint16Array(6*a),c=this.brush.rotationMode==qt.RotationMode.TRAJECTORY?1:0,l=le.createInstance(e.layout),h=function(t){l.fill(t,e.points,e.layout,e.style);var o=76*(t-i),a=z.calculateBrushGLSegmentBounds(l,n.brush.scattering);r=a.union(r);var u=l.red/255*l.alpha,h=l.green/255*l.alpha,f=l.blue/255*l.alpha;0==l.dX&&0==l.dY&&(l.dX=2*n.inkGLContext.random()-1,l.dY=2*n.inkGLContext.random()-1);var d=n.brush.rotationMode==qt.RotationMode.RANDOM?2*n.inkGLContext.random()*Math.PI:0,p=(2*n.inkGLContext.random()-1)*n.brush.scattering;z.SQURE.forEach((function(e,t){var r=o+19*t;s[r]=e.x,s[r+1]=e.y,s[r+2]=l.x,s[r+3]=l.y,s[r+4]=l.size,s[r+5]=l.rotation,s[r+6]=l.scaleX,s[r+7]=l.scaleY,s[r+8]=l.offsetX,s[r+9]=l.offsetY,s[r+10]=u,s[r+11]=h,s[r+12]=f,s[r+13]=l.alpha,s[r+14]=l.dX,s[r+15]=l.dY,s[r+16]=c,s[r+17]=d,s[r+18]=p}))},f=i;f<o;f++)h(f);for(var d=0,p=0;p<u.length;p+=6)u[p]=d,u[p+1]=d+1,u[p+2]=d+2,u[p+3]=d+2,u[p+4]=d+1,u[p+5]=d+3,d+=4;return this.gl.bufferData(this.gl.ARRAY_BUFFER,s,this.gl.STATIC_DRAW),this.gl.bufferData(this.gl.ELEMENT_ARRAY_BUFFER,u,this.gl.STATIC_DRAW),this.inkGLContext.drawElements(this.gl.TRIANGLES,u.length,this.gl.UNSIGNED_SHORT,0),r}}],[{key:"getVertexShader",value:function(){return"\n\t\t\tprecision ".concat(At.VERTEX_SHADER_PRECISION," float;\n\n\t\t\tuniform mat4 u_projectionMatrix;\n\t\t\tuniform mat4 u_viewMatrix;\n\t\t\tuniform vec2 u_fillTextureSize;\n\t\t\tuniform vec2 u_fillTextureOffset;\n\n\t\t\tattribute lowp vec4 a_color;\n\t\t\t/* (x,y) is the center. z is the offset by x, w is the offset by y */\n\t\t\tattribute highp vec2 a_coordinates;\n\t\t\t/* the velocity at that point. It is the derivative of the function */\n\t\t\tattribute vec2 a_velocity;\n\t\t\t/* 1-shape trajectory rotation coficient, 2-shape randrom rotation angle, 3-scattering value */\n\t\t\tattribute vec3 a_transformParams;\n\n\t\t\t/* sprite rotation angle */\n\t\t\tattribute highp float a_spriteRotation;\n\t\t\t/* sprite's: 1-scaleX, 2-scaleY, 3-offsetX, 4-offsetY */\n\t\t\tattribute highp vec4 a_spriteScaleAndOffset;\n\n\t\t\tvarying lowp vec4 v_color;\n\t\t\tattribute vec3 a_xys;\n\t\t\tvarying highp vec2 v_shapeTexturePosition;\n\t\t\tvarying highp vec2 v_fillTexturePosition;\n\n\t\t\tmat2 trajectoryRotate(vec2 vNormal, float value) {\n\t\t\t\tvec2 base = vec2(1.0, 0.0);\n\n\t\t\t\tvec2 vNormalR = mix(base, vNormal, value);\n\t\t\t\tvNormalR = normalize(vNormalR);\n\n\t\t\t\tfloat cosfi = dot(vNormalR, base);\n\t\t\t\tfloat sinfi = vNormalR.x * base.y - vNormalR.y * base.x;\n\n\t\t\t\treturn mat2(\n\t\t\t\t\tcosfi, -sinfi,\n\t\t\t\t\tsinfi, cosfi\n\t\t\t\t);\n\t\t\t}\n\n\t\t\tmat2 angleRotate2(float fi) {\n\t\t\t\tfloat sinfi = sin(fi);\n\t\t\t\tfloat cosfi = cos(fi);\n\n\t\t\t\treturn mat2(\n\t\t\t\t\tcosfi, -sinfi,\n\t\t\t\t\tsinfi, cosfi\n\t\t\t\t);\n\t\t\t}\n\n\t\t\tmat2 scale2(float sx, float sy) {\n\t\t\t\treturn mat2(sx, 0.0, 0.0, sy);\n\t\t\t}\n\n\t\t\tmat3 rotate2h(float fi) {\n\t\t\t\tfloat sinfi = sin(fi);\n\t\t\t\tfloat cosfi = cos(fi);\n\n\t\t\t\treturn mat3(\n\t\t\t\t\tcosfi,  sinfi, 0.0,\n\t\t\t\t\t-sinfi, cosfi, 0.0,\n\t\t\t\t\t0.0,    0.0,   1.0\n\t\t\t\t);\n\t\t\t}\n\n\t\t\tmat3 scale2h(float sx, float sy) {\n\t\t\t\treturn mat3(\n\t\t\t\t\tsx,  0.0, 0.0,\n\t\t\t\t\t0.0, sy,  0.0,\n\t\t\t\t\t0.0, 0.0, 1.0\n\t\t\t\t);\n\t\t\t}\n\n\t\t\tmat3 translate2h(float tx, float ty) {\n\t\t\t\treturn mat3(\n\t\t\t\t\t1.0, 0.0, 0.0,\n\t\t\t\t\t0.0, 1.0, 0.0,\n\t\t\t\t\ttx,  ty,  1.0\n\t\t\t\t);\n\t\t\t}\n\n\t\t\tvec2 orthoOffset(vec2 vNormal, float value) {\n\t\t\t\tvec2 vno = vec2(vNormal.y * value, vNormal.x * value);\n\t\t\t\treturn vno;\n\t\t\t}\n\n\t\t\tvoid main() {\n\t\t\t\t// Calculate radius from size\n\t\t\t\tfloat halfSize = a_xys.z / 2.0;\n\n\t\t\t\tvec2 vNormal = normalize(a_velocity);\n\n\t\t\t\t// Because this applied to the texture, the y reversed because the texture coordinate system y is increasing downwards.\n\t\t\t\tvNormal.y = -vNormal.y;\n\n\t\t\t\tfloat spriteRotation = a_spriteRotation;\n\t\t\t\tvec4 spriteScaleAndOffset = a_spriteScaleAndOffset;\n\t\t\t\tspriteScaleAndOffset.y = -spriteScaleAndOffset.y;\n\t\t\t\tspriteScaleAndOffset.w = -spriteScaleAndOffset.w;\n\n\t\t\t\tmat2 productRotateMatrix = angleRotate2(a_transformParams.y) * trajectoryRotate(vNormal, a_transformParams.x);\n\t\t\t\tvec2 scatterOffset = orthoOffset(vNormal, a_transformParams.z * halfSize);\n\t\t\t\tvec2 transformedCoordinates = productRotateMatrix * a_coordinates;\n\n\t\t\t\tvec3 coordinatesH = vec3(transformedCoordinates.x, transformedCoordinates.y, 1.0);\n\t\t\t\tcoordinatesH = rotate2h(spriteRotation) * translate2h(spriteScaleAndOffset.z, spriteScaleAndOffset.w) * scale2h(spriteScaleAndOffset.x * halfSize, spriteScaleAndOffset.y * halfSize) * coordinatesH;\n\t\t\t\tvec2 coordinates = coordinatesH.xy;\n\n\t\t\t\tvec2 offset = coordinates + scatterOffset;\n\t\t\t\tvec4 position = vec4(a_xys.x + offset.x, a_xys.y + offset.y, 0.0, 1.0);\n\n\t\t\t\tv_color = a_color;\n\n\t\t\t\tvec4 viewPosition = u_viewMatrix * position;\n\t\t\t\tgl_Position = u_projectionMatrix * viewPosition;\n\t\t\t\tv_fillTexturePosition = position.xy / u_fillTextureSize + u_fillTextureOffset;\n\t\t\t\tv_shapeTexturePosition = (a_coordinates + 1.0) * 0.5; /* [-1;1] -> [0;1] */\n\t\t\t}\n\t\t")}},{key:"getFragmentShader",value:function(e){return"\n\t\t\tuniform lowp sampler2D u_shapeTexture;\n\t\t\tuniform lowp sampler2D u_fillTexture;\n\n\t\t\t/* lowp seems to lead to an overflow on PowerVR SGX540, so use mediump instead :)*/\n\t\t\tvarying mediump vec4 v_color;\n\t\t\tvarying highp vec2 v_shapeTexturePosition;\n\t\t\tvarying highp vec2 v_fillTexturePosition;\n\n\t\t\tvoid main() {\n\t\t\t\tlowp vec4 c = v_color * texture2D(u_shapeTexture, v_shapeTexturePosition) * texture2D(u_fillTexture, v_fillTexturePosition);\n\n\t\t\t\tgl_FragColor = ".concat(e?"c":"vec4(c.x / c.w, c.y / c.w, c.z / c.w, c.w * 255.0)",";\n\t\t\t}\n\t\t")}}]),r}(Bt),Jt=function(){function e(t,r){P(this,e);var n=t.getContext("webgl2",r)||t.getContext("webgl",r);if(this.debug){var i=new Proxy(n,{get:function(e,t,r){var n;return n="function"==typeof e[t]?Reflect.get.apply(Reflect,arguments):e[t],"getError"!=t&&At.logGLError(e,t),n}});Object.getOwnPropertyNames(n.constructor.prototype).forEach((function(e){var t=n[e];"function"==typeof t&&(i[e]=t.bind(n))})),n=i}this.gl=n,this.glVersion=n.drawArraysInstanced?2:1,this.inkGLContext=new At(n);var o=n.drawArraysInstanced?Yt:Ft;this.simpleProgram=new o(this.inkGLContext),this.textureProgram=new zt(this.inkGLContext),this.spriteProgram=new Kt(this.inkGLContext),this.inkGLContext.programs=[this.simpleProgram,this.textureProgram,this.spriteProgram],this.currentTarget=null,this.inkGLContext.init(new z(0,0,0,0),new z(0,0,0,0))}return w(e,[{key:"createLayer",value:function(e,t){return new Lt(this.inkGLContext,e,t)}},{key:"drawLayerWithTransform",value:function(e,t,r){if(this.currentTarget){var n=e.graphicsBounds.toQuad(),i=e.graphicsBounds.toQuad(t);this.drawLayer(e,n,i,r)}}},{key:"drawLayer",value:function(e,t,r,n){if(this.currentTarget&&e.useTextureStorage){var o=i.mat4.create(),a=i.mat4.create(),s=this.currentTarget;s.flipY?i.mat4.ortho(a,0,s.width,s.height,0,1,-1):i.mat4.ortho(a,0,s.width,0,s.height,1,-1),e.flipY?i.mat4.ortho(o,-e.width,e.width,2*e.height,0,0,1):i.mat4.ortho(o,-e.width,e.width,-e.height,e.height,0,1),this.inkGLContext.blendMode=n,this.textureProgram.drawTexture(e.texture,r,t,a,o)}}},{key:"setTarget",value:function(e,t){if(e&&!(e instanceof Lt))throw new TypeError("layer must be unset or instanceof InkLayer");if(t&&!(t instanceof z))throw new TypeError("clipRect must be unset or instanceof RectGL");if(e){this.currentTarget=e;var r=new z(0,0,e.storageWidth,e.storageHeight),n=new z(0,0,e.width,e.height);this.inkGLContext.resize(r,n),this.inkGLContext.setUniforms(e.flipY),t?this.setTargetClipRect(t):this.disableTargetClipRect(),this.gl.bindFramebuffer(this.gl.FRAMEBUFFER,e.framebuffer)}}},{key:"clearColor",value:function(e){this.inkGLContext.clearColorBuffer(e)}},{key:"setTargetClipRect",value:function(e){if(e=e.floor().intersect(this.currentTarget.graphicsBounds),this.currentTarget.flipY)e=new z(e.x,this.currentTarget.storageHeight-e.top,e.width,e.height);else{var t=this.currentTarget.scaleFactor;e=new z(e.x*t,e.y*t,e.width*t,e.height*t)}this.inkGLContext.clipRect=e,this.inkGLContext.scissors(e)}},{key:"disableTargetClipRect",value:function(){var e=this.inkGLContext;e.scissors(null),e.clipRect=e.graphicsBox}},{key:"drawStroke",value:function(e,t,r){return this.currentTarget?0==t.length?null:(this.inkGLContext.blendMaxFallback&&e.blendMode==Tt.MAX&&this.inkGLContext.enableStencilBufferForBlending(this.currentTarget),this.inkGLContext.transform=this.currentTarget.matrix,e instanceof qt?this.drawGL(e,t,r):this.draw2D(e,t,r)):null}},{key:"drawGL",value:function(e,t,r){var n;r&&(n=this.inkGLContext.scatterMethodRandomSeed,this.inkGLContext.scatterMethodRandomSeed=r.randomSeed),this.spriteProgram.setBrush(e),this.inkGLContext.blendMode=e.blendMode;var i=this.spriteProgram.drawSprites(t);return r&&(r.randomSeed=this.inkGLContext.scatterMethodRandomSeed,this.inkGLContext.scatterMethodRandomSeed=n),this.clipDirtyArea(i)}},{key:"draw2D",value:function(e,t,r){return this.fill(t,r,!0,t.segment)}},{key:"fill",value:function(e,t){var r=!(arguments.length>2&&void 0!==arguments[2])||arguments[2],n=arguments.length>3&&void 0!==arguments[3]&&arguments[3],i=this.clipDirtyArea(e.bounds.toGLRect());if(i){var o=e.vertices;o.length>0?this.simpleProgram.drawVertices(this.currentTarget.framebuffer,o,t,r,n):i=void 0}return i}},{key:"clipDirtyArea",value:function(e){var t=e,r=this.inkGLContext.clipRect;return this.inkGLContext.transform&&(t=t.transform(this.inkGLContext.transform)),(t=r.intersect(t))&&(t=t.ceil(),1==this.glVersion&&(t=z.ofEdges(t.left-1,t.bottom-1,t.right+1,t.top+1))),t}},{key:"readPixels",value:function(e){var t=this.currentTarget;if(e){if(!(e instanceof z))throw new TypeError("box must be instance of RectGL")}else e=t.graphicsBounds;t.flipY&&(e=new z(e.x,t.height-e.y-e.height,e.width,e.height)),this.setTarget(t);var r=new Uint8Array(e.width*e.height*4);return this.gl.readPixels(parseInt(e.x*t.scaleFactor),parseInt(e.y*t.scaleFactor),parseInt(e.width*t.scaleFactor),parseInt(e.height*t.scaleFactor),this.gl.RGBA,this.gl.UNSIGNED_BYTE,r),r}},{key:"writePixels",value:function(e,t){if(e&&!(e instanceof z))throw new TypeError("rect must be instance of RectGL");var r=this.currentTarget;if(e||(e=new z(0,0,r.width,r.height)),!r.useTextureStorage)throw new Error("writePixels layer without texture is not supported!");r.flipY&&(e=new z(e.x,r.height-e.y-e.height,e.width,e.height));var n=new z(e.x*r.scaleFactor,e.y*r.scaleFactor,e.width*r.scaleFactor,e.height*r.scaleFactor);this.gl.finish(),this.gl.activeTexture(this.gl.TEXTURE0),this.gl.bindTexture(this.gl.TEXTURE_2D,r.texture),this.gl.texSubImage2D(this.gl.TEXTURE_2D,0,parseInt(n.x),parseInt(n.y),parseInt(n.width),parseInt(n.height),this.gl.RGBA,this.gl.UNSIGNED_BYTE,t)}}]),e}(),$t=v?v.default||globalThis.ClipperLib:{},Qt=$t.Clipper,er=$t.Paths,tr=$t.Path;$t.ClipType,$t.PolyType;var rr=$t.PolyFillType;function nr(e,t,r){return(nr="undefined"!=typeof Reflect&&Reflect.get?Reflect.get:function(e,t,r){var n=function(e,t){for(;!Object.prototype.hasOwnProperty.call(e,t)&&null!==(e=O(e)););return e}(e,t);if(n){var i=Object.getOwnPropertyDescriptor(n,t);return i.get?i.get.call(r):i.value}})(e,t,r||e)}function ir(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var r,n=O(e);if(t){var i=O(this).constructor;r=Reflect.construct(n,arguments,i)}else r=n.apply(this,arguments);return A(this,r)}}var or=function(e,t){R(n,e);var r=ir(n);function n(){var e;P(this,n);for(var t=arguments.length,i=new Array(t),o=0;o<t;o++)i[o]=arguments[o];if(e=r.call.apply(r,[this].concat(i)),i.some((function(e){return!(e instanceof ht)})))throw new Error("Expected data item type is Polygon");return Object.defineProperty(T(e),"bounds",{get:function(){var t;return e.length>0&&(e.forEach((function(e){return t=e.bounds.union(t)})),t=t.ceil()),t},enumerable:!0}),Object.defineProperty(T(e),"vertices",{get:function(){return e.triangulate()},enumerable:!0}),e}return w(n,[{key:"clone",value:function(){return D(this.constructor,te(this.map((function(e){return e.clone()}))))}},{key:"push",value:function(){for(var e,t=arguments.length,r=new Array(t),i=0;i<t;i++)r[i]=arguments[i];if(r.some((function(e){return!(e instanceof ht)})))throw new Error("Expected data item type is Polygon");(e=nr(O(n.prototype),"push",this)).call.apply(e,[this].concat(r))}},{key:"triangulate",value:function(){var e;return(e=Float32Array.createSharedInstance()).concat.apply(e,te(this.map((function(e){return e.vertices}))))}},{key:"transform",value:function(e){this.forEach((function(t){return t.transform(e)}))}},{key:"toJSON",value:function(){return{type:"PolygonArray",polygons:this.map((function(e){return e.toJSON()}))}}}],[{key:t,get:function(){return Array}},{key:"fromJSON",value:function(e){if("PolygonArray"!=e.type)throw new Error("PolygonArray deserialization failed. JSON type is ".concat(e.type,", expected PolygonArray."));return D(n,te(e.polygons.map((function(e){return ht.fromJSON(e)}))))}}]),n}(N(Array),Symbol.species);function ar(e,t){var r="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!r){if(Array.isArray(e)||(r=function(e,t){if(!e)return;if("string"==typeof e)return sr(e,t);var r=Object.prototype.toString.call(e).slice(8,-1);"Object"===r&&e.constructor&&(r=e.constructor.name);if("Map"===r||"Set"===r)return Array.from(e);if("Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r))return sr(e,t)}(e))||t&&e&&"number"==typeof e.length){r&&(e=r);var n=0,i=function(){};return{s:i,n:function(){return n>=e.length?{done:!0}:{done:!1,value:e[n++]}},e:function(e){throw e},f:i}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var o,a=!0,s=!1;return{s:function(){r=r.call(e)},n:function(){var e=r.next();return a=e.done,e},e:function(e){s=!0,o=e},f:function(){try{a||null==r.return||r.return()}finally{if(s)throw o}}}}function sr(e,t){(null==t||t>e.length)&&(t=e.length);for(var r=0,n=new Array(t);r<t;r++)n[r]=e[r];return n}function ur(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var r,n=O(e);if(t){var i=O(this).constructor;r=Reflect.construct(n,arguments,i)}else r=n.apply(this,arguments);return A(this,r)}}var cr=function(e){R(r,e);var t=ur(r);function r(){var e,n;P(this,r);for(var i=arguments.length,o=new Array(i),a=0;a<i;a++)o[a]=arguments[a];return e=t.call.apply(t,[this].concat(o)),Object.defineProperty(T(e),"encoding",{get:function(){return n},set:function(t){n=t,e.forEach((function(e){return e.encoding=t}))},enumerable:!0}),e}return w(r,[{key:"intersects",value:function(e){e instanceof ht&&(e=[e]);var t,r=ar(this);try{for(r.s();!(t=r.n()).done;){var n,i=t.value,o=ar(e);try{for(o.s();!(n=o.n()).done;){var a=n.value;if(i.intersects(a))return{poly1:i,poly2:a}}}catch(e){o.e(e)}finally{o.f()}}}catch(e){r.e(e)}finally{r.f()}return null}},{key:"toJSON",value:function(){var e=nr(O(r.prototype),"toJSON",this).call(this);return e.type="InkPath2D",e}}],[{key:"fromJSON",value:function(e){if("InkPath2D"!=e.type)throw new Error("InkPath2D deserialization failed. JSON type is ".concat(e.type,", expected InkPath2D."));return D(r,te(e.polygons.map((function(e){return ht.fromJSON(e)}))))}}]),r}(or);function lr(e,t){var r="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!r){if(Array.isArray(e)||(r=function(e,t){if(!e)return;if("string"==typeof e)return hr(e,t);var r=Object.prototype.toString.call(e).slice(8,-1);"Object"===r&&e.constructor&&(r=e.constructor.name);if("Map"===r||"Set"===r)return Array.from(e);if("Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r))return hr(e,t)}(e))||t&&e&&"number"==typeof e.length){r&&(e=r);var n=0,i=function(){};return{s:i,n:function(){return n>=e.length?{done:!0}:{done:!1,value:e[n++]}},e:function(e){throw e},f:i}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var o,a=!0,s=!1;return{s:function(){r=r.call(e)},n:function(){var e=r.next();return a=e.done,e},e:function(e){s=!0,o=e},f:function(){try{a||null==r.return||r.return()}finally{if(s)throw o}}}}function hr(e,t){(null==t||t>e.length)&&(t=e.length);for(var r=0,n=new Array(t);r<t;r++)n[r]=e[r];return n}var fr=65534,dr=function(){function e(t){if(P(this,e),t instanceof ht&&(t=new cr(t)),!(t instanceof cr))throw new Error("Unexpected path type found");var r=t.bounds,n=fr/(r.width+1e-16),i=fr/(r.height+1e-16),o=Math.floor(Math.min(n,i)),a=r.left+32767/o,s=r.top+32767/o;this.solution=new er,this.bounds=r,this.transform={scale:o,offsetX:a,offsetY:s},this.subject=this.apply(t)}return w(e,[{key:"convertPoint",value:function(e){var t=(e.x-this.transform.offsetX)*this.transform.scale,r=(e.y-this.transform.offsetY)*this.transform.scale;return{X:t<0?Math.ceil(t):Math.floor(t),Y:r<0?Math.ceil(r):Math.floor(r)}}},{key:"containsPoint",value:function(e){return Qt.PointInPolygon(this.convertPoint(e),this.solution)}},{key:"apply",value:function(e){var t=new er;if(e instanceof ht&&(e=new cr(e)),!(e instanceof cr))throw new Error("Unexpected path type found");var r,n=lr(e);try{for(n.s();!(r=n.n()).done;){for(var i=r.value,o=new tr,a=i.shape,s=0;s<a.length;s++)o.push(this.convertPoint({x:a.getPointX(s),y:a.getPointY(s)}));t.push(o)}}catch(e){n.e(e)}finally{n.f()}return t}},{key:"toPolygon",value:function(){var e=[];this.lastPoint={};var t,r=lr(this.solution);try{for(r.s();!(t=r.n()).done;){var n=t.value;0!=n.length&&e.push(this.flatPath(n))}}catch(e){r.e(e)}finally{r.f()}return ht.createSharedInstance(e.first,e.slice(1))}},{key:"flatPath",value:function(e){var t,r=[],n=lr(e);try{for(n.s();!(t=n.n()).done;){var i=t.value;this.lastPoint.X!=i.X||this.lastPoint.Y!=i.Y?(r.push(i.X/this.transform.scale+this.transform.offsetX,i.Y/this.transform.scale+this.transform.offsetY),this.lastPoint=i):console.warn("Duplicate point detected: {".concat(i.X,", ").concat(i.Y,"}"))}}catch(e){n.e(e)}finally{n.f()}return r.length<6&&(console.warn("Invalid contour found: [".concat(r.join(", "),"]")),r.clear()),r}}]),e}(),pr={palettes:{}},yr=["AliceBlue","#F0F8FF","AntiqueWhite","#FAEBD7","Aqua","#00FFFF","Aquamarine","#7FFFD4","Azure","#F0FFFF","Beige","#F5F5DC","Bisque","#FFE4C4","Black","#000000","BlanchedAlmond","#FFEBCD","Blue","#0000FF","BlueViolet","#8A2BE2","Brown","#A52A2A","BurlyWood","#DEB887","CadetBlue","#5F9EA0","Chartreuse","#7FFF00","Chocolate","#D2691E","Coral","#FF7F50","CornflowerBlue","#6495ED","Cornsilk","#FFF8DC","Crimson","#DC143C","Cyan","#00FFFF","DarkBlue","#00008B","DarkCyan","#008B8B","DarkGoldenRod","#B8860B","DarkGray","#A9A9A9","DarkGreen","#006400","DarkKhaki","#BDB76B","DarkMagenta","#8B008B","DarkOliveGreen","#556B2F","DarkOrange","#FF8C00","DarkOrchid","#9932CC","DarkRed","#8B0000","DarkSalmon","#E9967A","DarkSeaGreen","#8FBC8F","DarkSlateBlue","#483D8B","DarkSlateGray","#2F4F4F","DarkTurquoise","#00CED1","DarkViolet","#9400D3","DeepPink","#FF1493","DeepSkyBlue","#00BFFF","DimGray","#696969","DodgerBlue","#1E90FF","FireBrick","#B22222","FloralWhite","#FFFAF0","ForestGreen","#228B22","Fuchsia","#FF00FF","Gainsboro","#DCDCDC","GhostWhite","#F8F8FF","Gold","#FFD700","GoldenRod","#DAA520","Gray","#808080","Green","#008000","GreenYellow","#ADFF2F","HoneyDew","#F0FFF0","HotPink","#FF69B4","IndianRed","#CD5C5C","Indigo","#4B0082","Ivory","#FFFFF0","Khaki","#F0E68C","Lavender","#E6E6FA","LavenderBlush","#FFF0F5","LawnGreen","#7CFC00","LemonChiffon","#FFFACD","LightBlue","#ADD8E6","LightCoral","#F08080","LightCyan","#E0FFFF","LightGoldenRodYellow","#FAFAD2","LightGray","#D3D3D3","LightGreen","#90EE90","LightPink","#FFB6C1","LightSalmon","#FFA07A","LightSeaGreen","#20B2AA","LightSkyBlue","#87CEFA","LightSlateGray","#778899","LightSteelBlue","#B0C4DE","LightYellow","#FFFFE0","Lime","#00FF00","LimeGreen","#32CD32","Linen","#FAF0E6","Magenta","#FF00FF","Maroon","#800000","MediumAquaMarine","#66CDAA","MediumBlue","#0000CD","MediumOrchid","#BA55D3","MediumPurple","#9370DB","MediumSeaGreen","#3CB371","MediumSlateBlue","#7B68EE","MediumSpringGreen","#00FA9A","MediumTurquoise","#48D1CC","MediumVioletRed","#C71585","MidnightBlue","#191970","MintCream","#F5FFFA","MistyRose","#FFE4E1","Moccasin","#FFE4B5","NavajoWhite","#FFDEAD","Navy","#000080","OldLace","#FDF5E6","Olive","#808000","OliveDrab","#6B8E23","Orange","#FFA500","OrangeRed","#FF4500","Orchid","#DA70D6","PaleGoldenRod","#EEE8AA","PaleGreen","#98FB98","PaleTurquoise","#AFEEEE","PaleVioletRed","#DB7093","PapayaWhip","#FFEFD5","PeachPuff","#FFDAB9","Peru","#CD853F","Pink","#FFC0CB","Plum","#DDA0DD","PowderBlue","#B0E0E6","Purple","#800080","RebeccaPurple","#663399","Red","#FF0000","RosyBrown","#BC8F8F","RoyalBlue","#4169E1","SaddleBrown","#8B4513","Salmon","#FA8072","SandyBrown","#F4A460","SeaGreen","#2E8B57","SeaShell","#FFF5EE","Sienna","#A0522D","Silver","#C0C0C0","SkyBlue","#87CEEB","SlateBlue","#6A5ACD","SlateGray","#708090","Snow","#FFFAFA","SpringGreen","#00FF7F","SteelBlue","#4682B4","Tan","#D2B48C","Teal","#008080","Thistle","#D8BFD8","Tomato","#FF6347","Turquoise","#40E0D0","Violet","#EE82EE","Wheat","#F5DEB3","White","#FFFFFF","WhiteSmoke","#F5F5F5","Yellow","#FFFF00","YellowGreen","#9ACD32"],vr={red:["LightSalmon","Salmon","DarkSalmon","LightCoral","IndianRed","Crimson","FireBrick","Red","DarkRed"],orange:["Coral","Tomato","OrangeRed","Gold","Orange","DarkOrange"],yellow:["LightYellow","LemonChiffon","LightGoldenRodYellow","PapayaWhip","Moccasin","PeachPuff","PaleGoldenRod","Khaki","DarkKhaki","Yellow"],green:["LawnGreen","Chartreuse","LimeGreen","Lime","ForestGreen","Green","DarkGreen","GreenYellow","YellowGreen","SpringGreen","MediumSpringGreen","LightGreen","PaleGreen","DarkSeaGreen","MediumSeaGreen","SeaGreen","Olive","DarkOliveGreen","OliveDrab"],cyan:["LightCyan","Cyan","Aqua","Aquamarine","MediumAquaMarine","PaleTurquoise","Turquoise","MediumTurquoise","DarkTurquoise","LightSeaGreen","CadetBlue","DarkCyan","Teal"],blue:["PowderBlue","LightBlue","LightSkyBlue","SkyBlue","DeepSkyBlue","LightSteelBlue","DodgerBlue","CornflowerBlue","SteelBlue","RoyalBlue","Blue","MediumBlue","DarkBlue","Navy","MidnightBlue","MediumSlateBlue","SlateBlue","DarkSlateBlue"],purple:["Lavender","Thistle","Plum","Violet","Orchid","Fuchsia","Magenta","MediumOrchid","MediumPurple","BlueViolet","DarkViolet","DarkOrchid","DarkMagenta","Purple","RebeccaPurple","Indigo"],pink:["Pink","LightPink","HotPink","DeepPink","PaleVioletRed","MediumVioletRed"],white:["White","Snow","HoneyDew","MintCream","Azure","AliceBlue","GhostWhite","WhiteSmoke","SeaShell","Beige","OldLace","FloralWhite","Ivory","AntiqueWhite","Linen","LavenderBlush","MistyRose"],gray:["Gainsboro","LightGray","Silver","DarkGray","Gray","DimGray","LightSlateGray","SlateGray","DarkSlateGray","Black"],brown:["Cornsilk","BlanchedAlmond","Bisque","NavajoWhite","Wheat","BurlyWood","Tan","RosyBrown","SandyBrown","GoldenRod","Peru","DarkGoldenRod","Chocolate","SaddleBrown","Sienna","Brown","Maroon"]},mr={};for(var gr=function(e){var t=re.getEnumValueName(yr[e]);Object.defineProperty(pr,t,{get:function(){return function(e,t){return mr[e]||(mr[e]=We.fromColor(t)),mr[e]}(t,yr[e+1])},enumerable:!0})},br=0;br<yr.length;br+=2)gr(br);for(var Er in vr){var Pr=vr[Er];pr.palettes[Er]={scale:Pr};for(var kr=function(e){var t=re.getEnumValueName(Pr[e]);Object.defineProperty(pr.palettes[Er],t,{get:function(){return pr[t]},enumerable:!0})},wr=0;wr<Pr.length;wr++)kr(wr)}function xr(e,t){var r="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!r){if(Array.isArray(e)||(r=function(e,t){if(!e)return;if("string"==typeof e)return Sr(e,t);var r=Object.prototype.toString.call(e).slice(8,-1);"Object"===r&&e.constructor&&(r=e.constructor.name);if("Map"===r||"Set"===r)return Array.from(e);if("Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r))return Sr(e,t)}(e))||t&&e&&"number"==typeof e.length){r&&(e=r);var n=0,i=function(){};return{s:i,n:function(){return n>=e.length?{done:!0}:{done:!1,value:e[n++]}},e:function(e){throw e},f:i}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var o,a=!0,s=!1;return{s:function(){r=r.call(e)},n:function(){var e=r.next();return a=e.done,e},e:function(e){s=!0,o=e},f:function(){try{a||null==r.return||r.return()}finally{if(s)throw o}}}}function Sr(e,t){(null==t||t>e.length)&&(t=e.length);for(var r=0,n=new Array(t);r<t;r++)n[r]=e[r];return n}var Ir=function(){function e(t){P(this,e),Object.defineProperty(this,"ctx",{value:t,enumerable:!0})}return w(e,[{key:"clearCanvas",value:function(){this.ctx.clearRect(0,0,this.ctx.canvas.width,this.ctx.canvas.height)}},{key:"setTransform",value:function(e){this.ctx.setTransform(e.a,e.b,e.c,e.d,e.tx,e.ty)}},{key:"drawRect",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:pr.GRAY.toRGBA(.3);this.ctx.strokeStyle=t.toString(),this.ctx.strokeRect(e.left,e.top,e.width,e.height)}},{key:"fillRect",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:pr.GRAY.toRGBA(.3);this.ctx.fillStyle=t.toString(),this.ctx.fillRect(e.left,e.top,e.width,e.height)}},{key:"drawPoint",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:5,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:pr.BLACK;this.ctx.beginPath(),this.ctx.arc(e.x,e.y,t,0,2*Math.PI),this.renderStyle({type:"stroke",style:r})}},{key:"fillPoint",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:5,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:pr.BLACK;this.ctx.beginPath(),this.ctx.arc(e.x,e.y,t,0,2*Math.PI),this.renderStyle({type:"fill",style:r})}},{key:"drawEllipse",value:function(e,t,r){var n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:pr.BLACK;this.ctx.beginPath(),this.ctx.ellipse(e.x,e.y,t,r,0,0,2*Math.PI),this.renderStyle({type:"stroke",style:n})}},{key:"fillEllipse",value:function(e,t,r){var n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:pr.BLACK;this.ctx.beginPath(),this.ctx.ellipse(e.x,e.y,t,r,0,0,2*Math.PI),this.renderStyle({type:"fill",style:n})}},{key:"drawShape",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:pr.DARK_MAGENTA.toRGBA(.5);this.renderShape(e,{type:"stroke",style:t})}},{key:"fillShape",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:pr.ORANGE.toRGBA(.6);this.renderShape(e,{type:"fill",style:t})}},{key:"renderShape",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};if(e instanceof $e)this.ctx.beginPath(),this.renderPath(e);else if(e instanceof ht)this.renderPolygon(e);else{if(!(e instanceof or))throw new Error("Unexpected shape type found");this.ctx.beginPath();var r,n=xr(e);try{for(n.s();!(r=n.n()).done;){var i=r.value;this.renderPolygon(i,{segment:!0})}}catch(e){n.e(e)}finally{n.f()}}this.renderStyle(t)}},{key:"renderPolygon",value:function(e){var t=this,r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};r.segment||this.ctx.beginPath(),this.renderPath(e.shape,!0),e.holes.forEach((function(e){return t.renderPath(e,{holesDirection:ht.PointsDirection.CLOCKWISE})})),r.segment||this.renderStyle(r)}},{key:"renderPath",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},r=!t.holesDirection||t.holesDirection==ht.PointsDirection.CLOCKWISE;if(r){this.ctx.moveTo(e.getPointX(0),e.getPointY(0));for(var n=1;n<e.length;n++)this.ctx.lineTo(e.getPointX(n),e.getPointY(n))}else{this.ctx.moveTo(e.getPointX(e.length-1),e.getPointY(e.length-1));for(var i=e.length-2;i>=0;i--)this.ctx.lineTo(e.getPointX(i),e.getPointY(i))}this.ctx.closePath(),this.renderStyle(t)}},{key:"renderStyle",value:function(e){if(e.type){if("fill"!=e.type&&"stroke"!=e.type)throw new Error("Option type should be oneof(stroke, fill)");e.style&&(this.ctx["".concat(e.type,"Style")]=e.style instanceof We?e.style.toString():e.style),this.ctx[e.type]()}}}]),e}();function Rr(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var r,n=O(e);if(t){var i=O(this).constructor;r=Reflect.construct(n,arguments,i)}else r=n.apply(this,arguments);return A(this,r)}}var Tr=function(e){R(r,e);var t=Rr(r);function r(e,n,i){var o,a=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0,s=arguments.length>4&&void 0!==arguments[4]?arguments[4]:1;return P(this,r),(o=t.call(this,n,i,e)).ts=a,o.tf=s,Object.defineProperty(T(o),"segmentsCount",{value:o.length-3,configurable:!0}),Object.defineProperty(T(o),"bounds",{get:function(){return V.ofSpline(T(o),o.pointProps.scattering).ceil()},enumerable:!0}),Object.defineProperty(T(o),"color",{get:function(){return We.isColor(o.pointProps)?We.fromColor(o.pointProps):void 0},set:function(e){if(!e)throw new Error("Spline color cannot be removed");if(!(e instanceof We))throw new Error("Expected value should be Color instance");"red"in o.pointProps&&(o.pointProps.red=e.red),"green"in o.pointProps&&(o.pointProps.green=e.green),"blue"in o.pointProps&&(o.pointProps.blue=e.blue),"alpha"in o.pointProps&&(o.pointProps.alpha=e.alpha)},enumerable:!0}),o.validate(),o}return w(r,[{key:"validate",value:function(){if(!this.layout.includes(le.Property.X))throw new Error("Layout doesn't contains required properties X");if(!this.layout.includes(le.Property.Y))throw new Error("Layout doesn't contains required properties Y");if(0==this.points.length)throw new Error("Empty spline is not allowed");if(this.points.length%this.stride!=0)throw new Error("Path length doesn't match the stride provided via the layout");if(this.ts<0||this.ts>=1)throw new Error("Invalid spline ts ".concat(this.ts," found. The value must be in the interval [0, 1)."));if(this.tf<=0||this.tf>1)throw new Error("Invalid spline tf ".concat(this.tf," found. The value must be in the interval (0, 1]."));if(1==this.segmentsCount&&this.ts>this.tf)throw new Error("Invalid spline t range ".concat(this.ts," - ").concat(this.tf," found. Spline has only one segment and ts <= tf."));if(this.segmentsCount<1)throw new Error("Incompleted spline found. Spline is defined with at least 4 control points.")}},{key:"clone",value:function(){return new r(this.layout.slice(),this.points.clone(),Object.clone(this.pointProps),this.ts,this.tf)}},{key:"getSegment",value:function(e){var t=e,r=e+3,n=0==t?this.ts:0,i=r+1==this.length?this.tf:1;return this.slice({fromPointIndex:t,toPointIndex:r,fromTValue:n,toTValue:i})}},{key:"slice",value:function(e){var t=this.slicePoints(e.fromPointIndex,e.toPointIndex,e.fromTValue,e.toTValue),n=new r(this.layout.slice(),t,Object.clone(this.pointProps),e.fromTValue,e.toTValue);return n.id=e.id,n}},{key:"toPlainPath",value:function(){for(var e=[],t=0;t<this.length;t++)e.push(this.getPointX(),this.getPointY());return new tt(e)}},{key:"toJSON",value:function(){return{type:"Spline",id:this.id,layout:this.layout.map((function(e){return e.name})),points:Ye.encode(this.points,this.encoding),pointProps:this.pointProps,ts:this.ts,tf:this.tf}}}],[{key:"fromJSON",value:function(e){var t=Ye.decode(e.points),n=new r(e.layout.map((function(e){return le.Property[e]})),t,e.pointProps,e.ts,e.tf);return n.id=e.id,n}},{key:"fromRect",value:function(e,t){return new r(void 0,[e.left,e.top,e.left,e.top,e.right,e.top,e.right,e.bottom,e.left,e.bottom,e.left,e.top,e.left,e.top],t)}}]),r}(nt);function Ar(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var r,n=O(e);if(t){var i=O(this).constructor;r=Reflect.construct(n,arguments,i)}else r=n.apply(this,arguments);return A(this,r)}}var Or=function(e){R(r,e);var t=Ar(r);function r(e,n,i){var o,a=arguments.length>3&&void 0!==arguments[3]?arguments[3]:[];P(this,r),o=t.call(this,n,i,e),a.length>0&&!Object.isFrozen(a.first)&&a.forEach((function(e){return Object.freeze(e)})),Object.defineProperty(T(o),"splineParameters",{value:Object.freeze(a),enumerable:!0});var s=new Ke(e,i);return Object.defineProperty(T(o),"style",{get:function(){return s.style},set:function(e){return s.style.reset(e)},enumerable:!0}),Object.defineProperty(T(o),"color",{get:function(){return o.style.color},set:function(e){if(!e)throw new Error("Spline color cannot be removed");if(!(e instanceof We))throw new Error("Expected value should be Color instance");"red"in o.pointProps&&(o.pointProps.red=e.red),"green"in o.pointProps&&(o.pointProps.green=e.green),"blue"in o.pointProps&&(o.pointProps.blue=e.blue),"alpha"in o.pointProps&&(o.pointProps.alpha=e.alpha)},enumerable:!0}),Object.defineProperty(T(o),"bounds",{get:function(){return V.ofSpline(T(o),o.pointProps.scattering).ceil()},enumerable:!0}),o.validate(),o}return w(r,[{key:"validate",value:function(){if(!this.layout.includes(le.Property.X))throw new Error("Layout doesn't contains required properties X");if(!this.layout.includes(le.Property.Y))throw new Error("Layout doesn't contains required properties Y");if(0==this.points.length)throw new Error("Empty spline is not allowed");if(this.points.length%this.stride!=0)throw new Error("Path length doesn't match the stride provided via the layout")}},{key:"clone",value:function(){return new r(this.layout.slice(),this.points.clone(),Object.clone(this.pointProps),this.splineParameters.slice())}},{key:"getPoint",value:function(e){return nr(O(r.prototype),"getPoint",this).call(this,e,this.style)}},{key:"getPointSegmentIndex",value:function(e){return this.splineParameters[e]?this.splineParameters[e].index:void 0}},{key:"getPointT",value:function(e){return this.splineParameters[e]?this.splineParameters[e].t:void 0}},{key:"getPointParameter",value:function(e){return this.splineParameters[e]}},{key:"toJSON",value:function(){return{type:"InterpolatedSpline",layout:this.layout.map((function(e){return e.name})),points:Ye.encode(this.points,this.encoding),pointProps:this.pointProps,splineParameters:this.splineParameters}}}],[{key:"fromJSON",value:function(e){var t=Ye.decode(e.points);return new r(e.layout.map((function(e){return le.Property[e]})),t,e.pointProps,e.splineParameters)}},{key:"fromRect",value:function(e,t){throw new Error("InterpolatedSpline.fromRect is not supported. Try Spline.fromRect and interpolate with particular Spline interpolator.")}}]),r}(nt);function Cr(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var r,n=O(e);if(t){var i=O(this).constructor;r=Reflect.construct(n,arguments,i)}else r=n.apply(this,arguments);return A(this,r)}}var Dr=i.mat4.fromValues(0,-.5,1,-.5,1,0,-2.5,1.5,0,.5,2,-1.5,0,0,-.5,.5),Nr=function(e){R(r,e);var t=Cr(r);function r(){var e,n=arguments.length>0&&void 0!==arguments[0]&&arguments[0],i=arguments.length>1&&void 0!==arguments[1]&&arguments[1];return P(this,r),(e=t.call(this)).calculateDerivates=n,e.keepSplineParameters=i,e.state={lastPointPosition:void 0,lastPointSize:0},e}return w(r,[{key:"initState",value:function(e){var t=this;this.state.layout={},e.layout.forEach((function(e,r){t.state.layout[e.name]={index:r,polynomials:i.vec4.create()}})),this.keepSplineParameters&&(this.state.splineParameters=[]),this.splineLayout=e.layout,this.pathPointProps=Object.clone(e.pointProps),this.scattering&&(this.pathPointProps.scattering=this.scattering),this.layout=this.calculateDerivates?e.layout.concat([le.Property.D_X,le.Property.D_Y]):e.layout,this.state.ready=!0}},{key:"predict",value:function(e){if(!e)return[];this.state.ready||this.initState(e);var t=Object.clone(this.state);delete this.state.splineParameters,this.resetState();var r=this.discretize(e);return this.state=t,r}},{key:"buildImpl",value:function(e){return e?(this.state.ready||this.initState(e),this.discretize(e)):[]}},{key:"getOutput",value:function(e,t){if(0!=e.length){var n=t==r.OutputType.ALL_DATA?void 0:this.state.splineParameters;return n&&(n=n.slice()),new Or(this.layout,e,this.pathPointProps,n)}}},{key:"discretize",value:function(e){throw new Error("This method is abstract and should be implemented")}},{key:"storeLastPoint",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;this.state.lastPointPosition=new X(this.getPropValue(le.Property.X,e,t),this.getPropValue(le.Property.Y,e,t),this.getPropValue(le.Property.Z,e,t)),this.state.lastPointSize=this.getPropValue(le.Property.SIZE,e,t)}},{key:"getPropValue",value:function(e,t){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;return this.state.layout[e.name]?t[r+this.state.layout[e.name].index]:void 0}},{key:"calculatePolynomials",value:function(e,t){var r=this,n=e.points,o=this.splineLayout.length*(t+0),a=this.splineLayout.length*(t+1),s=this.splineLayout.length*(t+2),u=this.splineLayout.length*(t+3);this.splineLayout.forEach((function(e,t){var c=i.vec4.fromValues(n[o+t],n[a+t],n[s+t],n[u+t]);i.vec4.transformMat4(r.state.layout[e.name].polynomials,c,Dr)}))}},{key:"calculateInterpolatedPoint",value:function(e,t,r){var n=this;this.initState(e);var o=new le(0,0,this.splineLayout.includes(le.Property.Z)?0:void 0),a=i.vec4.fromValues(1,r,r*r,r*r*r);return this.calculatePolynomials(e,t),this.splineLayout.forEach((function(e){var t=i.vec4.dot(n.state.layout[e.name].polynomials,a);o[re.getPropName(e.name)]=t})),o}},{key:"samplePoint",value:function(e){var t=this,r=[],n=i.vec4.fromValues(1,e,e*e,e*e*e);return this.splineLayout.forEach((function(e){var o=i.vec4.dot(t.state.layout[e.name].polynomials,n);r.push(o)})),this.calculateDerivates&&(r.push(this.getDerivativeOf(this.state.layout.X.polynomials,n)),r.push(this.getDerivativeOf(this.state.layout.Y.polynomials,n))),r}},{key:"getDerivativeOf",value:function(e,t){var r=i.vec4.fromValues(e[1],2*e[2],3*e[3],0);return i.vec4.dot(r,t)}},{key:"keepSegmentT",value:function(e,t){this.state.splineParameters&&this.state.splineParameters.push(r.defineParameter(e,t))}},{key:"resetState",value:function(){}},{key:"reset",value:function(){nr(O(r.prototype),"reset",this).call(this),this.state.ready=!1,this.state.lastPointPosition=void 0,this.state.lastPointSize=0,delete this.state.splineParameters}}],[{key:"defineParameter",value:function(e,t){return e>0&&0==t?{index:e-1,t:1}:{index:e,t:t}}}]),r}(It);function Mr(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var r,n=O(e);if(t){var i=O(this).constructor;r=Reflect.construct(n,arguments,i)}else r=n.apply(this,arguments);return A(this,r)}}var Lr=function(e){R(r,e);var t=Mr(r);function r(){var e,n=arguments.length>0&&void 0!==arguments[0]?arguments[0]:.1,i=arguments.length>1?arguments[1]:void 0,o=arguments.length>2?arguments[2]:void 0;return P(this,r),(e=t.call(this,i,o)).spacing=n,e}return w(r,[{key:"split",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:8,r=this.spacing;this.spacing=1,this.splitCount=t;var n=this.build(e);return this.spacing=r,delete this.splitCount,n}},{key:"discretize",value:function(e){for(var t=[],r=this.splitCount,n=Math.max(1,10*(this.spacing>1?1:this.spacing)),o=0;o<e.segmentsCount;o++){if(this.calculatePolynomials(e,o),isNaN(this.splitCount)){var a=e.getPoint(o+1),s=e.getPoint(o+2),u=i.vec2.distance(a.value,s.value),c=this.pathPointProps.size;this.state.layout.SIZE&&(c=Math.min(a.size,s.size)),r=Math.floor(n*(u/c)/this.spacing)+1}for(var l=1/r,h=0;h<=r;h++){var f=!this.state.lastPointPosition,d=h/r;if(0==o&&d<e.ts){if(!(d+l>=e.ts))continue;d=e.ts,f=this.spacing<=1}if(o==e.segmentsCount-1&&d>=e.tf){if(!(d<e.tf+l))continue;d=e.tf,f=this.lastSegment&&this.spacing<=1}if(!(o>0&&0==d)){var p=this.samplePoint(d);if(!f&&this.state.lastPointPosition){var y=new X(this.getPropValue(le.Property.X,p),this.getPropValue(le.Property.Y,p),this.getPropValue(le.Property.Z,p)),v=this.state.lastPointPosition.vec.squaredDistance(this.state.lastPointPosition.value,y.value),m=(this.state.layout.SIZE?(this.state.lastPointSize+p[this.state.layout.SIZE.index])/2:this.pathPointProps.size)*this.spacing;f=v>=m*m}f&&(t.push.apply(t,te(p)),this.storeLastPoint(p),this.keepSegmentT(o,d))}}}return this.state.splineParameters&&(0!=t.length&&this.state.splineParameters.first.t==e.ts||(t.unshift.apply(t,te(this.samplePoint(e.ts))),this.state.splineParameters.unshift(Nr.defineParameter(0,e.ts))),this.state.splineParameters.last.t!=e.tf&&(t.push.apply(t,te(this.samplePoint(e.tf))),this.state.splineParameters.push(Nr.defineParameter(e.segmentsCount-1,e.tf)))),t}}]),r}(Nr);function Br(e,t){var r="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!r){if(Array.isArray(e)||(r=function(e,t){if(!e)return;if("string"==typeof e)return _r(e,t);var r=Object.prototype.toString.call(e).slice(8,-1);"Object"===r&&e.constructor&&(r=e.constructor.name);if("Map"===r||"Set"===r)return Array.from(e);if("Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r))return _r(e,t)}(e))||t&&e&&"number"==typeof e.length){r&&(e=r);var n=0,i=function(){};return{s:i,n:function(){return n>=e.length?{done:!0}:{done:!1,value:e[n++]}},e:function(e){throw e},f:i}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var o,a=!0,s=!1;return{s:function(){r=r.call(e)},n:function(){var e=r.next();return a=e.done,e},e:function(e){s=!0,o=e},f:function(){try{a||null==r.return||r.return()}finally{if(s)throw o}}}}function _r(e,t){(null==t||t>e.length)&&(t=e.length);for(var r=0,n=new Array(t);r<t;r++)n[r]=e[r];return n}var Fr=function(){function e(){P(this,e),this.interpolator=new Lr(.1,!1,!0)}return w(e,[{key:"build",value:function(e,t,r){this.context=e,this.path=r,this.holesPerStroke={},this.strokeHoles=[],t.sort(re.comparator({sortBy:"strokeID",sortOrder:"asc"},{sortBy:"segmentIndex",sortOrder:"asc"},{sortBy:"splineIndex",sortOrder:"asc"},{sortBy:"pointIndex",sortOrder:"asc"})),this.debug&&(this.table=new ne([{name:"strokeID",title:"Stroke ID"},{name:"segmentIndex",title:"Segment Index"},{name:"splineIndex",title:"Spline Index"},{name:"pointIndex",title:"Point Index"},{name:"prevT",title:"Prev T"},{name:"t",title:"T Value"},{name:"nextT",title:"Next T"},{name:"ts",title:"Start T"},{name:"tf",title:"End T"},{name:"size",title:"Size"},{name:"hole",title:"HolePart"},{name:"nodeIndex",title:"Node Index"}]));var n,i=Br(t);try{for(i.s();!(n=i.n()).done;){var o=n.value;this.isHolePart(o)?this.update(o):this.add(o),this.debug&&this.table.insert({strokeID:o.strokeID,segmentIndex:o.segmentIndex,splineIndex:o.splineIndex,pointIndex:o.pointIndex,prevT:o.prevT.toFixed(4),t:o.t.toFixed(4),nextT:o.nextT.toFixed(4),ts:o.spline.ts.toFixed(4),tf:o.spline.tf.toFixed(4),size:"".concat(o.bounds.width.toFixed(2)," / ").concat(o.bounds.height.toFixed(2)),hole:o.hole,nodeIndex:o.nodeIndex})}}catch(e){i.e(e)}finally{i.f()}return this.debug&&this.table.length>0&&console.log(this.table.toString()),this.narrow(),this.holesPerStroke}},{key:"add",value:function(e){this.strokeHoles=this.holesPerStroke[e.strokeID],this.strokeHoles||(this.strokeHoles=[],this.holesPerStroke[e.strokeID]=this.strokeHoles);var t=this.context.getNodes(e.strokeID).indexOf(e);this.strokeHoles.push({fromPointIndex:e.segmentIndex,toPointIndex:e.segmentIndex,fromTValue:e.prevT,toTValue:e.nextT,fromNodeIndex:t,toNodeIndex:t,strokeID:e.strokeID}),this.debug&&(e.hole=!1,e.nodeIndex=t)}},{key:"update",value:function(e){var t=this.strokeHoles.last;t.toPointIndex=e.segmentIndex,t.toTValue=e.nextT,t.toNodeIndex=this.context.getNodes(e.strokeID).indexOf(e),this.debug&&(e.hole=!0,e.nodeIndex=t.toNodeIndex)}},{key:"isHolePart",value:function(e){var t=this.strokeHoles.last;return!(!t||t.strokeID!=e.strokeID)&&(e.segmentIndex==t.toPointIndex&&e.prevT<=t.toTValue||e.segmentIndex==t.toPointIndex+1&&1==t.toTValue&&0==e.prevT)}},{key:"narrow",value:function(){for(var e=0,t=Object.values(this.holesPerStroke);e<t.length;e++){var r,n=Br(t[e]);try{for(n.s();!(r=n.n()).done;){var i=r.value,o=this.context.getNodes(i.strokeID),a=o[i.fromNodeIndex],s=o[i.toNodeIndex],u={s:this.extractT(a,"s",a.prevT,a.nextT),f:this.extractT(s,"f",s.prevT,s.nextT)};a.ts=u.s,s.tf=u.f,i.fromTValue=u.s,i.toTValue=u.f}}catch(e){n.e(e)}finally{n.f()}}}},{key:"extractT",value:function(e,t,r,n){var i,o,a="s"==t?r:n;try{i=new Tr(e.spline.layout,e.spline.points,e.spline.pointProps,r,n)}catch(e){return a}for(var s=this.interpolator.build(i),u=0;u<s.length;u++){var c=s.getPoint(u),l=this.context.getBrushApplier(e.strokeID).applyBrush(c);if(this.path.intersects(l)){if("s"==t){a=o;break}o=s.getPointT(u)}else if("s"==t)o=s.getPointT(u);else if(o){a=s.getPointT(u);break}}return a}}]),e}();function Ur(e,t){var r="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!r){if(Array.isArray(e)||(r=function(e,t){if(!e)return;if("string"==typeof e)return jr(e,t);var r=Object.prototype.toString.call(e).slice(8,-1);"Object"===r&&e.constructor&&(r=e.constructor.name);if("Map"===r||"Set"===r)return Array.from(e);if("Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r))return jr(e,t)}(e))||t&&e&&"number"==typeof e.length){r&&(e=r);var n=0,i=function(){};return{s:i,n:function(){return n>=e.length?{done:!0}:{done:!1,value:e[n++]}},e:function(e){throw e},f:i}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var o,a=!0,s=!1;return{s:function(){r=r.call(e)},n:function(){var e=r.next();return a=e.done,e},e:function(e){s=!0,o=e},f:function(){try{a||null==r.return||r.return()}finally{if(s)throw o}}}}function jr(e,t){(null==t||t>e.length)&&(t=e.length);for(var r=0,n=new Array(t);r<t;r++)n[r]=e[r];return n}var Gr,Yr=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:e.Mode.WHOLE_STROKE;P(this,e),this.mode=t,this.operations=Promise.resolve(),this.holesBuilder=new Fr}var t;return w(e,[{key:"updateSegmentation",value:function(t){if(!this.context)throw new Error("Required spatial context not found");if(t&&0!=t.length){var r,n=[],i=!1,o=Ur(t);try{for(o.s();!(r=o.n()).done;){var a=r.value,s=this.context.search(a.bounds);if(0!=s.length){var u,c=[],l=Ur(s);try{for(l.s();!(u=l.n()).done;){var h=u.value;switch(h.depth){case e.SegmentationDepth.STROKE_BOUNDS:for(var f=[],d=this.context.getStroke(h.strokeID),p=this.context.getBrushApplier(d.id),y=0;y<d.segmentsCount;y++){var v=e.buildStrokeSegment(d.id,d.spline,y,p);f.push(v)}this.context.updateTree(h,f),c=c.concat(f),i=!0;break;case e.SegmentationDepth.STROKE_SEGMENT:for(var m=[],g=this.context.getBrushApplier(h.strokeID),b=this.context.distanceInterpolator.build(h.spline),E=g.build(b),P=this.buildShapeSegment(0,h.spline,b,E),k=0;k<b.length-1;k++){var w=this.buildSplineSegment(h,k,b,E,P);P=w.fPoint,m.push(w)}this.context.updateTree(h,m),c=c.concat(m),i=!0;break;case e.SegmentationDepth.SPLINE_SEGMENT:h.convex=this.context.convexHullChainProducer.build(h.shapesPath),h.shape=h.convex.first,h.depth=e.SegmentationDepth.CONVEX,i=!0;break;case e.SegmentationDepth.CONVEX:if(h.convex.intersects(a))if(this.mode==e.Mode.PARTIAL_STROKE){var x=[];x.push(this.buildPointSegment(h,0)),x.push(this.buildPointSegment(h,1)),this.context.updateTree(h,x),c=c.concat(x),i=!0}else n.push(h);break;case e.SegmentationDepth.SHAPE:n.push(h);break;default:throw new Error("Invalid node depth found: ".concat(h.depth))}}}catch(e){l.e(e)}finally{l.f()}if(c.length>0&&this.context.load(c),i){this.updateSegmentation(t);break}var S,I=Ur(n);try{for(I.s();!(S=I.n()).done;){var R=S.value;this.nodes.add(R)}}catch(e){I.e(e)}finally{I.f()}this.context.tree.canvas&&this.context.tree.canvas.refresh()}}}catch(e){o.e(e)}finally{o.f()}}}},{key:"updateSegmentationAsync",value:(t=fe(pe.mark((function t(r){var n,i,o,a,s,u,c,l,h,f,d,p,y,v,m,g,b,E,P,k,w,x,S;return pe.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(this.context){t.next=2;break}throw new Error("Required spatial context not found");case 2:if(r&&0!=r.length){t.next=4;break}return t.abrupt("return");case 4:n=!1,i=Ur(r),t.prev=6,i.s();case 8:if((o=i.n()).done){t.next=69;break}if(a=o.value,0!=(s=this.context.search(a.bounds)).length){t.next=13;break}return t.abrupt("continue",67);case 13:u=[],c=Ur(s),t.prev=15,c.s();case 17:if((l=c.n()).done){t.next=51;break}h=l.value,t.t0=h.depth,t.next=t.t0===e.SegmentationDepth.STROKE_BOUNDS?22:t.t0===e.SegmentationDepth.STROKE_SEGMENT?30:t.t0===e.SegmentationDepth.SPLINE_SEGMENT?39:t.t0===e.SegmentationDepth.CONVEX?43:t.t0===e.SegmentationDepth.SHAPE?45:48;break;case 22:return f=this.context.getStroke(h.strokeID),t.next=25,this.context.segmentsProducer.buildStrokeSegments(f);case 25:return d=t.sent,this.context.updateTree(h,d),u=u.concat(d),n=!0,t.abrupt("break",49);case 30:for(p=[],y=this.context.getBrushApplier(h.strokeID),v=this.context.curvatureInterpolator.build(h.spline),m=y.build(v),g=0;g<v.length-1;g++)b=this.buildSplineSegment2(h,g,v,m),p.push(b);return this.context.updateTree(h,p),u=u.concat(p),n=!0,t.abrupt("break",49);case 39:return h.convex=this.context.convexHullChainProducer.build(h.shapesPath),h.depth=e.SegmentationDepth.CONVEX,n=!0,t.abrupt("break",49);case 43:if(h.convex.intersects(a))if(this.mode==e.Mode.PARTIAL_STROKE){for(E=[],P=this.context.getBrushApplier(h.strokeID),k=this.context.distanceInterpolator.build(h.spline),w=P.build(k),x=0;x<k.length;x++)S=this.buildPointSegment2(h,x,k,w),E.push(S);this.context.updateTree(h,E),u=u.concat(E),n=!0}else this.nodes2.push(h),this.context.unload(h);return t.abrupt("break",49);case 45:return this.nodes2.push(h),this.context.unload(h),t.abrupt("break",49);case 48:throw new Error("Invalid node depth found: ".concat(h.depth));case 49:t.next=17;break;case 51:t.next=56;break;case 53:t.prev=53,t.t1=t.catch(15),c.e(t.t1);case 56:return t.prev=56,c.f(),t.finish(56);case 59:if(u.length>0&&this.context.load(u),!n){t.next=66;break}return t.next=63,this.updateSegmentationAsync(r);case 63:return t.abrupt("break",69);case 66:this.context.tree.canvas&&this.context.tree.canvas.refresh();case 67:t.next=8;break;case 69:t.next=74;break;case 71:t.prev=71,t.t2=t.catch(6),i.e(t.t2);case 74:return t.prev=74,i.f(),t.finish(74);case 77:case"end":return t.stop()}}),t,this,[[6,71,74,77],[15,53,56,59]])}))),function(e){return t.apply(this,arguments)})},{key:"buildSplineSegment",value:function(t,r,n,i,o){var a=new cr(i[r],i[r+1]),s=this.buildShapeSegment(r+1,t.spline,n,i);return{strokeID:t.strokeID,segmentIndex:t.segmentIndex,splineIndex:r,bounds:a.bounds,spline:new Tr(t.spline.layout,t.spline.points,t.spline.pointProps,n.getPointT(r),n.getPointT(r+1)),shapesPath:a,sPoint:o,fPoint:s,depth:e.SegmentationDepth.SPLINE_SEGMENT}}},{key:"buildSplineSegment2",value:function(t,r,n,i){var o=new cr(i[r],i[r+1]);return{strokeID:t.strokeID,segmentIndex:t.segmentIndex,splineIndex:r,bounds:o.bounds,spline:new Tr(t.spline.layout,t.spline.points,t.spline.pointProps,n.getPointT(r),n.getPointT(r+1)),shapesPath:o,depth:e.SegmentationDepth.SPLINE_SEGMENT}}},{key:"buildShapeSegment",value:function(e,t,r,n){var i=n[e],o=i.bounds,a=r.getPointT(e),s=r.getPointT(e-1),u=r.getPointT(e+1);if(isNaN(s)&&(s=t.ts),isNaN(u)&&(u=t.tf),o.width!=o.height){var c=Math.max(o.width,o.height);o=new V(o.center.x-c/2,o.center.y-c/2,c,c)}return{shape:i,prevT:s,t:a,nextT:u,bounds:o}}},{key:"buildPointSegment",value:function(t,r){var n=0==r?t.sPoint:t.fPoint;return{strokeID:t.strokeID,segmentIndex:t.segmentIndex,splineIndex:t.splineIndex,pointIndex:r,spline:t.spline,bounds:n.bounds,prevT:n.prevT,t:n.t,nextT:n.nextT,shape:n.shape,depth:e.SegmentationDepth.SHAPE}}},{key:"buildPointSegment2",value:function(t,r,n,i){var o=this.buildShapeSegment(r,t.spline,n,i);return{strokeID:t.strokeID,segmentIndex:t.segmentIndex,splineIndex:t.splineIndex,pointIndex:r,spline:t.spline,bounds:o.bounds,prevT:o.prevT,t:o.t,nextT:o.nextT,shape:o.shape,depth:e.SegmentationDepth.SHAPE}}},{key:"createIntervals",value:function(e,t){var r={intersected:{},selected:[]};if(0==t.length)return r;var n=this.holesBuilder.build(this.context,e instanceof Set?Array.from(e):e,t);for(var i in n){var o=n[i],a=this.context.getNodes(i),s=[],u=[];r.intersected[i]={intervals:s,holes:u};var c,l=Ur(o);try{for(l.s();!(c=l.n()).done;){var h=c.value,f=0==h.fromPointIndex&&h.fromTValue==a.first.ts,d=h.toPointIndex==a.last.segmentIndex&&h.toTValue==a.last.tf;if(f&&d)r.selected.push(i),delete r.intersected[i];else{u.push(h),this.context.tree.canvas&&this.context.tree.canvas.addOperation("drawIntersection",t,this.context.getNodes(h.strokeID).slice(h.fromNodeIndex,h.toNodeIndex+1));var p=void 0;f?p={fromPointIndex:h.toPointIndex,fromTValue:h.toTValue,fromNodeIndex:h.toNodeIndex}:d?(s.last||s.push({fromPointIndex:0,fromTValue:a.first.spline.ts,fromNodeIndex:0}),s.last.toPointIndex=h.fromPointIndex+3,s.last.toTValue=h.fromTValue,s.last.toNodeIndex=h.fromNodeIndex):s.last?(s.last.toPointIndex=h.fromPointIndex+3,s.last.toTValue=h.fromTValue,s.last.toNodeIndex=h.fromNodeIndex,p={fromPointIndex:h.toPointIndex,fromTValue:h.toTValue,fromNodeIndex:h.toNodeIndex}):(s.push({fromPointIndex:0,fromTValue:a.first.spline.ts,toPointIndex:h.fromPointIndex+3,toTValue:h.fromTValue,fromNodeIndex:0,toNodeIndex:h.fromNodeIndex}),p={fromPointIndex:h.toPointIndex,fromTValue:h.toTValue,fromNodeIndex:h.toNodeIndex}),p&&s.push(p),h!=o.last||d||(s.last.toPointIndex=a.last.segmentIndex+3,s.last.toTValue=a.last.spline.tf,s.last.toNodeIndex=a.length-1)}}}catch(e){l.e(e)}finally{l.f()}for(var y=[],v=function(){var e=g[m];if(1==e.fromTValue){var t=a.filter((function(t){return t.segmentIndex==e.fromPointIndex+1})).first,r=a.filter((function(t){return t.segmentIndex==e.fromPointIndex}));u.push({fromNodeIndex:r.first.nodeIndex||a.indexOf(r.first),toNodeIndex:r.last.nodeIndex||a.indexOf(r.last),type:"OVERLAPPING_INC"}),e.fromPointIndex++,e.fromTValue=0,e.fromNodeIndex=a.indexOf(t)}if(0==e.toTValue){var n=e.toPointIndex-3,i=a.filter((function(e){return e.segmentIndex==n-1})).last,o=a.filter((function(e){return e.segmentIndex==n}));u.push({fromNodeIndex:o.first.nodeIndex||a.indexOf(o.first),toNodeIndex:o.last.nodeIndex||a.indexOf(o.last),type:"OVERLAPPING_DEC"}),e.toPointIndex--,e.toTValue=1,e.toNodeIndex=a.indexOf(i)}if(e.toPointIndex-e.fromPointIndex<3)y.push(e);else if(e.toPointIndex-e.fromPointIndex==3&&e.fromTValue>=e.toTValue){var s=a.filter((function(t){return t.segmentIndex==e.fromPointIndex}));u.push({fromNodeIndex:s.first.nodeIndex||a.indexOf(s.first),toNodeIndex:s.last.nodeIndex||a.indexOf(s.last),type:"INVALID"}),y.push(e)}},m=0,g=s;m<g.length;m++)v();s.remove.apply(s,y),0==s.length&&(r.selected.includes(i)||r.selected.push(i),delete r.intersected[i])}return r}},{key:"reset",value:function(e){if(!e)throw new Error("Required spatial context not found");this.context=e,this.nodes=new Set,this.nodes2=[],this.context.tree.canvas&&this.context.tree.canvas.refresh()}}],[{key:"buildStrokeNode",value:function(t){return{strokeID:t.id,bounds:t.bounds,depth:e.SegmentationDepth.STROKE_BOUNDS}}},{key:"buildStrokeSegment",value:function(t,r,n,i){if(n<0||n>=r.segmentsCount)throw new Error("Invalid index ".concat(n," found. Ensure that index range is {0, ").concat(r.segmentsCount-1,"}."));var o=.166666666666,a=r.getSegment(n),s=a.getPoint(0),u=a.getPoint(1),c=a.getPoint(2),l=a.getPoint(3),h=-o*s.x+u.x+o*c.x,f=-o*s.y+u.y+o*c.y,d=+o*u.x+c.x-o*l.x,p=+o*u.y+c.y-o*l.y,y=u.toArray(a.layout).concat(c.toArray(a.layout)),v=new Or(a.layout,y,a.pointProps),m=i.build(v),g=m.first.bounds,b=m.last.bounds,E=Math.max(g.width,b.height),P=Math.max(g.height,b.height),k=Math.max(E,P),w=new V(h-k/2,f-P/2,k,k),x=new V(d-k/2,p-P/2,k,k);return{strokeID:t,segmentIndex:n,bounds:g.union(b).union(w).union(x),spline:a,depth:e.SegmentationDepth.STROKE_SEGMENT}}}]),e}();function Xr(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var r,n=O(e);if(t){var i=O(this).constructor;r=Reflect.construct(n,arguments,i)}else r=n.apply(this,arguments);return A(this,r)}}Yr.SegmentationDepth={STROKE_BOUNDS:0,STROKE_SEGMENT:1,SPLINE_SEGMENT:2,CONVEX:3,SHAPE:4},Object.defineEnum(Yr,"Mode",["WHOLE_STROKE","PARTIAL_STROKE"]);var zr=(S(Gr={},Yr.SegmentationDepth.STROKE_BOUNDS,pr.RED),S(Gr,Yr.SegmentationDepth.STROKE_SEGMENT,pr.BLUE),S(Gr,Yr.SegmentationDepth.SPLINE_SEGMENT,pr.BROWN),S(Gr,Yr.SegmentationDepth.CONVEX,pr.MAGENTA),S(Gr,Yr.SegmentationDepth.SHAPE,pr.GREEN),Gr),Vr=function(e){R(r,e);var t=Xr(r);function r(e){var n;P(this,r),(n=t.call(this,e.getContext("2d"))).operations=[];var i=n.refresh.bind(T(n));return n.refresh=re.debounce(i,100),n}return w(r,[{key:"addOperation",value:function(e){for(var t=arguments.length,r=new Array(t>1?t-1:0),n=1;n<t;n++)r[n-1]=arguments[n];this.operations.push({name:e,args:r})}},{key:"clear",value:function(){var e=this.ctx.canvas.toRect().transform(this.ctx.getTransform().invert());this.ctx.clearRect(e.left,e.top,e.width,e.height),this.clearCanvas()}},{key:"refresh",value:function(){var e=this,t=[];r.allocateSegments(t,this.data,0),this.clear();for(var n=t.length-1;n>=0;n--){var i=t[n],o=zr[i.depth];i.depth==Yr.SegmentationDepth.SHAPE?this.drawShape(i.shape,o):i.depth==Yr.SegmentationDepth.CONVEX?this.drawShape(i.convex.first,o):this.drawRect(i.bounds,o)}this.operations.forEach((function(t){return e[t.name].apply(e,te(t.args))})),this.operations.clear()}},{key:"drawRange",value:function(e){var t=this;e.forEach((function(e){return t.drawRect(e.bounds,pr.PURPLE)}))}},{key:"drawIntersection",value:function(e,t){var r=this;t.forEach((function(e){return r.fillShape(e.shape,pr.YELLOW.toRGBA(.8))})),this.fillShape(e,pr.PINK.toRGBA(.3))}},{key:"drawSelection",value:function(e,t,r){this.fillRect(e),this.fillShape(t,pr.DARK_MAGENTA.toRGBA(.5)),this.fillShape(r)}}],[{key:"allocateSegments",value:function(e,t,n){if(t&&(t.bounds&&e.push(t),t.children))if(10!==n)for(var i=0;i<t.children.length;i++)r.allocateSegments(e,t.children[i],n+1);else console.warn("depth 10")}},{key:"getInstance",value:function(e,t){if(e){var n=new r(e);return Object.defineProperty(n,"data",{get:function(){return t.data},enumerable:!0}),n}}}]),r}(Ir);function Hr(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var r,n=O(e);if(t){var i=O(this).constructor;r=Reflect.construct(n,arguments,i)}else r=n.apply(this,arguments);return A(this,r)}}var Zr=function(e){R(r,e);var t=Hr(r);function r(){var e,n;P(this,r);for(var i=arguments.length,o=new Array(i),a=0;a<i;a++)o[a]=arguments[a];return e=t.call.apply(t,[this].concat(o)),"undefined"!=typeof document&&("loading"==document.readyState?addEventListener("DOMContentLoaded",(function(t){return n=Vr.getInstance(document.getElementById("rbush"),T(e))})):n=Vr.getInstance(document.getElementById("rbush"),T(e))),Object.defineProperty(T(e),"canvas",{get:function(){return e.debug?n:null},enumerable:!0}),e}return w(r,[{key:"toBBox",value:function(e){return{minX:e.bounds.left,minY:e.bounds.top,maxX:e.bounds.right,maxY:e.bounds.bottom}}},{key:"compareMinX",value:function(e,t){return e.bounds.x-t.bounds.x}},{key:"compareMinY",value:function(e,t){return e.bounds.y-t.bounds.y}},{key:"search",value:function(e){return nr(O(r.prototype),"search",this).call(this,{minX:e.left,minY:e.top,maxX:e.right,maxY:e.bottom})}},{key:"find",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:this.data,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:[];if(t){if(t.stroke){var i=!0;Object.keys(e).forEach((function(r){i=i&&t[r]==e[r]})),i&&n.push(t)}if(t.children){if(6!==r){for(var o=0;o<t.children.length;o++)this.find(e,t.children[o]||null,r+1,n);return n}console.warn("depth 6")}}}}]),r}(m.default),qr=g?g.default||globalThis.JSZip:{},Wr=new TextEncoder,Kr={fourCCLength:4,versionLength:3,chunkDescriptorLength:8,fourCC:{RIFF:Wr.encode("RIFF"),HEAD:Wr.encode("HEAD"),META:Wr.encode("META"),DATA:Wr.encode("DATA"),TXT:Wr.encode("TEXT"),JSON:Wr.encode("JSON")}};function Jr(e,t){var r="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!r){if(Array.isArray(e)||(r=function(e,t){if(!e)return;if("string"==typeof e)return $r(e,t);var r=Object.prototype.toString.call(e).slice(8,-1);"Object"===r&&e.constructor&&(r=e.constructor.name);if("Map"===r||"Set"===r)return Array.from(e);if("Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r))return $r(e,t)}(e))||t&&e&&"number"==typeof e.length){r&&(e=r);var n=0,i=function(){};return{s:i,n:function(){return n>=e.length?{done:!0}:{done:!1,value:e[n++]}},e:function(e){throw e},f:i}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var o,a=!0,s=!1;return{s:function(){r=r.call(e)},n:function(){var e=r.next();return a=e.done,e},e:function(e){s=!0,o=e},f:function(){try{a||null==r.return||r.return()}finally{if(s)throw o}}}}function $r(e,t){(null==t||t>e.length)&&(t=e.length);for(var r=0,n=new Array(t);r<t;r++)n[r]=e[r];return n}Object.defineEnum(Kr,"ContentType",["BINARY","PROTO","JSON","TEXT"]),Object.defineEnum(Kr,"CompressionType",["NONE","ZIP","LZMA"]);var Qr=function(){function e(t){var r=this,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:new Uint8Array([0,0,0]);P(this,e),this.textEncoder=new TextEncoder,Object.defineProperty(this,"format",{get:function(){return t},set:function(e){if(!e)throw new Error("format is expected");if("string"==typeof e&&(e=r.textEncoder.encode(e)),!(e instanceof Uint8Array))throw new Error("format expected type is Uint8Array");if(e.length!=Kr.fourCCLength)throw new Error("format expected length is ".concat(Kr.fourCCLength));t=e}}),Object.defineProperty(this,"version",{get:function(){return n},set:function(e){if(e){if("string"==typeof e&&(e=new Uint8Array(e.split("."))),!(e instanceof Uint8Array))throw new Error("version expected type is Uint8Array");if(e.length!=Kr.versionLength)throw new Error("version expected length is ".concat(Kr.versionLength))}n=e}}),Object.defineProperty(this,"length",{get:function(){return r.descriptors.length}}),this.format=t,this.version=n,this.reset()}var t,r,n;return w(e,[{key:"add",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};if(e){if(this.validateChunkDescriptor(t),Object.equals(t.fourCC,Kr.fourCC.META)){if(e instanceof ArrayBuffer||ArrayBuffer.isTypedArray(e))throw new Error("Binary meta is not allowed");if(this.descriptors.some((function(e){return Object.equals(e.fourCC,Kr.fourCC.META)})))throw new Error("Meta chunk is found. More than 1 meta chunk is not allowed.")}t=Object.assign({},t,{data:e}),Object.equals(t.fourCC,Kr.fourCC.META)?this.descriptors.unshift(t):this.descriptors.push(t)}}},{key:"validateChunkDescriptor",value:function(e){if(e.fourCC||(e.fourCC=Kr.fourCC.DATA),e.version||(e.version=new Uint8Array([0,0,0])),e.contentType||(e.contentType=Kr.ContentType.BINARY),e.compressionType||(e.compressionType=Kr.CompressionType.NONE),"string"==typeof e.fourCC&&(e.fourCC=this.textEncoder.encode(e.fourCC)),"string"==typeof e.version&&(e.version=new Uint8Array(e.version.split("."))),!(e.fourCC instanceof Uint8Array))throw new Error("Invalid fourCC type - ".concat(e.fourCC,", expected string or Uint8Array"));if(e.fourCC.length!=Kr.fourCCLength)throw new Error("Invalid fourCC: [".concat(e.fourCC,"]"));if(!(e.version instanceof Uint8Array))throw new Error("Invalid chunk version - ".concat(e.version,", expected string or Uint8Array"));if(e.version.length!=Kr.versionLength)throw new Error("Invalid version: [".concat(e.version,"]"))}},{key:"encode",value:(n=fe(pe.mark((function e(){var t;return pe.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(0!=this.descriptors.length){e.next=2;break}throw new Error("Chunks not found. Build process failed.");case 2:return e.next=4,this.build();case 4:return t=e.sent,this.reset(),e.abrupt("return",t);case 7:case"end":return e.stop()}}),e,this)}))),function(){return n.apply(this,arguments)})},{key:"build",value:(r=fe(pe.mark((function e(){var t,r,n,i,o,a,s,u,c,l,h,f=this;return pe.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(0!=this.descriptors.length){e.next=2;break}throw new Error("RIFF build failed. Chunks not found.");case 2:t=0,r=[],n=0,i=Jr(this.descriptors),e.prev=6,i.s();case 8:if((o=i.n()).done){e.next=17;break}return a=o.value,e.next=12,this.buildChunk(a);case 12:s=e.sent,r.push(s),n+=s.length;case 15:e.next=8;break;case 17:e.next=22;break;case 19:e.prev=19,e.t0=e.catch(6),i.e(e.t0);case 22:return e.prev=22,i.f(),e.finish(22);case 25:return u=this.buildHeadChunk(r),n+=u.length,r.unshift(u),c=Kr.fourCCLength+n,l=Kr.fourCC.RIFF.length+Uint32Array.BYTES_PER_ELEMENT+c,h=new ArrayBuffer(l),this.content=new Uint8Array(h),this.contentView=new DataView(h),this.content.set(Kr.fourCC.RIFF,t),t+=Kr.fourCC.RIFF.length,this.contentView.setUint32(t,c,!0),t+=Uint32Array.BYTES_PER_ELEMENT,this.content.set(this.format,t),t+=this.format.length,r.forEach((function(e){f.appendChunk(e,t),t+=e.length})),e.abrupt("return",this.content);case 41:case"end":return e.stop()}}),e,this,[[6,19,22,25]])}))),function(){return r.apply(this,arguments)})},{key:"buildChunk",value:(t=fe(pe.mark((function e(t){var r,n,i,o,a;return pe.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:r=t.data,t.contentType==Kr.ContentType.JSON&&(r=JSON.stringify(r)),e.t0=t.compressionType,e.next=e.t0===Kr.CompressionType.NONE?5:e.t0===Kr.CompressionType.ZIP?7:e.t0===Kr.CompressionType.LZMA?13:14;break;case 5:return t.contentType!=Kr.ContentType.JSON&&t.contentType!=Kr.ContentType.TEXT||(r=this.textEncoder.encode(r)),e.abrupt("break",15);case 7:return(n=new qr).file("data",r),e.next=11,n.generateAsync({type:"uint8array",compression:"DEFLATE",compressionOptions:{level:9}});case 11:return r=e.sent,e.abrupt("break",15);case 13:throw new Error("LZMA compression is not supported yet");case 14:throw new Error("Invalid compression type: ".concat(t.compressionType));case 15:return i=r.length,o=i%2,a=t.fourCC.length+Uint32Array.BYTES_PER_ELEMENT+i+o,e.abrupt("return",Object.assign({},t,{data:r,size:i,length:a}));case 19:case"end":return e.stop()}}),e,this)}))),function(e){return t.apply(this,arguments)})},{key:"buildHeadChunk",value:function(e){var t=this.version.length+1+e.length*Kr.chunkDescriptorLength,r=t%2,n=Kr.fourCCLength+Uint32Array.BYTES_PER_ELEMENT+t+r,i=new Uint8Array(t+r),o=this.version.length+1;return i.set(this.version,0),e.forEach((function(e,t){var r=new Uint8Array(8);r.set(e.version,0),r.set([e.contentType.value],3),r.set([e.compressionType.value],4),i.set(r,o+t*Kr.chunkDescriptorLength)})),{fourCC:Kr.fourCC.HEAD,data:i,size:t,length:n}}},{key:"appendChunk",value:function(e,t){this.content.set(e.fourCC,t),t+=e.fourCC.length,this.debug&&console.log((new TextDecoder).decode(e.fourCC),e.size),this.contentView.setUint32(t,e.size,!0),t+=Uint32Array.BYTES_PER_ELEMENT,this.content.set(e.data,t)}},{key:"reset",value:function(){this.descriptors=[],this.content=null,this.contentView=null}}]),e}(),en={contentType:Kr.ContentType.BINARY,compressionType:Kr.CompressionType.NONE},tn=function(){function e(){P(this,e),this.textDecoder=new TextDecoder}var t,r;return w(e,[{key:"decode",value:(r=fe(pe.mark((function e(t,r){var n,i,o,a,s,u,c,l,h,f,d;return pe.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r instanceof Uint8Array&&(r=this.textDecoder.decode(r)),i=(n=0)+Kr.fourCC.RIFF.length,this.content=t,this.contentView=new DataView(t.buffer),this.descriptor={},this.onChunkDecoded||(this.descriptor.chunks=[],this.descriptor.asProps=function(){return Object.assign.apply(Object,[{}].concat(te(this.chunks.map((function(e){return S({},e.fourCC.toLowerCase(),e.value)})))))}),Object.equals(this.content.subarray(n,i),Kr.fourCC.RIFF)){e.next=9;break}throw new Error("Invalid RIFF fourCC");case 9:if(i=(n=i)+Uint32Array.BYTES_PER_ELEMENT,(o=this.contentView.getUint32(n,!0)+i)%2==0){e.next=14;break}throw new Error("Invalid RIFF file size");case 14:if(o==this.content.length){e.next=16;break}throw new Error("Incomplete RIFF file");case 16:i=(n=i)+Kr.fourCCLength,this.descriptor.format=this.textDecoder.decode(this.content.subarray(n,i)),n=i,s=0;case 21:if(!(n<o)){e.next=53;break}if(u=this.content.subarray(n,n+Kr.fourCCLength),!Object.equals(u,Kr.fourCC.HEAD)){e.next=28;break}a=this.decodeHead(n),n+=a.length,e.next=51;break;case 28:if(c=this.textDecoder.decode(u),r&&c!=r){e.next=49;break}return l=this.readChunk(n),n+=l.length,h=a.descriptors[s]||en,e.next=35,this.decodeChunk(l.data,h);case 35:if(f=e.sent,!r){e.next=40;break}return e.abrupt("return",f);case 40:if(!this.onChunkDecoded){e.next=45;break}return e.next=43,this.onChunkDecoded(c,f,this.descriptor);case 43:e.next=46;break;case 45:this.descriptor.chunks.push({fourCC:c,value:f});case 46:s++,e.next=51;break;case 49:d=this.readChunkDimensionality(n),n+=d.length;case 51:e.next=21;break;case 53:return e.abrupt("return",this.onChunkDecoded?void 0:this.descriptor);case 54:case"end":return e.stop()}}),e,this)}))),function(e,t){return r.apply(this,arguments)})},{key:"decodeHead",value:function(e){var t=this.readChunk(e),r={size:t.size,length:t.length,descriptors:[]},n="".concat(t.data[0],".").concat(t.data[1],".").concat(t.data[2]);"0.0.0"!=n&&(this.descriptor.version=n);for(var i=(t.size+t.size%2-4)/8,o=0;o<i;o++){var a=4+o*Kr.chunkDescriptorLength,s=t.data.slice(a,a+8);n="".concat(s[0],".").concat(s[1],".").concat(s[2]);var u={contentType:Kr.ContentType[s[3]],compressionType:Kr.CompressionType[s[4]]};"0.0.0"!=n&&(u.version=n),r.descriptors.push(u)}return r}},{key:"readChunk",value:function(e){var t,r=this.readChunkDimensionality(e);if(r.size>0){var n=r.byteOffset+r.size;t=this.content.subarray(r.byteOffset,n),t=new Uint8Array(t,t.byteOffset,t.length)}else t=new Uint8Array(0);return{data:t,size:r.size,length:r.length}}},{key:"readChunkDimensionality",value:function(e){e+=Kr.fourCCLength;var t=this.contentView.getUint32(e,!0),r=Kr.fourCCLength+Uint32Array.BYTES_PER_ELEMENT+t,n=r%2;return{byteOffset:e+Uint32Array.BYTES_PER_ELEMENT,size:t,length:r+n}}},{key:"decodeChunk",value:(t=fe(pe.mark((function e(t,r){var n,i;return pe.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:e.t0=r.compressionType,e.next=e.t0===Kr.CompressionType.NONE?3:e.t0===Kr.CompressionType.ZIP?5:e.t0===Kr.CompressionType.LZMA?18:19;break;case 3:return n=r.contentType==Kr.ContentType.JSON||r.contentType==Kr.ContentType.TEXT?this.textDecoder.decode(t):t,e.abrupt("break",20);case 5:return e.next=7,qr.loadAsync(t);case 7:if(i=e.sent,r.contentType!=Kr.ContentType.JSON&&r.contentType!=Kr.ContentType.TEXT){e.next=14;break}return e.next=11,i.file("data").async("string");case 11:n=e.sent,e.next=17;break;case 14:return e.next=16,i.file("data").async("uint8array");case 16:n=e.sent;case 17:return e.abrupt("break",20);case 18:throw new Error("LZMA compression is not supported yet");case 19:throw new Error("Invalid compression type: ".concat(r.compressionType));case 20:return r.contentType==Kr.ContentType.JSON&&(n=JSON.parse(n)),e.abrupt("return",n);case 22:case"end":return e.stop()}}),e,this)}))),function(e,r){return t.apply(this,arguments)})}]),e}(),rn=function(){function e(){P(this,e)}return w(e,[{key:"calculatePrecision",value:function(e,t){throw new Error("PrecisionCalculator.calculatePrecision(data, property) should be implemented")}}]),e}();function nn(e,t){var r="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!r){if(Array.isArray(e)||(r=function(e,t){if(!e)return;if("string"==typeof e)return on(e,t);var r=Object.prototype.toString.call(e).slice(8,-1);"Object"===r&&e.constructor&&(r=e.constructor.name);if("Map"===r||"Set"===r)return Array.from(e);if("Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r))return on(e,t)}(e))||t&&e&&"number"==typeof e.length){r&&(e=r);var n=0,i=function(){};return{s:i,n:function(){return n>=e.length?{done:!0}:{done:!1,value:e[n++]}},e:function(e){throw e},f:i}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var o,a=!0,s=!1;return{s:function(){r=r.call(e)},n:function(){var e=r.next();return a=e.done,e},e:function(e){s=!0,o=e},f:function(){try{a||null==r.return||r.return()}finally{if(s)throw o}}}}function on(e,t){(null==t||t>e.length)&&(t=e.length);for(var r=0,n=new Array(t);r<t;r++)n[r]=e[r];return n}var an=["position","size","rotation","scale","offset"],sn={position:0,size:4,rotation:8,scale:12,offset:16},un=function(){function e(){var t=this,r=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0;P(this,e),this.precisions=r;var n,i=nn(an);try{var o=function(){var e=n.value;Object.defineProperty(t,e,{get:function(){return t.get(e)},set:function(r){return t.set(e,r)},enumerable:!0})};for(i.s();!(n=i.n()).done;)o()}catch(e){i.e(e)}finally{i.f()}Object.defineProperty(this,"factors",{get:function(){return Object.assign.apply(Object,[{}].concat(te(an.map((function(e){return S({},e,Math.pow(10,t[e]))})))))},enumerable:!0})}return w(e,[{key:"get",value:function(e){return this.precisions>>sn[e]&15}},{key:"set",value:function(e,t){if(t>15||t<0)throw new Error("Invalid '".concat(e,"' precision value ").concat(t," found. The value must be in the interval [0, 15]."));if(t>this[e])throw new Error("PrecisionSchema '".concat(e,"' update failed. Update value ").concat(t," > ").concat(this[e]," - update value should be less than current value."));t!=this[e]&&(this.precisions=this.precisions&~(15<<sn[e])|t<<sn[e])}},{key:"update",value:function(e){var t=this;an.forEach((function(r){var n=e[r];n<t[r]&&(t[r]=n)}))}},{key:"decode",value:function(){var e=this;return Object.assign.apply(Object,[{}].concat(te(an.map((function(t){return S({},t,e[t])})))))}}],[{key:"encode",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},t=0;return an.forEach((function(r){var n=e[r]||0;if(n>15||n<0)throw new Error("Invalid '".concat(r,"' precision value ").concat(n," found. The value must be in the interval [0, 15]."));t=t&~(15<<sn[r])|n<<sn[r]})),t}}]),e}();function cn(e,t){var r="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!r){if(Array.isArray(e)||(r=function(e,t){if(!e)return;if("string"==typeof e)return ln(e,t);var r=Object.prototype.toString.call(e).slice(8,-1);"Object"===r&&e.constructor&&(r=e.constructor.name);if("Map"===r||"Set"===r)return Array.from(e);if("Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r))return ln(e,t)}(e))||t&&e&&"number"==typeof e.length){r&&(e=r);var n=0,i=function(){};return{s:i,n:function(){return n>=e.length?{done:!0}:{done:!1,value:e[n++]}},e:function(e){throw e},f:i}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var o,a=!0,s=!1;return{s:function(){r=r.call(e)},n:function(){var e=r.next();return a=e.done,e},e:function(e){s=!0,o=e},f:function(){try{a||null==r.return||r.return()}finally{if(s)throw o}}}}function ln(e,t){(null==t||t>e.length)&&(t=e.length);for(var r=0,n=new Array(t);r<t;r++)n[r]=e[r];return n}var hn=function(){function e(){P(this,e)}return w(e,null,[{key:"l2Norm",value:function(e){var t,r=0,n=cn(e);try{for(n.s();!(t=n.n()).done;){var i=t.value;r+=i*i}}catch(e){n.e(e)}finally{n.f()}return Math.sqrt(r)}},{key:"rmse",value:function(e,t){for(var r=0,n=0;n<e.length;n++){var i=e[n]-t[n];r+=i*i}return Math.sqrt(r/e.length)}},{key:"variance",value:function(e){if(e.length<=1)return 0;var t,r=this.average(e),n=0,i=cn(e);try{for(i.s();!(t=i.n()).done;){var o=t.value-r;n+=o*o}}catch(e){i.e(e)}finally{i.f()}return n/(e.length-1)}},{key:"average",value:function(e){var t,r=0,n=cn(e);try{for(n.s();!(t=n.n()).done;){r+=t.value}}catch(e){n.e(e)}finally{n.f()}return r/e.length}},{key:"calculateError",value:function(e,t){for(var r=Math.pow(10,t),n=new Float32Array(e.length),i=0;i<n.length;i++){var o=Math.round(e[i]*r);if(o>Number.MAX_INT32||o<-Number.MAX_INT32)return NaN;n[i]=o}for(var a=new Float32Array(e.length),s=0;s<n.length;s++)a[s]=n[s]/r;return this.rmse(e,a)}},{key:"isZero",value:function(e){return Math.abs(e)<Number.EPSILON}}]),e}();function fn(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var r,n=O(e);if(t){var i=O(this).constructor;r=Reflect.construct(n,arguments,i)}else r=n.apply(this,arguments);return A(this,r)}}var dn=function(e){R(r,e);var t=fn(r);function r(e,n){var i;return P(this,r),(i=t.call(this)).layout=e,i.pathPointCalculator=n,i.inputBuffer=[],i.prediction=!0,i}return w(r,[{key:"togglePrediction",value:function(e){console.warn("PathProducer togglePrediction method is deprecated. Use InkBuilder instance prediction property to configure prediction behaviour."),this.prediction=e}},{key:"addImpl",value:function(e,t){if(e.phase!=this.phase)throw new Error("The phase of the addition (".concat(e.phase.name,") doesn't match the phase of the PathProducer (").concat(this.phase.name,")"));var r=[],n=[];e&&this.inputBuffer.push(e);var i=this.inputBuffer.length>=3?this.inputBuffer[this.inputBuffer.length-3]:null,o=this.inputBuffer.length>=2?this.inputBuffer[this.inputBuffer.length-2]:null,a=this.inputBuffer.length>=1?this.inputBuffer[this.inputBuffer.length-1]:null,s=this.calculate(i,o,a);return e&&s&&r.push.apply(r,te(s.toArray(this.layout))),this.phase==Y.Phase.END?(s=this.calculate(o,a,null))&&r.push.apply(r,te(s.toArray(this.layout))):this.prediction&&(this.phase==Y.Phase.UPDATE||t)&&(s=this.calculate(o,a,t))&&(n.push.apply(n,te(s.toArray(this.layout))),(s=this.calculate(a,t,null))&&n.push.apply(n,te(s.toArray(this.layout)))),{added:r,predicted:n}}},{key:"calculate",value:function(e,t,r){return t?this.pathPointCalculator(e,t,r):null}},{key:"reset",value:function(){nr(O(r.prototype),"reset",this).call(this),this.inputBuffer.clear()}}]),r}(Y);function pn(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var r,n=O(e);if(t){var i=O(this).constructor;r=Reflect.construct(n,arguments,i)}else r=n.apply(this,arguments);return A(this,r)}}var yn=[-6e-6,-139e-6,-185e-6,414e-6,.002357,.003357,-.003135,-.023928,-.042909,-.017858,.096525,.254692,.347072,.26881,.114933],vn=function(e){R(r,e);var t=pn(r);function r(e){var n,i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:15;return P(this,r),(n=t.call(this)).buffer=[],n.pointsCount=0,n.filter=yn.slice(),Object.defineProperty(T(n),"movingAverageWindowSize",{get:function(){return i},set:function(e){i=e,this.filter.length!=e&&(this.filter=r.resample(yn,e)),this.predictionPointsCount=4*e/15,this.windowSize=this.filter.length},enumerable:!0}),n.dimsCount=e,n.movingAverageWindowSize=i,n}return w(r,[{key:"add",value:function(e,t){return t?this.project(e):this.addSequence(e)}},{key:"buildImpl",value:function(e){return this.project(e)}},{key:"project",value:function(e){if(e.length%this.dimsCount!=0)throw new Error("Points size ('".concat(e.length,"') must be multiple of the dimensions count ('").concat(this.dimsCount,"')."));if(0==e.length)return[];var t=[],r=this.buffer.slice(),n=e.slice(0,e.length-this.dimsCount),i=this.addSequence(n);t.push.apply(t,te(i));for(var o=e.slice(e.length-this.dimsCount,e.length),a=this.predictionPointsCount,s=0;s<a;s++){var u=this.addPoint(o);a-s<=this.pointsCount&&t.push.apply(t,te(u))}return this.buffer=r,t}},{key:"addSequence",value:function(e){if(e.length%this.dimsCount!=0)throw new Error("Points size ('".concat(e.length,"') must be multiple of the dimensions count ('").concat(this.dimsCount,"')."));for(var t=[],r=e.length/this.dimsCount,n=0;n<r;n++){var i=this.addPoint(e.slice(n*this.dimsCount,(n+1)*this.dimsCount));t.push.apply(t,te(i))}return this.pointsCount+=r,t}},{key:"addPoint",value:function(e){var t;for((t=this.buffer).push.apply(t,te(e));this.buffer.length<this.windowSize*this.dimsCount;){var r;(r=this.buffer).unshift.apply(r,te(this.buffer.slice(0,this.dimsCount)))}for(;this.buffer.length>this.windowSize*this.dimsCount;)this.buffer=this.buffer.slice(this.dimsCount);return this.filterBuffer()}},{key:"filterBuffer",value:function(){for(var e=[],t=0;t<this.windowSize;t++)for(var r=0;r<this.dimsCount;r++)isNaN(e[r])&&(e[r]=0),e[r]+=this.buffer[t*this.dimsCount+r]*this.filter[t];return e}},{key:"reset",value:function(){nr(O(r.prototype),"reset",this).call(this),this.pointsCount=0,this.buffer.clear()}}],[{key:"resample",value:function(e,t){for(var r=new Float32Array(t),n=e.length/t,i=0,o=0;o<t;o++){var a=(e.length-1)*o/(t-1),s=Math.floor(a),u=Math.ceil(a),c=a-s,l=n*(e[s]*(1-c)+e[u]*c);i+=l,r[o]=l}for(var h=1/i,f=0;f<t;f++)r[f]*=h;return r}}]),r}(It);function mn(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var r,n=O(e);if(t){var i=O(this).constructor;r=Reflect.construct(n,arguments,i)}else r=n.apply(this,arguments);return A(this,r)}}var gn=function(e){R(r,e);var t=mn(r);function r(e){var n;return P(this,r),(n=t.call(this)).layout=e,n.pathPointProps={},n.lastSpline=[],n}return w(r,[{key:"add",value:function(e,t){0==this.lastSpline.length&&e.length>0&&e.unshift.apply(e,te(e.slice(0,this.layout.length))),t&&(e.length>=this.layout.length?e.push.apply(e,te(e.slice(e.length-this.layout.length,e.length))):e.push.apply(e,te(this.getLastPart())));var r=this.getFirstPart();return this.lastSpline=r.concat(e),e}},{key:"predict",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[];if(0==e.length)return e;var t=[],r=this.getFirstPart();for(t.push.apply(t,te(r)),t.push.apply(t,te(e)),t.push.apply(t,te(t.slice(t.length-this.layout.length,t.length)));t.length<4*this.layout.length;)t.unshift(t.slice(0,this.layout.length));return t}},{key:"buildImpl",value:function(e){var t=[];return e.length>0&&(t.push.apply(t,te(e.slice(0,this.layout.length))),t.push.apply(t,te(e)),e.length>=this.layout.length&&t.push.apply(t,te(e.slice(e.length-this.layout.length,e.length)))),e}},{key:"getOutput",value:function(e,t){var n=t==r.OutputType.ADDITION?this.lastSpline.length>=4*this.layout.length?this.lastSpline:[]:e;return 0==n.length?void 0:new Tr(this.layout,n,this.pathPointProps,0,1)}},{key:"getFirstPart",value:function(){return this.lastSpline.slice(Math.max(0,this.lastSpline.length-3*this.layout.length),this.lastSpline.length)}},{key:"getLastPart",value:function(){return this.lastSpline.slice(this.lastSpline.length-this.layout.length,this.lastSpline.length)}},{key:"reset",value:function(){nr(O(r.prototype),"reset",this).call(this),this.lastSpline=[]}}]),r}(It),bn=function(){function e(t){P(this,e),this.key=t,this.height=1}return w(e,[{key:"leftRotate",value:function(){var t=this.right,r=t.left;return t.left=this,this.right=r,this.height=Math.max(e.height(this.left),e.height(this.right))+1,t.height=Math.max(e.height(t.left),e.height(t.right))+1,t}},{key:"rightRotate",value:function(){var t=this.left,r=t.right;return t.right=this,this.left=r,this.height=Math.max(e.height(this.left),e.height(this.right))+1,t.height=Math.max(e.height(t.left),e.height(t.right))+1,t}},{key:"getBalanceFactor",value:function(){return e.height(this.left)-e.height(this.right)}}],[{key:"height",value:function(e){return e?e.height:0}},{key:"minValue",value:function(e){if(e){for(var t=e;t.left;)t=t.left;return t.key}}},{key:"maxValue",value:function(e){if(e){for(var t=e;t.right;)t=t.right;return t.key}}}]),e}(),En=function(){function e(){P(this,e),this.count=0,this.hasKey=!1,this.root}return w(e,[{key:"min",value:function(){return bn.minValue(this.root)}},{key:"max",value:function(){return bn.maxValue(this.root)}},{key:"add",value:function(e){return this.hasKey=!1,this.root=this.insertNode(this.root,e),this.hasKey||this.count++,!this.hasKey}},{key:"insertNode",value:function(e,t){if(!e)return new bn(t);if(t<e.key)e.left=this.insertNode(e.left,t);else{if(!(t>e.key))return this.hasKey=!0,e;e.right=this.insertNode(e.right,t)}if(!this.hasKey){e.height=1+Math.max(bn.height(e.left),bn.height(e.right));var r=e.getBalanceFactor();if(r>1){if(t<e.left.key)return e.rightRotate();if(t>e.left.key)return e.left=e.left.leftRotate(),e.rightRotate()}else if(r<-1){if(t>e.right.key)return e.leftRotate();if(t<e.right.key)return e.right=e.right.rightRotate(),e.leftRotate()}}return e}},{key:"contains",value:function(e){return this.containsNode(this.root,e)}},{key:"containsNode",value:function(e,t){return!!e&&(t<e.key?this.containsNode(e.left,t):!(t>e.key)||this.containsNode(e.right,t))}},{key:"printTree",value:function(){if(this.root)for(var e=[this.root],t=this.root.height;e.length>0;){var r=e.shift();t!=r.height&&console.log("-"),console.log("".concat(r.key," with height: ").concat(r.height,", balance: ").concat(r.getBalanceFactor())),t=r.height;var n=r.left,i=r.right;n&&e.push(n),i&&e.push(i)}}},{key:"toArray",value:function(){var t=[];return e.fillArray(t,this.root),t}}],[{key:"fillArray",value:function(e,t){t&&(this.fillArray(e,t.left),e.push(t.key),this.fillArray(e,t.right))}}]),e}(),Pn=function(){function e(){var t=this;P(this,e),this.tree=new En,Object.defineProperty(this,"length",{get:function(){return t.tree.count},enumerable:!0})}return w(e,[{key:"clear",value:function(){this.tree=new En}},{key:"add",value:function(e){return this.tree.add(e)}},{key:"includes",value:function(e){return this.tree.contains(e)}},{key:"min",value:function(){return this.tree.min()}},{key:"max",value:function(){return this.tree.max()}},{key:"toArray",value:function(){return this.tree.toArray()}}]),e}();function kn(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var r,n=O(e);if(t){var i=O(this).constructor;r=Reflect.construct(n,arguments,i)}else r=n.apply(this,arguments);return A(this,r)}}var wn=function(e){R(r,e);var t=kn(r);function r(e,n){var i;return P(this,r),(i=t.call(this,e,n)).state.segmentIndex=-1,i.state.lastSegmentIndex=-1,i.state.lastPointRotation=0,i.state.lastPointT=0,i.state.absAccumulatedErrorPos=0,i.state.absAccumulatedErrorS=0,i.setT=new Pn,Object.defineProperty(T(i),"errorThreshold",{get:function(){return this.error},set:function(e){this.error=e,this.errorDistSq=this.error*this.error,this.error10=10*this.error},enumerable:!0}),i.errorThreshold=.15,i}return w(r,[{key:"discretize",value:function(e){for(var t=[],r=e.segmentsCount,n=r-1,i=0;i<r;i++){this.calculatePolynomials(e,i);var o=this.calculateTValues(i==n,e.ts,e.tf);t.push.apply(t,te(this.samplePoints(i,o))),o.length>0&&(this.resetAccumulatedErrors(),this.storeLastPoint(t))}return t}},{key:"samplePoints",value:function(e,t){var r=this,n=[];return t.toArray().forEach((function(t){r.keepSegmentT(e,t),n.push.apply(n,te(r.samplePoint(t)))})),n}},{key:"storeLastPoint",value:function(e){var t=e.length-this.layout.length;nr(O(r.prototype),"storeLastPoint",this).call(this,e,t),this.state.lastPointRotation=this.getPropValue(le.Property.ROTATION,e,t),this.state.lastPointT=this.setT.max(),this.state.lastSegmentIndex=this.state.segmentIndex}},{key:"calculateTValues",value:function(e,t,r){this.state.segmentIndex++;var n=0==this.state.segmentIndex?t:0,i=e?r:1;return this.setT.clear(),this.getTForPos(n,i),this.state.layout.SIZE&&this.getTForCubic(n,i,this.state.layout.SIZE.polynomials,this.error),this.mustAddStartT()&&this.setT.add(n),e&&this.setT.add(i),this.state.layout.ROTATION&&this.getTForRotation(n,i),this.setT}},{key:"mustAddStartT",value:function(){if(this.state.lastSegmentIndex<0)return!0;var e=this.state.lastPointT-(this.state.segmentIndex-this.state.lastSegmentIndex),t=this.setT.length>0?this.setT.min():1,r=this.getPosErrorAtT0(t,this.state.lastPointPosition);if(this.state.absAccumulatedErrorPos+=Math.abs(r),this.state.layout.SIZE){var n=this.getErrorAtT0(this.state.layout.SIZE.polynomials,t,e,this.state.lastPointSize);this.state.absAccumulatedErrorS+=Math.abs(n)}return this.state.absAccumulatedErrorPos>this.errorDistSq||this.state.absAccumulatedErrorS>this.error}},{key:"getPosErrorAtT0",value:function(e,t){var r=this.getTPoint(e),n=this.getTPoint(0);return this.minDistanceSq(t,r,n)}},{key:"getErrorAtT0",value:function(e,t,r,n){var i=r,o=n,a=t,s=this.cubicCalc(e,a),u=this.cubicCalc(e,0),c=o+(0-i)*(s-o)/(a-i);return Math.abs(u-c)}},{key:"getTForPos",value:function(e,t){var r=this.getTPoint(e),n=this.getTPoint(t),i=this.subdividePos(r,n);if(i.split)this.subdivideRecursivePos(r,i),this.setT.add(i.t),this.subdivideRecursivePos(i,n);else{var o=this.subdividePos(r,i),a=this.subdividePos(i,n);o.split&&(this.subdivideRecursivePos(r,o),this.setT.add(o.t),this.subdivideRecursivePos(o,i)),(o.split||a.split)&&this.setT.add(i.t),a.split&&(this.subdivideRecursivePos(i,a),this.setT.add(a.t),this.subdivideRecursivePos(a,n))}}},{key:"subdivideRecursivePos",value:function(e,t){var r=this.subdividePos(e,t);r.split&&(this.subdivideRecursivePos(e,r),this.setT.add(r.t),this.subdivideRecursivePos(r,t))}},{key:"subdividePos",value:function(e,t){var r=.5*(e.t+t.t),n=this.getTPoint(r),i=this.minDistanceSq(e,t,n),o=e.add(t).scaleSelf(.5),a=n.subtract(o).absSelf();return n.split=i>this.errorDistSq||a.x>this.error10||a.y>this.error10,this.state.layout.Z&&(n.split=n.split||a.z>this.error10),n}},{key:"getTForCubic",value:function(e,t,r,n){var i={v:this.cubicCalc(r,e),t:e},o={v:this.cubicCalc(r,t),t:t},a=this.subdivide(i,o,r);if(a.diff>n)this.subdivideRecursive(i,a,r,n),this.setT.add(a.t),this.subdivideRecursive(a,o,r,n);else{var s=this.subdivide(i,a,r),u=this.subdivide(a,o,r);s.diff>n&&(this.subdivideRecursive(i,s,r,n),this.setT.add(s.t),this.subdivideRecursive(s,a,r,n)),(s.diff>n||u.diff>n)&&this.setT.add(a.t),u.diff>n&&(this.subdivideRecursive(a,u,r,n),this.setT.add(u.t),this.subdivideRecursive(u,o,r,n))}}},{key:"subdivideRecursive",value:function(e,t,r,n){var i=this.subdivide(e,t,r);i.diff>n&&(this.subdivideRecursive(e,i,r,n),this.setT.add(i.t),this.subdivideRecursive(i,t,r,n))}},{key:"subdivide",value:function(e,t,r){var n=.5*(e.t+t.t),i=this.cubicCalc(r,n),o=.5*(e.v+t.v);return{v:i,t:n,diff:Math.abs(i-o)}}},{key:"getTForRotation",value:function(e,t){var r=this.state.layout.ROTATION.polynomials,n=this.state.lastPointRotation;this.state.lastSegmentIndex<0&&(n=this.cubicCalc(r,e));for(var i=.25*(t-e),o=0;o<4;o++){var a=e+o*i,s=this.cubicCalc(r,a);Math.abs(s-n)>.06&&(this.setT.add(a),n=s)}}},{key:"minDistanceSq",value:function(e,t,r){var n=r.vec,i=n.squaredDistance(e.value,t.value);if(0==i)return n.squaredDistance(r.value,e.value);var o=Math.max(0,Math.min(1,n.dot(r.subtract(e).value,t.subtract(e).value)/i)),a=t.subtract(e).scale(o).add(e);return n.squaredDistance(r.value,a.value)}},{key:"getTPoint",value:function(e){var t=new X(this.cubicCalc(this.state.layout.X.polynomials,e),this.cubicCalc(this.state.layout.Y.polynomials,e),this.state.layout.Z?this.cubicCalc(this.state.layout.Z.polynomials,e):void 0);return t.t=e,t}},{key:"cubicCalc",value:function(e,t){return e[0]+e[1]*t+e[2]*t*t+e[3]*t*t*t}},{key:"resetAccumulatedErrors",value:function(){this.state.absAccumulatedErrorPos=0,this.state.absAccumulatedErrorS=0}},{key:"resetState",value:function(){this.state.segmentIndex=-1,this.state.lastSegmentIndex=-1,this.state.lastPointT=0,this.state.lastPointRotation=0,this.resetAccumulatedErrors()}},{key:"reset",value:function(){nr(O(r.prototype),"reset",this).call(this),this.resetState()}}]),r}(Nr);function xn(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var r,n=O(e);if(t){var i=O(this).constructor;r=Reflect.construct(n,arguments,i)}else r=n.apply(this,arguments);return A(this,r)}}var Sn=function(e){R(r,e);var t=xn(r);function r(e){var n;return P(this,r),(n=t.call(this)).brush=e,n}return w(r,[{key:"buildImpl",value:function(e){return this.generatePolygons(e)}},{key:"generatePolygons",value:function(e){var t=new cr;if(!e)return t;for(var r=0;r<e.length;r++){var n=e.getPoint(r),i=this.applyBrush(n);t.push(i)}return t}},{key:"applyBrush",value:function(e){for(var t=this.createTransform(e),r=this.brush.selectShape(t.maxScale).shape,n=Float32Array.createSharedInstance(2*r.length),o=0;o<r.length;o++){var a=o*r.stride,s=i.vec4.fromValues(r.getPointX(o),r.getPointY(o),0,1);i.vec4.transformMat4(s,s,t),n[a]=s[0]/s[3],n[a+1]=s[1]/s[3]}return ht.createSharedInstance(n)}},{key:"createTransform",value:function(e){if(isNaN(e.size))throw new Error("Size information not found.");var t=i.mat4.create(),r=e.size*e.scaleX,n=e.size*e.scaleY,o=e.size*e.scaleZ||0,a=Math.max(r,n,o);return i.mat4.translate(t,t,i.vec3.fromValues(e.x,e.y,e.z||0)),i.mat4.rotateZ(t,t,e.rotation),i.mat4.translate(t,t,i.vec3.fromValues(e.offsetX,e.offsetY,e.offsetZ||0)),i.mat4.scale(t,t,i.vec3.fromValues(r,n,o)),t.maxScale=a,t}}]),r}(It);function In(e,t){var r="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!r){if(Array.isArray(e)||(r=function(e,t){if(!e)return;if("string"==typeof e)return Rn(e,t);var r=Object.prototype.toString.call(e).slice(8,-1);"Object"===r&&e.constructor&&(r=e.constructor.name);if("Map"===r||"Set"===r)return Array.from(e);if("Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r))return Rn(e,t)}(e))||t&&e&&"number"==typeof e.length){r&&(e=r);var n=0,i=function(){};return{s:i,n:function(){return n>=e.length?{done:!0}:{done:!1,value:e[n++]}},e:function(e){throw e},f:i}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var o,a=!0,s=!1;return{s:function(){r=r.call(e)},n:function(){var e=r.next();return a=e.done,e},e:function(e){s=!0,o=e},f:function(){try{a||null==r.return||r.return()}finally{if(s)throw o}}}}function Rn(e,t){(null==t||t>e.length)&&(t=e.length);for(var r=0,n=new Array(t);r<t;r++)n[r]=e[r];return n}function Tn(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var r,n=O(e);if(t){var i=O(this).constructor;r=Reflect.construct(n,arguments,i)}else r=n.apply(this,arguments);return A(this,r)}}S(Sn,"ARRAY_TYPE",cr);var An=function(e){R(r,e);var t=Tn(r);function r(){var e;return P(this,r),(e=t.call(this)).lastPolygon,e}return w(r,[{key:"add",value:function(e,t){return this.buildConvexHulls(e,!0)}},{key:"buildImpl",value:function(e){if(!(e instanceof cr)){if(!(e instanceof ht))throw new Error("ConvexHullChainProducer build 'input' type missmatch, expected type is oneof(Polygon, InkPath2D)");e=[e]}return this.buildConvexHulls(e)}},{key:"buildConvexHulls",value:function(e){var t,r=arguments.length>1&&void 0!==arguments[1]&&arguments[1],n=new cr,i=this.lastPolygon,o=In(e);try{for(o.s();!(t=o.n()).done;){var a=t.value;if(i||1==e.length){var s=i?i.union(a):a.convex();n.push(s)}i=a}}catch(e){o.e(e)}finally{o.f()}return r&&e.length>0&&(this.lastPolygon=e.last),n}},{key:"reset",value:function(){nr(O(r.prototype),"reset",this).call(this),this.lastPolygon=null}}]),r}(It);function On(e,t){var r="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!r){if(Array.isArray(e)||(r=function(e,t){if(!e)return;if("string"==typeof e)return Cn(e,t);var r=Object.prototype.toString.call(e).slice(8,-1);"Object"===r&&e.constructor&&(r=e.constructor.name);if("Map"===r||"Set"===r)return Array.from(e);if("Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r))return Cn(e,t)}(e))||t&&e&&"number"==typeof e.length){r&&(e=r);var n=0,i=function(){};return{s:i,n:function(){return n>=e.length?{done:!0}:{done:!1,value:e[n++]}},e:function(e){throw e},f:i}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var o,a=!0,s=!1;return{s:function(){r=r.call(e)},n:function(){var e=r.next();return a=e.done,e},e:function(e){s=!0,o=e},f:function(){try{a||null==r.return||r.return()}finally{if(s)throw o}}}}function Cn(e,t){(null==t||t>e.length)&&(t=e.length);for(var r=0,n=new Array(t);r<t;r++)n[r]=e[r];return n}S(An,"ARRAY_TYPE",cr),"function"==typeof Worker&&(Worker.prototype.on=function(e,t){this["on".concat(e)]=function(r){var n="message"==e?r.data:r;t(n)}}),"function"==typeof DedicatedWorkerGlobalScope&&(DedicatedWorkerGlobalScope.prototype.on=function(e,t){this["on".concat(e)]=function(r){var n="message"==e?r.data:r;t(n)}});var Dn=!1,Nn=function(){function e(t,r){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:e.WorkerType.CLASSIC;if(P(this,e),!Dn)throw new Error("Constructor is private, use static method getInstance instead.");this.name=t,this.type=n,r&&r.startsWith("file://")&&(r=r.replace("file://","")),this.src=r,this.workers=[],this.transferables=[],this.status=e.Status.CLOSED,this.resolver={};var i=0;Object.defineProperty(this,"nextID",{get:function(){return String(i++)},enumerable:!0,configurable:!0})}var t,r,n;return w(e,[{key:"open",value:(n=fe(pe.mark((function t(){var r,n,i,o,a,s,u,c,l=this,h=arguments;return pe.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(r=h.length>0&&void 0!==h[0]?h[0]:this.src,this.status==e.Status.CLOSED){t.next=3;break}throw new Error("".concat(this.name," worker cannot be opened. Current status is ").concat(this.status.name,"."));case 3:if(r){t.next=5;break}throw new Error("".concat(this.name," worker location is not deined."));case 5:if("function"!=typeof Worker){t.next=10;break}n=Worker,i=navigator.hardwareConcurrency||1,t.next=19;break;case 10:return t.next=12,import("os");case 12:return o=t.sent,t.next=15,import("worker_threads");case 15:a=t.sent,s=a.Worker,n=s,i=o.cpus().length;case 19:for(this.ready=0,u=function(e){var t=l.name+e,i=new n(r,{type:l.type,name:t,workerData:{name:t}});i.name=e,i.on("message",(function(e){return"INIT"==e.action?l.confirmWorkerReady():l.recieve(e)})),i.on("error",(function(t){return l.recieveError(t,e)})),l.workers.push(i)},c=0;c<i;c++)u(c);return this.status=e.Status.OPEN_IN_PROGRESS,t.abrupt("return",new Promise((function(e,t){l.workers.forEach((function(e,t){return e.postMessage({action:"INIT",worker:t})})),l.resolve=e})));case 24:case"end":return t.stop()}}),t,this)}))),function(){return n.apply(this,arguments)})},{key:"confirmWorkerReady",value:function(){this.ready++,this.ready==this.workers.length&&(this.resolve(),delete this.ready,delete this.resolve,this.status=e.Status.OPEN)}},{key:"close",value:function(){this.workers.forEach((function(e){return e.terminate()})),this.workers.clear(),this.status=e.Status.CLOSED}},{key:"broadcast",value:(r=fe(pe.mark((function t(r,n){var i=this;return pe.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(this.status==e.Status.OPEN){t.next=2;break}throw new Error("ThreadBridge is not opened yet. Current status is ".concat(this.status.name,". Use open first."));case 2:return t.abrupt("return",new Promise((function(e,t){i.resolver[n]=e;var o,a=On(i.workers);try{for(a.s();!(o=a.n()).done;){var s=o.value,u=i.buildRequestMessage(r,n);if(!u)break;i.send(s.name,u)}}catch(e){a.e(e)}finally{a.f()}})));case 3:case"end":return t.stop()}}),t,this)}))),function(e,t){return r.apply(this,arguments)})},{key:"broadcastMessage",value:(t=fe(pe.mark((function t(r){var n=this;return pe.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(this.status==e.Status.OPEN){t.next=2;break}throw new Error("ThreadBridge is not opened yet. Current status is ".concat(this.status.name,". Use open first."));case 2:if(r.actionID){t.next=4;break}throw new Error("message actionID is required");case 4:return t.abrupt("return",new Promise((function(e,t){n.resolver[r.actionID]=e;var i,o=On(n.workers);try{for(o.s();!(i=o.n()).done;){var a=i.value;n.send(a.name,r)}}catch(e){o.e(e)}finally{o.f()}})));case 5:case"end":return t.stop()}}),t,this)}))),function(e){return t.apply(this,arguments)})},{key:"send",value:function(t,r){if(this.status!=e.Status.OPEN)throw new Error("ThreadBridge is not opened yet. Current status is ".concat(this.status.name,". Use open first."));if(!r)throw new Error("message is required");this.workers[t].postMessage(r,this.transferables),this.transferables.clear()}},{key:"buildRequestMessage",value:function(e,t){throw new Error("ThreadBridge.buildRequestMessage(action, actionID) is abstract and should be implemented")}},{key:"recieve",value:function(e){throw new Error("ThreadBridge.recieve(message) is abstract and should be implemented")}},{key:"resolve",value:function(e,t){this.resolver[e](t),delete this.resolver[e]}},{key:"recieveError",value:function(e,t){console.warn("".concat(this.name," worker ").concat(t,": ").concat(e.message)),e.filename||console.error(e)}}],[{key:"getInstance",value:function(){return this.instance||(Dn=!0,this.instance=new this,Dn=!1),this.instance}}]),e}();function Mn(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var r,n=O(e);if(t){var i=O(this).constructor;r=Reflect.construct(n,arguments,i)}else r=n.apply(this,arguments);return A(this,r)}}Object.defineEnum(Nn,"Status",["OPEN","OPEN_IN_PROGRESS","CLOSED"]),Nn.WorkerType={CLASSIC:"classic",MODULE:"module"};var Ln=function(e){R(n,e);var t,r=Mn(n);function n(){var e;return P(this,n),(e=r.call(this,n.WORKER_NAME,n.buildWorkerURL(),n.buildWorkerURL().contains("/wacom-src/")?Nn.WorkerType.MODULE:Nn.WorkerType.CLASSIC)).state={},e}return w(n,[{key:"build",value:(t=fe(pe.mark((function e(t,r,n){var i;return pe.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return i=this.nextID,this.state[i]={type:r,input:t,output:new cr,queue:te(t.slice()),lastPolygon:n,expected:t.length,processed:0},e.next=4,this.broadcast("BUILD",i);case 4:return e.abrupt("return",e.sent);case 5:case"end":return e.stop()}}),e,this)}))),function(e,r,n){return t.apply(this,arguments)})},{key:"buildRequestMessage",value:function(e,t){var r={action:e,actionID:t},n=this.state[t];if("BUILD"!=e)throw new Error("Unknow data action found: ".concat(e));var i=n.queue.shift();if(i){var o,a=n.input.indexOf(i),s=0==a?n.lastPolygon:n.input[a-1];return s?o=Array.of.apply(Array,te(s.shape.points).concat(te(i.shape.points))):(s=i,(i=n.queue.shift())?(o=Array.of.apply(Array,te(s.shape.points).concat(te(i.shape.points))),n.updateIndex=!0,n.expected--,a++):o=s.shape.points),r.index=a,r.data=o,r}}},{key:"recieve",value:function(e){var t=this.state[e.actionID],r=t.updateIndex?e.index-1:e.index;if(t.output[r]=ht.createSharedInstance(e.data),t.processed++,t.processed==t.expected){var n;if(delete this.state[e.actionID],this.keepAllData&&t.type==It.OutputType.ADDITION)this.path||(this.path=new cr),(n=this.path).push.apply(n,te(t.output));this.resolve(e.actionID,t.output)}else{var i=this.buildRequestMessage(e.action,e.actionID);i&&this.send(e.worker,i)}}}],[{key:"buildWorkerURL",value:function(){if("function"!=typeof DedicatedWorkerGlobalScope){var e=void 0===l?"undefined"==typeof document&&"undefined"==typeof location?new(require("url").URL)("file:"+__filename).href:"undefined"==typeof document?location.href:document.currentScript&&document.currentScript.src||new URL("digital-ink-min.js",document.baseURI).href:l;return(e=e.substring(0,e.lastIndexOf("/"))).endsWith("workers")||(e+="/workers"),e+="/".concat(n.WORKER_NAME,".js")}}}]),n}(Nn);function Bn(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var r,n=O(e);if(t){var i=O(this).constructor;r=Reflect.construct(n,arguments,i)}else r=n.apply(this,arguments);return A(this,r)}}S(Ln,"WORKER_NAME","ConvexHullProvider");var _n=function(e){R(n,e);var t,r=Bn(n);function n(){var e;return P(this,n),(e=r.call(this)).lastPolygon,e.convexHullProducer=Ln.getInstance(),e}return w(n,[{key:"build",value:(t=fe(pe.mark((function e(t){var r,i,o,a,s=arguments;return pe.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r=s.length>1&&void 0!==s[1]?s[1]:n.OutputType.PROCESSOR,i=!(s.length>2&&void 0!==s[2])||s[2],o=this.lastPolygon,r==n.OutputType.ADDITION&&t.length>0&&(this.lastPolygon=t.last),i&&(this.lastPolygon=null),this.convexHullProducer.status!=Nn.Status.CLOSED){e.next=8;break}return e.next=8,this.convexHullProducer.open();case 8:return e.next=10,this.convexHullProducer.build(t,r,o);case 10:return a=e.sent,e.abrupt("return",this.getOutput(a));case 12:case"end":return e.stop()}}),e,this)}))),function(e){return t.apply(this,arguments)})},{key:"reset",value:function(){nr(O(n.prototype),"reset",this).call(this),this.lastPolygon=null}}],[{key:"buildWorkerURL",value:function(){return Ln.buildWorkerURL()}}]),n}(It);function Fn(e,t){var r="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!r){if(Array.isArray(e)||(r=function(e,t){if(!e)return;if("string"==typeof e)return Un(e,t);var r=Object.prototype.toString.call(e).slice(8,-1);"Object"===r&&e.constructor&&(r=e.constructor.name);if("Map"===r||"Set"===r)return Array.from(e);if("Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r))return Un(e,t)}(e))||t&&e&&"number"==typeof e.length){r&&(e=r);var n=0,i=function(){};return{s:i,n:function(){return n>=e.length?{done:!0}:{done:!1,value:e[n++]}},e:function(e){throw e},f:i}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var o,a=!0,s=!1;return{s:function(){r=r.call(e)},n:function(){var e=r.next();return a=e.done,e},e:function(e){s=!0,o=e},f:function(){try{a||null==r.return||r.return()}finally{if(s)throw o}}}}function Un(e,t){(null==t||t>e.length)&&(t=e.length);for(var r=0,n=new Array(t);r<t;r++)n[r]=e[r];return n}S(_n,"ARRAY_TYPE",cr);var jn=function(){function e(){P(this,e)}return w(e,null,[{key:"union",value:function(e){var t=new dr(e);return t.subject=Qt.SimplifyPolygons(t.subject,rr.pftNonZero),t.solution=Qt.CleanPolygons(t.subject,.1*t.transform.scale),1==t.subject.length&&0==t.solution.first.length&&(t.solution=t.subject),t.toPolygon()}},{key:"simplify",value:function(t){var r,n=new or,i=this.createClipperPath(t);r=Qt.SimplifyPolygon(i,rr.pftNonZero);var o,a=Fn(r=Qt.CleanPolygons(r,.1*i.scale));try{for(a.s();!(o=a.n()).done;){var s=o.value;0!=s.length&&n.push(ht.createSharedInstance(e.fromClipperPath(s,i.scale)))}}catch(e){a.e(e)}finally{a.f()}return n}},{key:"createClipperPath",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:32,r=new tr;r.scale=t;for(var n=0;n<e.length;n++)r.push({X:Math.round(e.getPointX(n)*t),Y:Math.round(e.getPointY(n)*t)});return r}},{key:"fromClipperPath",value:function(e){for(var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:e.scale||32,r=Float32Array.createSharedInstance(2*e.length),n=0;n<e.length;n++){var i=e[n],o=2*n;r[o]=i.X/t,r[o+1]=i.Y/t}return r}},{key:"containsPoint",value:function(e,t){var r={X:Math.round(t.x*e.scale),Y:Math.round(t.y*e.scale)};return 1==Qt.PointInPolygon(r,e)}}]),e}();function Gn(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var r,n=O(e);if(t){var i=O(this).constructor;r=Reflect.construct(n,arguments,i)}else r=n.apply(this,arguments);return A(this,r)}}var Yn=function(e){R(r,e);var t=Gn(r);function r(){return P(this,r),t.call(this)}return w(r,[{key:"predict",value:function(e){return console.warn("Prediction merge is not recommended"),e}},{key:"buildImpl",value:function(e){return this.merge(e)}},{key:"merge",value:function(e){if(0!=e.length)return jn.union(e)}}]),r}(It);function Xn(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var r,n=O(e);if(t){var i=O(this).constructor;r=Reflect.construct(n,arguments,i)}else r=n.apply(this,arguments);return A(this,r)}}S(Yn,"ARRAY_TYPE",cr);var zn=function(e){R(r,e);var t=Xn(r);function r(){var e,n=arguments.length>0&&void 0!==arguments[0]?arguments[0]:.1;return P(this,r),(e=t.call(this)).epsilon=n,e}return w(r,[{key:"predict",value:function(e){return console.warn("Prediction simplify is not recommended"),e}},{key:"buildImpl",value:function(e){var t=this;return e instanceof ht?e.simplify(this.epsilon):D(e.constructor,te(e.map((function(e){return e.simplify(t.epsilon)}))))}}]),r}(It);function Vn(){}S(zn,"ARRAY_TYPE",cr),Object.defineEnum(Vn,"Stage",["PATH_PRODUCER","SMOOTHER","SPLINE_PRODUCER","SPLINE_INTERPOLATOR","BRUSH_APPLIER","CONVEX_HULL_CHAIN_PRODUCER","POLYGON_MERGER","POLYGON_SIMPLIFIER"]);var Hn=Vn.Stage,Zn=Y.Phase,qn=It.OutputType,Wn=Object.freeze({__proto__:null,Stage:Hn,Phase:Zn,OutputType:qn,PathProducer:dn,Smoother:vn,SplineProducer:gn,DistanceBasedInterpolator:Lr,CurvatureBasedInterpolator:wn,BrushApplier:Sn,ConvexHullChainProducer:An,ConvexHullChainProducerAsync:_n,PolygonMerger:Yn,PolygonSimplifier:zn}),Kn=function(){function e(t){var r=this;P(this,e),this.phase=t.phase;var n=isNaN(t.altitude)||isNaN(t.azimuth)?void 0:{altitude:t.altitude,azimuth:t.azimuth};Object.defineProperty(this,"x",{value:t.x,enumerable:!0}),Object.defineProperty(this,"y",{value:t.y,enumerable:!0}),Object.defineProperty(this,"z",{value:t.z,enumerable:!0}),Object.defineProperty(this,"timestamp",{value:t.timestamp,enumerable:!0,writable:!0}),Object.defineProperty(this,"force",{value:t.pressure,enumerable:!0}),Object.defineProperty(this,"pressure",{value:t.pressure,enumerable:!0}),Object.defineProperty(this,"rotation",{value:t.rotation,enumerable:!0}),Object.defineProperty(this,"radiusX",{value:t.radiusX,enumerable:!0}),Object.defineProperty(this,"radiusY",{value:t.radiusY,enumerable:!0}),Object.defineProperty(this,"altitude",{get:function(){return n||(n=r.computeTilt(t)||{}),n.altitude},enumerable:!0}),Object.defineProperty(this,"azimuth",{get:function(){return n||(n=r.computeTilt(t)||{}),n.azimuth},enumerable:!0}),t.pointer&&Object.defineProperty(this,"pointer",{value:t.pointer,enumerable:!0}),this.computedAzimuth=void 0}return w(e,[{key:"createPathPoint",value:function(e){return new le(this.x,this.y,this.z,e)}},{key:"computeTilt",value:function(e){if(!isNaN(e.tiltX)&&!isNaN(e.tiltY)){var t=e.tiltX,r=e.tiltY,n=Math.tan(Math.toRadians(t)),i=Math.tan(Math.toRadians(r)),o=Math.sqrt(n*n+i*i);return{altitude:Math.atan2(1,o),azimuth:Math.atan2(i,n)}}}},{key:"speed",value:function(t,r){var n={x:0,y:0,time:0};return(n=t&&!r?this.minus(t):r&&!t?r.minus(this):r.minus(t)).time>0?e.getMagnitude(n.x,n.y)/(n.time/1e3):(0==n.time||console.warn("Speed out of range: ".concat(n.time,"ms")),0)}},{key:"computeNearestAzimuthAngle",value:function(e){var t;if(isNaN(this.azimuth))return 0;if(e){if(isNaN(e.azimuth))return 0;var r=2*Math.PI,n=e.computedAzimuth||e.azimuth,i=parseInt(n/r),o=(t=this.azimuth+i*r)-n;o>=Math.PI?t-=r:o<-Math.PI&&(t+=r)}else t=this.azimuth;return this.computedAzimuth=t,t}},{key:"minus",value:function(e){return{x:this.x-e.x,y:this.y-e.y,time:this.timestamp-e.timestamp}}}],[{key:"getMagnitude",value:function(e,t){return Math.sqrt(e*e+t*t)}}]),e}();Object.defineEnum(Kn,"Property",["X","Y","Z","PHASE","TIMESTAMP","PRESSURE","RADIUS_X","RADIUS_Y","ALTITUDE","AZIMUTH","ROTATION"]);var Jn=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[],r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[];P(this,e),this.accumulatedAddition=t,this.lastPrediction=r,this.first=!1,this.last=!1}return w(e,[{key:"add",value:function(e,t){var r,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:[];e==Y.Phase.BEGIN?this.reset(!0):e==Y.Phase.END&&(this.last=!0),t&&(r=this.accumulatedAddition).push.apply(r,te(t)),this.lastPrediction=n}},{key:"clone",value:function(){var t=new e(this.accumulatedAddition.slice(),this.lastPrediction.slice());return t.first=this.first,t.last=this.last,t}},{key:"reset",value:function(){var e=arguments.length>0&&void 0!==arguments[0]&&arguments[0];this.first=e,this.last=!1,this.accumulatedAddition.clear(),this.lastPrediction.clear()}}]),e}(),$n=[Hn.SMOOTHER,Hn.POLYGON_MERGER,Hn.POLYGON_SIMPLIFIER],Qn=[Hn.SPLINE_INTERPOLATOR,Hn.BRUSH_APPLIER,Hn.CONVEX_HULL_CHAIN_PRODUCER,Hn.POLYGON_MERGER,Hn.POLYGON_SIMPLIFIER],ei=function(){function e(){var t=this;P(this,e),this.layout=[le.Property.X,le.Property.Y],this.pathSegment=new Jn,this.pathProducer=new dn(this.layout),this.smoother=new vn(this.layout.length),this.splineProducer=new gn(this.layout),this.distanceInterpolator=new Lr,this.curvatureInterpolator=new wn,this.brushApplier=new Sn,this.polygonMerger=new Yn,this.polygonSimplifier=new zn,this.splineProducer.keepAllData=!0,this.phase=void 0,this.pointerID=void 0,this.concatSegments=!1,this.lastPipelineStage=void 0,this.excludedPipelineStages=[],this.configured=!1,Object.defineProperty(this,"prediction",{get:function(){return t.pathProducer.prediction},set:function(e){return t.pathProducer.prediction=e},enumerable:!0})}return w(e,[{key:"configure",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};if(this.reset(this.pointerID),e.onBuildComplete)throw new Error("InkBuilderSettings onBuildComplete property is deprecated. Use InkBuilder instance onComplete property to set callback.");if("mergePrediction"in e&&console.warn("InkBuilderSettings 'mergePrediction' property is deprecated. Do not affects PolygonMerger behaviour."),!e.brush)throw new Error("InkBuilderSettings brush property is required");if(e.excludedPipelineStages){if(!Array.isArray(e.excludedPipelineStages))throw new Error("Expected type of excludedPipelineStages is Array instance");var t=e.excludedPipelineStages.filter((function(e){return!$n.includes(e)}));t.length>0&&console.warn("excludedPipelineStages property includes steps which cannot be excluded: ".concat(t.map((function(e){return e.name})).join(", "))),this.excludedPipelineStages=e.excludedPipelineStages}if(!this.excludedPipelineStages.includes(Hn.SMOOTHER)&&e.movingAverageWindowSize&&(this.smoother.movingAverageWindowSize=e.movingAverageWindowSize),e.lastPipelineStage){if(!Qn.includes(e.lastPipelineStage))throw new Error("lastPipelineStage property expects one of: ".concat(Qn.map((function(e){return e.name})).join(", ")));if(this.excludedPipelineStages.includes(e.lastPipelineStage))throw new Error("lastPipelineStage ".concat(e.lastPipelineStage.name," is disabled, check excludedPipelineStages configuration"));if(e.brush instanceof qt&&e.lastPipelineStage!=Hn.SPLINE_INTERPOLATOR)throw new Error("lastPipelineStage ".concat(e.lastPipelineStage.name," is not compatible with provided brush"));this.lastPipelineStage=e.lastPipelineStage}switch(this.brush=e.brush,this.brush instanceof xt&&(this.brushApplier.brush=this.brush),this.lastPipelineStage||(this.brush instanceof xt?(this.brush.spacing>1?this.lastPipelineStage=Hn.BRUSH_APPLIER:this.excludedPipelineStages.includes(Hn.POLYGON_SIMPLIFIER)&&this.excludedPipelineStages.includes(Hn.POLYGON_MERGER)?this.lastPipelineStage=Hn.CONVEX_HULL_CHAIN_PRODUCER:this.lastPipelineStage=Hn.POLYGON_MERGER,this.lastPipelineStage==Hn.POLYGON_MERGER&&(this.concatSegments=Boolean(e.concatSegments))):this.lastPipelineStage=Hn.SPLINE_INTERPOLATOR),this.lastPipelineStage==Hn.SPLINE_INTERPOLATOR||this.lastPipelineStage==Hn.BRUSH_APPLIER?(this.splineInterpolator=this.distanceInterpolator,this.splineInterpolator.spacing=this.brush.spacing,this.splineInterpolator.scattering=this.brush.scattering,this.splineInterpolator.calculateDerivates=this.brush instanceof qt):(this.splineInterpolator=this.curvatureInterpolator,this.splineInterpolator.errorThreshold=e.errorThreshold||.15),this.splineInterpolator.keepAllData=!1,this.brushApplier.keepAllData=!1,this.convexHullChainProducer.keepAllData=!1,this.polygonMerger.keepAllData=!1,this.polygonSimplifier.keepAllData=!1,this.lastPipelineStage){case Hn.SPLINE_INTERPOLATOR:this.splineInterpolator.keepAllData=!0;break;case Hn.BRUSH_APPLIER:this.brushApplier.keepAllData=!0;break;case Hn.CONVEX_HULL_CHAIN_PRODUCER:this.convexHullChainProducer.keepAllData=!0;break;case Hn.POLYGON_MERGER:this.polygonMerger.keepAllData=!0;break;case Hn.POLYGON_SIMPLIFIER:this.polygonSimplifier.keepAllData=!0;break;default:throw console.warn(this.lastPipelineStage),new Error("Invalid lastPipelineStage found")}if(this.lastPipelineStage==Hn.POLYGON_SIMPLIFIER&&(console.warn("InkBuilderSettings: Pipeline stage POLYGON_SIMPLIFIER is deprecated. POLYGON_MERGER stage is recommended as last stage."),this.polygonSimplifier.epsilon=e.epsilon||.1),e.pathPointCalculator&&(this.calculator=e.pathPointCalculator,this.pathProducer.pathPointCalculator=e.pathPointCalculator),!e.layout)throw new Error("InkBuilderSettings layout property is required");var r=e.pathPointProps||{};if(this.layout=e.layout,this.brush instanceof xt){if(this.layout.includes(le.Property.RED))throw new Error("RED layout channel is not supported for non particles strokes");if(this.layout.includes(le.Property.GREEN))throw new Error("GREEN layout channel is not supported for non particles strokes");if(this.layout.includes(le.Property.BLUE))throw new Error("BLUE layout channel is not supported for non particles strokes");if(this.layout.includes(le.Property.ALPHA))throw new Error("ALPHA layout channel is not supported for non particles strokes")}if(!this.layout.includes(le.Property.RED)&&isNaN(r.red))throw new Error("Stroke color red channel information is required. Please provide via layout or through configure settings via pathPointProps property.");if(!this.layout.includes(le.Property.GREEN)&&isNaN(r.green))throw new Error("Stroke color green channel information is required. Please provide via layout or through configure settings via pathPointProps property.");if(!this.layout.includes(le.Property.BLUE)&&isNaN(r.blue))throw new Error("Stroke color blue channel information is required. Please provide via layout or through configure settings via pathPointProps property.");if(!this.layout.includes(le.Property.ALPHA)&&isNaN(r.alpha))throw new Error("Stroke color alpha channel information is required. Please provide via layout or through configure settings via pathPointProps property.");this.pathProducer.layout=this.layout,this.smoother.dimsCount=this.layout.length,this.splineProducer.layout=this.layout,this.splineProducer.pathPointProps=r,this.configured=!0}},{key:"add",value:function(e,t){if(!this.configured)throw new Error("InkBuilder instance is not configured yet, use configure method to configure the instance.");if(!this.calculator)throw new Error("InkBuilder instance is not configured properly, pathPointCalculator property is required");if(!e.phase)throw new Error("SensorPoint phase is not found");this.phase=e.phase;var r,n=new Kn(e);t&&(this.prediction?r=new Kn(t):console.warn("Prediction sensor point is available, but ignored, prediction is disabled")),this.device&&(this.phase==dn.Phase.BEGIN&&this.device.openStream(e),this.device.add(n),this.phase==dn.Phase.END&&(this.sensorData=this.device.closeStream()));var i=this.pathProducer.add(this.phase,n,r);this.pathSegment.add(this.phase,i.added,i.predicted)}},{key:"ignore",value:function(e){if(!e.phase)throw new Error("SensorPoint phase is not found");this.device&&e&&e.phase==dn.Phase.UPDATE&&this.device.add(new Kn(e),!0)}},{key:"build",value:function(){throw new Error("InkBuilderAbstract.build() is abstract and should be implemented")}},{key:"processSegment",value:function(e,t,r){throw new Error("InkBuilderAbstract.processSegment(path, type, lastSegment) is abstract and should be implemented")}},{key:"getSensorData",value:function(){return this.sensorData}},{key:"getSpline",value:function(){return this.splineProducer.allData}},{key:"getInkPath",value:function(){var e,t;switch(this.lastPipelineStage){case Hn.SPLINE_INTERPOLATOR:e=this.splineInterpolator.allData;break;case Hn.BRUSH_APPLIER:e=this.brushApplier.allData;break;case Hn.CONVEX_HULL_CHAIN_PRODUCER:e=this.convexHullChainProducer.allData;break;case Hn.POLYGON_MERGER:e=this.polygonMerger.allData;break;case Hn.POLYGON_SIMPLIFIER:e=this.polygonSimplifier.allData;break;default:throw console.warn(this.lastPipelineStage),new Error("Invalid lastPipelineStage found")}this.concatSegments&&(this.lastPipelineStage!=Hn.POLYGON_MERGER&&this.lastPipelineStage!=Hn.POLYGON_SIMPLIFIER||(t=this.polygonMerger.build(e)),this.lastPipelineStage==Hn.POLYGON_SIMPLIFIER&&(t=this.polygonSimplifier.build(t)),t&&(e=new cr(t)));return e}},{key:"abort",value:function(){this.device&&this.device.closeStream(!0),this.reset()}},{key:"reset",value:function(e){this.pointerID=e,this.phase=void 0,this.concatSegments=!1,this.lastPipelineStage=void 0,this.excludedPipelineStages.clear(),this.sensorData=void 0,this.pathProducer.reset(),this.smoother.reset(),this.splineProducer.reset(),this.distanceInterpolator.reset(),this.curvatureInterpolator.reset(),this.brushApplier.reset(),this.convexHullChainProducer.reset(),this.polygonMerger.reset(),this.polygonSimplifier.reset(),this.configured=!1}}]),e}();function ti(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var r,n=O(e);if(t){var i=O(this).constructor;r=Reflect.construct(n,arguments,i)}else r=n.apply(this,arguments);return A(this,r)}}ei.Phase=dn.Phase;var ri=function(e){R(r,e);var t=ti(r);function r(){var e;return P(this,r),(e=t.call(this)).convexHullChainProducer=new An,e}return w(r,[{key:"build",value:function(){var e=this.buildSegment();return e.phase=this.phase,e.pointerID=this.pointerID,this.onComplete&&this.onComplete(e),this.phase==Zn.END&&delete this.phase,e}},{key:"buildSegment",value:function(){var e={};return this.pathSegment.accumulatedAddition.length>0&&(e.added=this.processSegment(this.pathSegment.accumulatedAddition,qn.ADDITION,this.pathSegment.last),e.added&&(e.added.segment=!0)),this.prediction&&this.pathSegment.lastPrediction.length>0&&(e.predicted=this.processSegment(this.pathSegment.lastPrediction,qn.PREDICTION,this.pathSegment.last),e.predicted&&(e.predicted.segment=!0)),this.pathSegment.reset(),e}},{key:"processSegment",value:function(e,t,r){if(this.excludedPipelineStages.includes(Hn.SMOOTHER)||(e=this.smoother.build(e,t,r)),e=this.splineProducer.build(e,t,r))return this.processSpline(e,t,r)}},{key:"processSpline",value:function(e){var t,r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:qn.PROCESSOR,n=!(arguments.length>2&&void 0!==arguments[2])||arguments[2],i=this.splineInterpolator.build(e,r,n);if(this.lastPipelineStage==Hn.SPLINE_INTERPOLATOR)return i;if(i)return i=this.brushApplier.build(i,r,n),this.lastPipelineStage==Hn.BRUSH_APPLIER?i:(i=this.convexHullChainProducer.build(i,r,n),this.lastPipelineStage==Hn.CONVEX_HULL_CHAIN_PRODUCER||r==qn.PREDICTION?i:this.excludedPipelineStages.includes(Hn.POLYGON_MERGER)||(t=this.polygonMerger.build(i,r,n),this.lastPipelineStage!=Hn.POLYGON_MERGER)?(this.excludedPipelineStages.includes(Hn.POLYGON_SIMPLIFIER)||(t=this.polygonSimplifier.build(t,r,n)),new cr(t)):new cr(t));if(r==qn.PROCESSOR)throw new Error("InkBuilder processSpline failed for spline",e)}}]),r}(ei),ni=function(){function e(){P(this,e),this.queue=Promise.resolve(),this.thenables=[]}var t;return w(e,[{key:"then",value:function(e,t,r){var n=this;return this.thenables.push(e),this.queue=this.queue.then((function(){return n.thenables.shift(),e.canceled?Promise.resolve():e.apply(void 0,arguments)})),t&&this.then((function(e){return t(e,r)})),this}},{key:"catch",value:function(e){return this.queue=this.queue.catch(e),this}},{key:"cancel",value:function(){this.thenables.forEach((function(e){return e.canceled=!0}))}},{key:"isEmpty",value:function(){return 0==this.thenables.length}}],[{key:"serial",value:(t=fe(pe.mark((function t(r,n){var i;return pe.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return i=new e,r.forEach((function(e,t){return i.then(e,n,t)})),t.abrupt("return",i.queue);case 3:case"end":return t.stop()}}),t)}))),function(e,r){return t.apply(this,arguments)})}]),e}();function ii(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var r,n=O(e);if(t){var i=O(this).constructor;r=Reflect.construct(n,arguments,i)}else r=n.apply(this,arguments);return A(this,r)}}var oi,ai,si=function(e){R(a,e);var t,r,n,i,o=ii(a);function a(){var e;return P(this,a),(e=o.call(this)).convexHullChainProducer=new _n,e.queue=new ni,e}return w(a,[{key:"onComplete",value:function(e){throw new Error("InkBuilderAbstract.onComplete(pathSegment) is abstract and should be implemented")}},{key:"build",value:function(){var e=this;if(!this.buildPhase||this.phase==Zn.END){var t=this.phase;this.queue.then((function(){return e.buildPhase=t,e.buildSegment()})).then((function(r){e.buildPhase=null,r.phase=t,r.pointerID=e.pointerID,e.onComplete(r),t==Zn.END&&delete e.phase}))}}},{key:"buildChain",value:(i=fe(pe.mark((function e(){var t;return pe.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.buildSegment();case 2:return(t=e.sent).phase=this.phase,t.pointerID=this.pointerID,this.onComplete(t),this.phase==Zn.END&&delete this.phase,e.abrupt("return",t);case 8:case"end":return e.stop()}}),e,this)}))),function(){return i.apply(this,arguments)})},{key:"buildSegment",value:(n=fe(pe.mark((function e(){var t;return pe.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t={},!(this.pathSegment.accumulatedAddition.length>0)){e.next=6;break}return e.next=4,this.processSegment(this.pathSegment.accumulatedAddition,qn.ADDITION,this.pathSegment.last);case 4:t.added=e.sent,t.added&&(t.added.segment=!0);case 6:if(!(this.prediction&&this.pathSegment.lastPrediction.length>0)){e.next=11;break}return e.next=9,this.processSegment(this.pathSegment.lastPrediction,qn.PREDICTION,this.pathSegment.last);case 9:t.predicted=e.sent,t.predicted&&(t.predicted.segment=!0);case 11:return this.pathSegment.reset(),e.abrupt("return",t);case 13:case"end":return e.stop()}}),e,this)}))),function(){return n.apply(this,arguments)})},{key:"processSegment",value:(r=fe(pe.mark((function e(t,r,n){return pe.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this.excludedPipelineStages.includes(Hn.SMOOTHER)||(t=this.smoother.build(t,r,n)),t=this.splineProducer.build(t,r,n)){e.next=4;break}return e.abrupt("return");case 4:return e.abrupt("return",this.processSpline(t,r,n));case 5:case"end":return e.stop()}}),e,this)}))),function(e,t,n){return r.apply(this,arguments)})},{key:"processSpline",value:(t=fe(pe.mark((function e(t){var r,n,i,o,a=arguments;return pe.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r=a.length>1&&void 0!==a[1]?a[1]:qn.PROCESSOR,n=!(a.length>2&&void 0!==a[2])||a[2],i=this.splineInterpolator.build(t,r,n),this.lastPipelineStage!=Hn.SPLINE_INTERPOLATOR){e.next=5;break}return e.abrupt("return",i);case 5:if(i){e.next=9;break}if(r!=qn.PROCESSOR){e.next=8;break}throw new Error("InkBuilderAsync processSpline failed for spline",t);case 8:return e.abrupt("return");case 9:if(i=this.brushApplier.build(i,r,n),this.lastPipelineStage!=Hn.BRUSH_APPLIER){e.next=12;break}return e.abrupt("return",i);case 12:return e.next=14,this.convexHullChainProducer.build(i,r,n);case 14:if(i=e.sent,this.lastPipelineStage!=Hn.CONVEX_HULL_CHAIN_PRODUCER){e.next=17;break}return e.abrupt("return",i);case 17:if(r!=qn.PREDICTION){e.next=19;break}return e.abrupt("return",i);case 19:if(this.excludedPipelineStages.includes(Hn.POLYGON_MERGER)){e.next=23;break}if(o=this.polygonMerger.build(i,r,n),this.lastPipelineStage!=Hn.POLYGON_MERGER){e.next=23;break}return e.abrupt("return",new cr(o));case 23:return this.excludedPipelineStages.includes(Hn.POLYGON_SIMPLIFIER)||(o=this.polygonSimplifier.build(o,r,n)),e.abrupt("return",new cr(o));case 25:case"end":return e.stop()}}),e,this)}))),function(e){return t.apply(this,arguments)})},{key:"abort",value:function(){this.buildPhase=null,this.queue.cancel(),nr(O(a.prototype),"abort",this).call(this)}}]),a}(ei);function ui(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var r,n=O(e);if(t){var i=O(this).constructor;r=Reflect.construct(n,arguments,i)}else r=n.apply(this,arguments);return A(this,r)}}var ci=function(e){R(n,e);var t,r=ui(n);function n(e,t,i,o){var a,s,u,c,l;P(this,n),a=r.call(this,t.id),t.id||(t.id=a.id);var h=n.RenderMode.SOURCE_OVER,f=n.CompressionType.AUTO,d=new Ke(t.layout,t.pointProps);Object.defineProperty(T(a),"target",{get:function(){return console.warn("Stroke 'target' property is deprecated. Do not affects Stroke behaviour.")},set:function(e){return console.warn("Stroke 'target' property is deprecated. Do not affects Stroke behaviour.")}});var p=!0;return Object.defineProperty(T(a),"layout",{value:t.layout,enumerable:!0}),Object.defineProperty(T(a),"points",{get:function(){return t.points},enumerable:!0}),Object.defineProperty(T(a),"pointProps",{value:t.pointProps,enumerable:!0}),Object.defineProperty(T(a),"style",{value:d.style,enumerable:!0}),Object.defineProperty(T(a),"ts",{value:t.ts,enumerable:!0}),Object.defineProperty(T(a),"tf",{value:t.tf,enumerable:!0}),Object.defineProperty(T(a),"stride",{value:t.stride,enumerable:!0}),Object.defineProperty(T(a),"length",{value:t.length,enumerable:!0}),Object.defineProperty(T(a),"segmentsCount",{value:t.segmentsCount,enumerable:!0}),Object.defineProperty(T(a),"color",{get:function(){return d.style.color},set:function(e){t.color=e,i&&(i.color=e)},enumerable:!0}),Object.defineProperty(T(a),"sensorData",{get:function(){return o},set:function(e){if(o)throw new Error("sensorData is immutable");o=e}}),Object.defineProperty(T(a),"spline",{value:t,enumerable:!0}),Object.defineProperty(T(a),"path",{get:function(){return i||a.buildPath(),i},set:function(e){(i=e)instanceof Or&&(i.style=d.style),a.bounds=null},enumerable:!0}),Object.defineProperty(T(a),"pathValue",{get:function(){return i}}),Object.defineProperty(T(a),"bounds",{get:function(){return u||(u=a.path.bounds),a.matrix?u.transform(a.matrix).ceil():u},set:function(e){return u=e},enumerable:!0}),Object.defineProperty(T(a),"descriptor",{value:{brush:{}},enumerable:!0}),Object.defineProperty(T(a),"brush",{get:function(){return e||(e=a.descriptor.brush.value),e},set:function(r){if(p||(a.path=null),"string"==typeof r?r=new Xe(r):r instanceof xt||r instanceof qt?r=new Xe(r.name,r):r instanceof Xe||(r=new Xe(r.name,r.value)),r instanceof qt&&!t.randomSeed)throw new Error("Spline do not provides randomSeed. Raster rendering requires it.");e=null,a.descriptor.brush=r},enumerable:!0}),Object.defineProperty(T(a),"randomSeed",{get:function(){return c},set:function(e){if(c)throw new Error("randomSeed is immutable");c=e},enumerable:!0}),Object.defineProperty(T(a),"renderMode",{get:function(){return h},set:function(e){if(!e)throw new Error("Stroke renderMode is required");if(!re.isValidURL(e))throw new Error("The renderMode ".concat(e," is not a well formed URI"));h=e}}),Object.defineProperty(T(a),"blendMode",{get:function(){return n.RenderMode.getBlendMode(h)},set:function(e){if(!a.blendMode)throw new Error("Override user defined renderMode '".concat(a.renderMode,"' is not allowed."));a.renderMode=n.RenderMode.get(e)}}),Object.defineProperty(T(a),"precisionSchema",{get:function(){return l},set:function(e){if(l)throw new Error("precisionSchema is immutable, precisionSchema.update(schema) is an alternative");if(e){if(!(e instanceof un))throw new Error("Expected precisionSchema type is PrecisionSchema");l=e,f=n.CompressionType.COMPUTED}else f=n.CompressionType.NONE}}),Object.defineProperty(T(a),"compressionType",{get:function(){return f},set:function(e){if(!e)throw new Error("Stroke compressionType is required");if(f==n.CompressionType.COMPUTED&&e==n.CompressionType.NONE)throw new Error("compressionType NONE is not applicable for compressed stroke");f=e,a.invalidatePrecisionSchema&&(delete a.invalidatePrecisionSchema,l=void 0)}}),Object.defineProperty(T(a),"uri",{get:function(){return s||(s=Me.createStrokeURI(a.id)),s},enumerable:!0}),a.brush=e,a.path=i,a.sensorDataOffset=0,a.sensorDataMapping=[],p=!1,a}return w(n,[{key:"buildPath",value:function(){if(this.pathProceessInProgress)throw new Error("Init process in progress. Await init stroke.");oi||(oi=new ri),oi.configure(this.buildInkBuilderSettings()),this.path=oi.processSpline(this.spline)}},{key:"init",value:(t=fe(pe.mark((function e(t){return pe.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return this.pathProceessInProgress=!0,ai||(ai=new si),ai.configure(this.buildInkBuilderSettings(t)),e.next=5,ai.processSpline(this.spline);case 5:this.path=e.sent,delete this.pathProceessInProgress;case 7:case"end":return e.stop()}}),e,this)}))),function(e){return t.apply(this,arguments)})},{key:"buildInkBuilderSettings",value:function(e){return n.onPipeline?n.onPipeline(this):Object.assign({},{brush:this.brush,layout:this.layout,pathPointProps:this.pointProps},e)}},{key:"invalidateBounds",value:function(){this.bounds=null}},{key:"clone",value:function(){var e=new n(this.descriptor.brush,this.spline.clone(),void 0,this.sensorData);return e.randomSeed=this.randomSeed,e.renderMode=this.renderMode,e.sensorDataOffset=this.sensorDataOffset,e.sensorDataMapping=this.sensorDataMapping.clone(),e}},{key:"getSensorPoint",value:function(e){if(e>=this.length||e<0)throw new Error("Index ".concat(e," out of range - (0, ").concat(this.length-1,")"));var t;if(this.sensorData){var r,n=this.sensorData.inkStream;if(n)this.sensorDataMapping.length>0?r=e>=this.sensorDataMapping.length?this.sensorDataMapping.last:this.sensorDataMapping[e]:(r=this.sensorDataOffset+e)>=n.length&&(r=n.length-1),(t=n.get(r)).index=r,t.timespan=t.timestamp,t.timestamp+=this.sensorData.created}return t}},{key:"getPoint",value:function(e){return this.spline.getPoint(e)}},{key:"setPoint",value:function(e,t){var r=this,n=e*this.stride;this.layout.forEach((function(e,i){return r.points[n+i]=t.getProperty(e)}))}},{key:"pointAt",value:function(e){return this.getPoint(e)}},{key:"getSegment",value:function(e){return this.spline.getSegment(e)}},{key:"getAverageWidth",value:function(){var e=0;if(this.layout.includes(le.Property.SIZE)){for(var t=0,r=0;r<this.length;r++)t+=this.getPoint(r).size;e=t/this.length}else e=this.pointProps.size;return e}},{key:"split",value:function(e){var t=this,r=e.map((function(e){return t.slice(e)}));return r.includes(this)||0==r.length?void 0:r}},{key:"slice",value:function(e){var t=e.fromPointIndex,r=e.toPointIndex,i=e.fromTValue,o=e.toTValue;if(0==t&&r+1==this.length&&i==this.ts&&o==this.tf)return this;var a=this.spline.slice(e),s=new n(this.descriptor.brush,a,void 0,this.sensorData);return e.id||(e.id=s.id),s.randomSeed=this.randomSeed,s.renderMode=this.renderMode,this.sensorData&&(s.sensorDataOffset=this.sensorDataOffset+t,this.sensorDataMapping.length>0?s.sensorDataMapping=this.sensorDataMapping.slice(t,r+1):s.sensorDataMapping=[]),s}},{key:"subStroke",value:function(e){return console.warn("Stroke subStroke method is deprecated. Use Stroke instance slice method instead."),this.slice(e)}},{key:"transform",value:function(e){e||(e=this.matrix,this.matrix=null),e&&(this.spline.transform(e),this.pathValue&&this.path.transform(e),this.compressionType!=n.CompressionType.NONE&&(this.invalidatePrecisionSchema=!0,this.compressionType=n.CompressionType.AUTO),this.bounds=null)}},{key:"setTransform",value:function(e){this.matrix=e}}],[{key:"createInstance",value:function(e,t,r){var i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{},o=arguments.length>4?arguments[4]:void 0,a=arguments.length>5&&void 0!==arguments[5]?arguments[5]:0,s=arguments.length>6&&void 0!==arguments[6]?arguments[6]:1,u=i.id,c=i.color;u&&delete i.id,c&&(delete i.color,i=Object.assign({},i),r.includes(le.Property.RED)||(i.red=c.red),r.includes(le.Property.GREEN)||(i.green=c.green),r.includes(le.Property.BLUE)||(i.blue=c.blue),r.includes(le.Property.ALPHA)||(i.alpha=c.alpha));var l=new Tr(r,t,i,a,s);l.id=u;var h=new n(e,l);return h.randomSeed=o,h}},{key:"validatePath",value:function(e){if(!e)return!1;if(0==e.length)return!1;if(e instanceof cr)return!0;if(Array.isArray(e))throw new Error("path should be instance of InkPath2D");var t=!1,r=0,n=!1,i=e.pointProps,o=i.size,a=i.red,s=i.green,u=i.blue,c=i.alpha;if(!(e instanceof Or)){var l=e.points.length,h=e.layout.length;n=0==l||l<4*h,r=l%h}return 0!=r?console.error("The points array (length: ".concat(e.points.length,") does not refer to provided layout (").concat(e.layout.map((function(e){return e.name})).join(", "),")")):n?console.error("Less than needed minimum of points passed (At least 4 points are needed to define a path)!"):!e.layout.includes(le.Property.SIZE)&&isNaN(o)?console.error("Either the size property must be set or the path layout must include a SIZE property"):!e.layout.includes(le.Property.RED)&&isNaN(a)?console.error("Either the color property must be set or the path layout must include a RED property"):!e.layout.includes(le.Property.GREEN)&&isNaN(s)?console.error("Either the color property must be set or the path layout must include a GREEN property"):!e.layout.includes(le.Property.BLUE)&&isNaN(u)?console.error("Either the color property must be set or the path layout must include a BLUE property"):!e.layout.includes(le.Property.ALPHA)&&isNaN(c)?console.error("Either the color property must be set or the path layout must include a ALPHA property"):t=!0,t}},{key:"decodeInkPath",value:function(e){if("InkPath2D"==e.type)return cr.fromJSON(e);if("InterpolatedSpline"==e.type)return Or.fromJSON(e);throw new Error("Decode ink path faild. Cannot identify type: ".concat(e.type))}}]),n}(U);function li(e,t){var r="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!r){if(Array.isArray(e)||(r=function(e,t){if(!e)return;if("string"==typeof e)return hi(e,t);var r=Object.prototype.toString.call(e).slice(8,-1);"Object"===r&&e.constructor&&(r=e.constructor.name);if("Map"===r||"Set"===r)return Array.from(e);if("Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r))return hi(e,t)}(e))||t&&e&&"number"==typeof e.length){r&&(e=r);var n=0,i=function(){};return{s:i,n:function(){return n>=e.length?{done:!0}:{done:!1,value:e[n++]}},e:function(e){throw e},f:i}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var o,a=!0,s=!1;return{s:function(){r=r.call(e)},n:function(){var e=r.next();return a=e.done,e},e:function(e){s=!0,o=e},f:function(){try{a||null==r.return||r.return()}finally{if(s)throw o}}}}function hi(e,t){(null==t||t>e.length)&&(t=e.length);for(var r=0,n=new Array(t);r<t;r++)n[r]=e[r];return n}ci.RenderMode=Object.assign.apply(Object,[{}].concat(te(Object.keys(Tt).map((function(e){return S({},e,"will://rasterization/3.0/blend-mode/".concat(re.getPropName(e,!0)))}))))),ci.RenderMode.get=function(e){return ci.RenderMode[re.getEnumValueName(e.replace(/-/g,"_"))]},ci.RenderMode.getBlendMode=function(e){return Tt[Object.keys(ci.RenderMode).filter((function(t){return ci.RenderMode[t]==e})).first]},ci.Target={},Object.defineProperty(ci.Target,"2D",{get:function(){return console.warn("Stroke 'Target[2D]' enum is deprecated")}}),Object.defineProperty(ci.Target,"GL",{get:function(){return console.warn("Stroke 'Target[GL]' enum is deprecated")}}),Object.defineEnum(ci,"CompressionType",["AUTO","NONE","COMPUTED"]);var fi=function(){function e(){var t;P(this,e),this.statistics={},this.statisticCounts={},Object.defineProperty(this,"calculator",{get:function(){return t},set:function(e){if(t&&!(t instanceof rn))throw new Error("calculator should be instance of PrecisionCalculator");t=e},enumerable:!0})}return w(e,[{key:"determinePrecisions",value:function(e){this.reset();var t,r=li(e);try{for(r.s();!(t=r.n()).done;){var n=t.value;this.updatePrecisionSchema(n)}}catch(e){r.e(e)}finally{r.f()}this.printStats()}},{key:"updatePrecisionSchema",value:function(e){var t=this.determinePrecisionSchema(e);e.precisionSchema?e.precisionSchema.update(t):e.precisionSchema=t}},{key:"determinePrecisionSchema",value:function(t){if(t.compressionType==ci.CompressionType.AUTO){if(!this.calculator)throw new Error("PrecisionDetector calculator property is required");var r,n=Number.MAX_SAFE_INTEGER,i=Number.MAX_SAFE_INTEGER,o=Number.MAX_SAFE_INTEGER,a=Number.MAX_SAFE_INTEGER,s=Number.MAX_SAFE_INTEGER,u=li(t.layout);try{for(u.s();!(r=u.n()).done;){var c=r.value,l=void 0,h=t.spline.getChannelData(c),f=this.calculator.calculatePrecision(h,c);switch(c){case le.Property.X:case le.Property.Y:case le.Property.Z:l=e.StatType.POSITION,n=Math.min(f,n);break;case le.Property.SIZE:l=e.StatType.SIZE,i=Math.min(f,i);break;case le.Property.ROTATION:l=e.StatType.ROTATION,o=Math.min(f,o);break;case le.Property.SCALE_X:case le.Property.SCALE_Y:case le.Property.SCALE_Z:l=e.StatType.SCALE,a=Math.min(f,a);break;case le.Property.OFFSET_X:case le.Property.OFFSET_Y:case le.Property.OFFSET_Z:l=e.StatType.OFFSET,s=Math.min(f,s);break;default:continue}if(this.debug){var d=hn.calculateError(h,f);this.addSampleStatistics(l,f,d,Math.min.apply(Math,te(h)),Math.max.apply(Math,te(h)))}}}catch(e){u.e(e)}finally{u.f()}n==Number.MAX_SAFE_INTEGER&&(n=0),i==Number.MAX_SAFE_INTEGER&&(i=0),o==Number.MAX_SAFE_INTEGER&&(o=0),a==Number.MAX_SAFE_INTEGER&&(a=0),s==Number.MAX_SAFE_INTEGER&&(s=0);var p=un.encode({position:n,size:i,rotation:o,scale:a,offset:s});return new un(p)}}},{key:"addSampleStatistics",value:function(t,r,n,i,o){if(this.debug){t!=e.StatType.TOTAL&&this.addSampleStatistics(e.StatType.TOTAL,r,n,i,o);var a=t.name;a in this.statistics||(this.statistics[a]={},this.statisticCounts[a]=0),r in this.statistics[a]||(this.statistics[a][r]={samplesCount:0,totalError:0,minError:Number.MAX_SAFE_INTEGER,maxError:0,sampleMinVal:Number.MAX_SAFE_INTEGER,sampleMaxVal:Number.MIN_SAFE_INTEGER}),this.statistics[a][r].samplesCount+=1,this.statistics[a][r].totalError+=n,this.statistics[a][r].minError=Math.min(this.statistics[a][r].minError,n),this.statistics[a][r].maxError=Math.max(this.statistics[a][r].maxError,n),this.statistics[a][r].sampleMinVal=Math.min(this.statistics[a][r].sampleMinVal,i),this.statistics[a][r].sampleMaxVal=Math.max(this.statistics[a][r].sampleMaxVal,o),this.statisticCounts[a]+=1}}},{key:"printStats",value:function(){var e=this;this.debug&&(Object.keys(this.statistics).forEach((function(t){Object.values(e.statistics[t]).forEach((function(r){r.meanTotalError=r.samplesCount>0?r.totalError/r.samplesCount:NaN,r.usage=e.statisticCounts[t]>0?r.samplesCount/e.statisticCounts[t]*100:NaN}));var r=Object.keys(e.statistics[t]).sort((function(e,t){return e>t}));console.log("***********************************************************************"),r.forEach((function(r){var n=e.statistics[t][r];console.log("Stat Type: ".concat(t," | Precision: ").concat(r)),console.log(" -> Count: ".concat(n.samplesCount," (").concat(n.usage,"%)")),console.log(" -> Min/Max Error: ".concat(n.minError," / ").concat(n.maxError)),console.log(" -> Sample Min/Max Value: ".concat(n.sampleMinVal," / ").concat(n.sampleMaxVal)),console.log(" -> TotalError: ".concat(n.totalError," / ").concat(n.meanTotalError," (mean)"))}))})),console.log("***********************************************************************"))}},{key:"reset",value:function(){this.statistics={},this.statisticCounts={}}}]),e}();Object.defineEnum(fi,"StatType",["TOTAL","POSITION","SIZE","ROTATION","SCALE","OFFSET"]);var di=function(){function e(t){var r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:e.Type.UNKNOWN,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};P(this,e),this.uri=t,this.type=r,this.ontologyType,this.instance,this.internalID=n.internalID,this.externalModelID=n.modelID,this.isGloballyUnique=!!n.isGloballyUnique,this.belongsToCurrentModel=!!n.belongsToCurrentModel,this.triples=[],this.referencedEntities=[],this.referencedByEntities=[]}return w(e,[{key:"printDebugInfo",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"";console.log("".concat(e,"----------------------------------------------------------------")),console.log("".concat(e,"EntityURI: ").concat(this.uri)),console.log("".concat(e,"Type: ").concat(this.type)),console.log("".concat(e,"OntologyType: ").concat(this.ontologyType)),console.log("".concat(e,"InternalEntityID: ").concat(this.internalID)),console.log("".concat(e,"ExternalModelID: ").concat(this.externalModelID)),console.log("".concat(e,"EntityInstance:"),this.instance),console.log("".concat(e,"IsGloballyUnique: ").concat(this.isGloballyUnique)),console.log("".concat(e,"BelongsToCurrentModel: ").concat(this.belongsToCurrentModel)),console.log("".concat(e,"ReferencedEntities: ").concat(this.referencedEntities.length)),this.referencedEntities.forEach((function(t){return console.log("".concat(e," -> ").concat(t.uri))})),console.log("".concat(e,"ReferencedByEntities: ").concat(this.referencedByEntities.length)),this.referencedByEntities.forEach((function(t){return console.log("".concat(e," -> ").concat(t.uri))}))}}]),e}();Object.defineEnum(di,"Type",["UNKNOWN","NODE","STROKE","NAMED_ENTITY"]);var pi,yi=function(){function e(t){var r;P(this,e),this.model=t,this.entities={},this.entityDetector=(S(r={},di.Type.NODE,{regEx:new RegExp(/^(uim:node)(\/[a-zA-Z0-9-]{36})?(\/[a-zA-Z0-9-_]{1,})?\/([a-zA-Z0-9-]{36})(#chunk=[0-9]+,[0-9]+)?$/),entityIDGroupIndex:0,modelIDGroupIndex:2}),S(r,di.Type.STROKE,{regEx:new RegExp(/^(uim:stroke)(\/[a-zA-Z0-9-]{36})?(\/)([a-zA-Z0-9-]{36})$/),entityIDGroupIndex:4,modelIDGroupIndex:2}),S(r,di.Type.NAMED_ENTITY,{regEx:new RegExp(/^(uim:ne)(\/[a-zA-Z0-9-]{36})?(\/)([a-zA-Z0-9-]{36})$/),entityIDGroupIndex:0,modelIDGroupIndex:2}),r)}return w(e,[{key:"clean",value:function(){this.analyze(),this.cleanupInternals(),this.cleanupUnusedEntities()}},{key:"analyze",value:function(){var t=this,r={};this.model.knowledgeGraph.forEach((function(e){var n=r[e.subject];n||(n=t.determineEntityBasedOnURI(e.subject),r[e.subject]=n),n.triples.includes(e)||n.triples.push(e)})),Object.values(r).forEach((function(e){if(e.internalID&&e.belongsToCurrentModel)switch(e.type){case di.Type.NODE:e.instance=t.model.getNode(e.internalID);break;case di.Type.STROKE:e.instance=t.model.getStroke(e.internalID)}})),Object.values(r).forEach((function(t){t.triples.forEach((function(e){var n=r[e.object];n&&(t.referencedEntities.includes(n)||t.referencedEntities.push(n),n.referencedByEntities.includes(t)||n.referencedByEntities.push(t))}));var n=t.triples.filter((function(t){return t.predicate==e.CommonRDF.HAS_TYPE||"@"==t.predicate})).first;n&&(t.ontologyType=n.object)})),this.entities=r,this.debug&&this.printStats()}},{key:"determineEntityBasedOnURI",value:function(e){for(var t=di.Type.UNKNOWN,r={},n=0,i=Object.keys(this.entityDetector);n<i.length;n++){var o=i[n];t=di.Type[o];var a=this.entityDetector[o],s=a.regEx.exec(e);if(s){var u=s[a.entityIDGroupIndex],c=s[a.modelIDGroupIndex];if(!u)throw new Error("Failed to extract internal ID");c&&(c=c.substring(1)),r={internalID:u,externalModelId:c,isGloballyUnique:!!c,belongsToCurrentModel:!c||this.model.id&&this.model.id==c};break}}return new di(e,t,r)}},{key:"cleanupInternals",value:function(){var e=new Set,t=[di.Type.NODE,di.Type.STROKE];Object.values(this.entities).forEach((function(r){t.includes(r.type)&&r.belongsToCurrentModel&&!r.instance&&e.add(r.uri)})),e.size>0&&(this.debug&&console.log("[KnowledgeGraphAnalyzer] Cleanup internals - ".concat(e.size,": ").concat(Array.from(e).join(", "))),this.model.knowledgeGraph.remove((function(t){return e.has(t.subject)||e.has(t.object)})),this.analyze())}},{key:"cleanupUnusedEntities",value:function(){var e=new Set;Object.values(this.entities).forEach((function(t){t.type!=di.Type.NAMED_ENTITY||!t.belongsToCurrentModel||t.referencedByEntities.length>0||e.add(t.uri)})),e.size>0&&(this.debug&&console.log("[KnowledgeGraphAnalyzer] Cleanup unused entities - ".concat(e.size,": ").concat(Array.from(e).join(", "))),this.model.knowledgeGraph.remove((function(t){return e.has(t.subject)||e.has(t.object)})),this.analyze())}},{key:"printStats",value:function(){var e=0,t=Object.values(this.entities);console.log("[KnowledgeGraphAnalyzer] Print ".concat(t.length," entities analysis")),t.forEach((function(r){return r.printDebugInfo("[".concat(++e,"/").concat(t.length,"] "))}))}}]),e}();function vi(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var r,n=O(e);if(t){var i=O(this).constructor;r=Reflect.construct(n,arguments,i)}else r=n.apply(this,arguments);return A(this,r)}}yi.CommonRDF={HAS_TYPE:"http://www.w3.org/1999/02/22-rdf-syntax-ns#type",LOCALE:"http://ogp.me/ns#locale"},Object.defineProperty(globalThis,"DIGITAL_INK_DEBUG",{get:function(){return pi},set:function(e){pi=e||{},ue.debug=pi.InputListener,Y.prototype.debug=pi.Pipeline,It.prototype.debug=pi.Pipeline,St.prototype.debug=pi.PathPointContext,dr.prototype.debug=pi.ClipperContext,Zr.prototype.debug=pi.RTree,Fr.prototype.debug=pi.HolesBuilder,Jt.prototype.debug=pi.GL,Qr.prototype.debug=pi.RIFF,tn.prototype.debug=pi.RIFF,fi.prototype.debug=pi.PrecisionDetector,yi.prototype.debug=pi.KnowledgeGraphAnalyzer},enumerable:!0,configurable:!0});var mi=function(e){R(i,e);var t,r,n=vi(i);function i(){var e;return P(this,i),(e=n.call(this,i.WORKER_NAME,i.buildWorkerURL(),Nn.WorkerType.CLASSIC)).actions={},e}return w(i,[{key:"importBrushes",value:(r=fe(pe.mark((function e(t){var r;return pe.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=this.nextID,this.actions[r]={expected:this.workers.length},e.next=4,this.broadcastMessage({action:"IMPORT_BRUSHES",actionID:r,brushes:t.map((function(e){return e.toJSON()}))});case 4:return e.abrupt("return",e.sent);case 5:case"end":return e.stop()}}),e,this)}))),function(e){return r.apply(this,arguments)})},{key:"build",value:(t=fe(pe.mark((function e(t){var r;return pe.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(0!=t.length){e.next=2;break}return e.abrupt("return");case 2:return r=this.nextID,this.actions[r]={strokes:t,queue:t.slice(),expected:t.length},this.updateProgress(0,t.length),e.next=7,this.broadcast("BUILD",r);case 7:return e.abrupt("return",e.sent);case 8:case"end":return e.stop()}}),e,this)}))),function(e){return t.apply(this,arguments)})},{key:"buildRequestMessage",value:function(e,t){var r={action:e,actionID:t},n=this.actions[t];if("BUILD"!=e)throw new Error("Unknow data action found: ".concat(e));var i=n.queue.shift();if(i)return i.spline.points.buffer instanceof ArrayBuffer&&this.transferables.push(i.spline.points.buffer),i.spline.encoding=Ye.Encoding.NONE,r.index=n.strokes.indexOf(i),r.brushName=i.brush.name,r.spline=i.spline.toJSON(),r}},{key:"recieve",value:function(e){var t=this.actions[e.actionID];switch(t.expected--,e.action){case"IMPORT_BRUSHES":break;case"BUILD":if(this.update(e.actionID,e.index,e.path,e.splineBuffer),t.expected>0){var r=this.buildRequestMessage(e.action,e.actionID);r&&this.send(e.worker,r)}break;default:throw new Error("Unknow data action found: ".concat(e.action))}0==t.expected&&(delete this.actions[e.actionID],this.resolve(e.actionID))}},{key:"update",value:function(e,t,r,n){var i=this.actions[e],o=i.strokes[t];n instanceof ArrayBuffer&&(o.spline.buffer=n),o.path=ci.decodeInkPath(r);var a=100*(i.strokes.length-i.expected)/i.strokes.length;this.updateProgress(a,i.expected,o)}},{key:"updateProgress",value:function(e,t,r){}}],[{key:"buildWorkerURL",value:function(){if(("undefined"==typeof document&&"undefined"==typeof location?new(require("url").URL)("file:"+__filename).href:"undefined"==typeof document?location.href:document.currentScript&&document.currentScript.src||new URL("digital-ink-min.js",document.baseURI).href).contains("/wacom-src/"))return"/node_modules/digital-ink/workers/".concat(i.WORKER_NAME,".js");if("function"!=typeof DedicatedWorkerGlobalScope){var e=void 0===l?"undefined"==typeof document&&"undefined"==typeof location?new(require("url").URL)("file:"+__filename).href:"undefined"==typeof document?location.href:document.currentScript&&document.currentScript.src||new URL("digital-ink-min.js",document.baseURI).href:l;return(e=e.substring(0,e.lastIndexOf("/"))).endsWith("workers")||(e+="/workers"),e+="/".concat(i.WORKER_NAME),"undefined"==typeof navigator?e+=".mjs":e+=".js",e}}}]),i}(Nn);if(S(mi,"WORKER_NAME","InkPathProvider"),ve.type2D==ve.Type2D.OFFSCREEN)if(ve.commonJS){var gi=require("canvas"),bi=gi.Canvas,Ei=gi.ImageData,Pi=gi.Image;global.OffscreenCanvas=bi,global.ImageData=Ei,global.Image=Pi}else console.warn("Current env - ".concat(ve.type.name,", do not provides OffscreenCanvas support"));function ki(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var r,n=O(e);if(t){var i=O(this).constructor;r=Reflect.construct(n,arguments,i)}else r=n.apply(this,arguments);return A(this,r)}}var wi=function(e){R(r,e);var t=ki(r);function r(e){var n;return P(this,r),n=t.call(this),Object.defineProperty(T(n),"surface",{value:e.canvas,enumerable:!0}),Object.defineProperty(T(n),"ctx",{value:e,enumerable:!0}),Object.defineProperty(T(n),"renderingContext",{value:new Ir(e),enumerable:!0}),Object.defineProperty(T(n),"bounds",{get:function(){return new V(0,0,n.width,n.height)},enumerable:!0}),n.ctx.getContextAttributes||(n.ctx.getContextAttributes=function(){return{}}),n}return w(r,[{key:"width",get:function(){return this.surface.width}},{key:"height",get:function(){return this.surface.height}},{key:"clear",value:function(e,t){if(t){if(We.isColor(e))throw new Error("`clear` first argument should be Rectangle")}else We.isColor(e)&&(t=e,e=null);e||(e=this.bounds),this.ctx.clearRect(e.left,e.top,e.width,e.height),t&&(this.ctx.fillStyle=t.toString(),this.ctx.fillRect(e.left,e.top,e.width,e.height))}},{key:"draw",value:function(e){return this.drawStroke(e.brush,e.path,e.color,e.matrix)}},{key:"drawStroke",value:function(e,t,r,n){if(!ci.validatePath(t))return null;if(!(e instanceof xt))throw new Error("Incompatible brush found. It should be Brush2D instance.");n?this.matrix&&(n=this.matrix.multiply(n)):n=this.matrix;var i=t.bounds;if(i&&(n&&(i=i.transform(n)),i=i.ceil()),i=this.bounds.intersect(i)){if(this.ctx.save(),n?this.ctx.setTransform(n.a,n.b,n.c,n.d,n.tx,n.ty):(this.ctx.rect(i.left,i.top,i.width,i.height),this.ctx.clip()),t instanceof cr)this.renderingContext.fillShape(t,r),e.pattern&&this.renderingContext.fillShape(t,e.pattern);else{if(!(t instanceof Or))throw new Error("drawStroke 'path' type missmatch, expected oneof(InkPath2D, InterpolatedSpline)");this.drawSpline(t,r)}this.ctx.restore()}return i}},{key:"drawSpline",value:function(e,t){t||(t=e.color),this.ctx.fillStyle="rgb(".concat(t.red,", ").concat(t.green,", ").concat(t.blue,")");for(var r=0;r<e.length;r++){var n=e.getPoint(r),i=n.size/2;this.ctx.beginPath(),this.ctx.arc(n.x,n.y,i,0,2*Math.PI),this.ctx.closePath(),this.ctx.fill()}}},{key:"fill",value:function(e,t){var r;if(V.isRect(e))r=e;else{if("number"==typeof e[0]&&e.length%2==0&&(e=ht.createInstance(e)),e instanceof ht)e=new or(e);else if(!(e instanceof or))throw new Error("fill shape type missmatch, expected oneof(PolygonArray, Polygon, Rect)");r=e.bounds}return(r=this.bounds.intersect(r))&&(r=r.ceil(),this.ctx.fillStyle=t.toString(),V.isRect(e)?this.ctx.fillRect(e.left,e.top,e.width,e.height):(this.ctx.save(),this.ctx.rect(r.left,r.top,r.width,r.height),this.ctx.clip(),this.renderingContext.fillShape(e),this.ctx.restore())),r}},{key:"blend",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};if(t.mode||(t.mode=Tt.SOURCE_OVER),t.transform&&t.destinationRect)throw new Error("`destinationRect` is not applicable with `transform`");if(t.sourceRect&&!t.destinationRect)throw new Error("With `sourceRect`, `destinationRect` is required");if(t.destinationRect&&!t.sourceRect)throw new Error("With `destinationRect`, `sourceRect`is required");t.rect&&(t.sourceRect=t.rect,t.destinationRect=t.rect),this.ctx.save(),t.transform?this.ctx.setTransform(t.transform.a,t.transform.b,t.transform.c,t.transform.d,t.transform.tx,t.transform.ty):t.clipRect&&(this.ctx.rect(t.clipRect.left,t.clipRect.top,t.clipRect.width,t.clipRect.height),this.ctx.clip()),this.ctx.globalCompositeOperation=t.mode,t.sourceRect&&t.destinationRect?this.ctx.drawImage(e.ctx.canvas,t.sourceRect.left,t.sourceRect.top,t.sourceRect.width,t.sourceRect.height,t.destinationRect.left,t.destinationRect.top,t.destinationRect.width,t.destinationRect.height):this.ctx.drawImage(e.ctx.canvas,0,0),this.ctx.restore()}},{key:"createImageData",value:function(e,t,r){return new ImageData(e,t,r)}},{key:"getImageData",value:function(e){e||(e=this.bounds);var t=this.ctx.getImageData(e.x,e.y,e.width,e.height);return t.x=e.x,t.y=e.y,t}},{key:"putImageData",value:function(e,t,r){if(!(e instanceof ImageData))throw new Error("putImageData 'imageData' parameter is not instance of ImageData");(isNaN(t)||isNaN(r))&&(t=e.x||0,r=e.y||0),this.ctx.putImageData(e,t,r)}},{key:"readPixels",value:function(e){return this.getImageData(e).data}},{key:"writePixels",value:function(e,t){if(!(e instanceof Uint8Array||e instanceof Uint8ClampedArray))throw new Error("writePixels 'data' parameter is not instance of Uint8Array or Uint8ClampedArray");t||(t=this.bounds),e instanceof Uint8Array&&(e=new Uint8ClampedArray(e.buffer)),this.putImageData(this.createImageData(e,t.width,t.height),t.x,t.y)}},{key:"getExportCanvas",value:function(e){var t=this.surface;return e&&(e=e.intersect(this.bounds).ceil(),(t=new OffscreenCanvas(e.width,e.height)).getContext("2d").putImageData(this.getImageData(e),0,0)),t}},{key:"resize",value:function(e,t){this.surface.width=e,this.surface.height=t}}]),r}(Ot);function xi(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var r,n=O(e);if(t){var i=O(this).constructor;r=Reflect.construct(n,arguments,i)}else r=n.apply(this,arguments);return A(this,r)}}var Si=function(e){R(r,e);var t=xi(r);function r(e){return P(this,r),t.call(this,e)}return w(r,[{key:"createLayer",value:function(e,t){var n;n=e&&t?{width:e,height:t}:e&&e.width&&e.height?e:r.getDefaultSize(this.width,this.height);var i=new OffscreenCanvas(n.width,n.height);return new wi(i.getContext("2d",this.ctx.getContextAttributes()))}}],[{key:"createInstance",value:function(e,t,n,i){if(!e||"function"!=typeof e.getContext)throw new Error("CanvasRenderingContext2D context provider is required");if(t>0&&n>0&&(e.width=t,e.height=n),!(e.width>0&&e.height>0))throw new Error("width and height are required and should be positive whole numbers");return new r(e.getContext("2d",i))}}]),r}(wi),Ii=function(){function e(t,r){var n=this;P(this,e),this.canvas=t,this.layer=t.createLayer(r),this.preliminaryLayer=void 0,this.restart=!0,this.runtime=!1,this.brush=void 0,this.color=void 0,this.backgroundColor=We.TRANSPERENT,this.blendMode=Tt.SOURCE_OVER,this.matrix=void 0,this.strokeBounds=void 0,this.updatedArea=void 0,Object.defineProperty(this,"settings",{get:function(){return{brush:n.brush,color:n.color,backgroundColor:n.backgroundColor,blendMode:n.blendMode,matrix:n.matrix,randomSeed:n.initialRandomSeed}},enumerable:!0})}return w(e,[{key:"configure",value:function(e){e.brush&&(this.brush=e.brush),e.color&&(this.color=e.color),e.backgroundColor&&(this.backgroundColor=e.backgroundColor),e.blendMode&&(this.blendMode=e.blendMode),"transform"in e&&this.setTransform(e.transform),this.restart=!0}},{key:"setTransform",value:function(e){this.matrix=e,this.layer.setTransform(e),this.preliminaryLayer&&this.preliminaryLayer.setTransform(e)}},{key:"draw",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];e instanceof ci?(this.reset(!1),this.drawStroke(e),this.restart=!0):(this.restart&&this.reset(!0),this.drawSegment(e,t),t&&(this.restart=!0))}},{key:"drawStroke",value:function(e){throw new Error("StrokeRenderer.drawStroke(stroke) should be implemented")}},{key:"drawSegment",value:function(e){throw new Error("StrokeRenderer.drawSegment(path, endStroke) should be implemented")}},{key:"drawPreliminary",value:function(e){throw new Error("StrokeRenderer.drawPreliminary(path) should be implemented")}},{key:"abort",value:function(){this.restart=!0}},{key:"reset",value:function(){var e=arguments.length>0&&void 0!==arguments[0]&&arguments[0];this.runtime=e,this.incompleteStrokeBounds=null,this.strokeBounds=null,this.updatedArea=null,this.preliminaryDirtyArea=null,this.layer.clear(this.backgroundColor),this.preliminaryLayer&&this.preliminaryLayer.clear(this.backgroundColor),this.restart=!1}},{key:"validate",value:function(e){if(!this.brush)throw new Error("StrokeRenderer requires 'brush' to be configured");return e&&e.length>0}},{key:"blendUpdatedArea",value:function(e){throw new Error("StrokeRenderer.blendUpdatedArea(layer) should be implemented")}},{key:"blendStroke",value:function(e,t,r){throw new Error("StrokeRenderer.blendStroke(layer, dirtyArea, blendMode) should be implemented")}},{key:"toStroke",value:function(e){throw new Error("StrokeRenderer.toStroke(builder) should be implemented")}}]),e}();function Ri(e,t){var r="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!r){if(Array.isArray(e)||(r=function(e,t){if(!e)return;if("string"==typeof e)return Ti(e,t);var r=Object.prototype.toString.call(e).slice(8,-1);"Object"===r&&e.constructor&&(r=e.constructor.name);if("Map"===r||"Set"===r)return Array.from(e);if("Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r))return Ti(e,t)}(e))||t&&e&&"number"==typeof e.length){r&&(e=r);var n=0,i=function(){};return{s:i,n:function(){return n>=e.length?{done:!0}:{done:!1,value:e[n++]}},e:function(e){throw e},f:i}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var o,a=!0,s=!1;return{s:function(){r=r.call(e)},n:function(){var e=r.next();return a=e.done,e},e:function(e){s=!0,o=e},f:function(){try{a||null==r.return||r.return()}finally{if(s)throw o}}}}function Ti(e,t){(null==t||t>e.length)&&(t=e.length);for(var r=0,n=new Array(t);r<t;r++)n[r]=e[r];return n}function Ai(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var r,n=O(e);if(t){var i=O(this).constructor;r=Reflect.construct(n,arguments,i)}else r=n.apply(this,arguments);return A(this,r)}}var Oi=function(e){R(r,e);var t=Ai(r);function r(e,n){var i;return P(this,r),(i=t.call(this,e,n)).alphaLayer=void 0,i}return w(r,[{key:"drawStroke",value:function(e){var t=e.blendMode;if(!(e.brush instanceof xt))throw new Error("Incompatible brush found. It should be Brush2D instance.");if(t){this.blendMode=e.style.blendMode||t;var r=this.layer.draw(e);this.strokeBounds=r,this.updatedArea=r}else console.warn("Cannot process ".concat(e.renderMode," render mode. Requres custom processing."))}},{key:"drawSegment",value:function(e){if(!this.color)throw new Error("StrokeRenderer requires 'color' to be configured");if(this.validate(e)){var t=this.layer.drawStroke(this.brush,e,this.color.toRGB(),e.matrix);t&&(this.incompleteStrokeBounds=t.union(this.incompleteStrokeBounds),this.strokeBounds=t.union(this.strokeBounds),this.updatedArea=this.incompleteStrokeBounds.union(this.preliminaryDirtyArea))}else this.updatedArea=this.preliminaryDirtyArea;this.blendWithPreliminaryLayer=!1,this.preliminaryDirtyArea=null}},{key:"drawPreliminary",value:function(e){this.validate(e)&&(this.preliminaryLayer||(this.preliminaryLayer=this.canvas.createLayer(),this.preliminaryLayer.setTransform(this.matrix)),this.updatedArea&&this.preliminaryLayer&&(this.preliminaryLayer.clear(this.updatedArea),this.preliminaryLayer.blend(this.layer,{mode:Tt.SOURCE_OVER,rect:this.updatedArea})),this.preliminaryDirtyArea=this.preliminaryLayer.drawStroke(this.brush,e,this.color.toRGB(),e.matrix),this.updatedArea=V.union(this.preliminaryDirtyArea,this.updatedArea),this.preliminaryLayer&&(this.blendWithPreliminaryLayer=!0))}},{key:"reset",value:function(e){nr(O(r.prototype),"reset",this).call(this,e),this.runtime&&this.color.alpha<1&&(this.alphaLayer?this.alphaLayer.resize(this.layer.width,this.layer.height):this.alphaLayer=this.canvas.createLayer(this.layer.width,this.layer.height))}},{key:"blendUpdatedArea",value:function(e){if(this.updatedArea){var t=e||this.canvas,r=this.blendWithPreliminaryLayer?this.preliminaryLayer:this.layer,n=t.bounds.intersect(this.updatedArea);n&&(this.color.alpha<1?(this.alphaLayer.clear(),this.alphaLayer.ctx.globalAlpha=1,this.alphaLayer.blend(t,{rect:n}),this.alphaLayer.ctx.globalAlpha=this.color.alpha,this.alphaLayer.blend(r,{mode:this.blendMode,rect:n}),t.clear(n),t.blend(this.alphaLayer,{rect:n})):t.blend(r,{mode:this.blendMode,rect:n})),this.incompleteStrokeBounds=null,this.updatedArea=null}}},{key:"blendStroke",value:function(e,t,r){if(this.strokeBounds){r||(r=this.blendMode);var n=this.layer,i=e||this.canvas;(t=i.bounds.intersect(t||this.strokeBounds))&&(this.runtime&&this.color.alpha<1?(this.alphaLayer.clear(),this.alphaLayer.ctx.globalAlpha=this.color.alpha,this.alphaLayer.blend(n,{rect:t}),i.blend(this.alphaLayer,{mode:r,rect:t})):i.blend(n,{mode:r,rect:t}))}}},{key:"blendStrokes",value:function(e,t){var r=this,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},i=arguments.length>3?arguments[3]:void 0;if(0!=e.length){var o,a,s,u=e.first.renderMode,c=[],l=function(){var e=ci.RenderMode.getBlendMode(u);r.strokeBounds=a,a=null,r.blendStroke(t,n.rect,e),o=r.strokeBounds.union(o),r.reset()},h=function(){if(!i)throw new Error("strokeRendererGL should be provided for WebGL strokes rasterization");i.reset(),s=i.blendStrokes(c,t,n),o=s.union(o),c.clear()};i&&(i.layer.resize(this.layer.width,this.layer.height),i.setTransform(this.matrix)),this.reset();var f,d=Ri(e);try{for(d.s();!(f=d.n()).done;){var p=f.value;p.brush instanceof xt?(c.length>0&&(h(),u=p.renderMode),u!=p.renderMode&&(l(),u=p.renderMode),a=p.bounds.union(a),this.drawStroke(p)):(a&&l(),c.push(p))}}catch(e){d.e(e)}finally{d.f()}return c.length>0?h():l(),this.restart=!0,o}}},{key:"toStroke",value:function(e,t){if(!this.brush)throw new Error("StrokeRenderer brush is not configured");t&&console.warn("StrokeRenderer2D.toStroke 'simplify' param is deprecated. Do not affects InkPath. InkBuilderSettings 'concatSegments' should be configured to affect ink path properly.");var r=e.getSensorData(),n=e.getSpline(),i=e.getInkPath(),o=new ci(this.brush,n,i,r);return r&&(o.sensorDataMapping=r.inkStream.getPipelineMapping()),this.blendMode!=Tt.SOURCE_OVER&&(o.renderMode=ci.RenderMode.get(this.blendMode)),o}},{key:"delete",value:function(){console.warn("Not applicable with 2D API")}}]),r}(Ii),Ci=void 0;ve.typeGL==ve.TypeGL.STACK&&(ve.commonJS?Ci=require("gl"):console.warn("Current env - ".concat(ve.type.name,", do not provides WebGL support")));var Di=Ci,Ni=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:300,r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:150;P(this,e),this.width=t,this.height=r}return w(e,[{key:"getContext",value:function(){var e=arguments.length>1?arguments[1]:void 0;if(!this.context){var t=this.width,r=this.height;this.context=Di(t,r,e),this.context.canvas=this;var n=this.context.getExtension("STACKGL_resize_drawingbuffer");Object.defineProperty(this,"width",{get:function(){return t},set:function(e){t=e,n.resize(t,r)},enumerable:!0}),Object.defineProperty(this,"height",{get:function(){return r},set:function(e){r=e,n.resize(t,r)},enumerable:!0})}return this.context}},{key:"destroy",value:function(){this.context&&(this.context.getExtension("STACKGL_destroy_context").destroy(),delete this.context)}}]),e}(),Mi=Di?Ni:void 0,Li=function(){function e(t){P(this,e),this.randomSeed=t||parseInt(Date.now()/1e3)}return w(e,[{key:"copyTo",value:function(e){e.randomSeed=this.randomSeed}}]),e}();function Bi(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var r,n=O(e);if(t){var i=O(this).constructor;r=Reflect.construct(n,arguments,i)}else r=n.apply(this,arguments);return A(this,r)}}var _i=function(e){R(r,e);var t=Bi(r);function r(e,n){var i;return P(this,r),i=t.call(this,e.inkGLContext,n),Object.defineProperty(T(i),"inkContext",{value:e,enumerable:!0}),Object.defineProperty(T(i),"bounds",{get:function(){return V.fromGLRect(i.graphicsBounds)},enumerable:!0}),i}return w(r,[{key:"clear",value:function(e,t){if(t){if(We.isColor(e))throw new Error("`clear` first argument should be Rect")}else We.isColor(e)?(t=e,e=null):t=We.TRANSPERENT;var r;if(V.isRect(e)){if(!e.intersect(this.bounds))return;r=V.fromRect(e).toGLRect()}Array.isArray(e)||e instanceof Float32Array?this.fill(e,t,!1):(this.inkContext.setTarget(this,r),this.inkContext.clearColor(t)),r&&this.inkContext.disableTargetClipRect()}},{key:"draw",value:function(e){var t,r=e.brush;return r instanceof qt?isFinite(e.randomSeed)&&(t=new Li(e.randomSeed)):t=e.color,this.drawStroke(r,e.path,t)}},{key:"drawStroke",value:function(e,t,r){if(!ci.validatePath(t))return null;this.inkContext.setTarget(this);var n=this.inkContext.drawStroke(e,t,r);return V.fromGLRect(n)}},{key:"fill",value:function(e,t){var r=!(arguments.length>2&&void 0!==arguments[2])||arguments[2];if(V.isRect(e))e=ht.fromRect(e),e=new or(e);else if("number"==typeof e[0]&&e.length%2==0&&(e=ht.createInstance(e)),e instanceof ht)e=new or(e);else if(!(e instanceof or))throw new Error("fill shape type missmatch, expected oneof(PolygonArray, Polygon, Rect)");this.inkContext.setTarget(this);var n=this.inkContext.fill(e,t,r);return V.fromGLRect(n)}},{key:"blend",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};if(t.mode||(t.mode=Tt.SOURCE_OVER),t.rect&&!t.transform&&(t.sourceRect=t.rect,t.destinationRect=t.rect),t.transform&&t.destinationRect)throw new Error("`destinationRect` is not applicable with `transform`");if(t.sourceRect&&!t.destinationRect)throw new Error("With `sourceRect`, `destinationRect` is required");if(t.destinationRect&&!t.sourceRect)throw new Error("With `destinationRect`, `sourceRect`is required");if(this.inkContext.setTarget(this,V.isRect(t.clipRect)?V.fromRect(t.clipRect).toGLRect():void 0),"boolean"==typeof t.flipY&&(e.flipY=t.flipY),t.transform&&t.rect){var r=V.fromRect(t.rect).toGLRect().toQuad(),n=V.fromRect(t.rect).toGLRect().toQuad(t.transform);this.inkContext.drawLayer(e,r,n,t.mode)}else t.transform?this.inkContext.drawLayerWithTransform(e,t.transform,t.mode):t.sourceRect&&t.destinationRect?this.inkContext.drawLayer(e,V.fromRect(t.sourceRect).toGLRect().toQuad(),V.fromRect(t.destinationRect).toGLRect().toQuad(),t.mode):this.inkContext.drawLayerWithTransform(e,null,t.mode)}},{key:"createImageData",value:function(e,t,r){return e instanceof Uint8Array&&(e=new Uint8ClampedArray(e.buffer)),new ImageData(e,t,r)}},{key:"getImageData",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];e||(e=this.bounds);var r=this.createImageData(this.readPixels(e,t),e.width,e.height);return r.x=e.x,r.y=e.y,r}},{key:"putImageData",value:function(e,t,r){if(!(e instanceof ImageData))throw new Error("putImageData 'imageData' parameter is not instance of ImageData");(isNaN(t)||isNaN(r))&&(t=e.x||0,r=e.y||0),this.writePixels(e.data,new V(t,r,e.width,e.height))}},{key:"readPixels",value:function(e,t){e&&(e=V.fromRect(e).toGLRect()),this.inkContext.setTarget(this);var r=this.inkContext.readPixels(e);if(t)for(var n=0;n<r.length;n+=4){var i=r[n+3];r[n]=parseInt(255*r[n]/i),r[n+1]=parseInt(255*r[n+1]/i),r[n+2]=parseInt(255*r[n+2]/i)}return r}},{key:"writePixels",value:function(e,t){if(!(e instanceof Uint8Array||e instanceof Uint8ClampedArray))throw new Error("writePixels 'data' parameter is not instance of Uint8Array or Uint8ClampedArray");t&&(t=V.fromRect(t).toGLRect()),this.inkContext.setTarget(this),this.inkContext.writePixels(t,e)}},{key:"getExportCanvas",value:function(e){e=e?e.intersect(this.bounds).ceil():this.bounds;var t=new OffscreenCanvas(e.width,e.height);return t.getContext("2d").putImageData(this.getImageData(e,!0),0,0),t}}]),r}(Lt);function Fi(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var r,n=O(e);if(t){var i=O(this).constructor;r=Reflect.construct(n,arguments,i)}else r=n.apply(this,arguments);return A(this,r)}}var Ui=function(e){R(n,e);var t,r=Fi(n);function n(e){var t,i;P(this,n),i=r.call(this,e,{display:!0,width:e.inkGLContext.gl.canvas.width,height:e.inkGLContext.gl.canvas.height,flipY:ve.typeGL==ve.TypeGL.WEB}),Object.defineProperty(T(i),"surface",{value:e.inkGLContext.gl.canvas,enumerable:!0}),Object.defineProperty(T(i),"ctx",{value:e.inkGLContext.gl,enumerable:!0}),Object.defineProperty(T(i),"MAX_SIZE",{value:i.ctx.getParameter(i.ctx.MAX_TEXTURE_SIZE),enumerable:!0});var o=i.ctx.getContextAttributes();if("function"==typeof requestAnimationFrame&&!o.preserveDrawingBuffer){var a=i.createLayer();Object.defineProperty(T(i),"backbuffer",{value:a,enumerable:!0});i.frameID=requestAnimationFrame((function e(r){i.present&&(delete i.present,nr((t=T(i),O(n.prototype)),"blend",t).call(t,a,{mode:Tt.COPY})),i.frameID=requestAnimationFrame(e)}))}return i}return w(n,[{key:"createLayer",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},t=e.width,r=e.height;if(t&&r){if(t>this.MAX_SIZE)throw new Error("Max width exceeded: ".concat(t," found, ").concat(this.MAX_SIZE," allowed"));if(r>this.MAX_SIZE)throw new Error("Max height exceeded: ".concat(r," found, ").concat(this.MAX_SIZE," allowed"))}else{var i=n.getDefaultSize(this.width,this.height);e.width=i.width,e.height=i.height}return new _i(this.inkContext,e)}},{key:"clear",value:function(e,t){this.backbuffer?(this.backbuffer.clear(e,t),this.present=!0):nr(O(n.prototype),"clear",this).call(this,e,t)}},{key:"draw",value:function(e,t){var r;return this.backbuffer?(r=this.backbuffer.draw(e,t),this.present=!0):r=nr(O(n.prototype),"draw",this).call(this,e,t),r}},{key:"drawStroke",value:function(e,t,r){var i;return this.backbuffer?(i=this.backbuffer.drawStroke(e,t,r),this.present=!0):i=nr(O(n.prototype),"drawStroke",this).call(this,e,t,r),i}},{key:"fill",value:function(e,t,r){var i;return this.backbuffer?(i=this.backbuffer.fill(e,t,r),this.present=!0):i=nr(O(n.prototype),"fill",this).call(this,e,t,r),i}},{key:"blend",value:function(e,t){this.backbuffer?(this.backbuffer.blend(e,t),this.present=!0):nr(O(n.prototype),"blend",this).call(this,e,t)}},{key:"readPixels",value:function(e,t){return this.backbuffer?this.backbuffer.readPixels(e,t):nr(O(n.prototype),"readPixels",this).call(this,e,t)}},{key:"writePixels",value:function(e,t){this.backbuffer?(this.backbuffer.writePixels(e,t),this.present=!0):nr(O(n.prototype),"writePixels",this).call(this,e,t)}},{key:"toBlob",value:(t=fe(pe.mark((function e(){var t,r,i,o=arguments;return pe.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t=o.length>0&&void 0!==o[0]?o[0]:this.bounds,r=o.length>1?o[1]:void 0,i=o.length>2?o[2]:void 0,!this.backbuffer){e.next=9;break}return e.next=6,this.backbuffer.toBlob(t,r,i);case 6:return e.abrupt("return",e.sent);case 9:return e.next=11,nr(O(n.prototype),"toBlob",this).call(this,t,r,i);case 11:return e.abrupt("return",e.sent);case 12:case"end":return e.stop()}}),e,this)}))),function(){return t.apply(this,arguments)})},{key:"resize",value:function(e,t){nr(O(n.prototype),"resize",this).call(this,e,t),this.surface.width=e,this.surface.height=t}},{key:"delete",value:function(){"number"==typeof this.frameID&&cancelAnimationFrame(this.frameID),nr(O(n.prototype),"delete",this).call(this),this.backbuffer&&this.backbuffer.delete()}},{key:"deleteLater",value:function(){return nr(O(n.prototype),"deleteLater",this).call(this),this.backbuffer&&this.backbuffer.deleteLater(),this}}],[{key:"createInstance",value:function(e,t,r,i){if(!e||"function"!=typeof e.getContext)throw new Error("WebGL context provider is required");if(t>0&&r>0&&(e.width=t,e.height=r),!(e.width>0&&e.height>0))throw new Error("width and height are required and should be positive whole numbers");return new n(new Jt(e,i))}}]),n}(_i);function ji(e,t){var r="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!r){if(Array.isArray(e)||(r=function(e,t){if(!e)return;if("string"==typeof e)return Gi(e,t);var r=Object.prototype.toString.call(e).slice(8,-1);"Object"===r&&e.constructor&&(r=e.constructor.name);if("Map"===r||"Set"===r)return Array.from(e);if("Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r))return Gi(e,t)}(e))||t&&e&&"number"==typeof e.length){r&&(e=r);var n=0,i=function(){};return{s:i,n:function(){return n>=e.length?{done:!0}:{done:!1,value:e[n++]}},e:function(e){throw e},f:i}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var o,a=!0,s=!1;return{s:function(){r=r.call(e)},n:function(){var e=r.next();return a=e.done,e},e:function(e){s=!0,o=e},f:function(){try{a||null==r.return||r.return()}finally{if(s)throw o}}}}function Gi(e,t){(null==t||t>e.length)&&(t=e.length);for(var r=0,n=new Array(t);r<t;r++)n[r]=e[r];return n}function Yi(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var r,n=O(e);if(t){var i=O(this).constructor;r=Reflect.construct(n,arguments,i)}else r=n.apply(this,arguments);return A(this,r)}}var Xi=function(e){R(r,e);var t=Yi(r);function r(e,n){var i;return P(this,r),(i=t.call(this,e,n)).layerOptions=n,i.bitmapLayer=void 0,i.randomSeed=void 0,i.initialRandomSeed=void 0,i}return w(r,[{key:"configure",value:function(e){nr(O(r.prototype),"configure",this).call(this,e),this.brush instanceof qt&&isFinite(e.randomSeed)&&(this.initialRandomSeed=e.randomSeed)}},{key:"draw",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];if(this.layer.isDeleted())throw new Error("StrokeRenderer cannot draw, it is already deleted");nr(O(r.prototype),"draw",this).call(this,e,t)}},{key:"drawStroke",value:function(e){var t=e.blendMode;if(t){this.blendMode=e.style.blendMode||t;var r=this.layer.draw(e);this.strokeBounds=r,this.updatedArea=r}else console.warn("Cannot process ".concat(e.renderMode," render mode. Requres custom processing."))}},{key:"drawSegment",value:function(e){if(this.validate(e)){e.color&&this.color&&!e.color.equals(this.color)&&(e.color=this.color);var t=this.brush instanceof qt?this.strokeLastRendererdDrawContext:this.color,r=this.layer.drawStroke(this.brush,e,t);r&&(this.incompleteStrokeBounds=r.union(this.incompleteStrokeBounds),this.strokeBounds=r.union(this.strokeBounds),this.updatedArea=this.incompleteStrokeBounds.union(this.preliminaryDirtyArea))}else this.updatedArea=this.preliminaryDirtyArea;this.blendWithPreliminaryLayer=!1,this.preliminaryDirtyArea=null}},{key:"drawPreliminary",value:function(e){if(this.validate(e)){var t=null;this.brush instanceof qt?(this.strokeLastRendererdDrawContext.copyTo(this.strokePrelimLastRenderedDrawContext),t=this.strokePrelimLastRenderedDrawContext):t=this.color,this.preliminaryLayer||(this.preliminaryLayer=this.canvas.createLayer(this.layerOptions),this.preliminaryLayer.setTransform(this.matrix)),this.updatedArea&&this.preliminaryLayer&&this.preliminaryLayer.blend(this.layer,{mode:Tt.COPY,rect:this.updatedArea}),e.color&&this.color&&!e.color.equals(this.color)&&(e.color=this.color),this.preliminaryDirtyArea=this.preliminaryLayer.drawStroke(this.brush,e,t),this.updatedArea=V.union(this.preliminaryDirtyArea,this.updatedArea),this.preliminaryLayer&&(this.blendWithPreliminaryLayer=!0)}}},{key:"reset",value:function(){nr(O(r.prototype),"reset",this).call(this),this.bitmapLayer&&(this.bitmapLayer.clear(this.backgroundColor),this.bitmapLayer.resize(this.layer.width,this.layer.height)),this.brush instanceof qt?(this.strokeLastRendererdDrawContext=new Li(this.initialRandomSeed),this.strokePrelimLastRenderedDrawContext||(this.strokePrelimLastRenderedDrawContext=new Li),delete this.initialRandomSeed,this.randomSeed=this.strokeLastRendererdDrawContext.randomSeed):delete this.randomSeed}},{key:"blendUpdatedArea",value:function(e){if(this.updatedArea){var t=this.blendWithPreliminaryLayer?this.preliminaryLayer:this.layer,r=e||this.canvas,n=r.bounds.intersect(this.updatedArea);if(n){if(r instanceof wi)throw new Error("Runtime blendig requires OffscreenLayerGL target");r.blend(t,{mode:this.blendMode,rect:n})}this.incompleteStrokeBounds=null,this.updatedArea=null}}},{key:"blendStroke",value:function(e,t,r){if(this.strokeBounds){r||(r=this.blendMode);var n=this.layer,i=e||this.canvas;(t=i.bounds.intersect(t||this.strokeBounds))&&(i instanceof wi?this.blendStroke2D(i,{mode:r,rect:t}):i.blend(n,{mode:r,rect:t}))}}},{key:"blendStroke2D",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},r=t.rect||t.sourceRect||this.layer.bounds,n=this.layer.getImageData(r,!0);if(!this.bitmapLayer){var i=new OffscreenCanvas(this.layer.width,this.layer.height);this.bitmapLayer=new wi(i.getContext("2d"))}this.bitmapLayer.putImageData(n,r.x,r.y),e.blend(this.bitmapLayer,t)}},{key:"blendStrokes",value:function(e,t){var r=this,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};if(0!=e.length){var i,o,a=e.first.renderMode,s=function(){var e=ci.RenderMode.getBlendMode(a);r.strokeBounds=o,o=null,r.blendStroke(t,n.rect,e),i=r.strokeBounds.union(i),r.reset()};this.reset();var u,c=ji(e);try{for(c.s();!(u=c.n()).done;){var l=u.value;(a!=l.renderMode||l.brush instanceof xt&&l!=e.first)&&(s(l),a=l.renderMode),o=l.bounds.union(o),this.drawStroke(l)}}catch(e){c.e(e)}finally{c.f()}return s(),this.restart=!0,i}}},{key:"toStroke",value:function(e){var t=e.getSensorData(),r=e.getSpline(),n=e.getInkPath(),i=new ci(this.brush,r,n,t);return t&&(i.sensorDataMapping=t.inkStream.getPipelineMapping()),i.randomSeed=this.randomSeed,this.blendMode!=Tt.SOURCE_OVER&&(i.renderMode=ci.RenderMode.get(this.blendMode)),i}},{key:"delete",value:function(){this.layer.delete(),this.preliminaryLayer&&this.preliminaryLayer.delete()}}]),r}(Ii),zi=function(){function e(t,r,n){var i,o,a=this;P(this,e),this.listeners=[];var s=function(e,t){Object.defineProperty(a,e,{get:function(){return t},set:function(r){if(!r&&"object"!=e)throw new Error("SemanticTriple ".concat(e," is required"));t=r,o=i,i=void 0,a.listeners.slice().forEach((function(e){return e(o,a)}))},enumerable:!0})};s("subject",t),s("predicate",r),s("object",n),Object.defineProperty(this,"hashCode",{get:function(){return i||(i=M(a.toString())),i},enumerable:!0}),this.subject=t,this.predicate=r,this.object=n}return w(e,[{key:"equals",value:function(e){return this.subject==e.subject&&this.predicate==e.predicate&&this.object==e.object}},{key:"subsets",value:function(e){if(!e||!e.subject&&!e.predicate&&!e.object)throw new Error("Illegal partialStatement found: at least onoeof(subject, predicate, object) is required");var t=!0;return e.subject&&(t=this.subject==e.subject),t&&e.predicate&&(t=this.predicate==e.predicate),t&&e.object&&(t=this.object==e.object),t}},{key:"addListener",value:function(e){this.listeners.push(e)}},{key:"removeListener",value:function(e){this.listeners.remove(e)}},{key:"toString",value:function(){return"triple(".concat(this.subject,", ").concat(this.predicate,", ").concat(this.object,")")}},{key:"toJSON",value:function(){return{subject:this.subject,predicate:this.predicate,object:this.object}}}],[{key:"hashCode",value:function(t){return t instanceof e?t.hashCode:M(e.prototype.toString.call(t))}}]),e}();function Vi(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var r,n=O(e);if(t){var i=O(this).constructor;r=Reflect.construct(n,arguments,i)}else r=n.apply(this,arguments);return A(this,r)}}var Hi=function(e,t){R(n,e);var r=Vi(n);function n(){var e,t,i;P(this,n),i=r.call(this);var o={};return Object.defineProperty(T(i),"items",{value:o}),Object.defineProperty(T(i),"update",{value:function(e,r){delete o[e],i.items.hasOwnProperty(r.hashCode)?(r.removeListener(i.update),nr((t=T(i),O(n.prototype)),"remove",t).call(t,r)):o[r.hashCode]=r}}),(e=i).add.apply(e,arguments),i}return w(n,[{key:"add",value:function(){for(var e=arguments.length,t=new Array(e),r=0;r<e;r++)t[r]=arguments[r];for(var n=0,i=t;n<i.length;n++){var o=i[n];o instanceof zi?this.push(o):this.addTriple(o.subject,o.predicate,o.object)}}},{key:"addTriple",value:function(e,t,r){this.push(new zi(e,t,r))}},{key:"push",value:function(){if(arguments.length>1)this.add.apply(this,arguments);else{var e=arguments.length<=0?void 0:arguments[0];if(e instanceof zi){var t=e.hashCode;this.items.hasOwnProperty(t)||(this.items[t]=e,nr(O(n.prototype),"push",this).call(this,e),e.addListener(this.update))}else this.addTriple(e.subject,e.predicate,e.object)}}},{key:"remove",value:function(){for(var e,t=this,r=arguments.length,i=new Array(r),o=0;o<r;o++)i[o]=arguments[o];"function"==typeof i[0]&&(i=this.filter(i[0])),(i=i.map((function(e){return e instanceof zi?e:t.items[zi.hashCode(e)]}))).forEach((function(e){e&&(e.removeListener(t.update),delete t.items[e.hashCode])})),(e=nr(O(n.prototype),"remove",this)).call.apply(e,[this].concat(te(i)))}},{key:"clear",value:function(){var e=this;nr(O(n.prototype),"clear",this).call(this),Object.keys(this.items).forEach((function(t){e.items[t].removeListener(e.update),delete e.items[t]}))}},{key:"clone",value:function(){var e=new n;return this.forEach((function(t){return e.addTriple(t.subject,t.predicate,t.object)})),e}},{key:"search",value:function(e){return console.warn("TripleStore search method is deprecated. Use filter instead."),this.filter((function(t){var r=!0;return Object.keys(e).forEach((function(n){r=r&&t[n]==e[n]})),r}))}}],[{key:t,get:function(){return Array}}]),n}(N(Array),Symbol.species),Zi=b?b.default||globalThis.protobuf:{},qi=function e(){var t=this,r=arguments.length>0&&void 0!==arguments[0]?arguments[0]:e.Type.STROKE,n=arguments.length>1?arguments[1]:void 0;return function(){if(P(t,e),r==e.Type.SENSOR_DATA)throw new Error("Sensor data trees are not supported yet");n||(n=r==e.Type.STROKE?"main":"sdm"),Object.defineProperty(t,"type",{value:r}),Object.defineProperty(t,"name",{get:function(){return n},set:function(r){if(e.reservedViewNames.includes(n))throw new Error("Tree name ".concat(n," update is not allowed. Reserved names are immutable."));if(e.reservedViewNames.includes(r))throw new Error("Tree name ".concat(r," is not allowed. It is reserved."));var i=Me.createNodeURISchema(t),o=Me.createNodeURISchema(t,r);t.model.knowledgeGraph.forEach((function(e){e.subject.startsWith(i)&&(e.subject=e.subject.replace(i,o)),e.object.startsWith(i)&&(e.object=e.object.replace(i,o))})),t.model.views[r]=t.model.views[n],delete t.model.views[n],n=r},enumerable:!0}),Object.defineProperty(t,"uri",{get:function(){return Me.createTreeURI(n)}})}()};S(qi,"reservedViewNames",["main","sdm","hwr","ner"]),Object.defineEnum(qi,"Type",["STROKE","SENSOR_DATA"]);var Wi=function(){function e(){P(this,e)}return w(e,null,[{key:"encodePathPointProperties",value:function(t,r){var n=r.$type;for(var i in n.fields){var o=void 0;if("color"==i)o=e.rgba(t.red,t.green,t.blue,t.alpha);else{if(("size"==i||i.startsWith("scale"))&&1==t[i])continue;o=t[i]}isFinite(o)&&(r[i]=o)}return r}},{key:"decodePathPointProperties",value:function(t,r){if(t){if(!r)throw new Error("Color property requires layout");var n=t.$type,i={};for(var o in n.fields)if("color"==o){var a=e.fromRGBA(t.color);r.includes(le.Property.RED)||(i.red=a.red),r.includes(le.Property.GREEN)||(i.green=a.green),r.includes(le.Property.BLUE)||(i.blue=a.blue),r.includes(le.Property.ALPHA)||(i.alpha=a.alpha)}else if(t.hasOwnProperty(o)){if(o.startsWith("scale")&&1==t[o])continue;i[o]=t[o]}return i}}},{key:"rgba",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0;return(255&e)<<24|(255&t)<<16|(255&r)<<8|255&(n=Math.round(255*n))}},{key:"fromRGBA",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,t=e>>24&255,r=e>>16&255,n=e>>8&255,i=(255&e)/255;return{red:t,green:r,blue:n,alpha:i}}}]),e}(),Ki={evolution:["3.0.0","3.1.0"],"3.1.0":{schema:{nested:{UIM_3_1_0:{options:{optimize_for:"SPEED",java_multiple_files:!1,java_package:"com.wacom.ink.protobuf",java_outer_classname:"UIM_3_1_0",csharp_namespace:"Protobuf.WILL_3_1_0",swift_prefix:"WILL3_1_0"},nested:{BlendMode:{values:{SOURCE_OVER:0,DESTINATION_OVER:1,DESTINATION_OUT:2,LIGHTER:3,COPY:4,MIN:5,MAX:6}},Rectangle:{fields:{x:{type:"float",id:1},y:{type:"float",id:2},width:{type:"float",id:3},height:{type:"float",id:4}}},Matrix:{fields:{m00:{type:"float",id:1},m01:{type:"float",id:2},m02:{type:"float",id:3},m03:{type:"float",id:4},m10:{type:"float",id:5},m11:{type:"float",id:6},m12:{type:"float",id:7},m13:{type:"float",id:8},m20:{type:"float",id:9},m21:{type:"float",id:10},m22:{type:"float",id:11},m23:{type:"float",id:12},m30:{type:"float",id:13},m31:{type:"float",id:14},m32:{type:"float",id:15},m33:{type:"float",id:16}}},Interval:{fields:{fromIndex:{type:"uint32",id:1},toIndex:{type:"uint32",id:2},fromTValue:{type:"float",id:3},toTValue:{type:"float",id:4},id:{type:"bytes",id:100}}},PathPointProperties:{fields:{color:{type:"sint32",id:1},size:{type:"float",id:2},rotation:{type:"float",id:3},scaleX:{type:"float",id:4},scaleY:{type:"float",id:5},scaleZ:{type:"float",id:6},offsetX:{type:"float",id:7},offsetY:{type:"float",id:8},offsetZ:{type:"float",id:9}}},Property:{fields:{name:{type:"string",id:1},value:{type:"string",id:2}}},InkState:{values:{PLANE:0,HOVERING:1,IN_VOLUME:2,VOLUME_HOVERING:3}},InkSensorMetricType:{values:{LENGTH:0,TIME:1,FORCE:2,ANGLE:3,NORMALIZED:4,LOGICAL:5,DIMENSIONLESS:6}},InkInputProviderType:{values:{PEN:0,TOUCH:1,MOUSE:2,CONTROLLER:3}},InputContext:{fields:{id:{type:"bytes",id:1},environmentID:{type:"bytes",id:2},sensorContextID:{type:"bytes",id:3}}},Environment:{fields:{id:{type:"bytes",id:1},properties:{rule:"repeated",type:"Property",id:2}}},InkInputProvider:{fields:{id:{type:"bytes",id:1},type:{type:"InkInputProviderType",id:2},properties:{rule:"repeated",type:"Property",id:3}}},InputDevice:{fields:{id:{type:"bytes",id:1},properties:{rule:"repeated",type:"Property",id:2}}},SensorContext:{fields:{id:{type:"bytes",id:1},sensorChannelsContext:{rule:"repeated",type:"SensorChannelsContext",id:2}}},SensorChannelsContext:{fields:{id:{type:"bytes",id:1},channels:{rule:"repeated",type:"SensorChannel",id:2},samplingRateHint:{type:"uint32",id:3},latency:{type:"uint32",id:4},inkInputProviderID:{type:"bytes",id:5},inputDeviceID:{type:"bytes",id:6}}},SensorChannel:{fields:{id:{type:"bytes",id:1},type:{type:"string",id:2},metric:{type:"InkSensorMetricType",id:3},resolution:{type:"double",id:4},min:{type:"float",id:5},max:{type:"float",id:6},precision:{type:"uint32",id:7}}},InputContextData:{fields:{inputContexts:{rule:"repeated",type:"InputContext",id:1},inkInputProviders:{rule:"repeated",type:"InkInputProvider",id:2},inputDevices:{rule:"repeated",type:"InputDevice",id:3},environments:{rule:"repeated",type:"Environment",id:4},sensorContexts:{rule:"repeated",type:"SensorContext",id:5}}},ChannelData:{fields:{sensorChannelID:{type:"bytes",id:1},values:{rule:"repeated",type:"sint32",id:2}}},SensorData:{fields:{id:{type:"bytes",id:1},inputContextID:{type:"bytes",id:2},state:{type:"InkState",id:3},timestamp:{type:"uint64",id:4},dataChannels:{rule:"repeated",type:"ChannelData",id:5}}},InputData:{fields:{inputContextData:{type:"InputContextData",id:1},sensorData:{rule:"repeated",type:"SensorData",id:2}}},RotationMode:{values:{NONE:0,RANDOM:1,TRAJECTORY:2}},BrushPrototype:{fields:{coordX:{rule:"repeated",type:"float",id:1},coordY:{rule:"repeated",type:"float",id:2},coordZ:{rule:"repeated",type:"float",id:3},indices:{rule:"repeated",type:"uint32",id:4},shapeURI:{type:"string",id:5},size:{type:"float",id:6}}},VectorBrush:{fields:{name:{type:"string",id:1},prototype:{rule:"repeated",type:"BrushPrototype",id:2},spacing:{type:"float",id:3}}},RasterBrush:{fields:{name:{type:"string",id:1},spacing:{type:"float",id:2},scattering:{type:"float",id:3},rotationMode:{type:"RotationMode",id:4},shapeTexture:{rule:"repeated",type:"bytes",id:5},shapeTextureURI:{rule:"repeated",type:"string",id:6},fillTexture:{type:"bytes",id:7},fillTextureURI:{type:"string",id:8},fillWidth:{type:"float",id:9},fillHeight:{type:"float",id:10},randomizeFill:{type:"bool",id:11},blendMode:{type:"BlendMode",id:12}}},Brushes:{fields:{vectorBrushes:{rule:"repeated",type:"VectorBrush",id:1},rasterBrushes:{rule:"repeated",type:"RasterBrush",id:2}}},Stroke:{oneofs:{data:{oneof:["splineData","splineCompressed"]},properties:{oneof:["propertiesIndex","propertiesValue"]},brushURI:{oneof:["brushURIIndex","brushURIValue"]},renderModeURI:{oneof:["renderModeURIIndex","renderModeURIValue"]}},fields:{id:{type:"bytes",id:1},precisions:{type:"sint32",id:2},startParameter:{type:"float",id:3},endParameter:{type:"float",id:4},splineData:{type:"SplineData",id:5},splineCompressed:{type:"SplineCompressed",id:6},propertiesIndex:{type:"uint32",id:7},propertiesValue:{type:"PathPointProperties",id:8},brushURIIndex:{type:"uint32",id:9},brushURIValue:{type:"string",id:10},renderModeURIIndex:{type:"uint32",id:11},renderModeURIValue:{type:"string",id:12},randomSeed:{type:"uint32",id:13},sensorDataOffset:{type:"uint32",id:14},sensorDataID:{type:"bytes",id:15},sensorDataMapping:{rule:"repeated",type:"uint32",id:16}},nested:{SplineData:{fields:{splineX:{rule:"repeated",type:"float",id:1},splineY:{rule:"repeated",type:"float",id:2},splineZ:{rule:"repeated",type:"float",id:3},red:{rule:"repeated",type:"uint32",id:4},green:{rule:"repeated",type:"uint32",id:5},blue:{rule:"repeated",type:"uint32",id:6},alpha:{rule:"repeated",type:"uint32",id:7},size:{rule:"repeated",type:"float",id:8},rotation:{rule:"repeated",type:"float",id:9},scaleX:{rule:"repeated",type:"float",id:10},scaleY:{rule:"repeated",type:"float",id:11},scaleZ:{rule:"repeated",type:"float",id:12},offsetX:{rule:"repeated",type:"float",id:13},offsetY:{rule:"repeated",type:"float",id:14},offsetZ:{rule:"repeated",type:"float",id:15}}},SplineCompressed:{fields:{splineX:{rule:"repeated",type:"sint32",id:1},splineY:{rule:"repeated",type:"sint32",id:2},splineZ:{rule:"repeated",type:"sint32",id:3},red:{rule:"repeated",type:"uint32",id:4},green:{rule:"repeated",type:"uint32",id:5},blue:{rule:"repeated",type:"uint32",id:6},alpha:{rule:"repeated",type:"uint32",id:7},size:{rule:"repeated",type:"sint32",id:8},rotation:{rule:"repeated",type:"sint32",id:9},scaleX:{rule:"repeated",type:"sint32",id:10},scaleY:{rule:"repeated",type:"sint32",id:11},scaleZ:{rule:"repeated",type:"sint32",id:12},offsetX:{rule:"repeated",type:"sint32",id:13},offsetY:{rule:"repeated",type:"sint32",id:14},offsetZ:{rule:"repeated",type:"sint32",id:15}}}}},InkData:{fields:{strokes:{rule:"repeated",type:"Stroke",id:1},unitScaleFactor:{type:"float",id:2},transform:{type:"Matrix",id:3},brushURIs:{rule:"repeated",type:"string",id:4},renderModeURIs:{rule:"repeated",type:"string",id:5},properties:{rule:"repeated",type:"PathPointProperties",id:6}}},TripleStore:{fields:{statements:{rule:"repeated",type:"SemanticTriple",id:1}},nested:{SemanticTriple:{fields:{subject:{type:"string",id:1},predicate:{type:"string",id:2},object:{type:"string",id:3}}}}},Properties:{fields:{properties:{rule:"repeated",type:"Property",id:1}}},StructureType:{values:{STROKE:0,SENSOR_DATA:1}},Node:{oneofs:{id:{oneof:["groupID","index"]}},fields:{depth:{type:"uint32",id:1},groupID:{type:"bytes",id:2},index:{type:"uint32",id:3},interval:{type:"Interval",id:4},bounds:{type:"Rectangle",id:5}}},InkTree:{fields:{name:{type:"string",id:1},tree:{rule:"repeated",type:"Node",id:2}}},InkStructure:{fields:{type:{type:"StructureType",id:1},inkTree:{type:"InkTree",id:2},views:{rule:"repeated",type:"InkTree",id:3}}},Path:{fields:{layout:{type:"uint32",id:1},pointProps:{type:"PathPointProperties",id:2},data:{rule:"repeated",type:"float",id:3}}},Polygon:{fields:{shape:{type:"Path",id:1},holes:{rule:"repeated",type:"Path",id:2}}},PolygonArray:{fields:{data:{rule:"repeated",type:"Polygon",id:1}}},InkPath:{oneofs:{data:{oneof:["path","polygons"]}},fields:{path:{type:"Path",id:1},polygons:{type:"PolygonArray",id:2},spline:{type:"Path",id:3}}},Style:{fields:{pointerID:{type:"uint32",id:1},color:{type:"sint32",id:2},brushURI:{type:"string",id:3},randomSeed:{type:"uint32",id:4},renderModeURI:{type:"string",id:5}}},Segment:{fields:{pointerID:{type:"uint32",id:1},complete:{type:"bool",id:2},ink:{type:"InkPath",id:3}}},StrokesContext:{fields:{path:{rule:"repeated",type:"bytes",id:1}}},Intersection:{fields:{path:{type:"bytes",id:1},intervals:{rule:"repeated",type:"Interval",id:2}}},InkOperation:{oneofs:{operation:{oneof:["compose","add","remove","update","split","select","updateSelection","transform"]}},fields:{compose:{type:"Compose",id:1},add:{type:"Add",id:2},remove:{type:"Remove",id:3},update:{type:"Update",id:4},split:{type:"Split",id:5},select:{type:"Select",id:6},updateSelection:{type:"UpdateSelection",id:7},transform:{type:"Transform",id:8}},nested:{Compose:{oneofs:{stage:{oneof:["style","segment","abort"]}},fields:{style:{type:"Style",id:1},segment:{type:"Segment",id:2},abort:{type:"bool",id:3}}},Add:{fields:{path:{type:"Stroke",id:1},ink:{type:"InkPath",id:2}}},Remove:{fields:{context:{type:"StrokesContext",id:1}}},Update:{fields:{context:{type:"StrokesContext",id:1},style:{type:"Style",id:2},edit:{type:"bool",id:3}}},Split:{fields:{intersections:{rule:"repeated",type:"Intersection",id:1},affectedArea:{type:"Rectangle",id:2}}},Select:{oneofs:{stage:{oneof:["selector","selection","abort"]}},fields:{selector:{type:"Stroke",id:1},selection:{type:"StrokesContext",id:2},abort:{type:"bool",id:3}}},UpdateSelection:{oneofs:{stage:{oneof:["transform","complete"]}},fields:{transform:{type:"Matrix",id:1},complete:{type:"bool",id:2}}},Transform:{fields:{context:{type:"StrokesContext",id:1},matrix:{type:"Matrix",id:2}}}}},Range:{fields:{min:{type:"float",id:1},max:{type:"float",id:2},remapURI:{type:"string",id:3}}},PathPointContext:{fields:{statics:{type:"PathPointProperties",id:1},dynamics:{type:"PathPointSettings",id:2},colorMask:{type:"uint32",id:3}}},PathPointSettings:{fields:{size:{type:"PropertySettings",id:1},red:{type:"PropertySettings",id:2},green:{type:"PropertySettings",id:3},blue:{type:"PropertySettings",id:4},alpha:{type:"PropertySettings",id:5},rotation:{type:"PropertySettings",id:6},scaleX:{type:"PropertySettings",id:7},scaleY:{type:"PropertySettings",id:8},scaleZ:{type:"PropertySettings",id:9},offsetX:{type:"PropertySettings",id:11},offsetY:{type:"PropertySettings",id:12},offsetZ:{type:"PropertySettings",id:13}}},PropertySettings:{fields:{value:{type:"Range",id:1},velocity:{type:"Range",id:2},pressure:{type:"Range",id:3},altitude:{type:"Range",id:4},radiusX:{type:"Range",id:5},radiusY:{type:"Range",id:6},resolveURI:{type:"string",id:7},dependencies:{type:"uint32",id:8}}},InkTool:{oneofs:{brush:{oneof:["vectorBrush","rasterBrush"]}},fields:{vectorBrush:{type:"VectorBrush",id:1},rasterBrush:{type:"RasterBrush",id:2},blendMode:{type:"BlendMode",id:3},context:{type:"PathPointContext",id:4}}}}}}},root:"UIM_3_1_0",messages:{InputContext:function(e){e.id=B.toBytes(B.format(e.id)),e.environmentID=B.toBytes(B.format(e.environmentID)),e.sensorContextID=B.toBytes(B.format(e.sensorContextID))},Environment:function(e){e.id=B.toBytes(B.format(e.id))},InkInputProvider:function(e){e.id=B.toBytes(B.format(e.id))},InputDevice:function(e){e.id=B.toBytes(B.format(e.id))},SensorContext:function(e){e.id=B.toBytes(B.format(e.id))},SensorChannelsContext:function(e){e.id=B.toBytes(B.format(e.id)),e.inputDeviceID=B.toBytes(B.format(e.inputDeviceID)),e.inkInputProviderID&&(e.inkInputProviderID=B.toBytes(B.format(e.inkInputProviderID))),e.samplingRateHint&&(e.samplingRateHint=e.samplingRateHint.value),e.latency&&(e.latency=e.latency.value)},SensorChannel:function(e){e.id=B.toBytes(B.format(e.id))},ChannelData:function(e){e.sensorChannelID=B.toBytes(B.format(e.sensorChannelID))},SensorData:function(e){e.id=B.toBytes(e.id),e.inputContextID=B.toBytes(B.format(e.inputContextID))},InputData:function(e){var t=[],r={};e.sensorData.forEach((function(e,n){r[e.id]?t.push(n):0==e.dataChannels.length?(console.warn("Not found corresponding data channels for sensor data with id: ".concat(e.id,". Invalid sensor data is discarded.")),t.push(n)):r[e.id]=e})),t.reverse().forEach((function(t){return e.sensorData.removeAt(t)}))},View:function(e){e.name.startsWith("will://")&&(e.name=e.name.toLowerCase()),e.name=e.name.substring(e.name.lastIndexOf("/")+1)},Node:function(e,t){var r=Ki["3.0.0"].format;e.chunkToIndex>e.chunkFromIndex&&(e.interval={fromIndex:e.chunkFromIndex,toIndex:e.chunkToIndex,fromTValue:0,toTValue:1}),e.update={nodeID:e.id},e.type==r.NodeType.STROKE_GROUP||e.type==r.NodeType.SENSOR_DATA_GROUP?(B.validate(e.id)||(e.id=B.generate(),e.update.id=e.id),e.groupID=B.toBytes(e.id),e.id="groupID"):(e.type==r.NodeType.STROKE?e.update.id=t.context.inkData.strokes[e.index].id:e.update.id=t.context.inputData.sensorData[e.index].id,e.id="index"),Object.defineProperty(e,"bounds",{get:function(){return e.groupBoundingBox},configurable:!0})},InkData:function(e,t){e.brushURIs=[],e.renderModeURIs=[],e.properties=[],e.unitScaleFactor=1,e.transform=t.context.transform},Stroke:function(e,t){var r=Ki["3.1.0"].format,n=Ki["3.1.0"].messages.PathPointProperties;e.data="splineData",e.splineData={splineX:e.splineX,splineY:e.splineY,splineZ:e.splineZ,red:e.red.map((function(e){return Math.round(255*e)})),green:e.green.map((function(e){return Math.round(255*e)})),blue:e.blue.map((function(e){return Math.round(255*e)})),alpha:e.red.map((function(e){return Math.round(255*e)})),size:e.size,rotation:e.rotation,scaleX:e.scaleX,scaleY:e.scaleY,scaleZ:e.scaleZ,offsetX:e.offsetX,offsetY:e.offsetY,offsetZ:e.offsetZ},e.id=B.toBytes(e.id),e.sensorDataID&&(e.sensorDataID=B.toBytes(e.sensorDataID)),e.randomSeed=e.style.particlesRandomSeed,e.brushURI="brushURIValue",e.renderModeURI="renderModeURIValue",e.properties="propertiesValue",e.brushURIValue=e.style.brushURI,e.style.renderModeURI&&(e.renderModeURIValue=e.style.renderModeURI),n(e.style.properties,t,!1),e.propertiesValue=Wi.encodePathPointProperties(e.style.properties,r.PathPointProperties.create())},PathPointProperties:function(e,t){var r=!(arguments.length>2&&void 0!==arguments[2])||arguments[2];if(!r){var n=Ki["3.0.0"].format;for(var i in n.PathPointProperties.fields)if(e[i]){var o=e[i].value;"red"!=i&&"green"!=i&&"blue"!=i||(o=Math.round(255*o)),e[i]=o}else e[i]=void 0}},TripleStore:function(e,t){var r=Ki["3.0.0"].format,n=[],i=[{tree:t.context.inkTree}].concat(te(t.context.views)),o=t.context.inkTree.first.type,a=o==r.NodeType.STROKE_GROUP?qi.Type.STROKE:qi.Type.SENSOR_DATA;i.forEach((function(e){if(e.tree.first.type!=o){var t=e.tree.first.type==r.NodeType.STROKE_GROUP?qi.Type.STROKE:qi.Type.SENSOR_DATA;throw new Error("Inconsistent view found: ".concat(t.name," Expected: ").concat(a.name))}var i=new qi(a,e.name);i.tree=e.tree,n.push(i)})),n.forEach((function(t){t.tree.forEach((function(r){return function(t,r,n,i){var o="uim:node/".concat(r),a=n||r;e.statements.forEach((function(e){e.subject==o&&(e.subject=Me.createNodeURI(t,a,i)),e.object==o&&(e.object=Me.createNodeURI(t,a,i))}))}(t,r.update.nodeID,r.update.id,r.interval)}))}))}}},"3.0.0":{schema:{nested:{WacomInkFormat3:{options:{optimize_for:"SPEED",java_multiple_files:!1,java_package:"com.wacom.ink.protobuf",java_outer_classname:"Will3_0_0",csharp_namespace:"Protobuf.WILL_3_0_0"},nested:{Rectangle:{fields:{x:{type:"float",id:1},y:{type:"float",id:2},width:{type:"float",id:3},height:{type:"float",id:4}}},Matrix4:{fields:{m00:{type:"float",id:1},m01:{type:"float",id:2},m02:{type:"float",id:3},m03:{type:"float",id:4},m10:{type:"float",id:5},m11:{type:"float",id:6},m12:{type:"float",id:7},m13:{type:"float",id:8},m20:{type:"float",id:9},m21:{type:"float",id:10},m22:{type:"float",id:11},m23:{type:"float",id:12},m30:{type:"float",id:13},m31:{type:"float",id:14},m32:{type:"float",id:15},m33:{type:"float",id:16}}},Range:{fields:{min:{type:"float",id:1},max:{type:"float",id:2},remapURI:{type:"string",id:3}}},Float32:{fields:{value:{type:"float",id:1}}},Uint32:{fields:{value:{type:"uint32",id:1}}},Property:{fields:{name:{type:"string",id:1},value:{type:"string",id:2}}},SemanticTriple:{fields:{subject:{type:"string",id:1},predicate:{type:"string",id:2},object:{type:"string",id:3}}},InkState:{values:{PLANE:0,HOVERING:1,IN_VOLUME:2,VOLUME_HOVERING:3}},InkSensorMetricType:{values:{LENGTH:0,TIME:1,FORCE:2,ANGLE:3,NORMALIZED:4,LOGICAL:5,DIMENSIONLESS:6}},InkInputProviderType:{values:{PEN:0,TOUCH:1,MOUSE:2,CONTROLLER:3}},InputContext:{fields:{id:{type:"string",id:1},environmentID:{type:"string",id:2},sensorContextID:{type:"string",id:3}}},Environment:{fields:{id:{type:"string",id:1},properties:{rule:"repeated",type:"Property",id:2}}},InkInputProvider:{fields:{id:{type:"string",id:1},type:{type:"InkInputProviderType",id:2},properties:{rule:"repeated",type:"Property",id:3}}},InputDevice:{fields:{id:{type:"string",id:1},properties:{rule:"repeated",type:"Property",id:2}}},SensorContext:{fields:{id:{type:"string",id:1},sensorChannelsContext:{rule:"repeated",type:"SensorChannelsContext",id:2}}},SensorChannelsContext:{fields:{id:{type:"string",id:1},channels:{rule:"repeated",type:"SensorChannel",id:2},samplingRateHint:{type:"Uint32",id:3},latency:{type:"Uint32",id:4},inkInputProviderID:{type:"string",id:5},inputDeviceID:{type:"string",id:6}}},SensorChannel:{fields:{id:{type:"string",id:1},type:{type:"string",id:2},metric:{type:"InkSensorMetricType",id:3},resolution:{type:"double",id:4},min:{type:"float",id:5},max:{type:"float",id:6},precision:{type:"uint32",id:7}}},InputContextData:{fields:{inputContexts:{rule:"repeated",type:"InputContext",id:1},inkInputProviders:{rule:"repeated",type:"InkInputProvider",id:2},inputDevices:{rule:"repeated",type:"InputDevice",id:3},environments:{rule:"repeated",type:"Environment",id:4},sensorContexts:{rule:"repeated",type:"SensorContext",id:5}}},ChannelData:{fields:{sensorChannelID:{type:"string",id:1},values:{rule:"repeated",type:"sint32",id:2}}},SensorData:{fields:{id:{type:"string",id:1},inputContextID:{type:"string",id:2},state:{type:"InkState",id:3},timestamp:{type:"uint64",id:4},dataChannels:{rule:"repeated",type:"ChannelData",id:5}}},Stroke:{fields:{id:{type:"string",id:1},startParameter:{type:"float",id:2},endParameter:{type:"float",id:3},splineX:{rule:"repeated",type:"float",id:4},splineY:{rule:"repeated",type:"float",id:5},splineZ:{rule:"repeated",type:"float",id:6},red:{rule:"repeated",type:"float",id:7},green:{rule:"repeated",type:"float",id:8},blue:{rule:"repeated",type:"float",id:9},alpha:{rule:"repeated",type:"float",id:10},size:{rule:"repeated",type:"float",id:11},rotation:{rule:"repeated",type:"float",id:12},scaleX:{rule:"repeated",type:"float",id:13},scaleY:{rule:"repeated",type:"float",id:14},scaleZ:{rule:"repeated",type:"float",id:15},offsetX:{rule:"repeated",type:"float",id:16},offsetY:{rule:"repeated",type:"float",id:17},offsetZ:{rule:"repeated",type:"float",id:18},sensorDataOffset:{type:"uint32",id:19},sensorDataID:{type:"string",id:20},sensorDataMapping:{rule:"repeated",type:"uint32",id:21},style:{type:"Style",id:22}}},RotationMode:{values:{NONE:0,RANDOM:1,TRAJECTORY:2}},BlendMode:{values:{SOURCE_OVER:0,DESTINATION_OVER:1,DESTINATION_OUT:2,LIGHTER:3,COPY:4,MIN:5,MAX:6}},BrushPrototype:{fields:{coordX:{rule:"repeated",type:"float",id:1},coordY:{rule:"repeated",type:"float",id:2},coordZ:{rule:"repeated",type:"float",id:3},indices:{rule:"repeated",type:"uint32",id:4},shapeURI:{type:"string",id:5},size:{type:"float",id:6}}},VectorBrush:{fields:{name:{type:"string",id:1},prototype:{rule:"repeated",type:"BrushPrototype",id:2},spacing:{type:"float",id:3}}},RasterBrush:{fields:{name:{type:"string",id:1},spacing:{type:"float",id:2},scattering:{type:"float",id:3},rotationMode:{type:"RotationMode",id:4},shapeTexture:{rule:"repeated",type:"bytes",id:5},shapeTextureURI:{rule:"repeated",type:"string",id:6},fillTexture:{type:"bytes",id:7},fillTextureURI:{type:"string",id:8},fillWidth:{type:"float",id:9},fillHeight:{type:"float",id:10},randomizeFill:{type:"bool",id:11},blendMode:{type:"BlendMode",id:12}}},NodeType:{values:{STROKE_GROUP:0,SENSOR_DATA_GROUP:1,STROKE:2,SENSOR_DATA:3}},Node:{fields:{id:{type:"string",id:1},depth:{type:"uint32",id:2},index:{type:"uint32",id:3},type:{type:"NodeType",id:4},groupBoundingBox:{type:"Rectangle",id:5},chunkFromIndex:{type:"uint32",id:6},chunkToIndex:{type:"uint32",id:7}}},View:{fields:{name:{type:"string",id:1},tree:{rule:"repeated",type:"Node",id:2}}},PathPointProperties:{fields:{size:{type:"Float32",id:1},red:{type:"Float32",id:2},green:{type:"Float32",id:3},blue:{type:"Float32",id:4},alpha:{type:"Float32",id:5},rotation:{type:"Float32",id:6},scaleX:{type:"Float32",id:7},scaleY:{type:"Float32",id:8},scaleZ:{type:"Float32",id:9},offsetX:{type:"Float32",id:11},offsetY:{type:"Float32",id:12},offsetZ:{type:"Float32",id:13}}},Style:{fields:{properties:{type:"PathPointProperties",id:1},brushURI:{type:"string",id:2},particlesRandomSeed:{type:"uint32",id:3},renderModeURI:{type:"string",id:4}}},InputData:{fields:{inputContextData:{type:"InputContextData",id:1},sensorData:{rule:"repeated",type:"SensorData",id:2}}},InkData:{fields:{strokes:{rule:"repeated",type:"Stroke",id:1}}},Brushes:{fields:{vectorBrushes:{rule:"repeated",type:"VectorBrush",id:1},rasterBrushes:{rule:"repeated",type:"RasterBrush",id:2}}},TripleStore:{fields:{statements:{rule:"repeated",type:"SemanticTriple",id:1}}},Tool:{oneofs:{brush:{oneof:["vectorBrush","rasterBrush"]}},fields:{vectorBrush:{type:"VectorBrush",id:1},rasterBrush:{type:"RasterBrush",id:2},blendMode:{type:"BlendMode",id:3},context:{type:"PathPointContext",id:4}}},PathPointContext:{fields:{statics:{type:"PathPointProperties",id:1},dynamics:{type:"PathPointSettings",id:2}}},PathPointSettings:{fields:{size:{type:"PropertySettings",id:1},red:{type:"PropertySettings",id:2},green:{type:"PropertySettings",id:3},blue:{type:"PropertySettings",id:4},alpha:{type:"PropertySettings",id:5},rotation:{type:"PropertySettings",id:6},scaleX:{type:"PropertySettings",id:7},scaleY:{type:"PropertySettings",id:8},scaleZ:{type:"PropertySettings",id:9},offsetX:{type:"PropertySettings",id:11},offsetY:{type:"PropertySettings",id:12},offsetZ:{type:"PropertySettings",id:13}}},PropertySettings:{fields:{value:{type:"Range",id:1},velocity:{type:"Range",id:2},pressure:{type:"Range",id:3},altitude:{type:"Range",id:4},radiusX:{type:"Range",id:5},radiusY:{type:"Range",id:6},resolveURI:{type:"string",id:7},dependencies:{rule:"repeated",type:"InputPropertyType",id:8}}},InputPropertyType:{values:{PRESSURE:0,RADIUS_X:1,RADIUS_Y:2,AZIMUTH:3,ALTITUDE:4,ROTATION:5}},InkObject:{fields:{inputData:{type:"InputData",id:1},inkData:{type:"InkData",id:2},brushes:{type:"Brushes",id:3},inkTree:{rule:"repeated",type:"Node",id:4},views:{rule:"repeated",type:"View",id:5},knowledgeGraph:{type:"TripleStore",id:6},transform:{type:"Matrix4",id:7},properties:{rule:"repeated",type:"Property",id:8}}}}}}},root:"WacomInkFormat3",messages:{}}};Ki.evolution.forEach((function(e){var t=Ki[e].root;Object.defineProperty(Ki[e],"format",{get:function(){return this.value||(this.value=Zi.Root.fromJSON(this.schema.nested[t])),this.value}})})),Object.defineProperty(Ki,"latest",{value:Ki[Ki.evolution.last].format,enumerable:!0});var Ji=Zi.Namespace,$i=Zi.Message,Qi=function(){function e(){P(this,e),this.format=Ki.latest}return w(e,null,[{key:"encode",value:function(e){return e.constructor.encode(e).finish()}},{key:"decode",value:function(e,t){if(!(t instanceof Ji))throw new Error("Expected 'Type' to be instance of 'Namespace'");return e instanceof ArrayBuffer&&(e=new Uint8Array(e)),e instanceof Uint8Array?t.decode(e):e instanceof $i?e:t.fromObject(e)}}]),e}();Zi.Namespace;var eo=Zi.Message,to=function(){function e(){P(this,e),Object.defineProperty(this,"format",{value:Ki.latest})}return w(e,[{key:"decodeInkObject",value:function(e,t){if("3.0.0"==t){var r=this.decode("InkObject",e.data,t);return{Properties:new eo({properties:r.properties}),KnowledgeGraph:r.knowledgeGraph,InputData:r.inputData,Brushes:r.brushes,InkData:r.inkData,InkStructure:new eo({type:Ki.latest.StructureType.STROKE,inkTree:{tree:r.inkTree},views:r.views})}}return{Properties:this.decode("Properties",e.prps,t),KnowledgeGraph:this.decode("TripleStore",e.knwg,t),InputData:this.decode("InputData",e.inpt,t),Brushes:this.decode("Brushes",e.brsh,t),InkData:this.decode("InkData",e.inkd,t),InkStructure:this.decode("InkStructure",e.inks,t)}}},{key:"decode",value:function(e,t){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"latest";if(t){for(var n=Ki[r].format,i=n[e].decode(t),o=Ki.evolution.slice();o.first!=r;)o=o.slice(1);return this.evolution=o.slice(1),this.evolution.length>0&&(this.state={context:i},this.resolve(i),delete this.state),i}}},{key:"resolve",value:function(e){var t=this,r=e.constructor.name;this.evolution.forEach((function(n){var i=Ki[n].messages[r];i&&i(e,t.state)})),Object.values(e).forEach((function(e){e instanceof eo?t.resolve(e):Array.isArray(e)&&e.length>0&&e.first instanceof eo&&e.forEach((function(e){e instanceof eo&&t.resolve(e)}))}))}}]),e}();function ro(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var r,n=O(e);if(t){var i=O(this).constructor;r=Reflect.construct(n,arguments,i)}else r=n.apply(this,arguments);return A(this,r)}}var no=function(e){R(r,e);var t=ro(r);function r(){var e;return P(this,r),(e=t.call(this)).precisionDetector=new fi,Object.defineProperty(T(e),"precisionCalculator",{get:function(){return e.precisionDetector.calculator},set:function(t){return e.precisionDetector.calculator=t},enumerable:!0}),e}return w(r,[{key:"encode",value:function(e){var t=this,r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1,n=arguments.length>2?arguments[2]:void 0;if(0!=e.length){var i=this.buildStrokesIndex(e);this.state={index:i.index},this.precisionDetector.calculator&&this.precisionDetector.reset();var o=this.format.InkData.create({strokes:e.map((function(e){return t.encodeStroke(e)})),unitScaleFactor:r,transform:this.encodeMatrix(n),brushURIs:i.brushURIs,renderModeURIs:i.renderModeURIs,properties:i.properties.map((function(e){return Wi.encodePathPointProperties(e,t.format.PathPointProperties.create())}))});return this.reset(),this.precisionDetector.calculator&&this.precisionDetector.printStats(),Qi.encode(o)}}},{key:"buildStrokesIndex",value:function(e){var t=this,r=[],n=[],i=[],o={},a={};return e.forEach((function(e){var s=[];for(var u in t.format.PathPointProperties.fields)"color"==u?(s.push("red",e.pointProps.red||0),s.push("green",e.pointProps.green||0),s.push("blue",e.pointProps.blue||0),s.push("alpha",(e.pointProps.alpha||0).toFixed(2))):s.push(u,(e.pointProps[u]||0).toFixed(2));s=s.join("_");var c=r.indexOf(e.brush.name),l=e.renderMode!=ci.RenderMode.SOURCE_OVER?n.indexOf(e.renderMode):void 0,h=i.indexOf(s);-1==c&&(c=r.push(e.brush.name)-1),-1==l&&(l=n.push(e.renderMode)-1),-1==h&&(h=i.push(s)-1,o[s]=e.pointProps),a[e.id]={brushURI:c,renderModeURI:l,pathPointProperties:h}})),{properties:i.map((function(e){return o[e]})),brushURIs:r,renderModeURIs:n,index:a}}},{key:"decode",value:function(e){var t=this,r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:[];if(e){var i=Qi.decode(e,this.format.InkData),o={brushes:r,brushURIs:i.brushURIs,sensorPaths:Object.assign.apply(Object,[{}].concat(te(n.map((function(e){return S({},e.id,e)}))))),renderModeURIs:i.renderModeURIs,properties:i.properties},a={strokes:i.strokes.map((function(e){return t.decodeStroke(e,o)})),unitScaleFactor:i.unitScaleFactor||1,transform:this.decodeMatrix(i.transform)};return this.reset(),a}}},{key:"encodeStroke",value:function(e){var t=this.state?this.state.index[e.id]:void 0,r=this.format.Stroke.create({id:B.toBytes(e.id),startParameter:e.ts,endParameter:e.tf,randomSeed:e.randomSeed});if(t?(r.brushURIIndex=t.brushURI+1,r.propertiesIndex=t.pathPointProperties+1,isFinite(t.renderModeURI)&&(r.renderModeURIIndex=t.renderModeURI+1)):(r.brushURIValue=e.brush.name,r.propertiesValue=Wi.encodePathPointProperties(e.pointProps,this.format.PathPointProperties.create()),e.renderMode!=ci.RenderMode.SOURCE_OVER&&(r.renderModeURIValue=e.renderMode)),this.precisionDetector.calculator&&e.compressionType==ci.CompressionType.AUTO&&this.precisionDetector.updatePrecisionSchema(e),e.precisionSchema?(r.precisions=e.precisionSchema.precisions,r.splineCompressed=this.encodeSplineCompressed(e.spline,e.precisionSchema)):r.splineData=this.encodeSpline(e.spline),e.sensorData&&!this.ignoreSensorData){if(!t)throw new Error("Model-less strokes sensor data persistance is not supported");r.sensorDataID=B.toBytes(e.sensorData.id),r.sensorDataOffset=e.sensorDataOffset,r.sensorDataMapping=e.sensorDataMapping}return r}},{key:"decodeStroke",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},r="splineCompressed"==e.data,n=e[e.data];if(0==n.splineX.length||0==n.splineY.length)throw new Error("Incomplete path definition");var i=[le.Property.X,le.Property.Y];n.splineZ.length>0&&i.push(le.Property.Z),n.red&&n.red.length>0&&i.push(le.Property.RED),n.green.length>0&&i.push(le.Property.GREEN),n.blue.length>0&&i.push(le.Property.BLUE),n.alpha.length>0&&i.push(le.Property.ALPHA),n.size.length>0&&i.push(le.Property.SIZE),n.rotation.length>0&&i.push(le.Property.ROTATION),n.scaleX.length>0&&i.push(le.Property.SCALE_X),n.scaleY.length>0&&i.push(le.Property.SCALE_Y),n.scaleZ.length>0&&i.push(le.Property.SCALE_Z),n.offsetX.length>0&&i.push(le.Property.OFFSET_X),n.offsetY.length>0&&i.push(le.Property.OFFSET_Y),n.offsetZ.length>0&&i.push(le.Property.OFFSET_Z);var o,a,s=n.splineX.length,u=i.length,c=Float32Array.createSharedInstance(s*u);r?(o=new un(e.precisions),this.decodeSplineCompressed(n,i,c,o)):this.decodeSpline(n,i,c),e.renderModeURI&&(a="renderModeURIValue"==e.renderModeURI?e.renderModeURIValue:t.renderModeURIs[e.renderModeURIIndex-1]);var l,h="propertiesValue"==e.properties?Wi.decodePathPointProperties(e.propertiesValue,i):Wi.decodePathPointProperties(t.properties[e.propertiesIndex-1],i),f="brushURIValue"==e.brushURI?e.brushURIValue:t.brushURIs[e.brushURIIndex-1],d=(t.brushes?t.brushes[f]:void 0)||f;t.sensorPaths&&e.sensorDataID&&(l=t.sensorPaths[B.fromBytes(e.sensorDataID)]);var p=e.startParameter,y=e.endParameter;1==p&&(console.warn("Invalid ts = 1 found on spline deserializtion, ts is set to 0.99999. Stroke ".concat(B.fromBytes(e.id)," is affected.")),p=.99999),0==y&&(console.warn("Invalid tf = 1 found on spline deserializtion, tf is set to 0.00001. Stroke ".concat(B.fromBytes(e.id)," is affected.")),y=1e-5);var v=new Tr(i,c,h,p,y);v.id=this.cloneStroke?B.generate():B.fromBytes(e.id);var m=new ci(d,v,t.inkPath,l);return m.randomSeed=e.randomSeed,m.precisionSchema=o,a&&(m.renderMode=a),l&&(m.sensorDataOffset=e.sensorDataOffset,m.sensorDataMapping=e.sensorDataMapping),m}},{key:"encodeSpline",value:function(e){for(var t=this.format.Stroke.SplineData.create(),r=function(r){var n=e.getPoint(r);e.layout.forEach((function(e){switch(e){case le.Property.X:t.splineX.push(n.x);break;case le.Property.Y:t.splineY.push(n.y);break;case le.Property.Z:t.splineZ.push(n.z);break;case le.Property.RED:t.red.push(n.red);break;case le.Property.GREEN:t.green.push(n.green);break;case le.Property.BLUE:t.blue.push(n.blue);break;case le.Property.ALPHA:t.alpha.push(Math.round(255*n.alpha));break;case le.Property.SIZE:t.size.push(n.size);break;case le.Property.ROTATION:t.rotation.push(n.rotation);break;case le.Property.SCALE_X:t.scaleX.push(n.scaleX);break;case le.Property.SCALE_Y:t.scaleY.push(n.scaleY);break;case le.Property.SCALE_Z:t.scaleZ.push(n.scaleZ);break;case le.Property.OFFSET_X:t.offsetX.push(n.offsetX);break;case le.Property.OFFSET_Y:t.offsetY.push(n.offsetY);break;case le.Property.OFFSET_Z:t.offsetZ.push(n.offsetZ);break;default:throw new Error("Invalid layout property provided: ".concat(e))}}))},n=0;n<e.length;n++)r(n);return t}},{key:"decodeSpline",value:function(e,t,r){for(var n=t.length,i=function(i){t.forEach((function(t,o){var a;switch(t){case le.Property.X:a=e.splineX[i];break;case le.Property.Y:a=e.splineY[i];break;case le.Property.Z:a=e.splineZ[i];break;case le.Property.RED:a=e.red[i];break;case le.Property.GREEN:a=e.green[i];break;case le.Property.BLUE:a=e.blue[i];break;case le.Property.ALPHA:a=e.alpha[i]/255;break;case le.Property.SIZE:a=e.size[i];break;case le.Property.ROTATION:a=e.rotation[i];break;case le.Property.SCALE_X:a=e.scaleX[i];break;case le.Property.SCALE_Y:a=e.scaleY[i];break;case le.Property.SCALE_Z:a=e.scaleZ[i];break;case le.Property.OFFSET_X:a=e.offsetX[i];break;case le.Property.OFFSET_Y:a=e.offsetY[i];break;case le.Property.OFFSET_Z:a=e.offsetZ[i];break;default:throw new Error("Invalid layout property provided: ".concat(t.name))}r[i*n+o]=a}))},o=0;o<r.length;o++)i(o)}},{key:"encodeSplineCompressed",value:function(e,t){for(var r=this.format.Stroke.SplineCompressed.create(),n=t.factors,i={},o=function(e,r,o){var a;if((o=Math.round(o*n[e]))>Number.MAX_INT32||o<-Number.MAX_INT32)throw new Error("Int32 precision exceeded ".concat(o," for precision with type ").concat(e," and value ").concat(t[e],". This value is not applicable."));return a=r in i?o-i[r]:o,i[r]=o,a},a=function(t){var n=e.getPoint(t);e.layout.forEach((function(e,t){switch(e){case le.Property.X:r.splineX.push(o("position","x",n.x));break;case le.Property.Y:r.splineY.push(o("position","y",n.y));break;case le.Property.Z:r.splineZ.push(o("position","z",n.z));break;case le.Property.RED:r.red.push(n.red);break;case le.Property.GREEN:r.green.push(n.green);break;case le.Property.BLUE:r.blue.push(n.blue);break;case le.Property.ALPHA:r.alpha.push(Math.round(255*n.alpha));break;case le.Property.SIZE:r.size.push(o("size","size",n.size));break;case le.Property.ROTATION:r.rotation.push(o("rotation","rotation",n.rotation));break;case le.Property.SCALE_X:r.scaleX.push(o("scale","scaleX",n.scaleX));break;case le.Property.SCALE_Y:r.scaleY.push(o("scale","scaleY",n.scaleY));break;case le.Property.SCALE_Z:r.scaleZ.push(o("scale","scaleZ",n.scaleZ));break;case le.Property.OFFSET_X:r.offsetX.push(o("offset","offsetX",n.offsetX));break;case le.Property.OFFSET_Y:r.offsetY.push(o("offset","offsetY",n.offsetY));break;case le.Property.OFFSET_Z:r.offsetZ.push(o("offset","offsetZ",n.offsetZ));break;default:throw new Error("Invalid layout property provided: ".concat(e))}}))},s=0;s<e.length;s++)a(s);return r}},{key:"decodeSplineCompressed",value:function(e,t,r,n){for(var i=t.length,o=n.factors,a={},s=function(e,t,r){return t in a&&(r+=a[t]),a[t]=r,r/o[e]},u=function(n){t.forEach((function(t,o){var a;switch(t){case le.Property.X:a=s("position","x",e.splineX[n]);break;case le.Property.Y:a=s("position","y",e.splineY[n]);break;case le.Property.Z:a=s("position","z",e.splineZ[n]);break;case le.Property.RED:a=e.red[n];break;case le.Property.GREEN:a=e.green[n];break;case le.Property.BLUE:a=e.blue[n];break;case le.Property.ALPHA:a=e.alpha[n]/255;break;case le.Property.SIZE:a=s("size","size",e.size[n]);break;case le.Property.ROTATION:a=s("rotation","rotation",e.rotation[n]);break;case le.Property.SCALE_X:a=s("scale","scaleX",e.scaleX[n]);break;case le.Property.SCALE_Y:a=s("scale","scaleY",e.scaleY[n]);break;case le.Property.SCALE_Z:a=s("scale","scaleZ",e.scaleZ[n]);break;case le.Property.OFFSET_X:a=s("offset","offsetX",e.offsetX[n]);break;case le.Property.OFFSET_Y:a=s("offset","offsetY",e.offsetY[n]);break;case le.Property.OFFSET_Z:a=s("offset","offsetZ",e.offsetZ[n]);break;default:throw new Error("Invalid layout property provided: ".concat(t.name))}r[n*i+o]=a}))},c=0;c<r.length;c++)u(c)}},{key:"encodeMatrix",value:function(e){if(e&&!e.isIdentity)return this.format.Matrix.create({m00:e.m11,m01:e.m12,m02:e.m13,m03:e.m14,m10:e.m21,m11:e.m22,m12:e.m23,m13:e.m24,m20:e.m31,m21:e.m32,m22:e.m33,m23:e.m34,m30:e.m41,m31:e.m42,m32:e.m43,m33:e.m44})}},{key:"decodeMatrix",value:function(e){if(e)return Q.fromMatrix([e.m00,e.m01,e.m02,e.m03,e.m10,e.m11,e.m12,e.m13,e.m20,e.m21,e.m22,e.m23,e.m30,e.m31,e.m32,e.m33])}},{key:"reset",value:function(){this.state=void 0,this.ignoreSensorData=!1,this.cloneStroke=!1}}]),r}(Qi);function io(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var r,n=O(e);if(t){var i=O(this).constructor;r=Reflect.construct(n,arguments,i)}else r=n.apply(this,arguments);return A(this,r)}}var oo=function(e){R(r,e);var t=io(r);function r(){return P(this,r),t.call(this)}return w(r,[{key:"encode",value:function(e){var t=this;if(0!=e.length){var r={},n={},i={},o={},a={};e.forEach((function(e){var t=e.context;r[t.id]||(r[t.id]=t,a[t.environment.id]||(a[t.environment.id]=t.environment),n[t.sensorContext.id]||(n[t.sensorContext.id]=t.sensorContext,t.sensorContext.channelsContexts.forEach((function(e){i[e.device.id]||(i[e.device.id]=e.device),e.inkProvider&&(o[e.inkProvider.id]||(o[e.inkProvider.id]=e.inkProvider))}))))}));var s=this.format.InputData.create({sensorData:e.map((function(e){return t.encodeSensorData(e)})),inputContextData:this.format.InputContextData.create({inputContexts:Object.values(r).map((function(e){return t.format.InputContext.create({id:B.toBytes(B.format(e.id)),environmentID:B.toBytes(B.format(e.environment.id)),sensorContextID:B.toBytes(B.format(e.sensorContext.id))})})),sensorContexts:Object.values(n).map((function(e){return t.format.SensorContext.create({id:B.toBytes(B.format(e.id)),sensorChannelsContext:e.channelsContexts.map((function(e){return t.format.SensorChannelsContext.create({id:B.toBytes(B.format(e.id)),channels:e.channels.map((function(e){return t.format.SensorChannel.create({id:B.toBytes(B.format(e.id)),type:e.type,metric:t.format.InkSensorMetricType[e.metric.name],resolution:e.resolution,min:e.min,max:e.max,precision:e.precision})})),samplingRateHint:e.samplingRate,latency:e.latency,inkInputProviderID:e.inkProvider?B.toBytes(B.format(e.inkProvider.id)):void 0,inputDeviceID:B.toBytes(B.format(e.device.id))})}))})})),inkInputProviders:Object.values(o).map((function(e){return t.format.InkInputProvider.create({id:B.toBytes(B.format(e.id)),type:t.format.InkInputProviderType[e.type.name],properties:t.encodeProperties(e.props)})})),inputDevices:Object.values(i).map((function(e){return t.format.InputDevice.create({id:B.toBytes(B.format(e.id)),properties:t.encodeProperties(e.props)})})),environments:Object.values(a).map((function(e){return t.format.Environment.create({id:B.toBytes(B.format(e.id)),properties:t.encodeProperties(e.props)})}))})});return Qi.encode(s)}}},{key:"decode",value:function(e){var t=this;if(!e)return[];var r=Qi.decode(e,this.format.InputData),n={},i={},o={},a={},s={};return r.inputContextData.environments.forEach((function(e){var r=new Ee;t.decodeProperties(e.properties,r.props),Object.freeze(r),r.id!=B.fromBytes(e.id).replace(/-/g,"")&&console.warn("Environment decode id missmatch - found ".concat(B.fromBytes(e.id).replace(/-/g,""),", expected ").concat(r.id)),s[r.id]=r})),r.inputContextData.inkInputProviders.forEach((function(e){var r=t.decodeProperties(e.properties),n=new G(G.Type[t.format.InkInputProviderType[e.type]],r);Object.freeze(n),n.id!=B.fromBytes(e.id).replace(/-/g,"")&&console.warn("InkInputProvider decode id missmatch - found ".concat(B.fromBytes(e.id).replace(/-/g,""),", expected ").concat(n.id)),a[n.id]=n})),r.inputContextData.inputDevices.forEach((function(e){var r=new je;t.decodeProperties(e.properties,r.props),Object.freeze(r),r.id!=B.fromBytes(e.id).replace(/-/g,"")&&console.warn("InputDevice decode id missmatch - found ".concat(B.fromBytes(e.id).replace(/-/g,""),", expected ").concat(r.id)),o[r.id]=r})),r.inputContextData.sensorContexts.forEach((function(e){var r=new Ce;e.sensorChannelsContext.forEach((function(e){var n=new Ae(o[B.fromBytes(e.inputDeviceID).replace(/-/g,"")],a[B.fromBytes(e.inkInputProviderID).replace(/-/g,"")]);e.samplingRateHint&&(n.samplingRate=e.samplingRateHint),e.latency&&(n.latency=e.latency),e.channels.forEach((function(e){var r=Re.Metric[t.format.InkSensorMetricType[e.metric]],i=new Re(e.type,r,e.resolution,e.min,e.max);i.precision=e.precision,n.add(i),i.id!=B.fromBytes(e.id).replace(/-/g,"")&&console.warn("SensorChannel decode id missmatch - found ".concat(B.fromBytes(e.id).replace(/-/g,""),", expected ").concat(i.id))})),r.addContext(n),n.id!=B.fromBytes(e.id).replace(/-/g,"")&&console.warn("SensorChannelsContext decode id missmatch - found ".concat(B.fromBytes(e.id).replace(/-/g,""),", expected ").concat(n.id))})),Object.freeze(r),i[r.id]=r,r.id!=B.fromBytes(e.id).replace(/-/g,"")&&console.warn("SensorContext decode id missmatch - found ".concat(B.fromBytes(e.id).replace(/-/g,""),", expected ").concat(r.id))})),r.inputContextData.inputContexts.forEach((function(e){var t=new Ne(s[B.fromBytes(e.environmentID).replace(/-/g,"")],i[B.fromBytes(e.sensorContextID).replace(/-/g,"")]);Object.freeze(t),t.id!=B.fromBytes(e.id).replace(/-/g,"")&&console.warn("InputContext decode id missmatch - found ".concat(B.fromBytes(e.id).replace(/-/g,""),", expected ").concat(t.id)),n[t.id]=t})),r.sensorData.map((function(e){return t.decodeSensorData(e,n[B.fromBytes(e.inputContextID).replace(/-/g,"")])}))}},{key:"encodeSensorData",value:function(e){var t=this,r=this.format.SensorData.create({id:B.toBytes(e.id),inputContextID:B.toBytes(B.format(e.context.id)),state:this.format.InkState[e.inkState.name],timestamp:e.created});return e.streams.forEach((function(e){var n={};e.channels.forEach((function(e){return n[e.id]=[]}));for(var i=function(t){var r=e.get(t);e.channels.forEach((function(e){n[e.id].push(r[re.getPropName(e.name)])}))},o=0;o<e.length;o++)i(o);e.channels.forEach((function(e){if(!("precision"in e))throw new Error("Precision not found for channel with id: ".concat(e.id));var i=n[e.id];if(0!=i.length){var o=Math.pow(10,e.precision),a=Math.round(i[0]*o),s=t.format.ChannelData.create({sensorChannelID:B.toBytes(B.format(e.id))});s.values.push(a);for(var u=1;u<i.length;u++){var c=Math.round(i[u]*o);s.values.push(c-a),a=c}r.dataChannels.push(s)}}))})),r}},{key:"decodeSensorData",value:function(e,t){if(0==e.dataChannels.length)throw new Error("Not found corresponding data channels for sensor data with id: ".concat(B.fromBytes(e.id)));var r=new Be(t,B.fromBytes(e.id));r.created=parseInt(L.fromValue(e.timestamp).toString()),r.inkState=Be.InkState[this.format.InkState[e.state]];var n={};return e.dataChannels.forEach((function(e){var r=B.fromBytes(e.sensorChannelID).replace(/-/g,"");if(0!=e.values.length){var i=t.sensorContext.getContextByChannelID(r);if(!i)throw new Error("Not found corresponding channel context for data with channelID ".concat(r));var o=i.get(r),a=Math.pow(10,o.precision),s=e.values[0],u=[];u.push(s/a);for(var c=1;c<e.values.length;c++){var l=s+e.values[c];u.push(l/a),s=l}n[r]=u}else n[r]=[]})),t.sensorContext.channelsContexts.forEach((function(e){var t=new _e(e.channels),i=n[e.channels.first.id];if(i)for(var o=i.length,a=function(r){e.channels.forEach((function(e){var i=n[e.id];if(!i)throw new Error("Not found corresponding data for channel ".concat(e.type," with id: ").concat(e.id));t.data.push(i[r])}))},s=0;s<o;s++)a(s);else{if(t.ink)throw new Error("Empty ink stream is not allowed");var u=0;if(e.channels.forEach((function(e){n[e.id]&&(u+=n[e.id].length)})),u>0)throw new Error("Un-alligned channels context is not valid, found with id: ".concat(e.id))}r.add(t)})),r}},{key:"encodeProperties",value:function(e){var t=this;return Object.keys(e).map((function(r){return t.format.Property.create({name:r,value:e[r]})}))}},{key:"decodeProperties",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return Object.assign.apply(Object,[t].concat(te(e.map((function(e){return S({},e.name,e.value)})))))}}]),r}(Qi);function ao(e,t){var r="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!r){if(Array.isArray(e)||(r=function(e,t){if(!e)return;if("string"==typeof e)return so(e,t);var r=Object.prototype.toString.call(e).slice(8,-1);"Object"===r&&e.constructor&&(r=e.constructor.name);if("Map"===r||"Set"===r)return Array.from(e);if("Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r))return so(e,t)}(e))||t&&e&&"number"==typeof e.length){r&&(e=r);var n=0,i=function(){};return{s:i,n:function(){return n>=e.length?{done:!0}:{done:!1,value:e[n++]}},e:function(e){throw e},f:i}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var o,a=!0,s=!1;return{s:function(){r=r.call(e)},n:function(){var e=r.next();return a=e.done,e},e:function(e){s=!0,o=e},f:function(){try{a||null==r.return||r.return()}finally{if(s)throw o}}}}function so(e,t){(null==t||t>e.length)&&(t=e.length);for(var r=0,n=new Array(t);r<t;r++)n[r]=e[r];return n}function uo(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var r,n=O(e);if(t){var i=O(this).constructor;r=Reflect.construct(n,arguments,i)}else r=n.apply(this,arguments);return A(this,r)}}var co=function(e){R(i,e);var t,r,n=uo(i);function i(){return P(this,i),n.call(this)}return w(i,[{key:"encode",value:(r=fe(pe.mark((function e(t){var r,n,i,o,a,s;return pe.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(0!=t.length){e.next=2;break}return e.abrupt("return");case 2:r=this.format.Brushes.create(),n=ao(t),e.prev=4,n.s();case 6:if((i=n.n()).done){e.next=19;break}if(!((o=i.value)instanceof xt)){e.next=13;break}a=this.encodeBrush2D(o),r.vectorBrushes.push(a),e.next=17;break;case 13:return e.next=15,this.encodeBrushGL(o);case 15:s=e.sent,r.rasterBrushes.push(s);case 17:e.next=6;break;case 19:e.next=24;break;case 21:e.prev=21,e.t0=e.catch(4),n.e(e.t0);case 24:return e.prev=24,n.f(),e.finish(24);case 27:return e.abrupt("return",Qi.encode(r));case 28:case"end":return e.stop()}}),e,this,[[4,21,24,27]])}))),function(e){return r.apply(this,arguments)})},{key:"decode",value:function(e){var t=this;if(!e)return{};var r=Qi.decode(e,this.format.Brushes),n={};return r.vectorBrushes.forEach((function(e){return n[e.name]=t.decodeBrush2D(e)})),r.rasterBrushes.forEach((function(e){return n[e.name]=t.decodeBrushGL(e)})),n}},{key:"encodeBrush2D",value:function(e){if(!e.name)throw new Error("Encode Brush2D failed. name property is required.");var t,r=this.format.VectorBrush.create({name:e.name,spacing:e.spacing}),n=ao(Array.isArray(e.shape)?e.shape:[e.shape]);try{for(n.s();!(t=n.n()).done;){var i=t.value,o=this.format.BrushPrototype.create({size:i.size});if(i.descriptor.shape.name)o.shapeURI=i.descriptor.shape.name;else for(var a=i.shape,s=0;s<a.shape.length;s++)o.coordX.push(a.shape.getPointX(s)),o.coordY.push(a.shape.getPointY(s));r.prototype.push(o)}}catch(e){n.e(e)}finally{n.f()}return r}},{key:"decodeBrush2D",value:function(e){if(Ge.instance&&Ge.instance[e.name]){if(Ge.instance[e.name]instanceof xt)return Ge.instance[e.name];throw new Error("URI conflict detected, ".concat(e.name," expected Brush2D, found ").concat(Ge.instance[e.name].constructor.name))}var t=[];return e.prototype.forEach((function(e){var r;if(e.shapeURI)r=e.shapeURI;else{r=Float32Array.createSharedInstance(2*e.coordX.length);for(var n=0;n<r.length/2;n++)r[2*n]=e.coordX[n],r[2*n+1]=e.coordY[n]}t.push(new ft(r,e.size))})),new xt(e.name,t,e.spacing)}},{key:"encodeBrushGL",value:(t=fe(pe.mark((function e(t){var r,n,i,o;return pe.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t.name){e.next=2;break}throw new Error("Encode BrushGL failed. name property is required.");case 2:if(r={shape:[],shapeURI:[],fill:void 0,filleURI:void 0},!Array.isArray(t.shape)){e.next=11;break}if(!((n=t.descriptor.shape.map((function(e){return e.name})).filter((function(e){return e}))).length>0)){e.next=9;break}if(n.length==t.shape.length){e.next=8;break}throw new Error("Brush ".concat(t.name," shape names length do not match with brush mipmap"));case 8:r.shapeURI=n;case 9:e.next=12;break;case 11:t.descriptor.shape.name&&r.shapeURI.push(t.descriptor.shape.name);case 12:if(r.fillURI=t.descriptor.fill.name,0!=r.shapeURI.length&&r.fillURI){e.next=23;break}return e.next=16,t.getShapeBinary();case 16:return e.t0=e.sent,e.next=19,t.getFillBinary();case 19:e.t1=e.sent,i={shape:e.t0,fill:e.t1},0==r.shapeURI.length&&(Array.isArray(t.shape)?r.shape=i.shape:r.shape.push(i.shape)),r.fillURI||(r.fill=i.fill);case 23:return o=t.blendMode.replace(/-/g,"_").toUpperCase(),e.abrupt("return",this.format.RasterBrush.create({name:t.name,spacing:t.spacing,scattering:t.scattering,blendMode:this.format.BlendMode[o],rotationMode:this.format.RotationMode[t.rotationMode.name],shapeTexture:r.shape,shapeTextureURI:r.shapeURI,fillTexture:r.fill,fillTextureURI:r.fillURI,fillWidth:t.fillTextureSize.width,fillHeight:t.fillTextureSize.height,randomizeFill:t.randomizeFill}));case 25:case"end":return e.stop()}}),e,this)}))),function(e){return t.apply(this,arguments)})},{key:"decodeBrushGL",value:function(e){if(Ge.instance&&Ge.instance[e.name]){if(Ge.instance[e.name]instanceof qt)return Ge.instance[e.name];throw new Error("URI conflict detected, ".concat(e.name," expected BrushGL, found ").concat(Ge.instance[e.name].constructor.name))}var t,r;if(e.shapeTextureURI.length>0)t=1==e.shapeTextureURI.length?{name:e.shapeTextureURI.first}:e.shapeTextureURI.map((function(e){return{name:e}}));else{if(!(e.shapeTexture.length>0))throw new Error("Decode BrushGL shape - insufficent data found");t=1==e.shapeTexture.length?{value:e.shapeTexture.first}:e.shapeTexture.map((function(e){return{value:e}}))}if(e.fillTextureURI)r={name:e.fillTextureURI};else{if(!e.fillTexture)throw new Error("Decode BrushGL fill - insufficent data found");r={value:e.fillTexture}}return new qt(e.name,t,r,{spacing:e.spacing,scattering:e.scattering,blendMode:Tt[this.format.BlendMode[e.blendMode]],rotationMode:qt.RotationMode[e.rotationMode]},{randomize:e.randomizeFill,size:{width:e.fillWidth,height:e.fillHeight}})}}]),i}(Qi);function lo(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var r,n=O(e);if(t){var i=O(this).constructor;r=Reflect.construct(n,arguments,i)}else r=n.apply(this,arguments);return A(this,r)}}var ho=function(e){R(r,e);var t=lo(r);function r(){return P(this,r),t.call(this)}return w(r,[{key:"encode",value:function(e){var t=this;if(e&&0!=e.length){var r=this.format.TripleStore.create({statements:e.map((function(e){return t.format.TripleStore.SemanticTriple.create({subject:e.subject,predicate:e.predicate,object:e.object})}))});return Qi.encode(r)}}},{key:"decode",value:function(e){if(e){var t=Qi.decode(e,this.format.TripleStore);return D(Hi,te(t.statements))}}}]),r}(Qi);function fo(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var r,n=O(e);if(t){var i=O(this).constructor;r=Reflect.construct(n,arguments,i)}else r=n.apply(this,arguments);return A(this,r)}}var po=function(e){R(r,e);var t=fo(r);function r(e){return P(this,r),t.call(this,e)}return r}(U);function yo(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var r,n=O(e);if(t){var i=O(this).constructor;r=Reflect.construct(n,arguments,i)}else r=n.apply(this,arguments);return A(this,r)}}var vo=function(e){R(r,e);var t=yo(r);function r(e){var n,i;return P(this,r),n=t.call(this,e),Object.defineProperty(T(n),"bounds",{get:function(){return i||(i=n.getBounds()),i},set:function(e){return i=e},enumerable:!0}),Object.defineProperty(T(n),"boundsValue",{get:function(){return i}}),Object.defineProperty(T(n),"root",{get:function(){for(var e=this.parent,t=this;e;)t=e,e=e.parent;return t},enumerable:!0}),n}return w(r,[{key:"getBounds",value:function(){throw new Error("getBounds is abstract, should be implemented")}},{key:"invalidateBounds",value:function(){this.preventInvalidateBounds||(this.bounds=void 0,this.parent&&this.parent.invalidateBounds())}},{key:"remove",value:function(){this.parent.removeChild(this)}}]),r}(po);function mo(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var r,n=O(e);if(t){var i=O(this).constructor;r=Reflect.construct(n,arguments,i)}else r=n.apply(this,arguments);return A(this,r)}}var go=function(e){R(r,e);var t=mo(r);function r(e){var n,i;return P(this,r),(n=t.call(this,e)).children=[],Object.defineProperty(T(n),"uri",{get:function(){return i||(i=Me.createNodeURI(n.root.model,n.id)),i},enumerable:!0}),Object.defineProperty(T(n),"type",{value:"GROUP",enumerable:!0}),Object.defineProperty(T(n),"content",{value:n.children,enumerable:!0}),n}return w(r,[{key:"getBounds",value:function(){var e;return this.children.forEach((function(t){e=e?e.union(t.bounds):t.bounds})),e}},{key:"contains",value:function(e){if(!(e instanceof vo))throw new Error("Incompatible node found - ".concat(e.constructor.name,". It should be ink model Element."));for(var t=!1,r=e.parent;r;){if(r==this){t=!0;break}r=r.parent}return t}},{key:"indexOf",value:function(e){if(!(e instanceof vo))throw new Error("Incompatible node found - ".concat(e.constructor.name,". It should be ink model Element."));return this.children.indexOf(e)}},{key:"appendChild",value:function(e,t){if(!(e instanceof vo))throw new Error("Incompatible node found - ".concat(e.constructor.name,". It should be ink model Element."));if(t<0)throw new Error("Index should be a positive number");var r=e.parent;if(r){if(this.root.id!=e.root.id)throw new Error("Moving nodes from one hierarchy to another is not allowed. Make sure root is common for this operation.");e.parent.children.remove(e),e.parent.invalidateBounds()}if(e.parent=this,isFinite(t)&&t<this.children.length?this.children.insert(e,t):this.children.push(e),!r){var n=this.root.model;n&&n.register(e,t)}return this.invalidateBounds(),e}},{key:"removeChild",value:function(e){if(!this.children.includes(e))throw new Error("Node was not found");var t=this.root.model;t&&t.unregister(e),this.invalidateBounds(),this.children.remove(e)}},{key:"remove",value:function(){this.parent?this.parent.removeChild(this):(this.model&&this.model.unregister(this),this.invalidateBounds())}}]),r}(vo);function bo(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var r,n=O(e);if(t){var i=O(this).constructor;r=Reflect.construct(n,arguments,i)}else r=n.apply(this,arguments);return A(this,r)}}var Eo=function(e){R(r,e);var t=bo(r);function r(e,n){var i;return P(this,r),i=t.call(this),Object.defineProperty(T(i),"uri",{get:function(){return i.id},enumerable:!0}),Object.defineProperty(T(i),"type",{value:"PATH",enumerable:!0}),Object.defineProperty(T(i),"index",{get:function(){return i.parent?i.parent.indexOf(T(i)):0},enumerable:!0}),Object.defineProperty(T(i),"content",{value:e,enumerable:!0}),Object.defineProperty(T(i),"fragment",{value:n,enumerable:!0}),Object.defineProperty(T(i),"interval",{get:function(){return console.warn("Element Path interval is deprecated. Use fragment property to get path part. fromIndex and toIndex are accessible as fromPointIndex, toPointIndex."),i.fragment&&(i.fragment.fromIndex=i.fragment.fromPointIndex,i.fragment.toIndex=i.fragment.toPointIndex),i.fragment},enumerable:!0}),i}return w(r,[{key:"buildURI",value:function(){return Me.createNodeURI(this.root.model,this.content.id,this.fragment)}},{key:"getBounds",value:function(){if(this.fragment){var e=this.content.slice(this.fragment);return e.brush instanceof xt&&e.buildPath({lastPipelineStage:Hn.BRUSH_APPLIER}),e.bounds}return this.content.bounds}},{key:"split",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1;if(this.content instanceof Be)throw new Error("SensorData is immutable. Split is not applicable.");if(!this.parent)throw new Error("Dettached Path node split is not allowed. Attach to hierarchy first.");if(e<0||e>this.content.length-1)throw new Error("Index out of range {0, ".concat(this.content.length-1,"}"));var n=this.fragment?this.fragment.fromPointIndex:0,i=this.fragment?this.fragment.toPointIndex:this.content.length-1,o=this.fragment?this.fragment.fromTValue:this.content.ts,a=this.fragment?this.fragment.toTValue:this.content.tf,s=new Qe(this.content.spline,n,e+1,o,t-.05),u=new Qe(this.content.spline,e-1,i,1==t?.05:t,a);if(s.toPointIndex+1-s.fromPointIndex<4)throw new Error("Invalid split index ".concat(e," found - range {").concat(s.fromPointIndex,", ").concat(s.toPointIndex,"} is invalid. At least 4 points are needed to define path fragment."));if(u.toPointIndex+1-u.fromPointIndex<4)throw new Error("Invalid split index ".concat(e," found - range {").concat(u.fromPointIndex,", ").concat(u.toPointIndex,"} is invalid. At least 4 points are needed to define path fragment."));var c=new r(this.content,s),l=new r(this.content,u),h=this.index;return this.remove(),this.parent.appendChild(c,h),this.parent.appendChild(l,h+1),[c,l]}}]),r}(vo);function Po(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var r,n=O(e);if(t){var i=O(this).constructor;r=Reflect.construct(n,arguments,i)}else r=n.apply(this,arguments);return A(this,r)}}var ko=function(e){R(r,e);var t=Po(r);function r(e,n,i){var o;return P(this,r),(o=t.call(this,n.type,e)).model=n,o.root=o.createGroup(i),o.root.model=T(o),Object.defineProperty(T(o),"tree",{get:function(){return console.warn("View 'tree' property is deprecated. Use root instead."),o.root}}),o.register(o.root),o}return w(r,[{key:"addPath",value:function(e,t){return t||(t=this.root),t.appendChild(this.createElement(e))}},{key:"createElement",value:function(e,t){if(t&&!(t instanceof Qe))throw new Error("fragment expected type is PathFragment");return this.model.createElement(e,this,t)}},{key:"createGroup",value:function(e){return this.model.createGroup(e,this)}},{key:"register",value:function(e){var t=this;if(e instanceof go)e.children.forEach((function(e){return t.register(e)}));else{if(!(e instanceof Eo))throw new Error("Register unknown node found: ".concat(e.id));if(e.content instanceof ci){if(this.type!=r.Type.STROKE)throw new Error("Incompatible element content found - ".concat(e.content.constructor.name,". Content should be instance of Stroke."))}else{if(!(e.content instanceof Be))throw new Error("Incompatible element content found - ".concat(e.content.constructor.name,". Content should be ").concat(this.type.name,"."));if(this.type!=r.Type.SENSOR_DATA)throw new Error("Incompatible element content found - ".concat(e.content.constructor.name,". Content should be instance of SensorData."))}if(!this.model.content.includes(e.content))throw new Error("Node content not found in underling ink model - ".concat(e.content.id))}this.model.index(e),this.updateKnowledgeGraph(e)}},{key:"unregister",value:function(e){var t=this;e instanceof go&&e.children.forEach((function(e){return t.unregister(e)})),delete this.model.registry.nodes[e.uri],this.updateKnowledgeGraph(e)}},{key:"updateKnowledgeGraph",value:function(e){var t=this;if(this.model.registry.nodes[e.uri]){if(!this.knowledgeGraph)return;this.knowledgeGraph.filter((function(t){return t.subject==e.uri||t.object==e.uri})).forEach((function(r){var n;r.subject==e.uri&&r.object.startsWith("uim:ne/")&&(n=t.model.knowledgeGraph).add.apply(n,te(t.knowledgeGraph.filter((function(e){return e.subject==r.object})))),t.model.knowledgeGraph.add(r)}))}else this.model.knowledgeGraph.filter((function(t){return t.subject==e.uri||t.object==e.uri})).forEach((function(r){var n;r.subject==e.uri&&r.object.startsWith("uim:ne/")&&(n=t.model.knowledgeGraph).remove.apply(n,te(t.model.knowledgeGraph.filter((function(e){return e.subject==r.object})))),t.model.knowledgeGraph.remove(r)}))}},{key:"extractKnowledge",value:function(){for(var e=this,t=this.model.knowledgeGraph.filter((function(t){return t.subject.startsWith(Me.createNodeURISchema(e))})),r=new Set(t.map((function(e){return e.object})));r.size>0;){var n=this.model.knowledgeGraph.filter((function(e){return r.has(e.subject)&&!t.includes(e)}));t.push.apply(t,te(n)),r=new Set(n.map((function(e){return e.object})))}return t}}]),r}(qi);function wo(e,t){var r="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!r){if(Array.isArray(e)||(r=function(e,t){if(!e)return;if("string"==typeof e)return xo(e,t);var r=Object.prototype.toString.call(e).slice(8,-1);"Object"===r&&e.constructor&&(r=e.constructor.name);if("Map"===r||"Set"===r)return Array.from(e);if("Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r))return xo(e,t)}(e))||t&&e&&"number"==typeof e.length){r&&(e=r);var n=0,i=function(){};return{s:i,n:function(){return n>=e.length?{done:!0}:{done:!1,value:e[n++]}},e:function(e){throw e},f:i}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var o,a=!0,s=!1;return{s:function(){r=r.call(e)},n:function(){var e=r.next();return a=e.done,e},e:function(e){s=!0,o=e},f:function(){try{a||null==r.return||r.return()}finally{if(s)throw o}}}}function xo(e,t){(null==t||t>e.length)&&(t=e.length);for(var r=0,n=new Array(t);r<t;r++)n[r]=e[r];return n}function So(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var r,n=O(e);if(t){var i=O(this).constructor;r=Reflect.construct(n,arguments,i)}else r=n.apply(this,arguments);return A(this,r)}}var Io=function(e){R(r,e);var t=So(r);function r(){var e,n=arguments.length>0&&void 0!==arguments[0]?arguments[0]:r.Type.STROKE,i=arguments.length>1?arguments[1]:void 0;return P(this,r),(e=t.call(this,n)).root=e.createGroup(i),e.root.model=T(e),Object.defineProperty(T(e),"tree",{get:function(){return console.warn("InkModel 'tree' property is deprecated. Use root instead."),e.root}}),e.props={},e.views={},e.unitScaleFactor=1,e.transform=void 0,e.knowledgeGraph=new Hi,e.knowledgeGraphAnalyzer=new yi(T(e)),Object.defineProperty(T(e),"registry",{value:{nodes:{},content:{},brushes:{}},enumerable:!0}),e.type==r.Type.STROKE?e.registry.sensorData={}:Object.defineProperty(e.registry,"sensorData",{get:function(){return e.content},enumerable:!0}),Object.defineProperty(T(e),"content",{value:[],enumerable:!0}),Object.defineProperty(T(e),"strokes",{get:function(){return e.type==r.Type.STROKE?e.content.slice():[]},enumerable:!0}),Object.defineProperty(T(e),"sensorData",{get:function(){var t;if(e.type==r.Type.STROKE){var n={};e.content.forEach((function(e){e.sensorData&&(n[e.sensorData.id]=e.sensorData)})),e.disableSensorDataIntegrity&&Object.keys(e.registry.sensorData).forEach((function(t){return n[t]=e.registry.sensorData[t]})),t=Object.values(n)}else t=e.content;return t},set:function(t){if(!(t instanceof Be))throw new Error("Data type mismatch, expected SensorData");if(e.type==r.Type.SENSOR_DATA)throw new Error("For SensorData models use 'addPath' method instead");e.index(t)},enumerable:!0}),Object.defineProperty(T(e),"brushes",{get:function(){var t={};return e.strokes.forEach((function(r){return t[r.brush.name]=e.registry.brushes[r.brush.name]||r.brush})),Object.values(t)},set:function(t){t.forEach((function(t){return e.index(t)}))},enumerable:!0}),e.register(e.root),e.disableSensorDataIntegrity=!0,e}return w(r,[{key:"addPath",value:function(e,t){t||(t=this.root);var r=this.createElement(e);return e.sensorData&&this.index(e.sensorData),e.brush&&this.index(e.brush),t.appendChild(r)}},{key:"removePath",value:function(e){e.nodeID&&this.registry.nodes[e.nodeID].remove()}},{key:"replacePath",value:function(e,t){var r=this,n=arguments.length>2&&void 0!==arguments[2]&&arguments[2];if(e.nodeID){var i=this.getNode(e.nodeID),o=i.parent||this.root,a=t.map((function(e){return r.createElement(e)})),s=o.children.indexOf(i);if(n){var u=o.appendChild(this.createGroup(),s);a.forEach((function(e){return u.appendChild(e)}))}else a.forEach((function(e,t){return o.appendChild(e,s+t)}));this.removePath(e)}}},{key:"createElement",value:function(e,t,n){if(!e)throw new Error("Element content not found");var i=t?t.type:this.type;switch(i){case r.Type.STROKE:if(!(e instanceof ci))throw new Error("Incompatible element content found - ".concat(e.constructor.name,". Content should be instance of Stroke."));if(n&&!t)throw new Error("Main tree is not fragmentable. Fragments are applicable only in Views.");break;case r.Type.SENSOR_DATA:if(!(e instanceof Be))throw new Error("Incompatible element content found - ".concat(e.constructor.name,". Content should be instance of SensorData."));if(n)throw new Error("SensorData fragments are not supported");break;default:throw console.warn(i),new Error("Invalid ink model type found")}return new Eo(e,n)}},{key:"createGroup",value:function(e,t){return new go(e)}},{key:"getItem",value:function(e){return console.warn("InkModel getItem method is deprecated. Use oneof(getNode(id), getStroke(id), getSensorData(id), getBrush(id))."),this.registry.nodes[e]||this.registry.content[e]||this.registry.sensorData[e]||this.registry.brushes[e]}},{key:"getNode",value:function(e){var t;if(re.isValidURL(e))t=this.registry.nodes[e];else{var r,n=wo([this].concat(te(Object.values(this.views))));try{for(n.s();!(r=n.n()).done;){var i=r.value,o=Me.createNodeURI(i,e);if(t=this.registry.nodes[o])break}}catch(e){n.e(e)}finally{n.f()}}return t}},{key:"getPath",value:function(e){return this.registry.content[e]}},{key:"getStroke",value:function(e){return this.type==r.Type.STROKE?this.registry.content[e]:void 0}},{key:"getSensorData",value:function(e){return this.registry.sensorData[e]}},{key:"getBrush",value:function(e){return this.registry.brushes[e]}},{key:"register",value:function(e,t){var n=this;if(e instanceof go)e.children.forEach((function(e){return n.register(e)}));else{if(!(e instanceof Eo))throw new Error("Register unknown node found: ".concat(e.id));if(e.content instanceof ci){if(this.type!=r.Type.STROKE)throw new Error("Incompatible element content found - ".concat(e.content.constructor.name,". Content should be instance of Stroke."))}else{if(!(e.content instanceof Be))throw new Error("Incompatible element content found - ".concat(e.content.constructor.name,". Content should be ").concat(this.type.name,"."));if(this.type!=r.Type.SENSOR_DATA)throw new Error("Incompatible element content found - ".concat(e.content.constructor.name,". Content should be instance of SensorData."))}Object.defineProperty(e.content,"nodeID",{value:e.id,enumerable:!0,configurable:!0}),isFinite(t)&&t<this.content.length?this.content.insert(e.content,t):this.content.push(e.content),this.index(e.content)}this.index(e),this.resetViews()}},{key:"index",value:function(e){var t,n=e.id;if(e instanceof po){n=e.uri,t="nodes";var i=this.type.name;e instanceof go&&(i="ol<".concat(i,">")),Object.defineProperty(e,"dataType",{value:i,enumerable:!0})}else e instanceof ci?t="content":e instanceof Be?t=this.type==r.Type.SENSOR_DATA?"content":"sensorData":e instanceof ze&&(t="brushes");if(!t)throw new Error("Expected item type is oneof(InkNode, Stroke, SensorData, Brush)");var o=this.registry[t];if(o[n]){if(o[n]!=e)throw new Error("Cannot register ".concat(t," item with id ").concat(n,". Already is available item with such identifier."))}else o[n]=e}},{key:"unregister",value:function(e){var t=this;this.resetViews(),e instanceof go?e.children.forEach((function(e){return t.unregister(e)})):e instanceof Eo&&(delete e.content.nodeID,delete this.registry.content[e.content.id],this.content.remove(e.content)),e==this.root?e.children.clear():delete this.registry.nodes[e.uri]}},{key:"createView",value:function(e,t,r){var n=new ko(e,this,t);return this.views[e]=n,r&&(n.knowledgeGraph=r,n.updateKnowledgeGraph(n.root)),n}},{key:"resetViews",value:function(){if(!this.keepViews){for(var e in this.views)this.views[e].root.remove(),delete this.views[e];this.knowledgeGraph.length>0&&this.knowledgeGraphAnalyzer.clean()}}}],[{key:"createCopyInstance",value:function(e){var t=new r(e.type,e.root.id);t.id=e.id,t.props=e.props,t.transform=e.transform,t.unitScaleFactor=e.unitScaleFactor,t.knowledgeGraph=e.knowledgeGraph.clone(),e.type==r.Type.STROKE&&(Object.values(e.registry.sensorData).forEach((function(e){return t.index(e)})),Object.values(e.registry.brushes).forEach((function(e){return t.index(e)})));var n=function e(t,r){t.children.forEach((function(t){if("PATH"==t.type){var n=r.root.model.createElement(t.content);r.appendChild(n)}else{if("GROUP"!=t.type)throw new Error("Unknown node type found: ".concat(t.type));var i=r.root.model.createGroup(t.id);r.appendChild(i),e(t,i)}}))};return n(e.root,t.root),Object.values(e.views).forEach((function(e){var r=t.createView(e.name,e.root.id);n(e.root,r.root)})),t}}]),r}(qi);function Ro(e,t){var r="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!r){if(Array.isArray(e)||(r=function(e,t){if(!e)return;if("string"==typeof e)return To(e,t);var r=Object.prototype.toString.call(e).slice(8,-1);"Object"===r&&e.constructor&&(r=e.constructor.name);if("Map"===r||"Set"===r)return Array.from(e);if("Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r))return To(e,t)}(e))||t&&e&&"number"==typeof e.length){r&&(e=r);var n=0,i=function(){};return{s:i,n:function(){return n>=e.length?{done:!0}:{done:!1,value:e[n++]}},e:function(e){throw e},f:i}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var o,a=!0,s=!1;return{s:function(){r=r.call(e)},n:function(){var e=r.next();return a=e.done,e},e:function(e){s=!0,o=e},f:function(){try{a||null==r.return||r.return()}finally{if(s)throw o}}}}function To(e,t){(null==t||t>e.length)&&(t=e.length);for(var r=0,n=new Array(t);r<t;r++)n[r]=e[r];return n}function Ao(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var r,n=O(e);if(t){var i=O(this).constructor;r=Reflect.construct(n,arguments,i)}else r=n.apply(this,arguments);return A(this,r)}}var Oo=function(e){R(r,e);var t=Ao(r);function r(){return P(this,r),t.call(this)}return w(r,[{key:"encode",value:function(e){var t=this,r=this.format.InkStructure.create({type:this.format.StructureType[e.type.name],inkTree:this.format.InkTree.create({tree:this.encodeNodeTree(e)}),views:Object.values(e.views).map((function(e){return t.encodeView(e)}))});return Qi.encode(r)}},{key:"decode",value:function(e,t,r){var n=this;if(e){var i=Qi.decode(e,this.format.InkStructure),o=i.type==this.format.StructureType.STROKE?Io.Type.STROKE:Io.Type.SENSOR_DATA,a=o==Io.Type.STROKE?t:r,s=new Io(o,B.fromBytes(i.inkTree.tree.first.groupID)),u=i.inkTree.tree.first.bounds;return u&&(s.root.bounds=new V(u.x,u.y,u.width,u.height)),this.decodeNodeTree(s,i.inkTree.tree.slice(1),a),i.views.forEach((function(e){return n.decodeView(e,s,a)})),o==Io.Type.STROKE&&r.forEach((function(e){return s.index(e)})),s}}},{key:"encodeView",value:function(e){return this.format.InkTree.create({name:e.name,tree:this.encodeNodeTree(e)})}},{key:"decodeView",value:function(e,t,r,n){var i=e.tree.first,o=B.fromBytes(i.groupID);if(!t.views[e.name]||t.views[e.name].root.id!=o){var a=t.createView(e.name,o,n),s=e.tree.first.bounds;s&&(a.root.bounds=new V(s.x,s.y,s.width,s.height)),this.decodeNodeTree(a,e.tree.slice(1),r),a.invalid&&(console.warn("Drop view ".concat(a.uri," due to invalid structure")),delete t.views[a.name],t.knowledgeGraphAnalyzer.clean())}}},{key:"encodeNodeTree",value:function(e){var t=[];return t.push(this.encodeNode(e.root,0)),this.addChildren(t,e,e.root.children,1),t}},{key:"addChildren",value:function(e,t,r,n){var i=this;r.forEach((function(r){var o=r instanceof Eo?(t.model||t).content.indexOf(r.content):void 0;e.push(i.encodeNode(r,n,o)),r instanceof go&&i.addChildren(e,t,r.children,n+1)}))}},{key:"encodeNode",value:function(e,t,r){var n=this.format.Node.create({depth:t,bounds:e.boundsValue});return e instanceof go?n.groupID=B.toBytes(e.id):n.index=r,e.fragment&&(n.interval=this.format.Interval.create({fromIndex:e.fragment.fromPointIndex,toIndex:e.fragment.toPointIndex,fromTValue:e.fragment.fromTValue,toTValue:e.fragment.toTValue})),n}},{key:"decodeNodeTree",value:function(e,t,r){if(!e.invalid){var n,i=e.root,o=0,a={},s=Ro(t);try{for(s.s();!(n=s.n()).done;){for(var u=n.value;o>=u.depth;)i=i.parent,o--;if(i.preventInvalidateBounds=!0,"groupID"==u.id){if(!(i instanceof go))throw new Error("Incorrect tree structure, a tree node is not a Group instance and cannot contain child nodes.");i=i.appendChild(e.createGroup(B.fromBytes(u.groupID))),u.bounds&&(i.bounds=new V(u.bounds.x,u.bounds.y,u.bounds.width,u.bounds.height))}else{var c=function(){var t=void 0;if(u.interval){if(e instanceof Io)throw new Error("Intervals are not applicable for InkModel, only View allow intervals");if(e.type==Io.Type.STROKE){var n=r[u.index];try{t=new Qe(n.spline,u.interval.fromIndex,u.interval.toIndex,u.interval.fromTValue,u.interval.toTValue),a[n.id]?a[n.id].forEach((function(e){if(t.overlaps(e))throw new Error("Overlapped fragments are not allowed. ".concat(t," overlaps ").concat(e))})):a[n.id]=[],a[n.id].push(t)}catch(t){if(Io.reservedViewNames.includes(e.name))return console.warn("invalid path fragment content id: ".concat(n.id," - ").concat(t.message)),e.invalid=!0,{v:void 0};throw t}}else console.warn("Intervals are not applicable for SensorData models, only Stroke models allow intervals. Model ".concat(e.name," discards interval."))}if(e.type==Io.Type.STROKE&&Io.reservedViewNames.includes(e.name)){var o=r[u.index],s=Me.createNodeURI(e,o.id,t);if((e.model||e).getNode(s))return console.warn("duplicate path node ".concat(s)),e.invalid=!0,{v:void 0}}var c=e.createElement(r[u.index],t);i=i.appendChild(c)}();if("object"===E(c))return c.v}delete i.parent.preventInvalidateBounds,o=u.depth}}catch(e){s.e(e)}finally{s.f()}}}}]),r}(Qi);function Co(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var r,n=O(e);if(t){var i=O(this).constructor;r=Reflect.construct(n,arguments,i)}else r=n.apply(this,arguments);return A(this,r)}}var Do=function(e){R(r,e);var t=Co(r);function r(){return P(this,r),t.call(this)}return w(r,[{key:"encode",value:function(){var e=this,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},r=this.format.Properties.create({properties:Object.keys(t).map((function(r){return e.format.Property.create({name:r,value:t[r]})}))});return 0==r.properties.length?void 0:Qi.encode(r)}},{key:"decode",value:function(e){if(e){var t=Qi.decode(e,this.format.Properties);return Object.assign.apply(Object,[{}].concat(te(t.properties.map((function(e){return S({},e.name,e.value)})))))}}}]),r}(Qi);function No(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var r,n=O(e);if(t){var i=O(this).constructor;r=Reflect.construct(n,arguments,i)}else r=n.apply(this,arguments);return A(this,r)}}var Mo=function(e){R(n,e);var t,r=No(n);function n(){var e;return P(this,n),(e=r.call(this)).brushesCodec=new co,e}return w(n,[{key:"encode",value:(t=fe(pe.mark((function e(t){var r,i,o,a,s,u,c,l=arguments;return pe.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r=l.length>1&&void 0!==l[1]?l[1]:{},i=l.length>2&&void 0!==l[2]?l[2]:{},o=l.length>3&&void 0!==l[3]?l[3]:Tt.SOURCE_OVER,a=[],isFinite(i.red)&&a.push(n.ColorIndex.indexOf("RED")),isFinite(i.green)&&a.push(n.ColorIndex.indexOf("GREEN")),isFinite(i.blue)&&a.push(n.ColorIndex.indexOf("BLUE")),isFinite(i.alpha)&&a.push(n.ColorIndex.indexOf("ALPHA")),s=re.encodeBitMask(a),e.t0=this.format.InkTool,e.t1=t instanceof xt?this.brushesCodec.encodeBrush2D(t):void 0,!(t instanceof qt)){e.next=17;break}return e.next=14,this.brushesCodec.encodeBrushGL(t);case 14:e.t2=e.sent,e.next=18;break;case 17:e.t2=void 0;case 18:return e.t3=e.t2,e.t4=this.format.PathPointContext.create({statics:Wi.encodePathPointProperties(i,this.format.PathPointProperties.create()),dynamics:this.encodePathPointSettings(r),colorMask:s}),e.t5={vectorBrush:e.t1,rasterBrush:e.t3,context:e.t4},u=e.t0.create.call(e.t0,e.t5),o!=Tt.SOURCE_OVER&&(c=o.replace(/-/g,"_").toUpperCase(),u.blendMode=this.format.BlendMode[c]),e.abrupt("return",Qi.encode(u));case 24:case"end":return e.stop()}}),e,this)}))),function(e){return t.apply(this,arguments)})},{key:"decode",value:function(e){if(e){var t=Qi.decode(e,this.format.InkTool),r=re.decodeBitMask(t.context.colorMask).map((function(e){return le.Property[n.ColorIndex[e]]})),i=[le.Property.RED,le.Property.GREEN,le.Property.BLUE,le.Property.ALPHA].filter((function(e){return!r.includes(e)}));return{brush:"vectorBrush"==t.brush?this.brushesCodec.decodeBrush2D(t.vectorBrush):this.brushesCodec.decodeBrushGL(t.rasterBrush),blendMode:Tt[this.format.BlendMode[t.blendMode]],statics:Wi.decodePathPointProperties(t.context.statics,i),dynamics:this.decodePathPointSettings(t.context.dynamics)}}}},{key:"encodePathPointSettings",value:function(e){var t=this.format.PathPointSettings.create();for(var r in this.format.PathPointSettings.fields)e[r]&&!e[r].disabled&&(t[r]=this.encodePropertySettings(r,e[r]));return t}},{key:"decodePathPointSettings",value:function(e){if(e){var t={};for(var r in this.format.PathPointSettings.fields)e[r]&&(t[r]=this.decodePropertySettings(e[r]));return t}}},{key:"encodePropertySettings",value:function(e,t){var r=this,i=function(t){if(t)return r.format.Range.create({min:t.min,max:t.max,remapURI:r.getActionDescriptorName(e,"Remap",t.remap)})};return this.format.PropertySettings.create({value:i(t.value),velocity:i(t.velocity),pressure:i(t.pressure),altitude:i(t.altitude),radiusX:i(t.radiusX),radiusY:i(t.radiusY),resolveURI:this.getActionDescriptorName(e,"Resolve",t.resolve),dependencies:re.encodeBitMask((t.dependencies||[]).map((function(e){return n.InputPropertyTypeIndex.indexOf(Re.getTypeName(e))})))||void 0})}},{key:"getActionDescriptorName",value:function(e,t,r){if(r){if("function"==typeof r)throw new Error("Encode '".concat(e,"' property failed. ").concat(t," action name property is required. Please provide ActionDescriptor for it's definition."));if("string"==typeof r)return r;if(r.name)return r.name;throw new Error("Encode '".concat(e,"' property failed. ").concat(t," action name property is required. Please provide ActionDescriptor for it's definition."))}}},{key:"decodePropertySettings",value:function(e){var t={},r=function(e,r){r&&(t[e]={min:r.min,max:r.max,remap:r.remapURI})};r("value",e.value),r("velocity",e.velocity),r("pressure",e.pressure),r("altitude",e.altitude),r("radiusX",e.radiusX),r("radiusY",e.radiusY),t.resolve=e.resolveURI;var i=re.decodeBitMask(e.dependencies).map((function(e){return Re.Type[n.InputPropertyTypeIndex[e]]}));return i.length>0&&(t.dependencies=i),t}}]),n}(Qi);Mo.InputPropertyTypeIndex=Object.freeze([void 0,"PRESSURE","RADIUS_X","RADIUS_Y","AZIMUTH","ALTITUDE","ROTATION"]),Mo.ColorIndex=Object.freeze([void 0,"RED","GREEN","BLUE","ALPHA"]);var Lo=new TextEncoder,Bo=3,_o=1,Fo=0,Uo={extension:"uim",contentType:"application/vnd.wacom-ink.model",description:"Universal Ink Model",fourCC:{format:Lo.encode("UINK"),InkObject:Lo.encode("DATA"),Properties:Lo.encode("PRPS"),InputData:Lo.encode("INPT"),Brushes:Lo.encode("BRSH"),InkData:Lo.encode("INKD"),InkStructure:Lo.encode("INKS"),TripleStore:Lo.encode("KNWG")}};Object.defineProperty(Uo,"version",{value:"".concat(Bo,".").concat(_o,".").concat(Fo)}),Object.defineProperty(Uo,"serial",{value:new Uint8Array([Bo,_o,Fo])}),Zi.BufferReader,Zi.BufferWriter;var jo=function(){function e(){var t=this;P(this,e),this.dataCodec=new no,this.inputCodec=new oo,this.brushesCodec=new co,this.structureCodec=new Oo,this.tripleStoreCodec=new ho,this.propsCodec=new Do,this.inkToolCodec=new Mo,this.compatibilityProvider=new to,this.riffEncoder=new Qr(Uo.fourCC.format,Uo.serial),this.riffDecoder=new tn,Object.defineProperty(this,"precisionCalculator",{get:function(){return t.dataCodec.precisionCalculator},set:function(e){return t.dataCodec.precisionCalculator=e},enumerable:!0})}var t,r,n,i;return w(e,[{key:"encodeInkModel",value:(i=fe(pe.mark((function e(t){var r,n=arguments;return pe.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=n.length>1&&void 0!==n[1]?n[1]:Kr.CompressionType.NONE,this.riffEncoder.add(this.propsCodec.encode(t.props),{version:Uo.serial,fourCC:Uo.fourCC.Properties,contentType:Kr.ContentType.PROTO,compressionType:r}),this.riffEncoder.add(this.inputCodec.encode(t.sensorData),{version:Uo.serial,fourCC:Uo.fourCC.InputData,contentType:Kr.ContentType.PROTO,compressionType:r}),e.t0=this.riffEncoder,e.next=6,this.brushesCodec.encode(t.brushes);case 6:return e.t1=e.sent,e.t2={version:Uo.serial,fourCC:Uo.fourCC.Brushes,contentType:Kr.ContentType.PROTO,compressionType:r},e.t0.add.call(e.t0,e.t1,e.t2),this.riffEncoder.add(this.dataCodec.encode(t.strokes,t.unitScaleFactor,t.transform),{version:Uo.serial,fourCC:Uo.fourCC.InkData,contentType:Kr.ContentType.PROTO,compressionType:r}),this.riffEncoder.add(this.tripleStoreCodec.encode(t.knowledgeGraph),{version:Uo.serial,fourCC:Uo.fourCC.TripleStore,contentType:Kr.ContentType.PROTO,compressionType:r}),this.riffEncoder.add(this.structureCodec.encode(t),{version:Uo.serial,fourCC:Uo.fourCC.InkStructure,contentType:Kr.ContentType.PROTO,compressionType:r}),e.next=14,this.riffEncoder.encode();case 14:return e.abrupt("return",e.sent);case 15:case"end":return e.stop()}}),e,this)}))),function(e){return i.apply(this,arguments)})},{key:"decodeInkModel",value:(n=fe(pe.mark((function e(t,r){var n,i;return pe.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t instanceof ArrayBuffer&&(t=new Uint8Array(t)),e.next=3,this.riffDecoder.decode(t);case 3:return n=e.sent,i=n.asProps(),e.abrupt("return",this.buildInkModel(i,n.version,r));case 6:case"end":return e.stop()}}),e,this)}))),function(e,t){return n.apply(this,arguments)})},{key:"buildInkModel",value:function(e,t,r){var n=this,i=this.compatibilityProvider.decodeInkObject(e,t),o=this.tripleStoreCodec.decode(i.KnowledgeGraph);if(r){var a=(r.type==Io.Type.STROKE?i.InkData.strokes:i.InputData.sensorData).map((function(e){return r.getPath(e.id)}));i.InkStructure.views.forEach((function(e){return n.decodeView(e,r,a,o)}))}else{var s=this.inputCodec.decode(i.InputData),u=this.brushesCodec.decode(i.Brushes),c=this.dataCodec.decode(i.InkData,u,s);(r=this.structureCodec.decode(i.InkStructure,c?c.strokes:[],s)).version=t,c&&(r.unitScaleFactor=c.unitScaleFactor,r.transform=c.transform,r.brushes=Object.values(u)),o&&(r.knowledgeGraph=o),i.Properties&&(r.props=this.propsCodec.decode(i.Properties))}return r}},{key:"encodeInputData",value:function(e){return this.inputCodec.encode(e)}},{key:"decodeInputData",value:function(e){return this.inputCodec.decode(e)}},{key:"encodeInkData",value:function(e){return this.dataCodec.ignoreSensorData=!0,this.dataCodec.encode(e)}},{key:"decodeInkData",value:function(e){this.dataCodec.cloneStroke=!0;var t=this.dataCodec.decode(e);return t?t.strokes:[]}},{key:"encodeBrushes",value:(r=fe(pe.mark((function e(t){return pe.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.brushesCodec.encode(t);case 2:return e.abrupt("return",e.sent);case 3:case"end":return e.stop()}}),e,this)}))),function(e){return r.apply(this,arguments)})},{key:"decodeBrushes",value:function(e){return Object.values(this.brushesCodec.decode(e))}},{key:"encodeProperties",value:function(e){return this.propsCodec.encode(e)}},{key:"decodeProperties",value:function(e){return this.propsCodec.decode(e)}},{key:"encodeTripleStore",value:function(e){return this.tripleStoreCodec.encode(e)}},{key:"decodeTripleStore",value:function(e){return this.tripleStoreCodec.decode(e)}},{key:"decodeJSON",value:function(e){var t,r=e.head,n=r.type,i=r.version,o=e.body;if("InkModel"==n){var a={},s=new TextDecoder,u=Ki[i].format;for(var c in o){var l=Qi.decode(o[c],u[c]);a[s.decode(Uo.fourCC[c]).toLowerCase()]=Qi.encode(l)}t=this.buildInkModel(a,i)}else{var h=Ki.latest,f=Qi.decode(o,h[n]);switch(n){case"InputData":t=this.decodeInputData(f);break;case"InkData":t=this.decodeInkData(f);break;case"Brushes":t=this.decodeBrushes(f);break;case"Properties":t=this.decodeProperties(f);break;case"TripleStore":t=this.decodeTripleStore(f);break;case"InkTool":t=this.inkToolCodec.decode(f);break;case"InkOperation":if(!this.inkOperationCodec)throw new Error("InkCodec.inkOperationCodec property is not found");this.inkOperationCodec.decode(void 0,f);break;default:throw new Error("input type missmatch - ".concat(n,", expected oneof(InkModel, InputData, InkData, Brushes, Properties, TripleStore, InkTool, InkOperation)"))}}return t}}],[{key:"buildJSON",value:(t=fe(pe.mark((function e(t){var r,n,i,o,a,s,u,c,l,h,f,d,p=arguments;return pe.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r=p.length>1&&void 0!==p[1]?p[1]:"InkModel",t instanceof ArrayBuffer&&(t=new Uint8Array(t)),n={type:r},i={},"InkModel"!=r){e.next=18;break}return o=new tn,e.next=8,o.decode(t);case 8:for(l in a=e.sent,s=a.asProps(),u=Ki[a.version].format,c=new TextDecoder,n.version=a.version,n.format=c.decode(Uo.fourCC.format),s.data?i.InkObject=s.data:(s.inks&&(i.InkStructure=s.inks),s.inpt&&(i.InputData=s.inpt),s.inkd&&(i.InkData=s.inkd),s.brsh&&(i.Brushes=s.brsh),s.prps&&(i.Properties=s.prps),s.knwg&&(i.TripleStore=s.knwg)),i)h=Qi.decode(i[l],u[l]),i[l]=h.toJSON();e.next=24;break;case 18:if(f=Ki.latest,d=Qi.decode(t,f[r])){e.next=22;break}throw new Error("Build type missmatch - ".concat(r,", expected oneof(InkModel, InputData, InkData, Brushes, Properties, TripleStore, InkTool, InkOperation)"));case 22:n.version=Ki.evolution.last,i=d.toJSON();case 24:return e.abrupt("return",{head:n,body:i});case 25:case"end":return e.stop()}}),e)}))),function(e){return t.apply(this,arguments)})}]),e}();function Go(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var r,n=O(e);if(t){var i=O(this).constructor;r=Reflect.construct(n,arguments,i)}else r=n.apply(this,arguments);return A(this,r)}}var Yo=function(e){R(r,e);var t=Go(r);function r(){var e;return P(this,r),(e=t.call(this)).dataCodec=new no,e}return w(r,[{key:"composeStyle",value:function(e){var t=this.format.InkOperation.create({compose:this.format.InkOperation.Compose.create({style:this.encodeStyle(e)})});return Qi.encode(t)}},{key:"composeSegment",value:function(e,t){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;if(e&&0!=e.length){var n=this.format.InkOperation.create({compose:this.format.InkOperation.Compose.create({segment:this.format.Segment.create({pointerID:r,complete:t,ink:this.encodeInkPath(e)})})});return Qi.encode(n)}}},{key:"composeAbort",value:function(){var e=this.format.InkOperation.create({compose:this.format.InkOperation.Compose.create({abort:!0})});return Qi.encode(e)}},{key:"add",value:function(e){var t=this.format.InkOperation.create({add:this.format.InkOperation.Add.create({path:this.dataCodec.encodeStroke(e),ink:this.encodeInkPath(e.path)})});return Qi.encode(t)}},{key:"remove",value:function(e){var t=this.buildStrokesContext(e);if(t){var r=this.format.InkOperation.create({remove:this.format.InkOperation.Remove.create({context:t})});return Qi.encode(r)}}},{key:"update",value:function(e,t){var r=arguments.length>2&&void 0!==arguments[2]&&arguments[2],n=this.buildStrokesContext(e);if(n){var i=this.format.InkOperation.create({update:this.format.InkOperation.Update.create({context:n,style:this.encodeStyle(t,!0),edit:r})});return Qi.encode(i)}}},{key:"split",value:function(e,t){var r=this,n=Object.keys(e);if(0!=n.length){var i=this.format.InkOperation.create({split:this.format.InkOperation.Split.create({intersections:n.map((function(t){return r.encodeIntersection(t,e[t].intervals)})),affectedArea:t})});return Qi.encode(i)}}},{key:"selectSelector",value:function(e){var t=this.format.InkOperation.create({select:this.format.InkOperation.Select.create({selector:this.dataCodec.encodeStroke(e)})});return Qi.encode(t)}},{key:"selectSelection",value:function(e){var t=this.buildStrokesContext(e);if(!t)return this.selectAbort();var r=this.format.InkOperation.create({select:this.format.InkOperation.Select.create({selection:t})});return Qi.encode(r)}},{key:"selectAbort",value:function(){var e=this.format.InkOperation.create({select:this.format.InkOperation.Select.create({abort:!0})});return Qi.encode(e)}},{key:"updateSelectionTransform",value:function(e){var t=this.format.InkOperation.create({updateSelection:this.format.InkOperation.UpdateSelection.create({transform:this.dataCodec.encodeMatrix(e)})});return Qi.encode(t)}},{key:"updateSelectionComplete",value:function(){var e=this.format.InkOperation.create({updateSelection:this.format.InkOperation.UpdateSelection.create({complete:!0})});return Qi.encode(e)}},{key:"transform",value:function(e,t){var r=this.buildStrokesContext(e);if(r){var n=this.format.InkOperation.create({transform:this.format.InkOperation.Transform.create({context:r,matrix:this.dataCodec.encodeMatrix(t)})});return Qi.encode(n)}}},{key:"buildStrokesContext",value:function(e){if(e&&(Array.isArray(e)||(e=[e]),0!=e.length))return this.format.StrokesContext.create({path:e.map((function(e){return"string"==typeof e?B.toBytes(e):B.toBytes(e.id)}))})}},{key:"decode",value:function(e,t){var r=this,n=Qi.decode(t,this.format.InkOperation);switch(n.operation){case"compose":switch(n.compose.stage){case"style":this.onComposeStyle(e,this.decodeStyle(n.compose.style,!1));break;case"segment":this.onComposeSegment(e,this.decodeInkPath(n.compose.segment.ink),n.compose.segment.complete,n.compose.segment.pointerID);break;case"abort":this.onComposeAbort(e);break;default:throw new Error("Unknown compose stage found: ".concat(n.compose.stage))}break;case"add":var i;n.add.ink&&(i=this.decodeInkPath(n.add.ink));var o=this.dataCodec.decodeStroke(n.add.path,{inkPath:i});this.onAdd(e,o);break;case"remove":this.onRemove(e,n.remove.context.path.map((function(e){return B.fromBytes(e)})));break;case"update":this.onUpdate(e,n.update.context.path.map((function(e){return B.fromBytes(e)})),this.decodeStyle(n.update.style,!0),n.update.edit);break;case"split":var a={intersected:{}},s=new V(n.split.affectedArea.x,n.split.affectedArea.y,n.split.affectedArea.width,n.split.affectedArea.height);n.split.intersections.forEach((function(e){var t=r.decodeIntersection(e);a.intersected[t.id]=t.intervals})),this.onSplit(e,a,s);break;case"select":switch(n.select.stage){case"selector":this.onSelectSelector(e,this.dataCodec.decodeStroke(n.select.selector));break;case"selection":this.onSelectSelection(e,n.select.selection.path.map((function(e){return B.fromBytes(e)})));break;case"abort":this.onSelectAbort(e);break;default:throw new Error("Unknown select stage found: ".concat(n.select.stage))}break;case"updateSelection":switch(n.updateSelection.stage){case"transform":this.onUpdateSelectionTransform(e,this.dataCodec.decodeMatrix(n.updateSelection.transform));break;case"complete":this.onUpdateSelectionComplete(e);break;default:throw new Error("Unknown selection update found: ".concat(n.updateSelection.stage))}break;case"transform":this.onTransform(e,n.transform.context.path.map((function(e){return B.fromBytes(e)})),this.dataCodec.decodeMatrix(n.transform.matrix));break;default:throw new Error("Unknown ink operation found: ".concat(n.operation))}}},{key:"traceDecode",value:function(){this.debug||(this.debug=!0,this.onComposeStyle=console.log.bind(console,"onComposeStyle"),this.onComposeSegment=console.log.bind(console,"onComposeSegment"),this.onComposeAbort=console.log.bind(console,"onComposeAbort"),this.onAdd=console.log.bind(console,"onAdd"),this.onRemove=console.log.bind(console,"onRemove"),this.onUpdate=console.log.bind(console,"onUpdate"),this.onSplit=console.log.bind(console,"onSplit"),this.onSelectSelector=console.log.bind(console,"onSelectSelector"),this.onSelectSelection=console.log.bind(console,"onSelectSelection"),this.onSelectAbort=console.log.bind(console,"onSelectAbort"),this.onUpdateSelectionTransform=console.log.bind(console,"onUpdateSelectionTransform"),this.onUpdateSelectionComplete=console.log.bind(console,"onUpdateSelectionComplete"),this.onTransform=console.log.bind(console,"onTransform"))}},{key:"onComposeStyle",value:function(e,t){throw new Error("InkOperation.onComposeStyle(user, style) should be implemented")}},{key:"onComposeSegment",value:function(e,t,r,n){throw new Error("InkOperation.onComposeSegment(user, segment, endStroke, pointerID) should be implemented")}},{key:"onComposeAbort",value:function(e){throw new Error("InkOperation.onComposeAbort(user) should be implemented")}},{key:"onAdd",value:function(e,t){throw new Error("InkOperation.onAdd(user, stroke) should be implemented")}},{key:"onRemove",value:function(e,t){throw new Error("InkOperation.onRemove(user, strokes) should be implemented")}},{key:"onUpdate",value:function(e,t,r,n){throw new Error("InkOperation.onUpdate(user, strokes, style, edit) should be implemented")}},{key:"onSplit",value:function(e,t,r){throw new Error("InkOperation.onSplit(user, intersections, affectedArea) should be implemented")}},{key:"onSelectSelector",value:function(e,t){throw new Error("InkOperation.onSelectSelector(user, selector) should be implemented")}},{key:"onSelectSelection",value:function(e,t){throw new Error("InkOperation.onSelectSelection(user, selection) should be implemented")}},{key:"onSelectAbort",value:function(e){throw new Error("InkOperation.onSelectAbort(user) should be implemented")}},{key:"onUpdateSelectionTransform",value:function(e,t){throw new Error("InkOperation.onUpdateSelectionTransform(user, transform) should be implemented")}},{key:"onUpdateSelectionComplete",value:function(e){throw new Error("InkOperation.onUpdateSelectionComplete(user) should be implemented")}},{key:"onTransform",value:function(e,t,r){throw new Error("InkOperation.onTransform(user, strokes, transform) should be implemented")}},{key:"encodeStyle",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1],r=this.format.Style.create();if(isFinite(e.pointerID)){if(t)throw new Error("Style property pointerID is not applicable for update");r.pointerID=e.pointerID}else if(!t)throw new Error("Style property pointerID is required");if(e.color)r.color=Wi.rgba(e.color.red,e.color.green,e.color.blue,e.color.alpha);else if(!t)throw new Error("Style property color is required");if(e.brush){if(r.brushURI=e.brush.name,e.brush instanceof qt)if(e.randomSeed){if(t)throw new Error("Style property randomSeed is not applicable for update, it is immutable");r.randomSeed=e.randomSeed}else if(!t)throw new Error("Style property randomSeed is required")}else if(!t)throw new Error("Style property brush is required");if(e.renderMode)e.renderMode!=ci.RenderMode.SOURCE_OVER&&(r.renderModeURI=e.renderMode);else if(e.blendMode)e.blendMode!=Tt.SOURCE_OVER&&(r.renderModeURI=ci.RenderMode.get(e.blendMode));else if(!t)throw new Error("Style property oneof(renderMode, blendMode) is required");return r}},{key:"decodeStyle",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1],r={};if(t||(r.pointerID=e.pointerID),e.color&&(r.color=We.fromColor(Wi.fromRGBA(e.color))),e.brushURI){var n=new Xe(e.brushURI);if(r.brush=n.value,r.brush instanceof qt)if(e.randomSeed)t?console.warn("Style property randomSeed is not applicable for update, it is immutable"):r.randomSeed=e.randomSeed;else if(!t)throw new Error("Style property randomSeed is required")}return r.renderMode=e.renderModeURI||ci.RenderMode.SOURCE_OVER,r}},{key:"encodeInkPath",value:function(e,t){var r=this,n=this.format.InkPath.create();if(e instanceof cr)n.polygons=this.format.PolygonArray.create({data:e.map((function(e){return r.format.Polygon.create({shape:r.format.Path.create({data:e.shape.points}),holes:e.holes.map((function(e){return r.format.Path.create({data:e.points})}))})}))});else if(e instanceof Or)n.path=this.format.Path.create({layout:re.encodeBitMask(e.layout.map((function(e){return e.value+1}))),pointProps:Wi.encodePathPointProperties(e.pointProps,this.format.PathPointProperties.create()),data:e.points});else{if(!(e instanceof Tr))throw new Error("Expected path type - oneof(InkPath2D, InterpolatedSpline, Spline), not found");if(t)throw new Error("spline already provided through path property");t=e}return t&&(n.spline=this.format.Path.create({layout:re.encodeBitMask(t.layout.map((function(e){return e.value+1}))),pointProps:Wi.encodePathPointProperties(t.pointProps,this.format.PathPointProperties.create()),data:t.points})),n}},{key:"decodeInkPath",value:function(e){var t;if("polygons"==e.data)t=D(cr,te(e.polygons.data.map((function(e){return ht.createInstance(e.shape.data,e.holes.map((function(e){return e.data})))}))));else if("path"==e.data){var r=re.decodeBitMask(e.path.layout).map((function(e){return le.Property[e-1]})),n=Wi.decodePathPointProperties(e.path.pointProps,r);t=new Or(r,e.path.data,n)}if(e.spline){var i=re.decodeBitMask(e.spline.layout).map((function(e){return le.Property[e-1]})),o=Wi.decodePathPointProperties(e.spline.pointProps,i),a=new Tr(i,e.spline.data,o);t?t.spline=a:t=a}return t}},{key:"encodeIntersection",value:function(e,t){var r=this;if(t.some((function(e){return!e.id})))throw new Error("Interval 'id' is required");return this.format.Intersection.create({path:B.toBytes(e),intervals:t.map((function(e){return r.format.Interval.create({id:B.toBytes(e.id),fromIndex:e.fromPointIndex,toIndex:e.toPointIndex,fromTValue:e.fromTValue,toTValue:e.toTValue})}))})}},{key:"decodeIntersection",value:function(e){return{id:B.fromBytes(e.path),intervals:e.intervals.map((function(e){return{id:B.fromBytes(e.id),fromPointIndex:e.fromIndex,toPointIndex:e.toIndex,fromTValue:e.fromTValue,toTValue:e.toTValue}}))}}}]),r}(Qi);function Xo(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var r,n=O(e);if(t){var i=O(this).constructor;r=Reflect.construct(n,arguments,i)}else r=n.apply(this,arguments);return A(this,r)}}var zo=function(e){R(r,e);var t=Xo(r);function r(){var e,n=arguments.length>0&&void 0!==arguments[0]?arguments[0]:2,i=arguments.length>1&&void 0!==arguments[1]&&arguments[1];return P(this,r),(e=t.call(this)).precision=n,e.autoAdjustOnIntegerOverflow=i,e}return w(r,[{key:"calculatePrecision",value:function(e,t){if(!this.autoAdjustOnIntegerOverflow)return this.precision;for(var r=this.precision,n=NaN;isNaN(n);){if(n=hn.calculateError(e,r),0==r){if(isNaN(n))throw new Error("Can't calculate appropriate precision value for the provided float sequence.");break}r--}return r}}]),r}(rn);function Vo(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var r,n=O(e);if(t){var i=O(this).constructor;r=Reflect.construct(n,arguments,i)}else r=n.apply(this,arguments);return A(this,r)}}var Ho=function(e){R(r,e);var t=Vo(r);function r(){var e,n=arguments.length>0&&void 0!==arguments[0]?arguments[0]:.5;return P(this,r),(e=t.call(this)).qualityFactor=n,e}return w(r,[{key:"calculatePrecision",value:function(e,t){var r=new Float32Array(9),n=0,i=NaN,o=hn.l2Norm(e);if(0==o)return 2;for(var a=0;a<9;a++){var s=hn.calculateError(e,a)/o;if(isNaN(s))break;if(!isNaN(i)&&i<=s)break;if(n=a,r[a]=s,hn.isZero(s))break;i=s}return Math.round(this.qualityFactor*n)}}]),r}(rn);function Zo(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var r,n=O(e);if(t){var i=O(this).constructor;r=Reflect.construct(n,arguments,i)}else r=n.apply(this,arguments);return A(this,r)}}var qo=function(e){R(r,e);var t=Zo(r);function r(){var e,n=arguments.length>0&&void 0!==arguments[0]?arguments[0]:.5;return P(this,r),(e=t.call(this)).qualityFactor=n,e}return w(r,[{key:"calculatePrecision",value:function(e,t){var r=new Float32Array(e.length);r[0]=0;for(var n=1;n<e.length;n++)r[n]=(e[n]-e[n-1])%1;var i=hn.variance(r),o=i%1==0?0:-Math.floor(Math.log10(i));return o=Math.min(o,9),Math.round(this.qualityFactor*o)}}]),r}(rn);function Wo(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var r,n=O(e);if(t){var i=O(this).constructor;r=Reflect.construct(n,arguments,i)}else r=n.apply(this,arguments);return A(this,r)}}var Ko=function(e){R(a,e);var t,r,n,i,o=Wo(a);function a(){var e;return P(this,a),(e=o.call(this,a.WORKER_NAME,a.buildWorkerURL(),Nn.WorkerType.CLASSIC)).state={},e}return w(a,[{key:"importBrushes",value:(i=fe(pe.mark((function e(t){var r;return pe.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=this.nextID,this.state[r]={expected:this.workers.length},e.next=4,this.broadcastMessage({action:"IMPORT_BRUSHES",actionID:r,brushes:t.map((function(e){return e.toJSON()}))});case 4:return e.abrupt("return",e.sent);case 5:case"end":return e.stop()}}),e,this)}))),function(e){return i.apply(this,arguments)})},{key:"importSpline",value:(n=fe(pe.mark((function e(t,r){var n;return pe.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=this.nextID,this.state[n]={expected:this.workers.length},e.next=4,this.broadcastMessage({action:"IMPORT_SPLINE",actionID:n,strokeID:t,spline:r.toJSON()});case 4:return e.abrupt("return",e.sent);case 5:case"end":return e.stop()}}),e,this)}))),function(e,t){return n.apply(this,arguments)})},{key:"removeSpline",value:(r=fe(pe.mark((function e(t){var r;return pe.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=this.nextID,this.state[r]={expected:this.workers.length},e.next=4,this.broadcastMessage({action:"REMOVE_SPLINE",actionID:r,strokeID:t});case 4:return e.abrupt("return",e.sent);case 5:case"end":return e.stop()}}),e,this)}))),function(e){return r.apply(this,arguments)})},{key:"buildStrokeSegments",value:(t=fe(pe.mark((function e(t){var r;return pe.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.importSpline(t.id,t.spline);case 2:return r=this.nextID,this.state[r]={strokeID:t.id,brushName:t.brush.name,indices:new Array(t.segmentsCount).fill(0).map((function(e,t){return t})),segments:[],count:t.segmentsCount,expected:t.segmentsCount},e.next=6,this.broadcast("BUILD_STROKE_SEGMENT",r);case 6:return e.abrupt("return",e.sent);case 7:case"end":return e.stop()}}),e,this)}))),function(e){return t.apply(this,arguments)})},{key:"buildRequestMessage",value:function(e,t){var r={action:e,actionID:t},n=this.state[t];if("BUILD_STROKE_SEGMENT"!=e)throw new Error("Unknow data action found: ".concat(e));var i=n.indices.shift();if(!isNaN(i))return r.index=i,r.strokeID=n.strokeID,r.brushName=n.brushName,r}},{key:"recieve",value:function(e){var t,r=this.state[e.actionID];switch(r.expected--,e.action){case"IMPORT_BRUSHES":case"IMPORT_SPLINE":case"REMOVE_SPLINE":break;case"BUILD_STROKE_SEGMENT":if(r.segments[e.index]={strokeID:r.strokeID,segmentIndex:e.index,bounds:V.fromRect(e.bounds),spline:Tr.fromJSON(e.spline),depth:e.depth},0==r.expected)t=r.segments,this.removeSpline(r.strokeID);else{var n=this.buildRequestMessage(e.action,e.actionID);n&&this.send(e.worker,n)}break;default:throw new Error("Unknow data action found: ".concat(e.action))}0==r.expected&&(delete this.state[e.actionID],this.resolve(e.actionID,t))}}],[{key:"buildWorkerURL",value:function(){if(("undefined"==typeof document&&"undefined"==typeof location?new(require("url").URL)("file:"+__filename).href:"undefined"==typeof document?location.href:document.currentScript&&document.currentScript.src||new URL("digital-ink-min.js",document.baseURI).href).contains("/wacom-src/"))return"/node_modules/digital-ink/workers/".concat(a.WORKER_NAME,".js");if("function"!=typeof DedicatedWorkerGlobalScope){var e=void 0===l?"undefined"==typeof document&&"undefined"==typeof location?new(require("url").URL)("file:"+__filename).href:"undefined"==typeof document?location.href:document.currentScript&&document.currentScript.src||new URL("digital-ink-min.js",document.baseURI).href:l;return(e=e.substring(0,e.lastIndexOf("/"))).endsWith("workers")||(e+="/workers"),e+="/".concat(a.WORKER_NAME),"undefined"==typeof navigator?e+=".mjs":e+=".js",e}}}]),a}(Nn);S(Ko,"WORKER_NAME","SegmentsProvider");var Jo=function(){function e(){P(this,e),this.tree=new Zr,this.strokes={},this.brushAppliers={},this.nodes={},this.distanceInterpolator=new Lr(1,!1,!0),this.curvatureInterpolator=new wn(!0,!0),this.convexHullChainProducer=new An,this.segmentsProducer=Ko.getInstance()}return w(e,[{key:"add",value:function(e){e.brush instanceof qt||(this.strokes[e.id]=e,this.loadStrokeNode(e))}},{key:"getStroke",value:function(e){return this.strokes[e]}},{key:"getBrushApplier",value:function(e){var t=this.strokes[e].brush;return this.brushAppliers[t.name]||(this.brushAppliers[t.name]=new Sn(t)),this.brushAppliers[t.name]}},{key:"getNodes",value:function(e){return this.nodes[e]}},{key:"loadStrokeNode",value:function(e){var t=Yr.buildStrokeNode(e);this.nodes[e.id]=[],this.nodes[e.id].push(t),this.load(this.nodes[e.id])}},{key:"reload",value:function(e){this.unload(this.nodes[e.id]),this.loadStrokeNode(e)}},{key:"remove",value:function(e){var t="string"==typeof e?e:e.id;this.unload(this.nodes[t]),delete this.nodes[t],delete this.strokes[t]}},{key:"update",value:function(e,t){var r=this,n={intersected:[],selected:[],dirtyArea:void 0};return Object.keys(e).forEach((function(i){var o=r.strokes[i],a=r.split(o,e[i]);a&&(n.intersected.push({stroke:o,strokes:a}),t||(n.dirtyArea=o.bounds.union(n.dirtyArea)),e[i].intervals.forEach((function(e,t){e.inside&&n.selected.push(a[t])})))})),n}},{key:"split",value:function(e,t){var r=this,n=t.intervals,i=t.holes;if(0==n.length)return[];var o=e.split(n);if(o){o.forEach((function(e){r.strokes[e.id]=e}));var a=[],s=[];return n.map((function(t){return r.nodes[e.id].slice(t.fromNodeIndex,t.toNodeIndex+1)})).forEach((function(t,i){var u,c,l=o[i],h=r.getBrushApplier(l.id),f=n[i].fromPointIndex,d=n[i].toPointIndex-3;if(l.ts!=t.first.spline.ts){var p=t.first.segmentIndex,y=r.nodes[e.id].filter((function(e){return e.segmentIndex==p}));t=t.filter((function(e){return e.segmentIndex!=p})),p>=f&&(u=Yr.buildStrokeSegment(l.id,l.spline,p-f,h),a.push(u)),s.push.apply(s,te(y))}if(t.length>0&&l.tf!=t.last.spline.tf){var v=t.last.segmentIndex,m=r.nodes[e.id].filter((function(e){return e.segmentIndex==v}));t=t.filter((function(e){return e.segmentIndex!=v})),v<=d&&(c=Yr.buildStrokeSegment(l.id,l.spline,v-f,h),a.push(c)),s.push.apply(s,te(m))}t.forEach((function(e){e.strokeID=l.id,e.segmentIndex-=f})),u&&t.unshift(u),c&&t.push(c),r.nodes[l.id]=t})),i.forEach((function(t){return s.push.apply(s,te(r.nodes[e.id].slice(t.fromNodeIndex,t.toNodeIndex+1)))})),this.unload(s),this.load(a),delete this.nodes[e.id],delete this.strokes[e.id],o}}},{key:"replace",value:function(e,t){var r=this;t.forEach((function(e){return r.add(e)})),this.remove(e)}},{key:"load",value:function(e){Array.isArray(e)||(e=[e]),0!=e.length&&(this.tree.load(e),this.tree.canvas&&this.tree.canvas.refresh())}},{key:"updateTree",value:function(e,t){this.tree.remove(e),this.nodes[e.strokeID].replace(e,t)}},{key:"unload",value:function(e){var t=this;Array.isArray(e)||(e=[e]),e.forEach((function(e){return t.tree.remove(e)})),this.tree.canvas&&this.tree.canvas.refresh()}},{key:"search",value:function(e){return this.tree.search(e)}},{key:"reset",value:function(){this.strokes={},this.brushAppliers={},this.nodes={},this.tree.clear(),this.tree.canvas&&this.tree.canvas.refresh()}}],[{key:"createInstance",value:function(t){var r=new e;if(t){r.strokes=Object.assign({},t.strokes),r.brushAppliers=t.brushAppliers;var n=[];for(var i in r.strokes)r.nodes[i]=t.nodes[i].map((function(e){return Object.assign({},e)})),n=n.concat(r.nodes[i]);r.tree.load(n)}return r}}]),e}();function $o(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var r,n=O(e);if(t){var i=O(this).constructor;r=Reflect.construct(n,arguments,i)}else r=n.apply(this,arguments);return A(this,r)}}var Qo=function(e){R(n,e);var t,r=$o(n);function n(e){return P(this,n),r.call(this,e)}return w(n,[{key:"intersect",value:function(e){if(!this.context)throw new Error("Required spatial context not found");return this.nodes=new Set,this.updateSegmentation(e),this.mode==n.Mode.PARTIAL_STROKE?this.createIntervals(this.nodes,e):{intersected:{},selected:Array.from(Set.prototype.map.call(this.nodes,(function(e){return e.strokeID})))}}},{key:"intersectAsync",value:(t=fe(pe.mark((function e(t){return pe.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this.context){e.next=2;break}throw new Error("Required spatial context not found");case 2:return this.nodes2=[],e.next=5,this.updateSegmentationAsync(t);case 5:if(this.mode!=n.Mode.PARTIAL_STROKE){e.next=9;break}return e.abrupt("return",this.createIntervals(this.nodes2,t));case 9:return e.abrupt("return",{intersected:{},selected:this.nodes2.map((function(e){return e.strokeID}))});case 10:case"end":return e.stop()}}),e,this)}))),function(e){return t.apply(this,arguments)})},{key:"intersectSegmentation",value:function(e){if(!this.context)throw new Error("Required spatial context not found");return this.createIntervals(0==this.nodes2.length?this.nodes:this.nodes2,e)}}]),n}(Yr);function ea(e,t){var r="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!r){if(Array.isArray(e)||(r=function(e,t){if(!e)return;if("string"==typeof e)return ta(e,t);var r=Object.prototype.toString.call(e).slice(8,-1);"Object"===r&&e.constructor&&(r=e.constructor.name);if("Map"===r||"Set"===r)return Array.from(e);if("Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r))return ta(e,t)}(e))||t&&e&&"number"==typeof e.length){r&&(e=r);var n=0,i=function(){};return{s:i,n:function(){return n>=e.length?{done:!0}:{done:!1,value:e[n++]}},e:function(e){throw e},f:i}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var o,a=!0,s=!1;return{s:function(){r=r.call(e)},n:function(){var e=r.next();return a=e.done,e},e:function(e){s=!0,o=e},f:function(){try{a||null==r.return||r.return()}finally{if(s)throw o}}}}function ta(e,t){(null==t||t>e.length)&&(t=e.length);for(var r=0,n=new Array(t);r<t;r++)n[r]=e[r];return n}function ra(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var r,n=O(e);if(t){var i=O(this).constructor;r=Reflect.construct(n,arguments,i)}else r=n.apply(this,arguments);return A(this,r)}}var na=function(e){R(n,e);var t,r=ra(n);function n(e){return P(this,n),r.call(this,e)}return w(n,[{key:"select",value:function(e){if(!this.context)throw new Error("Required spatial context not found");var t=e.spline.getPoint(0).toArray(e.layout),r=e.spline.getPoint(e.spline.length-1).toArray(e.layout),i=[].concat(te(r),te(r),te(t),te(t)),o=new ci(e.brush,new Tr(e.layout,i,e.pointProps));this.updateSegmentation(o.path);var a={intersected:{},selected:[]},s=e.bounds,u=jn.createClipperPath(e.spline),c=this.context.search(s),l=this.nodes.map((function(e){return e.strokeID})),h=Set.prototype.map.call(c,(function(e){return e.strokeID})).filter((function(e){return!l.has(e)}));if(this.context.tree.canvas&&this.context.tree.canvas.addOperation("drawSelection",s,e.spline,e.path.first),this.mode==n.Mode.PARTIAL_STROKE){var f=this.createIntervals(this.nodes,e.path);a=f;var d,p=ea(l);try{for(p.s();!(d=p.n()).done;){var y,v=d.value,m=f.intersected[v]?f.intersected[v].intervals:[],g=0==m.length?null:this.context.getNodes(v),b=ea(m);try{for(b.s();!(y=b.n()).done;){var E=y.value,P=this.computeCenter(g,E.fromNodeIndex,E.toNodeIndex),k=jn.containsPoint(u,P);this.context.tree.canvas&&this.context.tree.canvas.addOperation("fillPoint",P,5,k?We.WHITE:We.BLACK),E.inside=k}}catch(e){b.e(e)}finally{b.f()}}}catch(e){p.e(e)}finally{p.f()}}else a.selected=Array.from(l);var w,x=ea(h);try{for(x.s();!(w=x.n()).done;){var S=w.value,I=this.context.getNodes(S),R=this.computeCenter(I,0,I.length-1);jn.containsPoint(u,R)&&(a.selected.push(S),this.context.tree.canvas&&this.context.tree.canvas.addOperation("fillPoint",R,5,We.GREEN))}}catch(e){x.e(e)}finally{x.f()}return Object.defineProperty(a,"length",{get:function(){return Object.keys(a.intersected).length+a.selected.length},enumerable:!0}),this.context.tree.canvas&&this.context.tree.canvas.refresh(),a}},{key:"selectAsync",value:(t=fe(pe.mark((function e(t){var r,i,o,a,s,u,c,l,h,f,d,p,y,v,m,g,b,E,P,k,w,x,S,I,R,T;return pe.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this.context){e.next=2;break}throw new Error("Required spatial context not found");case 2:return r=t.spline.getPoint(0).toArray(t.layout),i=t.spline.getPoint(t.spline.length-1).toArray(t.layout),o=[].concat(te(i),te(i),te(r),te(r)),a=new ci(t.brush,new Tr(t.layout,o,t.pointProps)),e.next=8,this.updateSegmentationAsync(a.path);case 8:if(s={intersected:{},selected:[]},u=t.bounds,c=jn.createClipperPath(t.spline),l=this.context.search(u),h=this.nodes2.map((function(e){return e.strokeID})),f=l.map((function(e){return e.strokeID})).filter((function(e){return!h.includes(e)})),this.context.tree.canvas&&this.context.tree.canvas.addOperation("drawSelection",u,t.spline,t.path.first),this.mode==n.Mode.PARTIAL_STROKE){d=this.createIntervals(this.nodes2,t.path),s=d,p=ea(h);try{for(p.s();!(y=p.n()).done;){v=y.value,m=d.intersected[v]?d.intersected[v].intervals:[],g=0==m.length?null:this.context.getNodes(v),b=ea(m);try{for(b.s();!(E=b.n()).done;)P=E.value,k=this.computeCenter(g,P.fromNodeIndex,P.toNodeIndex),w=jn.containsPoint(c,k),this.context.tree.canvas&&this.context.tree.canvas.addOperation("fillPoint",k,5,w?We.WHITE:We.BLACK),P.inside=w}catch(e){b.e(e)}finally{b.f()}}}catch(e){p.e(e)}finally{p.f()}}else s.selected=Array.from(h);x=ea(f);try{for(x.s();!(S=x.n()).done;)I=S.value,R=this.context.getNodes(I),T=this.computeCenter(R,0,R.length-1),jn.containsPoint(c,T)&&(s.selected.push(I),this.context.tree.canvas&&this.context.tree.canvas.addOperation("fillPoint",T,5,We.GREEN))}catch(e){x.e(e)}finally{x.f()}return Object.defineProperty(s,"length",{get:function(){return Object.keys(s.intersected).length+s.selected.length},enumerable:!0}),this.context.tree.canvas&&this.context.tree.canvas.refresh(),e.abrupt("return",s);case 22:case"end":return e.stop()}}),e,this)}))),function(e){return t.apply(this,arguments)})},{key:"computeCenter",value:function(e,t,r){for(var n=r+1-t,i=0,o=0,a=t;a<=r;a++){var s=e[a].bounds.center;i+=s.x,o+=s.y}return{x:i/n,y:o/n}}}]),n}(Yr),ia=dn,oa=vn,aa=gn,sa=Lr,ua=wn,ca=Sn,la=An,ha=_n,fa=Yn,da=zn,pa=Hn;e.ArrayPath=tt,e.BlendMode=Tt,e.Brush2D=xt,e.BrushApplier=ca,e.BrushGL=qt,e.BrushPrototype=ft,e.Color=We,e.ColorsBox=pr,e.ConvexHullChainProducer=la,e.ConvexHullChainProducerAsync=ha,e.CurvatureBasedInterpolator=ua,e.DistanceBasedInterpolator=sa,e.Environment=Ee,e.FixedValuePrecisionCalculator=zo,e.InkBuilder=ri,e.InkBuilderAsync=si,e.InkCanvas2D=Si,e.InkCanvasGL=Ui,e.InkCodec=jo,e.InkController=x,e.InkInputProvider=G,e.InkModel=Io,e.InkObjectFormat=Uo,e.InkOperation=Yo,e.InkPath2D=cr,e.InkPathProducer=mi,e.InkToolCodec=Mo,e.InputContext=Ne,e.InputDevice=je,e.InputListener=ue,e.InterpolatedSpline=Or,e.Intersector=Qo,e.Matrix=Q,e.OffscreenCanvasGL=Mi,e.Path=$e,e.PathPoint=le,e.PathPointContext=St,e.PathProducer=ia,e.PathSegment=Jn,e.Pipeline=Wn,e.PipelineStage=pa,e.Point=X,e.PointerData=Kn,e.Poly=jn,e.Polygon=ht,e.PolygonArray=or,e.PolygonMerger=fa,e.PolygonSimplifier=da,e.PrecisionCalculator=rn,e.PrecisionSchema=un,e.RIFFDecoder=tn,e.RIFFEncoder=Qr,e.RIFFFormat=Kr,e.RMSEBasedPrecisionCalculator=Ho,e.Rect=V,e.RenderingContext2D=Ir,e.Scalar=xe,e.SegmentsProducer=Ko,e.Selector=na,e.SemanticTriple=zi,e.SensorChannel=Re,e.SensorChannelsContext=Ae,e.SensorContext=Ce,e.SensorData=Be,e.SensorStream=_e,e.ShapeFactory=Ve,e.SharedPath=nt,e.Smoother=oa,e.SpatialContext=Jo,e.Spline=Tr,e.SplineProducer=aa,e.Stroke=ci,e.StrokeRenderer2D=Oi,e.StrokeRendererGL=Xi,e.TextTable=ne,e.TripleStore=Hi,e.TypedArrayCodec=Ye,e.URIResolver=Ge,e.VarianceBasedPrecisionCalculator=qo,e.fsx=kt,e.math=st,e.utils=re,e.uuid=B,e.version=ye,Object.defineProperty(e,"__esModule",{value:!0})}));
